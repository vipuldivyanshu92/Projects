<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/introducing-the-model-and-sqlalchemy.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:42:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 7: Introducing the Model and SQLAlchemy &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 8: Starting the SimpleSite Tutorial" href="starting-the-simplesite-tutorial.html" />
    <link rel="prev" title="Chapter 6: Working with Forms and Validators" href="working-with-forms-and-validators.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="starting-the-simplesite-tutorial.html" title="Chapter 8: Starting the SimpleSite Tutorial"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="working-with-forms-and-validators.html" title="Chapter 6: Working with Forms and Validators"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-7-introducing-the-model-and-sqlalchemy">
<h1>Chapter 7: Introducing the Model and SQLAlchemy<a class="headerlink" href="#chapter-7-introducing-the-model-and-sqlalchemy" title="Permalink to this headline">¶</a></h1>
<p id="index-537">When people think about a model layer, they often immediately think of using a relational database management system (RDBMS) such as PostgreSQL or MySQL. In fact, there are many different ways to store your data in a Pylons application, so there are many different ways to model that data. It is important to decide on the correct approach for your particular needs. Some approaches might include these:</p>
<blockquote>
<ul class="simple">
<li>Storing data in files in the filesystem</li>
<li>Storing data via a web service such as Amazon S3</li>
<li>Storing data in an object database</li>
<li>Storing data in an XML database</li>
<li>Storing data in an RDBMS</li>
</ul>
</blockquote>
<p>Pylons supports all of these approaches, but each has its advantages and disadvantages. If you are heavily relying on XML data, then an XML database makes sense. If you want to be able to manipulate and store Python objects that don’t need to be indexed quickly, an object database might suit your needs. If you are storing lots of binary data such as photographs or videos that don’t need to be searchable, you might store them in a third-party storage solution such as Amazon S3. And if you have large amounts of related data that needs to be quickly indexed, an RDBMS might be best.</p>
<p>In this chapter, I’ll cover these different approaches to storing information and then give you an in-depth look at how to use RDBMSs with SQLAlchemy in Pylons.</p>
<div class="section" id="storing-data-in-the-filesystem">
<h2>Storing Data in the Filesystem<a class="headerlink" href="#storing-data-in-the-filesystem" title="Permalink to this headline">¶</a></h2>
<p id="index-538">There isn’t a great deal of point in storing data types such as photos, videos, and other binary data in a database because they take up a lot of space, which will slow down queries. It is much better to store binary data on the filesystem and store only key properties such as the filename or the creation date in a database.</p>
<p id="index-539">You might be tempted to store your application’s data in your project’s <tt class="docutils literal"><span class="pre">data</span></tt> directory since it is already present and can be customized in your application’s config file. The disadvantage is that because it is already used to store temporary session, cache, and template information, other Pylons developers working on your project might be used to deleting it when they want to clear this temporary information. To avoid this problem, it is better to keep the <tt class="docutils literal"><span class="pre">data</span></tt> directory for cached information and to add a new directory for your user’s data. Let’s call ours <tt class="docutils literal"><span class="pre">attachments</span></tt>, but the location will be customizable in the config file too.</p>
<p id="index-540">You could write code like this to load one of the files in this directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span>

<span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;attachments&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p id="index-541">You can save a file to the directory with a function like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;attachments&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-542">You can list all the files like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list_files</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;attachments&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>For this example, you’ll need to add a new variable in your project config file’s <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section:</p>
<div class="highlight-python"><pre># You could customize this to specify something like /var/lib/myapp/attachments
# if you prefer
attachments = %(here)s/attachments</pre>
</div>
<p id="index-543">Each Pylons project has a <tt class="docutils literal"><span class="pre">model</span></tt> directory, which is where code for interacting with the application’s data should be stored so you can define the previous functions in <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt>, for example.</p>
<p id="index-544">You can get information about a particular file like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;attachments&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-545">The <tt class="docutils literal"><span class="pre">os.path</span></tt> module documented at <a class="reference external" href="http://docs.python.org/lib/module-os.path.html">http://docs.python.org/lib/module-os.path.html</a> has other similar methods for accessing other information about files such as <tt class="docutils literal"><span class="pre">getmtime(path)</span></tt>, which returns the modification time.</p>
<p id="index-546">For additional filesystem information, see the <tt class="docutils literal"><span class="pre">os.stat()</span></tt> function, which returns an object whose attributes correspond to the members of the stat structure, namely, <tt class="docutils literal"><span class="pre">st_mode</span></tt> (protection bits), <tt class="docutils literal"><span class="pre">st_ino</span></tt> (inode number), <tt class="docutils literal"><span class="pre">st_dev</span></tt> (device), <tt class="docutils literal"><span class="pre">st_nlink</span></tt> (number of hard links), <tt class="docutils literal"><span class="pre">st_uid</span></tt> (user ID of owner), <tt class="docutils literal"><span class="pre">st_gid</span></tt> (group ID of owner), <tt class="docutils literal"><span class="pre">st_size</span></tt> (size of file, in bytes), <tt class="docutils literal"><span class="pre">st_atime</span></tt> (time of most recent access), <tt class="docutils literal"><span class="pre">st_mtime</span></tt> (time of most recent content modification), and <tt class="docutils literal"><span class="pre">st_ctime</span></tt> (platform dependent; time of most recent metadata change on Unix or the time of creation on Windows). It can be used in two ways, as described in the module documentation at <a class="reference external" href="http://docs.python.org/lib/os-file-dir.html">http://docs.python.org/lib/os-file-dir.html</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">statinfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&#39;somefile.txt&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">statinfo</span>
<span class="go">(33188, 422511L, 769L, 1, 1032, 100, 926L, 1105022698,1105022732, 1105022732)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">statinfo</span><span class="o">.</span><span class="n">st_size</span>
<span class="go">926L</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">statinfo</span><span class="p">[</span><span class="mf">7</span><span class="p">]</span>
<span class="go">1105022698</span>
</pre></div>
</div>
<p>You might want to turn the access and modification times into Python <tt class="docutils literal"><span class="pre">datetime</span></tt> objects and then format them in a different way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">statinfo</span><span class="p">[</span><span class="mf">7</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">modified</span>
<span class="go">datetime.datetime(2005, 1, 6, 14, 44, 58)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">modified</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S&quot;</span><span class="p">)</span>
<span class="go">&#39;2005-01-06T14:44:58&#39;</span>
</pre></div>
</div>
<p id="index-547">It is sometimes useful to express in words when something happens. You can do so like this using the <tt class="docutils literal"><span class="pre">time_ago_in_words()</span></tt> function included with WebHelpers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">webhelpers.date</span> <span class="kn">import</span> <span class="n">time_ago_in_words</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
<span class="go">&#39;over 2 years&#39;</span>
</pre></div>
</div>
<p id="index-548">It is also useful to express a file size in human-readable terms. Here’s a helper that does just that, which you can add to your project’s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file and use as <tt class="docutils literal"><span class="pre">h.size_to_human()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">size_to_human</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="mf">1024</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">unit_name</span> <span class="o">=</span> <span class="s">&#39;bytes&#39;</span>
    <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">unit_name</span> <span class="o">=</span> <span class="s">&#39;KB&#39;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">unit_name</span> <span class="o">=</span> <span class="s">&#39;MB&#39;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">unit_name</span> <span class="o">=</span> <span class="s">&#39;GB&#39;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">4</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span><span class="o">+</span><span class="s">&#39;&amp;nbsp;&#39;</span><span class="o">+</span><span class="n">unit_name</span>
</pre></div>
</div>
<p id="index-549">Here is some further reading on filesystem use:</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="http://docs.python.org/lib/bltin-file-objects.html">http://docs.python.org/lib/bltin-file-objects.html</a></li>
<li><a class="reference external" href="http://docs.python.org/lib/os-file-dir.html">http://docs.python.org/lib/os-file-dir.html</a></li>
<li><a class="reference external" href="http://docs.python.org/lib/module-shutil.html">http://docs.python.org/lib/module-shutil.html</a></li>
</ul>
</blockquote>
<p id="index-550">The <tt class="docutils literal"><span class="pre">shutil</span></tt> module’s <tt class="docutils literal"><span class="pre">copytree()</span></tt> function can be particularly useful on occasion.</p>
</div>
<div class="section" id="storing-data-in-amazon-s3">
<h2>Storing Data in Amazon S3<a class="headerlink" href="#storing-data-in-amazon-s3" title="Permalink to this headline">¶</a></h2>
<p id="index-551">If you are building a web application to store very large amounts of information, it is possible that you might prefer to use a third-party storage service to look after your data rather than using your own hard disk space. Amazon S3 is one such service, but there are many others, including CacheFly. The basic principle of these services is that you pay for the bandwidth and storage used. If you have a startup and can’t predict in advance how popular it will be, you may struggle to predict how many servers you will need for storage. By using a third-party service, the storage problem is largely solved because you can just order more storage without needing to buy any more machines.</p>
<p id="index-552">Amazon S3 works via an XML web services API, but a number of Python libraries provide a Python interface to these services. Here’s how you would upload and retrieve a file from Amazon S3 using a package called <tt class="docutils literal"><span class="pre">boto</span></tt> from <a class="reference external" href="http://code.google.com/b/boto">http://code.google.com/b/boto</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">boto.s3.connection</span> <span class="kn">import</span> <span class="n">S3Connection</span>
<span class="kn">from</span> <span class="nn">boto.s3.key</span> <span class="kn">import</span> <span class="n">Key</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">S3Connection</span><span class="p">(</span><span class="s">&#39;&lt;aws access key&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;aws secret key&gt;&#39;</span><span class="p">)</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="s">&#39;pylonsbook&#39;</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
<span class="n">k</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#39;foobar&#39;</span>
<span class="n">k</span><span class="o">.</span><span class="n">set_contents_from_filename</span><span class="p">(</span><span class="s">&#39;foo.png&#39;</span><span class="p">)</span>
<span class="n">k</span><span class="o">.</span><span class="n">get_contents_to_filename</span><span class="p">(</span><span class="s">&#39;bar.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In S3, bucket names are not unique to individual users, so you will have to find a bucket name that hasn’t yet been used rather than using <tt class="docutils literal"><span class="pre">pylonsbook</span></tt>. You can install <tt class="docutils literal"><span class="pre">boto</span></tt> using Easy Install like this:</p>
<div class="highlight-python"><pre>$ easy_install "boto==1.4c"</pre>
</div>
<p>Once the file is uploaded, your users will be able to access it directly without you needing to download it again every time it is requested, because it has a publicly accessible URL. You can visit a file uploaded with the previous code at <a class="reference external" href="http://s3.amazonaws.com/pylonsbook/foobar">http://s3.amazonaws.com/pylonsbook/foobar</a>.</p>
<p>Amazon S3 also allows you to store metadata about files you upload. As long as you don’t need to be able to search this metadata, you might find Amazon S3 provides all the tools you need for your particular application. Here’s how you would set some metadata associated with the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">k</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s">&#39;meta1&#39;</span><span class="p">,</span> <span class="s">&#39;This is the first metadata value&#39;</span><span class="p">)</span>
<span class="n">k</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s">&#39;meta2&#39;</span><span class="p">,</span> <span class="s">&#39;This is the second metadata value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-553">This code associates two metadata key/value pairs with the key <tt class="docutils literal"><span class="pre">k</span></tt>. To retrieve those values later, you’d use this code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">k</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s">&#39;meta1&#39;</span><span class="p">)</span>
<span class="go">&#39;This is the first metadata value&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">k</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s">&#39;meta2&#39;</span><span class="p">)</span>
<span class="go">&#39;This is the second metadata value&#39;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-554">To test this example, you would need to sign up for an Amazon web services account and replace the example values <tt class="docutils literal"><span class="pre">&lt;aws</span> <span class="pre">access</span> <span class="pre">key&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;aws</span> <span class="pre">secret</span> <span class="pre">key&gt;</span></tt> with your real Amazon keys. You will be charged for any data you store on Amazon, although for a simple test like this, the charge is very low. Just remember to delete your data if you don’t want to be continually charged for its storage each month.</p>
</div>
</div>
<div class="section" id="exploring-database-approaches">
<h2>Exploring Database Approaches<a class="headerlink" href="#exploring-database-approaches" title="Permalink to this headline">¶</a></h2>
<p id="index-555">Storing data structures in files or via third-party storage solutions clearly isn’t the right approach for all data storage needs. Often the key requirement is to be able to search or select related sets of information. In that case, a database is a sensible way to go.</p>
<p>I’ll discuss the different types of databases you can use in your Pylons application.</p>
<div class="section" id="object-databases">
<h3>Object Databases<a class="headerlink" href="#object-databases" title="Permalink to this headline">¶</a></h3>
<p id="index-556">If most of the data in your Pylons applications is in the form of classes, one very sensible way of storing that data is in an <em>object database</em>. An object database looks like a Python dictionary that is automatically saved to disk. You can store strings, numbers, dates, class instances, or even nested dictionaries and lists to create arbitrarily deep data structures. Compared to a regular Python dictionary, you have to call a few extra commands to open the database and commit changes, but reading/setting values works exactly like the normal Python operations. This avoids the complexity of converting a Python data structure to a non-Python medium (XML or RDBMS tables), and it allows you to quickly prototype a model because you can easily change and extend it.</p>
<p id="index-557">Two object databases are available for Python: Durus and ZODB. Durus is smaller and simpler, while ZODB is the database used in large Zope applications. Durus is recommended only for databases with fewer than 1 million records.</p>
<p id="index-558">Durus and ZODB can store only “pickleable” data types, in other words, those that can be serialized with Python’s <tt class="docutils literal"><span class="pre">pickle</span></tt> module. This includes all the standard data types including lists and dictionaries and instances of classes defined at the top level of their module. It does not include objects tied to external resources (an open file object or a database connection) or classes defined inside another class or inside a function. The Python standard library lists exactly which types can be pickled; see <a class="reference external" href="http://docs.python.org/lib/node317.html">http://docs.python.org/lib/node317.html</a>. Some users choose to store only built-in Python types (for example, dicts instead of class instances) to guarantee the data can always be unpickled on any Python system.</p>
<p>Both Durus and ZODB have a “persistent” class. Any object subclassing this will be saved and loaded separately rather than with its parent object.</p>
<p id="index-559">The main disadvantage of object databases is that all searching is done in Python code, in <tt class="docutils literal"><span class="pre">for</span></tt> loops you write, while an RDBMS such as PostgreSQL has heavily optimized C routines for searching very quickly and with low memory overhead. Depending on the nature of your data and the types of searches you do, an RDBMS may or may not have a significant performance advantage. If you are considering using an object database, you should weigh this against the programming convenience of using the familiar and flexible Python types an object database provides.</p>
<p id="index-560">Some users unfamiliar with object databases wonder how stable they are. Of course, this is a question you should ask about any database engine before trusting your data to it. Durus and ZODB use an append-only strategy with a simple filesystem layout to minimize the possibility of errors. Rather than overwriting objects, new versions are simply appended to the end of the file, and the old versions are abandoned. Backing up the data is a simple matter of copying the file. If the latest transaction at the end of the file gets corrupted or incompletely written, Durus and ZODB will simply truncate the file to return to the state that existed before the last transaction. Periodically the administrator runs a “pack” operation to rewrite the file without the abandoned sections, shrinking the file size.</p>
<p id="index-561">Since the majority of Pylons developers use an RDBMS for their model, documentation on using ZODB or Durus is very thin. If an object database is an approach you’d like to consider, then these links might help:</p>
<dl class="docutils">
<dt><em>Durus</em></dt>
<dd><a class="reference external" href="http://www.mems-exchange.org/software/durus/">http://www.mems-exchange.org/software/durus/</a>, <a class="reference external" href="http://sluggo.scrapping.cc/python/pylons/pylons-durus.html">http://sluggo.scrapping.cc/python/pylons/pylons-durus.html</a></dd>
<dt><em>ZODB</em></dt>
<dd><a class="reference external" href="http://pypi.python.org/pypi/ZODB3">http://pypi.python.org/pypi/ZODB3</a>, <a class="reference external" href="http://en.wikipedia.org/wiki/ZODB">http://en.wikipedia.org/wiki/ZODB</a> (links to tutorials)</dd>
</dl>
</div>
<div class="section" id="xml-databases">
<h3>XML Databases<a class="headerlink" href="#xml-databases" title="Permalink to this headline">¶</a></h3>
<p id="index-562">XML databases use XML documents as the unit of data they store and manipulate. If your Pylons application uses a lot of XML, it might make sense to store that information directly as XML in an XML database rather than storing it in another type of database. The following are the advantages of this approach:</p>
<blockquote>
<ul class="simple">
<li>You don’t need to do any conversion between the data store and the document format your application uses.</li>
<li>You can use query languages such as XPath and XQuery to quickly perform searches on documents in an optimized way.</li>
</ul>
</blockquote>
<p id="index-563">Two XML databases you can use with Pylons are eXist and Berkeley DB XML:</p>
<dl class="docutils">
<dt><em>eXist XML database</em> (<a class="reference external" href="http://exist.sourceforge.net/">http://exist.sourceforge.net/</a>):</dt>
<dd>The eXist server is written in Java but has XML-RPC and REST-style HTTP APIs that can be used from a Pylons application. Some parts of the main <tt class="docutils literal"><span class="pre">pylonshq.com</span></tt> web site currently use an eXist back end.</dd>
</dl>
<dl class="docutils" id="index-564">
<dt><em>Oracle Berkeley DB XML</em> (<a class="reference external" href="http://www.oracle.com/database/berkeley-db/xml/index.html">http://www.oracle.com/database/berkeley-db/xml/index.html</a>):</dt>
<dd>This is an open source, embeddable XML database with XQuery-based access to documents stored in containers. DB XML has a Python binding that could be used to integrate it into a Pylons application. One thing to be aware of with DB XML is that the license would require that your Pylons application be released under the source license too unless you bought a commercial license from Oracle.</dd>
</dl>
</div>
<div class="section" id="relational-database-management-systems">
<h3>Relational Database Management Systems<a class="headerlink" href="#relational-database-management-systems" title="Permalink to this headline">¶</a></h3>
<p id="index-565">Despite the advantages of object databases and XML databases for certain situations, the vast majority of people choose to use an RDBMS for the data persistence layer of their applications. Most of the time when people refer to a database, they mean an RDBMS such as MySQL, PostgreSQL, and many others. In the relational model, data and relationships can be represented in tables, rows, and columns that are defined and manipulated using a special language called Structured Query Language (SQL; pronounced “sequel”).</p>
<p>RDBMSs can be used in small, personal applications or in huge, multinational projects. Although the basic principles of how to use an RDBMS remain broadly the same in both cases, you will need a much greater understanding of how relational database management systems actually work in order to use them effectively in larger-scale projects because issues such as replication, failover, and partitioning become more important. These topics are beyond the scope of this book, but if you are interested, plenty of information is available online and in specialist books.</p>
</div>
<div class="section" id="object-relational-mappers">
<h3>Object-Relational Mappers<a class="headerlink" href="#object-relational-mappers" title="Permalink to this headline">¶</a></h3>
<p id="index-566">Object-relational mappers (ORMs) are tools that map the data structures in your database, namely, the rows in each table to objects in your Pylons application. As you manipulate the objects in the application, they automatically generate the SQL necessary to manipulate the underlying data.</p>
<p>Using an object-relational mapper has a number of advantages:</p>
<blockquote>
<ul class="simple">
<li>They make it much easier and more convenient to work with the underlying data.</li>
<li>Your Pylons application will work on any of the database engines supported by the object-relational mapper you use.</li>
<li>They usually deal with some of the complications such as connection pools and thread safety for you.</li>
<li>They’re often easier to learn for newcomers than learning SQL.</li>
</ul>
</blockquote>
<p>Although object-relational mappers have major advantages, they are not without their weaknesses:</p>
<blockquote>
<ul class="simple">
<li>By abstracting away the SQL, you generally have less control over the database than you would have had. Tools such as SQLAlchemy make up for this by also providing you with raw SQL access for the occasions when it is needed.</li>
<li>If you don’t understand how object-relational mappers work, it is easy to write inefficient code that requires many SQL statements to be executed. (Careful reading of this chapter should prevent that problem, though.)</li>
<li>Object-relational mappers can sometimes contain quite complex code that is necessary to make the interfaces they expose so easy to use. This means that if you run into a problem, it can be hard to track it down in the source code. By choosing a popular ORM such as SQLAlchemy, the chances are that there are a very few bugs, and any you find are likely to be dealt with quickly by the community.</li>
</ul>
</blockquote>
<p>Overall then, the benefits of object-relational mappers outweigh their disadvantages for the vast majority of Pylons developers.</p>
<p id="index-567">Quite a few object-relational mappers are available for Python:</p>
<blockquote>
<ul class="simple">
<li>SQLAlchemy (<a class="reference external" href="http://sqlalchemy.org/">http://sqlalchemy.org</a>) is a modern object-relational mapper and Python SQL toolkit with powerful features, excellent documentation and support, and a full-featured API. It provides a full suite of well-known enterprise-level persistence patterns, is designed for efficient and high-performing database access and exposes a simple and Pythonic API.</li>
</ul>
<ul class="simple" id="index-568">
<li>Storm (<a class="reference external" href="https://storm.canonical.com/">https://storm.canonical.com/</a>) is a new object-relational mapper from Canonical, the company behind Ubuntu Linux. It is simpler than SQLAlchemy with thorough unit tests. Storm is particularly designed to feel very natural to Python programmers and exposes multiple databases as stores in a clean and easy-to-use fashion.</li>
</ul>
<ul class="simple" id="index-569">
<li>SQLObject (<a class="reference external" href="http://sqlobject.org/">http://sqlobject.org</a>) is a popular object-relational mapper for providing an object interface to your database, with tables as classes, rows as instances, and columns as attributes. SQLObject is fairly old now, and although it is still used in TurboGears 1 and some other older frameworks, most users now choose SQLAlchemy instead.</li>
</ul>
</blockquote>
<p id="index-570">By far the most popular tool for use as a model in a Pylons application is SQLAlchemy, and with good reason. It is a very powerful tool that handles the vast majority of cases you are ever likely to need, has a large and helpful community behind it, and has extensive and accurate documentation. That’s not to say it is always the right tool for the job, and as you’ve seen so far in this chapter, Pylons is flexible enough to work with many different tools as a model. For the majority of cases, SQLAlchemy is a really good choice.</p>
</div>
</div>
<div class="section" id="setting-up-sqlalchemy">
<h2>Setting Up SQLAlchemy<a class="headerlink" href="#setting-up-sqlalchemy" title="Permalink to this headline">¶</a></h2>
<p id="index-571">In this section, you’ll look at everything you need to install and set up in order to use SQLAlchemy.</p>
<p>SQLAlchemy relies on various DB-API 2.0 drivers to handle the actual connections to the RDBMS software. Before you can use SQLAlchemy in earnest, you need to download and install the DB-API 2.0 driver for the RDBMS software you want to use. Not all RDBMSs have a Python DB-API 2.0 driver, and not all Python DB-API drivers can be used with SQLAlchemy.</p>
<p id="index-572">Table 7-1 outlines the major RDBMSs used by Pylons developers and the Python driver you need in order to be able to use them from Pylons. Other drivers are available for these RDBMSs, but at the time of writing, these are the drivers supported by SQLAlchemy.</p>
<p>It is worth noting that if you are using Python 2.5 or newer, you don’t need to install <tt class="docutils literal"><span class="pre">pysqlite</span></tt>, because it is already included as part of the Python standard library.</p>
<table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">RDBMS Engine</th>
<th class="head">Python DB-API 2.0 Driver</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>PostgreSQL <a class="reference external" href="http://postgreql.org/">http://postgreql.org</a></td>
<td><tt class="docutils literal"><span class="pre">psycopg2</span></tt> <a class="reference external" href="http://initd.org/projects/psycopg2">http://initd.org/projects/psycopg2</a></td>
</tr>
<tr><td>MySQL <a class="reference external" href="http://mysql.org/">http://mysql.org</a></td>
<td><tt class="docutils literal"><span class="pre">MySQLdb</span></tt> module packaged as <tt class="docutils literal"><span class="pre">mysql-python</span></tt> <a class="reference external" href="http://sourceforge.net/projects/mysql-python">http://sourceforge.net/projects/mysql-python</a></td>
</tr>
<tr><td>SQLite <a class="reference external" href="http://sqlite.org/">http://sqlite.org</a></td>
<td><tt class="docutils literal"><span class="pre">pysqlite</span></tt> <a class="reference external" href="http://initd.org/tracker/pysqlite">http://initd.org/tracker/pysqlite</a></td>
</tr>
<tr><td>Oracle   <a class="reference external" href="http://www.oracle.com/technology/products/database/oracle10g/index.html">http://www.oracle.com/technology/products/database/oracle10g/index.html</a></td>
<td><tt class="docutils literal"><span class="pre">cx_Oracle</span></tt> <a class="reference external" href="http://www.python.net/crew/atuining/cx_Oracle/">http://www.python.net/crew/atuining/cx_Oracle/</a></td>
</tr>
<tr><td>Microsoft SQL Server   <a class="reference external" href="http://microsoft.com/sql/default.aspx">http://microsoft.com/sql/default.aspx</a></td>
<td><tt class="docutils literal"><span class="pre">pyodbc</span></tt> (recommended), <tt class="docutils literal"><span class="pre">adodbapi</span></tt>, or <tt class="docutils literal"><span class="pre">pymssql</span></tt> <a class="reference external" href="http://pyodbc.sourceforge.net/">http://pyodbc.sourceforge.net/</a></td>
</tr>
<tr><td>Firebird <a class="reference external" href="http://www.firebirdsql.org/">http://www.firebirdsql.org/</a></td>
<td><tt class="docutils literal"><span class="pre">kinterbasdb</span></tt> <a class="reference external" href="http://kinterbasdb.sourceforge.net/">http://kinterbasdb.sourceforge.net/</a></td>
</tr>
<tr><td>Informix   <a class="reference external" href="http://www.ibm.com/software/data/informix/">http://www.ibm.com/software/data/informix/</a></td>
<td><tt class="docutils literal"><span class="pre">informixdb</span></tt> <a class="reference external" href="http://informixdb.sourceforge.net/">http://informixdb.sourceforge.net/</a></td>
</tr>
</tbody>
</table>
<p>Table 7-1. Popular RDBMSs and the Corresponding DB-API Drivers</p>
<p id="index-573">If you are just looking to get started quickly, SQLite is a good choice. You can download the latest SQLite 3 binary for your platform from <a class="reference external" href="http://www.sqlite.org/download.html">http://www.sqlite.org/download.html</a>. Once you have installed it, you will be able to run the <tt class="docutils literal"><span class="pre">sqlite3</span></tt> command to get an interactive prompt:</p>
<div class="highlight-python"><pre>$ sqlite3
SQLite version 3.4.0
Enter ".help" for instructions
sqlite&gt;</pre>
</div>
<p>You can type <tt class="docutils literal"><span class="pre">.help</span></tt> for help or <tt class="docutils literal"><span class="pre">.quit</span></tt> to quit.</p>
<p id="index-574">I’ll use SQLite for the examples because it is so easy to set up, but you could equally well use any of the systems in Table 7-1. SQLite also has the advantage that the Python modules it needs are already included with Python 2.5 and newer.</p>
<div class="section" id="installing-the-db-api-driver">
<h3>Installing the DB-API Driver<a class="headerlink" href="#installing-the-db-api-driver" title="Permalink to this headline">¶</a></h3>
<p id="index-575">Once you have installed, configured, and started the RDBMS you want to use, you need to install the appropriate DB-API 2.0 driver. In the case of SQLite, this is very easy because the software is automatically included with Python 2.5 or newer. If you are using Python 2.4 or older, you will need to install the driver in the same way you would for any RDBMS.</p>
<p id="index-576">The driver you will need for your RDBMS is listed in Table 7-1 along with the URL where you can obtain it. Most Pylons-related software is available on the Python Package Index and can be installed with the <tt class="docutils literal"><span class="pre">easy_install</span></tt> command, but if you are not running on Windows, it is usually necessary to have a build environment set up with the Python development package and appropriate client library for the RDBMS you want to use already installed so that <tt class="docutils literal"><span class="pre">easy_install</span></tt> can compile the C or C++ libraries it needs to compile. For example, with MySQL, you might run this:</p>
<div class="highlight-python"><pre>$ easy_install mysql-python</pre>
</div>
<p id="index-577">This would download the source for the <tt class="docutils literal"><span class="pre">MySQLdb</span></tt> module (this is a rare example when the package name is significantly different from the module name) and compile it. To compile it successfully, you will need the client library. For example, on Debian Etch, you would need to install the <tt class="docutils literal"><span class="pre">libmysqlclient15-dev</span></tt> package and the <tt class="docutils literal"><span class="pre">python-dev</span></tt> package.</p>
<p>Most commonly used software that isn’t on the Python Package Index will be available through your platform’s software repository. For example, versions of <tt class="docutils literal"><span class="pre">MySQLdb</span></tt> are available for Windows that you can install with its installer, and <tt class="docutils literal"><span class="pre">MySQLdb</span></tt> is available through the repositories for Debian, Ubuntu, Fedora, and other platforms. Mac OS X users can typically download a binary for the version of their operating system too.</p>
<p>If you are compiling a driver from source, it is always a good idea to read the software’s <tt class="docutils literal"><span class="pre">README</span></tt> or <tt class="docutils literal"><span class="pre">INSTALL</span></tt> files and to follow the instructions carefully. Bear in mind that you might need to use an older compiler than the one that comes with your platform.</p>
<p>Although installing a Python database driver sounds like it might be difficult, in practice it is normally easy because you can usually find a binary version.</p>
<p id="index-578">If you are following along using SQLite and are using Python 2.4 or older, let’s install <tt class="docutils literal"><span class="pre">pysqlite2</span></tt>:</p>
<div class="highlight-python"><pre>$ easy_install pysqlite</pre>
</div>
<p id="index-579">This installs the <tt class="docutils literal"><span class="pre">pysqlite2</span></tt> module to use in your application, but note that the package name is <tt class="docutils literal"><span class="pre">pysqlite</span></tt> even though you need to import <tt class="docutils literal"><span class="pre">pysqlite2</span></tt> to use the module.</p>
</div>
<div class="section" id="installing-sqlalchemy">
<h3>Installing SQLAlchemy<a class="headerlink" href="#installing-sqlalchemy" title="Permalink to this headline">¶</a></h3>
<p id="index-580">Installing SQLAlchemy is easy. You simply specify the version you require with Easy Install, and it will be downloaded and installed for you. At the time of this writing, the latest version is 0.5, so the examples in this book are likely to work with any version above 0.5 and below 0.6. It is always wise to read the release notes for each new version, though:</p>
<div class="highlight-python"><pre>$ easy_install "SQLAlchemy&gt;=0.5,&lt;=0.5.99"</pre>
</div>
<p>If you want to ensure that your application uses only the version of SQLAlchemy you tested your application on, you should specify the version explicitly:</p>
<div class="highlight-python"><pre>$ easy_install "SQLAlchemy==0.5.0"</pre>
</div>
</div>
<div class="section" id="creating-a-database">
<h3>Creating a Database<a class="headerlink" href="#creating-a-database" title="Permalink to this headline">¶</a></h3>
<p id="index-581">Now that you have the RDBMS software up and running, an appropriate DB-API driver, and SQLAlchemy itself, you will want to create a database.</p>
<p>Creating a database on the command line with SQLite is a simply a matter of connecting to it. The database is created if it doesn’t already exist:</p>
<div class="highlight-python"><pre>$ sqlite3 test.db</pre>
</div>
<p>You don’t actually need to create a database on the command line with SQLlite because a database will automatically be created for you when you connect from SQLAlchemy.</p>
<p>With other databases, things are a little more complex. PostgreSQL uses the <tt class="docutils literal"><span class="pre">createdb</span></tt> command, and MySQL uses a <tt class="docutils literal"><span class="pre">CREATE</span> <span class="pre">DATABASE</span></tt> SQL statement. Refer to your RDBMS documentation for the correct approach.</p>
<p id="index-582">With everything in place, let’s take a look at SQLAlchemy’s architecture.</p>
</div>
</div>
<div class="section" id="exploring-sqlalchemy-s-architecture">
<h2>Exploring SQLAlchemy’s Architecture<a class="headerlink" href="#exploring-sqlalchemy-s-architecture" title="Permalink to this headline">¶</a></h2>
<p id="index-583">SQLAlchemy’s architecture contains a complete set of APIs, each representing one aspect of what is actually going on. Conceptually you can think of these APIs in three layers, each building on top of the previous one:</p>
<div class="figure">
<img alt="_images/9349f0701.png" src="_images/9349f0701.png" />
</div>
<p id="index-584">The abstraction layer consists of the SQL Expression API and the Metadata and Type APIs, which help isolate your Python code from the details of the underlying database engine. SQLAlchemy also includes a Declarative API, which you&#8217;ll learn about later in this chapter.</p>
<p>You’ll learn about each of these components in this chapter and see many of the key ways in which they are used.</p>
<div class="section" id="engine-api">
<h3>Engine API<a class="headerlink" href="#engine-api" title="Permalink to this headline">¶</a></h3>
<p id="index-585">The lowest-level API you are likely to use is the Engine API. This represents a low-level abstraction of a database engine, allowing you to use the same API to create connections to different RDBMSs for sending SQL statements and for retrieving results.</p>
<p id="index-586">In this section, I’ll show an example of how you might use an engine to directly execute some SQL. Let’s test this example using SQLite. Create a file called <tt class="docutils literal"><span class="pre">engine_test.py</span></tt> with the following content:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CREATE TABLE users (</span>
<span class="sd">        username VARCHAR PRIMARY KEY,</span>
<span class="sd">        password VARCHAR NOT NULL</span>
<span class="sd">    );</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INSERT INTO users (username, password) VALUES (?, ?);</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span>
<span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select username from users&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;username:&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-587">To work with an engine, you need to have a connection to it. The <tt class="docutils literal"><span class="pre">connection</span></tt> in the example is an instance of a SQLAlchemy <tt class="docutils literal"><span class="pre">Connection</span></tt> object, and <tt class="docutils literal"><span class="pre">result</span></tt> is a SQLAlchemy <tt class="docutils literal"><span class="pre">ResultProxy</span></tt> object  (very much like a DB-API cursor) that allows you to iterate over the results of the statement you have executed.</p>
<p>If you run this example, you’ll see the following output:</p>
<div class="highlight-python"><pre>username: foo</pre>
</div>
<p id="index-588">When using <tt class="docutils literal"><span class="pre">create_engine()</span></tt>, you can specify different data source names (DSNs) to connect to different databases. For example, with SQLite, you can use <tt class="docutils literal"><span class="pre">sqlite:///relative/path</span></tt> to specify a file relative to the current working directory. You can use <tt class="docutils literal"><span class="pre">sqlite:////absolute/path</span></tt> to specify an absolute path. SQLite also has a memory mode that doesn’t use the filesystem at all and loses all its information when the program exits. This can be very useful for testing. To use it, specify <tt class="docutils literal"><span class="pre">sqlite:///:memory:</span></tt> as the argument to <tt class="docutils literal"><span class="pre">create_engine()</span></tt>. The <tt class="docutils literal"><span class="pre">create_engine()</span></tt> function can also be used in a similar way with other RDBMSs. For example, to connect to the database <tt class="docutils literal"><span class="pre">my_database</span></tt> on a MySQL server at <tt class="docutils literal"><span class="pre">some.domain.com</span></tt> with the username <tt class="docutils literal"><span class="pre">foo</span></tt> and the password <tt class="docutils literal"><span class="pre">bar</span></tt>, you could use <tt class="docutils literal"><span class="pre">mysql://foo:bar&#64;some.domain.com/my_database</span></tt> .</p>
<p>You’ll also notice that the values you inserted were passed as separate arguments to <tt class="docutils literal"><span class="pre">connection.execute()</span></tt> rather than as part of the SQL string. This is so that the values can be automatically encoded to the correct SQL types, which helps avoid the risk of <em>SQL injection attacks</em>, something you’ll learn more about later in the chapter.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Different databases use different markers (known as <em>param styles</em>) to label where the variables you pass to <tt class="docutils literal"><span class="pre">execute()</span></tt> should be inserted. The example above used SQLite which uses <tt class="docutils literal"><span class="pre">?</span></tt> as the param style but if you tried to use MySQL or PostgreSQL you would need to use <tt class="docutils literal"><span class="pre">%s</span></tt> as the param style instead. The SQL would then look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INSERT INTO users (username, password) VALUES (%s, %s);</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p class="last">Using <tt class="docutils literal"><span class="pre">&quot;&quot;&quot;</span></tt> characters to mark the begining and end of the SQL allows you to use <tt class="docutils literal"><span class="pre">&quot;</span></tt> and <tt class="docutils literal"><span class="pre">'</span></tt> characters as part of the SQL and also allows you to add line breaks if your SQL statements get very long.</p>
</div>
<p>Notice also that you were able to access the username column using dictionary-like access to the <tt class="docutils literal"><span class="pre">row</span></tt> object. This is a feature of the SQLAlchemy <tt class="docutils literal"><span class="pre">ResultProxy</span></tt> object that was returned.</p>
<p>SQLAlchemy engines have a number of features over and above the Python DB-API connections you might be used to, not least the ability to automatically use pools of connections. Here’s a representation of the structure:</p>
<div class="figure">
<img alt="_images/9349f0702.png" src="_images/9349f0702.png" />
</div>
<p id="index-589">Let&#8217;s look at each part of this diagram. You&#8217;ve already seen how to use a connection to execute SQL statements and retrieve results, and you&#8217;ve seen how to create an engine object to represent the particular database you want to connect to within the underlying RDBMS. You also know that SQLAlchemy uses the underlying DB-API 2.0 driver behind the scenes to communicate with the RDBMS, so let&#8217;s look at dialects and pools.</p>
<p>Instances of <tt class="docutils literal"><span class="pre">Dialect</span></tt> objects tell SQLAlchemy how to deal with the subtleties of the different implementations of the DB-API 2.0 drivers to make some of SQLAlchemy’s internal code a little simpler, but you wouldn’t usually interact with them directly.</p>
<p id="index-590">Pools, on the other hand, are more interesting. Aside from SQLite, most RDBMSs run as servers that the client connects to over a network. Each request that comes to the server and that needs to interact with a database will need its own database connection. Creating a connection can often be quite a costly exercise, and if you have a lot of requests, you will need to open and close lots of connections, which could impact the performance of your application. One solution to this problem is to have SQLAlchemy manage a pool of connections for you. When Pylons loads, SQLAlchemy can make a number of DB-API 2.0 connections to the underlying RDBMS and keep them open. When your application calls <tt class="docutils literal"><span class="pre">engine.connect()</span></tt> to obtain a connection, SQLAlchemy can return one of the connections from the pool rather than creating a new one. When you close the SQLAlchemy connection, it can return the DB-API connection to the pool ready to be used again the next time you call <tt class="docutils literal"><span class="pre">engine.connect()</span></tt>. This enables you to write your Pylons application in the same way you would if you were creating and closing lots of connections but have SQLAlchemy reuse connections from its internal pool.</p>
<p>You can configure pool options as arguments to the <tt class="docutils literal"><span class="pre">create_engine()</span></tt> function:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">pool_size</span></tt></dt>
<dd>The number of connections to keep open inside the connection pool.</dd>
<dt><tt class="docutils literal"><span class="pre">pool_recycle</span></tt></dt>
<dd>The length of time to keep connections open before recycling them. If not specified, the connections will stay open forever. This should be specified for MySQL in particular because servers typically close connections after eight hours, resulting in a “MySQL server has gone away” error.</dd>
<dt><tt class="docutils literal"><span class="pre">pool_timeout</span></tt></dt>
<dd>The number of seconds to wait before giving up on getting a connection from the pool.</dd>
</dl>
<p>Connection pools can quickly become quite complex, so if you are interested in using them, you should read the SQLAlchemy documentation for further information:</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="http://www.sqlalchemy.org/docs/05/dbengine.html#dbengine_options">http://www.sqlalchemy.org/docs/05/dbengine.html#dbengine_options</a></li>
<li><a class="reference external" href="http://www.sqlalchemy.org/docs/05/pooling.html">http://www.sqlalchemy.org/docs/05/pooling.html</a></li>
</ul>
</blockquote>
<p>In the following sections, you’ll learn about other APIs you can use with SQLAlchemy including the Metadata, SQL Expression, and Object-Relational APIs. These APIs abstract away the engine and connections so that you don’t need to work with them directly. Behind the scenes, they will all use connections and engines to perform their work, so it is useful to understand how they work and, in particular, to know how to create engines with the appropriate options.</p>
<p>The flipside of this is that SQLAlchemy engines will work without any of the other SQLAlchemy infrastructure being in place so that even if you want to work directly with SQL rather than using the rest of SQLAlchemy’s powerful feature set, it makes sense to use an SQLAlchemy connection rather than a DB-API connection so that you get all of SQLAlchemy’s other benefits such as connection pools and result proxies.</p>
<p id="index-591">You can find full information about engines and connections as well as threading implications in the excellent SQLAlchemy engine documentation at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/dbengine.html">http://www.sqlalchemy.org/docs/05/dbengine.html</a>.</p>
</div>
<div class="section" id="metadata-and-type-apis">
<h3>Metadata and Type APIs<a class="headerlink" href="#metadata-and-type-apis" title="Permalink to this headline">¶</a></h3>
<p id="index-592">Now that you’ve seen how the Engine API has abstracted how SQL queries are executed and how results are returned, you can turn your attention to how SQLAlchemy abstracts the tables and other schema-level objects of the database itself. It does this with database <em>metadata</em>.</p>
<p>To represent the various different data types that table columns can store, SQLAlchemy uses its <em>types system</em>. Together the types system and metadata can completely describe the database schema in an RDBMS-independent manner.</p>
<p id="index-593">The following is part of a table to store information about a page. Add this code to a new file called <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">schema</span><span class="p">,</span> <span class="n">types</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>

<span class="n">page_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;Untitled Page&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here you’ve created a <tt class="docutils literal"><span class="pre">metadata</span></tt> object from <tt class="docutils literal"><span class="pre">schema.MetaData</span></tt>, which will hold all the information about the tables, columns, types, foreign keys, indexes, and sequences that make up the database structure. You’ll see more about how these are used later in the chapter.</p>
<p>You’ve then created a <tt class="docutils literal"><span class="pre">schema.Table</span></tt> object to describe the <tt class="docutils literal"><span class="pre">page</span></tt> table and passed it the <tt class="docutils literal"><span class="pre">metadata</span></tt> object. This is so that the table object can add information about the table to the <tt class="docutils literal"><span class="pre">metadata</span></tt> object. SQLAlchemy is then able to access the table information via the <tt class="docutils literal"><span class="pre">metadata</span></tt> object. Add the following to the end of the <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt> file too:</p>
<div class="highlight-python"><pre>for t in metadata.sorted_tables
    print "Table name: ", t.name
    print "t is page_table: ", t is page_table</pre>
</div>
<p>If you run this example, you will see the following output:</p>
<div class="highlight-python"><pre>$ python metadata_test.py
Table name:  page
t is page_table: True</pre>
</div>
<p id="index-594">As you can see, the <tt class="docutils literal"><span class="pre">metadata</span></tt> object contains information about the tables, and the table object assigned to <tt class="docutils literal"><span class="pre">t</span></tt> in this example is the same as the <tt class="docutils literal"><span class="pre">page_table</span></tt> object.</p>
<p id="index-595">Each of the columns that makes up the tables has its own type. SQLAlchemy supports the following built-in types:</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">String</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Unicode</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Text</span></tt>/<tt class="docutils literal"><span class="pre">UnicodeText</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Numeric</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Float</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Datetime</span></tt>/<tt class="docutils literal"><span class="pre">Date</span></tt>/<tt class="docutils literal"><span class="pre">Time</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Interval</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Binary</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Boolean</span></tt></li>
</ul>
</blockquote>
<p id="index-596">In addition to the types listed here, there is a <tt class="docutils literal"><span class="pre">PickleType</span></tt> that is based on SQLAlchemy’s <tt class="docutils literal"><span class="pre">Binary</span></tt> type. <tt class="docutils literal"><span class="pre">PickleType</span></tt> uses Python’s <tt class="docutils literal"><span class="pre">pickle.dumps()</span></tt> to “pickle” objects being saved to the database, and it uses <tt class="docutils literal"><span class="pre">pickle.loads()</span></tt> to unpickle objects being retrieved. It therefore allows you to store any pickleable Python object as a serialized binary field. The same rules about which Python objects can be pickled apply whether you are using the <tt class="docutils literal"><span class="pre">PickleType</span></tt> field with SQLAlchemy or whether you are using an object database such as Durus or ZODB. Have a look at the Python documentation at <a class="reference external" href="http://docs.python.org/lib/node317.html">http://docs.python.org/lib/node317.html</a> for more information.</p>
<p>SQLAlchemy also supports some dialect-specific types to handle columns that occur only in particular databases. You can even create your own types if you need to do so. For full information, look at the SQLAlchemy types documentation at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/types.html">http://www.sqlalchemy.org/docs/05/types.html</a>.</p>
<p id="index-597">You can get information about the columns used in a table via the table’s <tt class="docutils literal"><span class="pre">.columns</span></tt> attribute. Add the following to the end of the <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt> example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">page_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Column Table name: &quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span>
</pre></div>
</div>
<p>If you run it again, you’ll see this output including the column information:</p>
<div class="highlight-python"><pre>$ python metadata_test.py
Table name:  page
t is page_table: True
Column:  Integer()
Column:  Unicode(length=255)
Column:  Unicode(length=255)
Column:  Text(length=None, convert_unicode=False, assert_unicode=None)</pre>
</div>
<p>At this stage, the <tt class="docutils literal"><span class="pre">metadata</span></tt> is just information; it doesn’t relate to any properties of a real database. To connect the metadata to a real database, you need to bind the <tt class="docutils literal"><span class="pre">metadata</span></tt> object to an engine.</p>
<p>Add the following to the end of the <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt> example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>
</pre></div>
</div>
<p>At this point, the metadata is connected to the database via the engine. Once again, I’ve chosen to use an in-memory SQLite database for the example, but you are free to use different parameters to <tt class="docutils literal"><span class="pre">create_engine()</span></tt> if you prefer.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p id="index-598">It is worth being aware that you can have SQLAlchemy automatically convert all string types to handle Unicode automatically if you set up the engine like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">,</span> <span class="n">convert_unicode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">In this book, you will instead use the <tt class="docutils literal"><span class="pre">Unicode</span></tt> type explicitly when you want to work with Unicode strings, but some Pylons developers prefer to take this shortcut.</p>
</div>
<p id="index-599">SQLAlchemy now has enough information to allow you to start manipulating the database with the SQL Expression API, but the <tt class="docutils literal"><span class="pre">metadata</span></tt> object has a few more tricks. If the tables described by the metadata don’t actually exist in the database, the <tt class="docutils literal"><span class="pre">metadata</span></tt> object can be used to create them. Add this line to the end of the <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">checkfirst=True</span></tt> argument means it will create the table only if it doesn’t already exist.</p>
<p>You’ll notice that you didn’t need a connection in order to create the tables. This is because the <tt class="docutils literal"><span class="pre">metadata</span></tt> object creates and closes a connection automatically from the engine.</p>
<p>If tables exist in the database that have not yet been defined in the <tt class="docutils literal"><span class="pre">metadata</span></tt> object, you can have SQLAlchemy automatically reflect the information like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">comment_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>There are plenty of other things you can do to specify information about the schema. The following are all supported:</p>
<blockquote>
<ul class="simple">
<li>Overriding some of the metadata for columns obtained by reflection</li>
<li>Specifying the schema name for databases that support the concept of multiple schemas</li>
<li>Cascading updates and deletes for databases supporting them</li>
<li>Handling database-specific options such as MySQL’s table back ends including <tt class="docutils literal"><span class="pre">InnoDB</span></tt> or <tt class="docutils literal"><span class="pre">MyISAM</span></tt></li>
<li>Default values</li>
<li>Dropping tables</li>
<li>Adding constraints, indexes, sequences, and more</li>
</ul>
</blockquote>
<p id="index-600">These are all described in detail at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/metadata.html">http://www.sqlalchemy.org/docs/05/metadata.html</a>.</p>
</div>
<div class="section" id="sql-expression-api">
<h3>SQL Expression API<a class="headerlink" href="#sql-expression-api" title="Permalink to this headline">¶</a></h3>
<p id="index-601">Once you have set up all the database metadata, SQLAlchemy has all the information it needs for you to be able to use its SQL Expression API.</p>
<p>The SQL Expression API enables you to build SQL queries programmatically using Python objects and operators. This can take a lot of the pain out of SQL because you don’t have to worry about converting Python values to safe SQL strings.</p>
<p id="index-602">Let’s create a new file called <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt> and add the following to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">metadata_test</span> <span class="kn">import</span> <span class="n">engine</span><span class="p">,</span> <span class="n">page_table</span>
</pre></div>
</div>
<p>You can now use the <tt class="docutils literal"><span class="pre">page</span></tt> table to perform simple operations. Here’s how you might perform a simple insert operation. Add the following to <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt> too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">SQL Expression Example</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="n">ins</span> <span class="o">=</span> <span class="n">page_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;test&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">u&#39;Test Page&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">u&#39;Some content!&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">print</span> <span class="n">ins</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
<span class="k">print</span> <span class="n">result</span>

<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run this example, the output from <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt> will be displayed first because you imported that file; then it will be followed by the output from <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt>, which looks like this:</p>
<div class="highlight-python"><pre>SQL Expression Example

INSERT INTO page (name, title, content) VALUES (?, ?, ?)
&lt;sqlalchemy.engine.base.ResultProxy object at 0x58c3f0&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">ins</span></tt> object automatically generates the correct SQL to insert the values specified, and an instance of a <tt class="docutils literal"><span class="pre">ResultProxy</span></tt> object (which you saw in the Engine API description) is returned to allow you to iterate over the results. Since this is an insert statement, there won’t be any interesting values returned.</p>
<p id="index-603">As an alternative, you could have written the same code like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">SQL Expression Example</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="n">ins</span> <span class="o">=</span> <span class="n">page_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;test&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">u&#39;Test Page&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">u&#39;Some content!&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">print</span> <span class="n">ins</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ins</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="k">print</span> <span class="n">result</span>
</pre></div>
</div>
<p>In this case, the opening/closing of the connection is handled by the <tt class="docutils literal"><span class="pre">metadata</span></tt> object associated with the <tt class="docutils literal"><span class="pre">page_table</span></tt> object. It is usually better to execute SQL Expression objects like <tt class="docutils literal"><span class="pre">ins</span></tt> via <tt class="docutils literal"><span class="pre">connection.execute()</span></tt> so that you always know precisely which connection is being used. This becomes particularly important when you are using the Object-Relational API within Pylons with a scoped session when you probably want to use the connection used by the session rather than letting the <tt class="docutils literal"><span class="pre">metadata</span></tt> object create a connection for you. You’ll see how this works in Chapter 8.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last" id="index-604">Because you are still using a SQLite in-memory database, each time this code is run, the database is created, the table is created, and the data is inserted. Once the code is executed, everything is lost so that when the code is run again, no errors occur. If you were to use a permanent database, you would need to drop the <tt class="docutils literal"><span class="pre">page</span></tt> table before rerunning the code.</p>
</div>
<div class="section" id="sql-injection-attacks">
<h4>SQL Injection Attacks<a class="headerlink" href="#sql-injection-attacks" title="Permalink to this headline">¶</a></h4>
<p id="index-605">The most important point about the <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt> code is that SQLAlchemy handles any type conversion of the values you specified to <tt class="docutils literal"><span class="pre">insert()</span></tt> using its types system. This is important because if you build the SQL strings yourself using values that a user has submitted, there is a chance you might not perform the conversions quite correctly. This can expose your application to a particular type of attack called a <em>SQL injection attack</em>.</p>
<p>As an example, consider this action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This is really BAD, don&#39;t do it!</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO page (name, title) VALUES (&#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;Page added&quot;</span>
</pre></div>
</div>
<p>If the user submits the values <tt class="docutils literal"><span class="pre">NewPage</span></tt> for the <tt class="docutils literal"><span class="pre">name</span></tt> variable and <tt class="docutils literal"><span class="pre">New</span> <span class="pre">Page</span></tt> for the <tt class="docutils literal"><span class="pre">title</span></tt>, everything works perfectly well. An attacker might instead submit the values <tt class="docutils literal"><span class="pre">NewPage</span></tt> and <tt class="docutils literal"><span class="pre">New</span> <span class="pre">Page');</span> <span class="pre">DROP</span> <span class="pre">TABLE</span> <span class="pre">page;</span> <span class="pre">--</span></tt>. At first sight this just looks very odd, but consider the SQL string your application now builds; it actually looks like this:</p>
<div class="highlight-python"><pre>INSERT INTO page (name, title) VALUES ('NewPage', 'NewPage'); DROP TABLE page; --')</pre>
</div>
<p>In SQL, <tt class="docutils literal"><span class="pre">--</span></tt> comments out the rest of the line, so the following statements would be executed without a syntax error, dropping the <tt class="docutils literal"><span class="pre">page</span></tt> table and removing all its data:</p>
<div class="highlight-python"><pre>INSERT INTO page (name, title) VALUES ('NewPage', 'NewPage');
DROP TABLE page;</pre>
</div>
<p id="index-606">This clearly isn’t what you wanted, which is why it is so important to let SQLAlchemy handle conversions for you using the SQL Expression API rather than writing SQL strings yourself, because the variables would have been correctly escaped and the page would just have had a very odd-looking title.</p>
</div>
<div class="section" id="selecting-results">
<h4>Selecting Results<a class="headerlink" href="#selecting-results" title="Permalink to this headline">¶</a></h4>
<p id="index-607">Here’s a simple select statement that explicitly uses the connection object from the engine. Add it to the end of the <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt> file before the <tt class="docutils literal"><span class="pre">connection.close()</span></tt> line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Selecting Results</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">page_table</span><span class="p">])</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">row</span>
</pre></div>
</div>
<p id="index-608">Before you test this example, it is useful to know about SQLAlchemy’s <tt class="docutils literal"><span class="pre">echo</span></tt> option, which tells the <tt class="docutils literal"><span class="pre">engine</span></tt> object to log all the SQL it executes to <tt class="docutils literal"><span class="pre">sys.stdout</span></tt> so you can see what SQLAlchemy is doing behind the scenes. Edit <tt class="docutils literal"><span class="pre">metadata_test.py</span></tt>, and add <tt class="docutils literal"><span class="pre">echo=True</span></tt> to the <tt class="docutils literal"><span class="pre">create_engine()</span></tt> function so it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Now when you run the example, you’ll be able to see the SQL <tt class="docutils literal"><span class="pre">SELECT</span></tt> statement SQLAlchemy will actually use without needing to manually add <tt class="docutils literal"><span class="pre">print</span></tt> statements. This can be useful when running test scripts to try different aspects of SQLAlchemy’s functionality but shouldn’t be enabled when you are using Pylons, because depending on the server and logging configuration you are using, it might result in messages going either to the error log or being sent to the browser. Instead, you can use Pylons’ logging system to log SQLAlchemy messages in a much more structured way. This is described in Chapter 20.</p>
<p>If you run this example now, you will see the following at the end of the output:</p>
<div class="highlight-python"><pre>Selecting Results

2008-09-04 16:01:22,294 INFO sqlalchemy.engine.base.Engine.0x..90 SELECT page.id, page.name, page.title, page.content
FROM page
2008-09-04 16:01:22,294 INFO sqlalchemy.engine.base.Engine.0x..90 []
(1, u'test', u'Test Page',  u'Some content!')</pre>
</div>
<p>As you can see, this results in the SQL statement <tt class="docutils literal"><span class="pre">SELECT</span> <span class="pre">page.id,</span> <span class="pre">page.name,</span> <span class="pre">page.title,</span> <span class="pre">page.content</span> <span class="pre">FROM</span> <span class="pre">page</span></tt> being executed.</p>
<p id="index-609">You can also specify <tt class="docutils literal"><span class="pre">WHERE</span></tt> clauses using a similar construct. For example, to specify pages that have an <tt class="docutils literal"><span class="pre">id</span></tt> greater than 1, you would write this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">page_table</span><span class="p">],</span> <span class="n">page_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">id</span><span class="o">&gt;</span><span class="mf">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>
</div>
<p>You’ll remember from the the “Metadata and Type APIs” section earlier in the chapter that table objects have a <tt class="docutils literal"><span class="pre">.columns</span></tt> attribute. The object returned contains a <tt class="docutils literal"><span class="pre">Column</span></tt> instance for each column in the table and these can be accessed as attributes based on the column name. In the example the <tt class="docutils literal"><span class="pre">id</span></tt> column can therefore be accessed as <tt class="docutils literal"><span class="pre">page_table.columns.id</span></tt>. SQLAlchemy knows how the standard Python operators should interact with the column objects to generate the appropriate SQL.</p>
<p>If you added this to the example, the extra output printed as a result of setting <tt class="docutils literal"><span class="pre">echo=True</span></tt> would be as follows:</p>
<div class="highlight-python"><pre>2008-09-04 16:16:10,891 INFO sqlalchemy.engine.base.Engine.0x..b0 SELECT page.id, page.name, page.title, page.content
FROM page
WHERE page.id &gt; ?
2008-09-04 16:16:10,891 INFO sqlalchemy.engine.base.Engine.0x..b0 [1]
[]</pre>
</div>
<p>As you can see, the SQL <tt class="docutils literal"><span class="pre">WHERE</span> <span class="pre">page.id</span> <span class="pre">&gt;</span> <span class="pre">?</span></tt> has been added to the query, and the <tt class="docutils literal"><span class="pre">[1]</span></tt> shows that the value <tt class="docutils literal"><span class="pre">1</span></tt> will be substituted into the query in place of the <tt class="docutils literal"><span class="pre">?</span></tt> character to execute the correct query.</p>
<p id="index-610">Once again, a <tt class="docutils literal"><span class="pre">ResultProxy</span></tt> object is returned, but this time you use its <tt class="docutils literal"><span class="pre">fetchall()</span></tt> method to return all the results in one go. Since there is only one page and its <tt class="docutils literal"><span class="pre">id</span></tt> is not greater than 1, there are no results, so an empty list is returned. The <tt class="docutils literal"><span class="pre">ResultProxy</span></tt> object also has <tt class="docutils literal"><span class="pre">fetchone()</span></tt> and <tt class="docutils literal"><span class="pre">fetchmany()</span></tt>, which are similar to their DB-API 2.0 counterparts.</p>
<p id="index-611">If you have a complex <tt class="docutils literal"><span class="pre">WHERE</span></tt> clause, it can be cumbersome to keep typing <tt class="docutils literal"><span class="pre">page_table.columns</span></tt>, so SQLAlchemy also allows you to write <tt class="docutils literal"><span class="pre">page_table.c</span></tt>. The <tt class="docutils literal"><span class="pre">.c</span></tt> attribute is just an alias to the same object you access using <tt class="docutils literal"><span class="pre">.columns</span></tt> but is shorter to type.</p>
<p>SQLAlchemy overloads most of the Python operators for use in <tt class="docutils literal"><span class="pre">WHERE</span></tt> clauses so that they behave the way you would expect when used in SQL. You’ve seen how to use <tt class="docutils literal"><span class="pre">&gt;</span></tt> in the previous example, but the operators <tt class="docutils literal"><span class="pre">==</span></tt>, <tt class="docutils literal"><span class="pre">&lt;</span></tt>, <tt class="docutils literal"><span class="pre">&lt;=</span></tt>, <tt class="docutils literal"><span class="pre">&gt;=</span></tt>, and <tt class="docutils literal"><span class="pre">!=</span></tt> have similar results.</p>
<p id="index-612">SQLAlchemy also provides operators for <tt class="docutils literal"><span class="pre">AND</span></tt>, <tt class="docutils literal"><span class="pre">OR</span></tt>, and <tt class="docutils literal"><span class="pre">NOT</span></tt> in the form of the Python operators <tt class="docutils literal"><span class="pre">&amp;</span></tt>, <tt class="docutils literal"><span class="pre">|</span></tt>, and <tt class="docutils literal"><span class="pre">!</span></tt>. If you use these, you have to be careful to correctly add parentheses to all the expressions you are operating on because Python operator precedence is slightly different from that of SQL. Here’s an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">page_table</span><span class="p">],</span> <span class="p">(</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">&lt;=</span><span class="mf">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">u&#39;t%&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Notice that you were able to use a <tt class="docutils literal"><span class="pre">LIKE</span></tt> clause too as a method of the <tt class="docutils literal"><span class="pre">name</span></tt> column.</p>
<p>If you don’t want to use the <tt class="docutils literal"><span class="pre">&amp;</span></tt>, <tt class="docutils literal"><span class="pre">|</span></tt>, and <tt class="docutils literal"><span class="pre">!</span></tt> operators, SQLAlchemy also provides <tt class="docutils literal"><span class="pre">and_()</span></tt>, <tt class="docutils literal"><span class="pre">or_()</span></tt>, and <tt class="docutils literal"><span class="pre">not_()</span></tt> functions that you can use instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span> <span class="n">not_</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">page_table</span><span class="p">],</span> <span class="n">and_</span><span class="p">(</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">&lt;=</span><span class="mf">10</span><span class="p">,</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">u&#39;t%&#39;</span><span class="p">)))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>
</div>
<p>This has the same effect. If you add this to the end of the <tt class="docutils literal"><span class="pre">sqlexpression_test.py</span></tt> file before <tt class="docutils literal"><span class="pre">connection.close()</span></tt> and run the program, the corresponding output is as follows:</p>
<div class="highlight-python"><pre>2008-09-04 16:34:27,014 INFO sqlalchemy.engine.base.Engine.0x..b0 SELECT page.id, page.name, page.title, page.content
FROM page
WHERE page.id &lt;= ? AND page.name LIKE ?
2008-09-04 16:34:27,015 INFO sqlalchemy.engine.base.Engine.0x..b0 [10, u'%t']
[(1, u'test', u'Test Page', u'Some content!')]</pre>
</div>
<p id="index-613">As you can see, the <tt class="docutils literal"><span class="pre">WHERE</span></tt> clause has been generated correctly, and this time the values <tt class="docutils literal"><span class="pre">10</span></tt> and <tt class="docutils literal"><span class="pre">t%</span></tt> replace the two question marks in the SQL query. This time the query results in the row being returned again.</p>
<p id="index-614">One operator that behaves slightly differently from the others is the <tt class="docutils literal"><span class="pre">+</span></tt> operator. If <tt class="docutils literal"><span class="pre">+</span></tt> is operating on two strings, it generates the appropriate SQL for concatenation. If it operates on two integers, it produces the SQL to add them together:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span>
<span class="go">page.name || user.title</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">comment_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>
<span class="go">page.id + comment.id</span>
</pre></div>
</div>
<p id="index-615">The SQL builder assembles chunks of SQL, and printing them displays the SQL. Notice that it has correctly added the <tt class="docutils literal"><span class="pre">||</span></tt> operator, which causes the strings to be concatenated in most RDBMSs. MySQL is slightly different, though. It requires strings to be concatenated with the <tt class="docutils literal"><span class="pre">concat()</span></tt> function. SQLAlchemy even does the right thing with MySQL. On MySQL you get this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span>
<span class="go">concat(page.name, user.title)</span>
</pre></div>
</div>
<p id="index-616">Once you have generated a select object, you can still add extra clauses to it. For example, if you wanted to add an <tt class="docutils literal"><span class="pre">ORDER_BY</span></tt> clause, you could write this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">page_table</span><span class="p">],</span> <span class="n">and_</span><span class="p">(</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">&lt;=</span><span class="mf">10</span><span class="p">,</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">u&#39;t%&#39;</span><span class="p">)))</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>This would run the same query as before but order by <tt class="docutils literal"><span class="pre">title</span></tt> descending and then by <tt class="docutils literal"><span class="pre">id</span></tt>.</p>
<p>You can write update statements like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Updating Results</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">update</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">page_table</span><span class="p">,</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">==</span><span class="s">u&#39;New Title&#39;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Updated Title&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-617">If you add the previous to the <tt class="docutils literal"><span class="pre">sqlexpressions_test.py</span></tt> file before <tt class="docutils literal"><span class="pre">connection.close()</span></tt> and execute it again, the corresponding <tt class="docutils literal"><span class="pre">UPDATE</span></tt> statement looks like this:</p>
<div class="highlight-python"><pre>Updating Results

2008-09-04 17:00:58,673 INFO sqlalchemy.engine.base.Engine.0x..d0 UPDATE page SET title=? WHERE page.title = ?
2008-09-04 17:00:58,673 INFO sqlalchemy.engine.base.Engine.0x..d0 [u'Updated Title', u'New Title']
2008-09-04 17:00:58,674 INFO sqlalchemy.engine.base.Engine.0x..d0 COMMIT</pre>
</div>
<p>Notice that SQLAlchemy automatically sent a <tt class="docutils literal"><span class="pre">COMMIT</span></tt> message to save the changes.</p>
<p id="index-618">Finally, let’s look at deleting rows. The pattern should be getting very familiar now. You can write delete statements like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Deleting Row</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">delete</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="n">page_table</span><span class="p">,</span> <span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="mf">1</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
<p>If you add the previous to the <tt class="docutils literal"><span class="pre">sqlexpressions_test.py</span></tt> file before <tt class="docutils literal"><span class="pre">connection.close()</span></tt> and execute it again, the corresponding <tt class="docutils literal"><span class="pre">DELETE</span></tt> statement looks like this:</p>
<div class="highlight-python"><pre>Deleting Row

2008-09-04 17:04:34,460 INFO sqlalchemy.engine.base.Engine.0x..f0 DELETE FROM page WHERE page.id = ?
2008-09-04 17:04:34,460 INFO sqlalchemy.engine.base.Engine.0x..f0 [1]
2008-09-04 17:04:34,461 INFO sqlalchemy.engine.base.Engine.0x..f0 COMMIT</pre>
</div>
<p id="index-619">The important thing to note about all these examples is that the code you write with the SQL Expression API will have the same effect on any of the RDBMSs that SQLAlchemy supports without you having to change any of your code. The only thing you need to change is the URI string to the <tt class="docutils literal"><span class="pre">create_engine()</span></tt> function. This automatic abstraction is a huge advantage if you are trying to write Pylons applications to work on multiple database back ends.</p>
<p>This has been a taste of the SQL Expression API, but there is a lot more too. It is extremely powerful, allowing you to do complex joins, aliases, group bys, functions, unions, other set operations and more, all through natural-feeling Python code based on information defined through the metadata in your tables and columns.</p>
<p id="index-620">Once again, the SQLAlchemy documentation is the best place to go to learn about all the features: <a class="reference external" href="http://www.sqlalchemy.org/docs/05/sqlexpression.html">http://www.sqlalchemy.org/docs/05/sqlexpression.html</a></p>
</div>
</div>
</div>
<div class="section" id="exploring-the-object-relational-api">
<h2>Exploring the Object-Relational API<a class="headerlink" href="#exploring-the-object-relational-api" title="Permalink to this headline">¶</a></h2>
<p id="index-621">The highest-level API SQLAlchemy provides is the Object-Relational API, which is the one you will spend the majority of your time using in your Pylons applications. The API allows you to work directly with Python objects without needing to think too much about the SQL that would normally be required to work with them.</p>
<p>Before you learn about the details of how the API works, I’ll cover some key concepts about relational databases.</p>
<div class="section" id="object-relational-principles">
<h3>Object-Relational Principles<a class="headerlink" href="#object-relational-principles" title="Permalink to this headline">¶</a></h3>
<p id="index-622">As you learned earlier in the chapter, object-relational mappers (ORMs) map rows from tables in relational databases to the objects used in your Pylons application.</p>
<p>The difficulty is that Python objects don’t always easily map to rows in tables. Before you look at SQLAlchemy’s Object-Relational API, let’s take a few moments for a very quick overview of the core ideas of relational databases that you need to know to use SQLAlchemy effectively.</p>
<p id="index-623">Let’s consider a wiki application that allows the creation of pages, has a comments system, and allows pages to be tagged. Each of the items mentioned in the previous sentence are known as <em>entities</em> in relational database terminology. They are the main things that exist in the real world. Ordinarily, each entity in the real world is represented by a table in the database, and each row in the table represents one instance of the entity. In our example, you would therefore need three tables: <tt class="docutils literal"><span class="pre">page</span></tt>, <tt class="docutils literal"><span class="pre">comment</span></tt>, and <tt class="docutils literal"><span class="pre">tag</span></tt>.</p>
<p id="index-624">Each row in each of the tables must have something unique about it that differentiates it from other rows in the table. In the case of wiki pages, this might be the page title or the URL of the page. A unique identifier of this type is called the <em>primary key</em> of the table. In the case of a wiki, you might choose to the use the page title as the primary key if each page title is different. This could cause a problem if the page title was able to change. To avoid this problem, all modern databases can assign an ID to a row automatically when the row is inserted into the table. By using an automatically assigned ID, you can be sure that all rows in a table have a different ID and that if any of the other properties change, the record will still be able to be accessed via a primary key lookup.</p>
<p id="index-625">If you are designing a database structure for use with SQLAlchemy, it is a good idea to add an <tt class="docutils literal"><span class="pre">id</span></tt> column to each table as a primary key. The rest of the examples in this book will use this approach.</p>
<p>Once the primary entities have been represented in tables with each row having a primary key, you need to think about how the different entities are related. There are three common ways they might be related:</p>
<dl class="docutils" id="index-626">
<dt><em>One to one</em></dt>
<dd>Data items in two tables both represent the same entity; it is just that you have chosen to store the fields in different tables. Most of the time, you will avoid one-to-one relationships because they are an indication that you might not have properly understood the key entities in your data structure.</dd>
</dl>
<dl class="docutils" id="index-627">
<dt><em>One to many</em></dt>
<dd>One entity has zero or more instances of another entity associated with it.</dd>
</dl>
<dl class="docutils" id="index-628">
<dt><em>Many to many</em></dt>
<dd>Zero or more instances of one entity are associated with zero or more instances of another entity.</dd>
</dl>
<p id="index-629">Thinking about entities and mappings can be a bit abstract, so I’ll show a wiki comments system as a concrete example.</p>
<p id="index-630">Each wiki page can have lots of different comments, but the same comment won’t appear on more than one page. This means there is a one-to-many mapping between pages and comments.</p>
<p id="index-631">The best way to represent a one-to-many mapping is by adding what is known as a <em>foreign key</em> to the <tt class="docutils literal"><span class="pre">comments</span></tt> table to store the <tt class="docutils literal"><span class="pre">id</span></tt> of the page to which the comment has been added. An appropriate name for the column to hold the foreign key might be <tt class="docutils literal"><span class="pre">pageid</span></tt>. This means that to find all the comments on, say, page 5, you would select all the comments in the <tt class="docutils literal"><span class="pre">comments</span></tt> table where <tt class="docutils literal"><span class="pre">pageid</span></tt> is 5.</p>
<p>So far so good. Now let’s think about the tags that are a little more complicated. Once again, pages can have multiple tags, but this time the same tag can also be used on multiple pages. You have a many-to-many relationship. This time the relationship can’t be modeled by adding a foreign key to the tag table because although this would allow you to work out the tags used on a particular page, it wouldn’t allow you to work out which pages used a particular tag unless you had duplicate tags in the <tt class="docutils literal"><span class="pre">tags</span></tt> table.</p>
<p>Creating duplicates of primary entities is often bad practice, so the only way to model the relationship between tags and pages is with a third table. We’ll call it <tt class="docutils literal"><span class="pre">pagetag</span></tt>. The <tt class="docutils literal"><span class="pre">pagetag</span></tt> table will have three columns, a foreign key to the <tt class="docutils literal"><span class="pre">page</span></tt> table, a foreign key to the <tt class="docutils literal"><span class="pre">tag</span></tt> table, and a primary key of its own. Here’s an example of the data the tables might contain:</p>
<div class="highlight-python"><pre>page table
+-----+------------------+-------------+---------------+
| id  | content          | posted      | title         |
+-----+------------------+-------------+---------------+
| 1   | When I was...    | 2007-05-08  | The Other Day |
| 2   | Databases are... | 2007-07-13  | Databases     |
+-----+------------------+-------------+---------------+

tag table
+-----+------------+-------------+
| id  | name       | created     |
+-----+------------+-------------+
| 1   | databases  | 2007-07-13  |
| 2   | life       | 2007-03-10  |
| 3   | fun        | 2007-04-28  |
| 4   | news       | 2008-03-30  |
+-----+------------+-------------+

pagetag table
+-----+-------+----------+
| id  | tagid | pageid   |
+-----+-------+----------+
| 1   | 1     | 2        |
| 2   | 2     | 1        |
| 3   | 3     | 1        |
| 4   | 3     | 2        |
+-----+-------+----------+</pre>
</div>
<p id="index-632">In this example, the tags <tt class="docutils literal"><span class="pre">databases</span></tt> and <tt class="docutils literal"><span class="pre">fun</span></tt> are associated with page 2, and <tt class="docutils literal"><span class="pre">life</span></tt> and <tt class="docutils literal"><span class="pre">fun</span></tt> are associated with page 1. Looking at the same data from the tags perspective, you can see that the <tt class="docutils literal"><span class="pre">fun</span></tt> tag is used on two pages, whereas the others are only associated with one page each. You can also see that the <tt class="docutils literal"><span class="pre">news</span></tt> tag hasn’t been used on any pages yet.</p>
<p>To find out the tag names associated with page 2, you would use a SQL <tt class="docutils literal"><span class="pre">JOIN</span></tt> to find all the rows in the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table with a <tt class="docutils literal"><span class="pre">pageid</span></tt> of 2 and then use the corresponding <tt class="docutils literal"><span class="pre">tagid</span></tt> to look up the name of the tag from the tag ID.</p>
<p>Writing SQL joins of this type isn’t complicated, but it can be time-consuming. Wouldn’t it be nice if you could just have a <tt class="docutils literal"><span class="pre">page</span></tt> object and get the tag names like this?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p id="index-633">This is precisely what you can do with SQLAlchemy’s Object-Relational API. In the next sections, you’ll look at how to set up the table, class, and mapper objects necessary to make this sort of API access possible.</p>
</div>
<div class="section" id="more-metadata">
<h3>More Metadata<a class="headerlink" href="#more-metadata" title="Permalink to this headline">¶</a></h3>
<p id="index-634">The first step toward setting up the Object-Relational API is to describe the database metadata. The Object-Relational API and the SQL expression language described earlier both use the same metadata. After all, both need to know how the database is structured in order to work. Let’s see how you would model the tables described earlier for the wiki system. Save the following in a file called <tt class="docutils literal"><span class="pre">model.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">schema</span><span class="p">,</span> <span class="n">types</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">page_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;page_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;posted&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;Untitled Page&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;heading&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">comment_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;comment_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">()),</span>
<span class="p">)</span>

<span class="n">pagetag_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;pagetag&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;pagetag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;tagid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;tag.id&#39;</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">tag_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
       <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;tag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p id="index-635">There are some features in this example you haven’t seen before:</p>
<blockquote>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">comment</span></tt> and <tt class="docutils literal"><span class="pre">pagetag</span></tt> tables use <tt class="docutils literal"><span class="pre">schema.ForeignKey()</span></tt> so that SQLAlchemy knows how the tables are related. Notice that the foreign keys are represented by a string in the format <tt class="docutils literal"><span class="pre">table.column</span></tt></li>
<li>The <tt class="docutils literal"><span class="pre">content</span></tt> column in the <tt class="docutils literal"><span class="pre">page</span></tt> table and the <tt class="docutils literal"><span class="pre">name</span></tt> column in the tag table are specified as <tt class="docutils literal"><span class="pre">nullable=false</span></tt>, which means SQLAlchemy will raise an exception if rows are inserted without values for those columns.</li>
<li>The <tt class="docutils literal"><span class="pre">id</span></tt> columns are all specified with <tt class="docutils literal"><span class="pre">primary_key=True</span></tt> so that SQLAlchemy knows to treat those columns as primary keys.</li>
</ul>
<ul class="simple" id="index-636">
<li>The primary key columns also specify an optional <tt class="docutils literal"><span class="pre">Sequence</span></tt> object. This allows SQLAlchemy to use sequences on databases that support them such as PostgreSQL and Oracle but to use autoincrementing fields on databases such as MySQL. If you haven’t come across sequences before, they are a bit like separate tables that keep track of the next available ID for a table. You don’t need to know about sequences to use SQLAlchemy; they are an advanced feature that SQLAlchemy can use if it is available, but your objects will behave in the same way whether or not sequences are used. See <a class="reference external" href="http://www.sqlalchemy.org/docs/05/documentation.html#metadata_defaults_sequences">http://www.sqlalchemy.org/docs/05/documentation.html#metadata_defaults_sequences</a> for more information.</li>
</ul>
<ul class="simple" id="index-637">
<li>The <tt class="docutils literal"><span class="pre">DateTime</span></tt> columns all have a default value of <tt class="docutils literal"><span class="pre">now</span></tt>. This means that if a value isn’t specified when a row is inserted, SQLAlchemy will call the <tt class="docutils literal"><span class="pre">now()</span></tt> function to generate a default value. The <tt class="docutils literal"><span class="pre">now()</span></tt> function is defined at the top and in turn uses the <tt class="docutils literal"><span class="pre">datetime</span></tt> module to get the current time. In this example, you could just have specified <tt class="docutils literal"><span class="pre">datetime.datetime.now</span></tt> as the default, but in other circumstances you will have to define your own function, so the example is written the way it is to demonstrate this.</li>
<li>The tag table’s <tt class="docutils literal"><span class="pre">name</span></tt> column uses <tt class="docutils literal"><span class="pre">unique=True</span></tt> to enforce the constraint that no two tags should have the same name.</li>
</ul>
</blockquote>
<p id="index-638">It is worth noting that although database-level constraints are useful to ensure data integrity, your Pylons application should be validating data it passes to the database using FormEncode to ensure it doesn’t break any database-level constraints. After all, an Internal Server Error page resulting from an exception raised by SQLAlchemy or the underlying engine won’t help your users know what was wrong. You’ll learn how to combine FormEncode and SQLAlchemy in a Pylons application in the next chapter.</p>
</div>
<div class="section" id="classes-and-mappers">
<h3>Classes and Mappers<a class="headerlink" href="#classes-and-mappers" title="Permalink to this headline">¶</a></h3>
<p id="index-639">Now that you have defined the table structures, turn your attention to the classes and mappers. Here’s what the <tt class="docutils literal"><span class="pre">Page</span></tt> class looks like; add it to the end of the <tt class="docutils literal"><span class="pre">model.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Similar classes would need to be created for comments and tags; add them to the end of <tt class="docutils literal"><span class="pre">model.py</span></tt> too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p id="index-640">Although I’ve chosen to create the classes you need without any extra methods, one popular way of setting up the classes is to have an <tt class="docutils literal"><span class="pre">__init__()</span></tt> method that takes arguments for each of the required fields in the table and sets them as class attributes. This setup helps you remember to always set all the required attributes because you can’t create objects without them.</p>
<p class="last">You might also like to add a customized <tt class="docutils literal"><span class="pre">__repr__()</span></tt> method to each of your classes that includes representations of key attributes such as the primary key. This can make it clearer which objects you are looking at if you interact with your model from the command line or via the Pylons interactive shell, which you’ll see used for testing in Chapter 12 and used to interact with your model in Chapter 19.</p>
</div>
<p id="index-641">So far, the <tt class="docutils literal"><span class="pre">Page</span></tt> class is still just a class and has nothing to do with the <tt class="docutils literal"><span class="pre">page</span></tt> table. To map the class to the table, you use a <em>mapper</em>. A simple mapper for <tt class="docutils literal"><span class="pre">Page</span></tt> might look like this (you’ll need a more complex one, though):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">mapper()</span></tt> function creates a new <tt class="docutils literal"><span class="pre">Mapper</span></tt> object and stores it away for future reference. It also adds the column names of the <tt class="docutils literal"><span class="pre">page</span></tt> table as attributes of the <tt class="docutils literal"><span class="pre">Page</span></tt> class so that class attributes correspond to table column names. SQLAlchemy keeps track of any changes to those attributes so the database can be automatically updated.</p>
<p>The <tt class="docutils literal"><span class="pre">Page</span></tt> class actually has a relationship to the <tt class="docutils literal"><span class="pre">comments</span></tt> table as well as the <tt class="docutils literal"><span class="pre">page</span></tt> table because pages can have multiple comments. You can specify this relationship like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p id="index-642">This tells SQLAlchemy that the <tt class="docutils literal"><span class="pre">Page</span></tt> class is mapped to the <tt class="docutils literal"><span class="pre">page_table</span></tt> table but that <tt class="docutils literal"><span class="pre">page</span></tt> objects should have an extra property called <tt class="docutils literal"><span class="pre">comments</span></tt>, which should return all the <tt class="docutils literal"><span class="pre">Comment</span></tt> objects related to that page when you read its <tt class="docutils literal"><span class="pre">.comments</span></tt> property. The <tt class="docutils literal"><span class="pre">relation()</span></tt> function also takes a <tt class="docutils literal"><span class="pre">backref</span></tt> argument, which means that all comment objects should also have a property named <tt class="docutils literal"><span class="pre">page</span></tt> that returns the page object to which a particular comment is related.</p>
<p>By using this single definition, you have therefore been able to define the relationship between pages and comments and also specify the properties on each, which will return instances of the other.</p>
<p>In fact, pages are related to tags as well as to comments, so you need a slightly more sophisticated call to <tt class="docutils literal"><span class="pre">orm.mapper()</span></tt>.</p>
<p>Add this import to the top of the <tt class="docutils literal"><span class="pre">model.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">orm</span>
</pre></div>
</div>
<p>Add this version of the mapper code to the end of <tt class="docutils literal"><span class="pre">model.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
   <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">),</span>
   <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p id="index-643">This is the same as the previous example but also specifies a <tt class="docutils literal"><span class="pre">tags</span></tt> property to relate the page to the tag objects associated with it. This call to <tt class="docutils literal"><span class="pre">relation()</span></tt> specifies a <em>secondary table</em>, <tt class="docutils literal"><span class="pre">pagetag_table</span></tt>, to be used to handle the many-to-many relationship between pages and tags. Once again, SQLAlchemy can work out the details from the metadata definitions of the tables and columns. All many-to-many relations should have the <tt class="docutils literal"><span class="pre">secondary</span></tt> argument to specify how the tables are related.</p>
<p id="index-644">Now that you’ve mapped the <tt class="docutils literal"><span class="pre">Page</span></tt> class, let’s look at the mappers for <tt class="docutils literal"><span class="pre">Tag</span></tt> and <tt class="docutils literal"><span class="pre">Comment</span></tt>. They look like this and are the last lines you’ll need to add to <tt class="docutils literal"><span class="pre">model.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">comment_table</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">tag_table</span><span class="p">)</span>
</pre></div>
</div>
<p>The mapper for <tt class="docutils literal"><span class="pre">Comment</span></tt> doesn’t need the <tt class="docutils literal"><span class="pre">page</span></tt> property specified because the mapper for <tt class="docutils literal"><span class="pre">Page</span></tt> has already specified it via the <tt class="docutils literal"><span class="pre">backref</span></tt>. The mapper for <tt class="docutils literal"><span class="pre">Tag</span></tt> doesn’t need to have the relation to <tt class="docutils literal"><span class="pre">Page</span></tt> specified because SQLAlchemy can already work it out via the <tt class="docutils literal"><span class="pre">secondary</span></tt> argument.</p>
<p>In this example, the <tt class="docutils literal"><span class="pre">Comment</span></tt> and <tt class="docutils literal"><span class="pre">Tag</span></tt> mappers actually need to be specified before the mapper for <tt class="docutils literal"><span class="pre">Page</span></tt> because the classes are used in the properties of the <tt class="docutils literal"><span class="pre">Page</span></tt> mapper. You sometimes have to think quite carefully about the order mappers are defined in order to be able to specify all the relationships correctly in Python code.</p>
<p>One point to note is that this setup doesn’t provide a way to get a list of pages that share one tag because you haven’t specified a backref on the <tt class="docutils literal"><span class="pre">tags</span></tt> property in the <tt class="docutils literal"><span class="pre">Page</span></tt> mapper, but you can always use a query if you need that information. When designing your mappers, there is a trade-off between adding relational structure to express an important structure or to simplify accessing data that is frequently used vs. the simplicity of using queries for things that might only occasionally be used.</p>
<p>Once again, SQLAlchemy has many more features than can be described here including lazy and eager loading, mapping to joins, and more. The SQLAlchemy documentation is very good and has all the details.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-645">When you are thinking about naming table columns, it is a strongly recommended that you don’t start any of the column names with <tt class="docutils literal"><span class="pre">_</span></tt>. SQLAlchemy adds certain objects to mapped class instances, and each of these starts with <tt class="docutils literal"><span class="pre">_</span></tt>, so you won’t want to create names that conflict with SQLAlchemy objects.</p>
</div>
</div>
<div class="section" id="understanding-the-session">
<h3>Understanding the Session<a class="headerlink" href="#understanding-the-session" title="Permalink to this headline">¶</a></h3>
<p id="index-646">There is one problem I haven’t discussed yet, and that is how SQLAlchemy manages objects in memory. After all, it wouldn’t be efficient for it to contact the database every time you accessed an attribute of an object. SQLAlchemy handles this problem by keeping track of objects in memory in what it calls a <em>session</em>.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-647">The SQLAlchemy session is completely unrelated to the Beaker session, which provides session management between requests using a cookie. It’s unfortunate that two different pieces of software chose the term <em>session</em> to mean completely different things.</p>
</div>
<p>SQLAlchemy provides different configuration options for the session depending on the type of application you are writing. You can read all about the various options in the SQLAlchemy documentation, but in this section you’ll use the same configuration options used by Pylons. You’ll also use the <tt class="docutils literal"><span class="pre">model.py</span></tt> you’ve just created.</p>
<p id="index-648">Create a new file called <tt class="docutils literal"><span class="pre">object_test.py</span></tt> in the same directory as <tt class="docutils literal"><span class="pre">model.py</span></tt>, and add the following content:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">model</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="c"># Create an engine and create all the tables we need</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>
<span class="n">model</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

<span class="c"># Set up the session</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">expire_on_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-649">Let’s look at this in detail. First you have a number of imports including the <tt class="docutils literal"><span class="pre">model</span></tt> module you created earlier. Next you create an engine as you’ve done before using the <tt class="docutils literal"><span class="pre">echo=True</span></tt> argument so that the SQL being generated behind the scenes gets output to the console (remember that you shouldn’t use this argument in a Pylons application and instead should use the logging technique described in Chapter 20). Finally, you get into the interesting part and create the session itself.</p>
<p id="index-650">In this example, the session is created in two parts. First you use a <tt class="docutils literal"><span class="pre">sessionmaker()</span></tt> function to return an object for building the particular type of session you want. To understand what the options mean, you need to know a little terminology. In SQLAlchemy, <em>flushing</em> is the process of updating the database with the changes made to the objects you have been working with, and <em>committing</em> is the process of sending a <tt class="docutils literal"><span class="pre">COMMIT</span></tt> statement to the database to make those flushes permanent. If you were to <em>roll back</em> some changes after they had been flushed but before the changes were committed, then the changes would be lost. With these definitions in mind, let’s look at the arguments.</p>
<p id="index-651">Let’s look at the arguments being used:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">bind=engine</span></tt></dt>
<dd>This ensures that the session is bound to the same engine to which the <tt class="docutils literal"><span class="pre">metadata</span></tt> object is bound. The session will automatically create the connections it needs.</dd>
<dt><tt class="docutils literal"><span class="pre">autoflush=True</span></tt></dt>
<dd>If you commit your changes to the database before they have been flushed, this option tells SQLAlchemy to flush them for you before the commit goes ahead. This ensures changes aren’t lost because you forgot to flush them.</dd>
<dt><tt class="docutils literal"><span class="pre">autocommit=False</span></tt></dt>
<dd>This tells SQLAlchemy to wrap all changes between commits in a transaction so that the commit and rollback behavior just described works correctly in RDBMSs that support this feature. If you specified <tt class="docutils literal"><span class="pre">autocommit=True</span></tt>, SQLAlchemy would automatically commit any changes after each flush, which normally isn’t what you want. If a problem happens halfway through a Pylons request, it is usually important that all uncommitted changes made up to that point are not saved so that the database isn’t left in a half-changed state. If you’ve used SQLAlchemy in earlier versions of Pylons such as 0.9.6, you may have noticed that the argument <tt class="docutils literal"><span class="pre">transactional=True</span></tt> was used. <tt class="docutils literal"><span class="pre">autocommit=False</span></tt> in SQLAlchemy 0.5 is the same as <tt class="docutils literal"><span class="pre">transactional=True</span></tt> in earlier versions, so the two arguments do the same thing.</dd>
<dt><tt class="docutils literal"><span class="pre">expire_on_commit=True</span></tt></dt>
<dd>This happens to be the default value anyway, but it means that all instances attached to the session will be fully expired after each commit so that all attribute/object access subsequent to a completed transaction will load from the most recent database state.</dd>
</dl>
<p id="index-652">The second part of the session creation code is the call to <tt class="docutils literal"><span class="pre">scoped_session()</span></tt>. As you’ve already learned, Pylons is a multithreaded framework. If you were to use an ordinary SQLAlchemy session in Pylons, different requests would change the session at the same time, which would result in some users seeing other people’s data, other users not seeing data they’d entered, and frequent application crashes. The <tt class="docutils literal"><span class="pre">scoped_session()</span></tt> object ensures that a different session is used for each thread so that every request can have its own access to the database. Although you don’t need this to run the test examples in this chapter, you will need to understand it to work with SQLAlchemy in a Pylons application, so it is worth learning the details now.</p>
</div>
<div class="section" id="exploring-the-session">
<h3>Exploring the Session<a class="headerlink" href="#exploring-the-session" title="Permalink to this headline">¶</a></h3>
<p id="index-653">Now that you’ve seen how the session is configured, let’s run through some examples of how it is used and see the effects the configuration options chosen actually have. For this part of the chapter, I’ll use an interactive Python prompt to execute commands so that you can see when SQLAlchemy actually generates the SQL. Start a prompt in the same directory where you’ve been writing the modules:</p>
<div class="highlight-python"><pre>$ python
Python 2.5.1 (r251:54863, Apr 15 2008, 22:57:26)
[GCC 4.0.1 (Apple Inc. build 5465)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt;</pre>
</div>
<p>Now import the <tt class="docutils literal"><span class="pre">session</span></tt> object from the <tt class="docutils literal"><span class="pre">object_test</span></tt> module you just created:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">object_test</span> <span class="kn">import</span> <span class="n">session</span>
</pre></div>
</div>
<p>A load of output will fly by as SQLAlchemy sets up the tables. Now let’s start by importing the <tt class="docutils literal"><span class="pre">model</span></tt> module and creating a new page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">u&#39;Test Page&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;Test content&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;Test Page&#39;</span>
</pre></div>
</div>
<p id="index-654">The first step toward persisting the <tt class="docutils literal"><span class="pre">test_page</span></tt> object is adding it to the session so that SQLAlchemy is aware of it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test_page</span><span class="p">)</span>
</pre></div>
</div>
<p>If you were creating lots of pages at once, you could use <tt class="docutils literal"><span class="pre">session.add_all([test_page1,</span> <span class="pre">test_page2,</span> <span class="pre">test_page3])</span></tt> instead. SQLAlchemy 0.4 used session.save() instead but session.add() is the correct method to use for SQLAlchemy 0.5 and above.</p>
<p id="index-655">At this stage, objects added to the session are still <em>pending</em>, and no SQL has been issued or echoed to the console. Let’s see what happens when you access the <tt class="docutils literal"><span class="pre">test_page</span></tt> object’s <tt class="docutils literal"><span class="pre">.id</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">test_page</span><span class="o">.</span><span class="n">id</span>
<span class="go">None</span>
</pre></div>
</div>
<p>As you can see, it returns <tt class="xref docutils literal"><span class="pre">None</span></tt>. You’ll remember from the table definition that <tt class="docutils literal"><span class="pre">id</span></tt> is the page table’s primary key column and that an <tt class="docutils literal"><span class="pre">id</span></tt> value is automatically assigned by the underlying RDBMS when the row is created. At this stage, although <tt class="docutils literal"><span class="pre">test_page</span></tt> has been added to the session, its data hasn’t been sent to the underlying RDBMS. You can force this to happen by <em>flushing</em> the session. Once the session has been flushed, the SQL is sent, and SQLAlchemy finds out the <tt class="docutils literal"><span class="pre">id</span></tt> of the page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="go">2008-09-04 20:53:55,191 INFO sqlalchemy.engine.base.Engine.0x..90 BEGIN</span>
<span class="go">2008-09-04 20:53:55,193 INFO sqlalchemy.engine.base.Engine.0x..90 INSERT INTO page (content, posted, title, heading) VALUES (?, ?, ?, ?)</span>
<span class="go">2008-09-04 20:53:55,194 INFO sqlalchemy.engine.base.Engine.0x..90 [u&#39;Test content&#39;, &#39;2008-09-04 20:53:55.193033&#39;, u&#39;Test Page&#39;, None]</span>
</pre></div>
</div>
<p id="index-656">As you can see, SQLAlchemy has now sent the <tt class="docutils literal"><span class="pre">INSERT</span></tt> statement to the SQLite database, but the interesting thing is that it also sent the SQL keyword <tt class="docutils literal"><span class="pre">BEGIN</span></tt> before it sent the <tt class="docutils literal"><span class="pre">INSERT</span></tt> statement. This starts a transaction within the RDBMS so that any changes can still be rolled back until they are committed. It also means that the changes won’t yet be visible to other users.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Some RDBMSs don’t support transactions and therefore cannot roll back data or hide it from other users after it has been flushed. MySQL’s default MyISAM tables don’t support transactions, so if you need this functionality, you should use InnoDB tables instead. If you are using MySQL, you can specify this by adding <tt class="docutils literal"><span class="pre">mysql_engine='InnoDB'</span></tt> to your <tt class="docutils literal"><span class="pre">Table</span></tt> classes. See <a class="reference external" href="http://www.sqlalchemy.org/docs/05/documentation.html#metadata_tables_options">http://www.sqlalchemy.org/docs/05/documentation.html#metadata_tables_options</a> for more information.</p>
</div>
<p id="index-657">Let’s see whether the <tt class="docutils literal"><span class="pre">test_page</span></tt> has an <tt class="docutils literal"><span class="pre">id</span></tt> now that the test page has been flushed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
</pre></div>
</div>
<p>As you can see, <tt class="docutils literal"><span class="pre">id</span></tt> has now been assigned. Notice that SQLAlchemy didn’t need to query the database again to tell you. Now let’s commit the changes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">2008-09-04 20:54:13,189 INFO sqlalchemy.engine.base.Engine.0x..90 COMMIT</span>
</pre></div>
</div>
<p>SQLAlchemy sends the <tt class="docutils literal"><span class="pre">COMMIT</span></tt> statement that permanently commits the flushed changes and ends the transaction.</p>
<p>Let’s access the test page’s <tt class="docutils literal"><span class="pre">id</span></tt> again and see what happens:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">id</span>
<span class="go">2008-09-04 21:08:19,024 INFO sqlalchemy.engine.base.Engine.0x..30 BEGIN</span>
<span class="go">2008-09-04 21:08:19,027 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.id = ?</span>
<span class="go">2008-09-04 21:08:19,027 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="go">1</span>
</pre></div>
</div>
<p>This time, SQLAlchemy reads the data from the database again. This might surprise you, but if you look back at the session creation code, you’ll recall that the <tt class="docutils literal"><span class="pre">expire_on_commit</span></tt> option was set to <tt class="xref docutils literal"><span class="pre">True</span></tt>, causing SQLAlchemy to automatically expire all objects attached to the session. Notice that SQLAlchemy actually fetched all the attributes, not just the <tt class="docutils literal"><span class="pre">id</span></tt>. If you access the <tt class="docutils literal"><span class="pre">id</span></tt> or any of the page’s other attributes, they will now be loaded from the session without access to the database:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;Test Page&#39;</span>
</pre></div>
</div>
<p id="index-658">The default values for the columns will also have been applied, so you can now also access the page’s <tt class="docutils literal"><span class="pre">posted</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">posted</span>
<span class="go">datetime.datetime(2008, 9, 4, 21, 3, 34, 975799)</span>
</pre></div>
</div>
<p>Let’s now delete this object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">test_page</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-659">Once again, no SQL is sent until you flush the session:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="go">008-09-04 21:39:13,247 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT comment.id AS comment_id, comment.pageid AS comment_pageid, comment.content AS comment_content, comment.name AS comment_name, comment.email AS comment_email, comment.created AS comment_created</span>
<span class="go">FROM comment</span>
<span class="go">WHERE ? = comment.pageid</span>
<span class="go">2008-09-04 21:39:13,248 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="go">2008-09-04 21:39:13,255 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT tag.id AS tag_id, tag.name AS tag_name</span>
<span class="go">FROM tag, pagetag</span>
<span class="go">WHERE ? = pagetag.pageid AND tag.id = pagetag.tagid</span>
<span class="go">2008-09-04 21:39:13,255 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="go">2008-09-04 21:39:13,258 INFO sqlalchemy.engine.base.Engine.0x..30 DELETE FROM page WHERE page.id = ?</span>
<span class="go">2008-09-04 21:39:13,258 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
</pre></div>
</div>
<p>As you can see, quite a few SQL statements are sent. SQLAlchemy is checking to ensure that there aren’t any comments or tags associated with the page you are deleting.</p>
<p id="index-660">At this stage, you could commit the changes, but this time let’s try a rollback:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="go">2008-09-04 21:41:42,989 INFO sqlalchemy.engine.base.Engine.0x..30 ROLLBACK</span>
</pre></div>
</div>
<p id="index-661">SQLAlchemy sends a <tt class="docutils literal"><span class="pre">ROLLBACK</span></tt> statement, causing the RDBMS to undo the changes. It is now as if the delete never happened. Once again, you can try to access the test page’s <tt class="docutils literal"><span class="pre">id</span></tt>. Once again, SQLAlchemy fetches the data from the database because the old session was automatically expired after the rollback:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">id</span>
<span class="go">2008-09-04 21:40:30,281 INFO sqlalchemy.engine.base.Engine.0x...55cc BEGIN</span>
<span class="go">2008-09-04 21:40:30,282 INFO sqlalchemy.engine.base.Engine.0x...55cc SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.id = ?</span>
<span class="go">2008-09-04 21:40:30,283 INFO sqlalchemy.engine.base.Engine.0x...55cc [1]</span>
<span class="go">1</span>
</pre></div>
</div>
<p>As you can see, the page clearly still exists, so the rollback was successful. Of course, if you exit the Python interactive prompt, all the data will be lost because you are still using an in-memory database, so don’t be surprised if the row is not there if you fire up another Python interactive shell.</p>
<p>You should now have a good understanding of the inner working of the session in the same configuration as you would find in a Pylons application, but there is one complication you haven’t yet dealt with. How do you use the SQL Expression API in the same transaction as a particular session?</p>
<p id="index-662">Start a new Python interactive prompt, and type the following to set up the tables and session and create a <tt class="docutils literal"><span class="pre">test_page</span></tt> object as before:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">object_test</span> <span class="kn">import</span> <span class="n">session</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">u&#39;Test Page&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;Test content&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">test_page</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="go">2008-09-04 21:59:29,852 INFO sqlalchemy.engine.base.Engine.0x..30 BEGIN</span>
<span class="go">2008-09-04 21:59:29,854 INFO sqlalchemy.engine.base.Engine.0x..30</span>
<span class="go">INSERT INTO page (content, posted, title, heading) VALUES (?, ?, ?, ?)</span>
<span class="go">2008-09-04 21:59:29,855 INFO sqlalchemy.engine.base.Engine.0x..30</span>
<span class="go">[u&#39;Test content&#39;, &#39;2008-09-04 21:59:29.854464&#39;, u&#39;Test Page&#39;, None]</span>
</pre></div>
</div>
<p id="index-663">I’ve already discussed all the output from this code, so I’ll just say that at this point a transaction has been started and the test page has been flushed to the database within that transaction.</p>
<p id="index-664">Now let’s write a SQL expression to select that row from the database, even though the changes haven’t been committed. The only way you can do this is if you make sure you use the same transaction as the session. The session has an <tt class="docutils literal"><span class="pre">execute()</span></tt> method for precisely this purpose. Let’s see it in action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">page_table</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="go">2008-09-04 21:59:29,868 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id, page.content, page.posted, page.title, page.heading</span>
<span class="go">FROM page</span>
<span class="go">2008-09-04 21:59:29,868 INFO sqlalchemy.engine.base.Engine.0x..30 []</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="go">[(1, u&#39;Test content&#39;, datetime.datetime(2008, 9, 4, 21, 59, 29, 854464), u&#39;Test Page&#39;, None)]</span>
</pre></div>
</div>
<p>Using <tt class="docutils literal"><span class="pre">session.execute()</span></tt> ensures that the same connection (and hence the same transaction) is used by both the session and the SQL expression object <tt class="docutils literal"><span class="pre">s</span></tt>. For this reason, it is always best to use <tt class="docutils literal"><span class="pre">session.execute()</span></tt> when working with SQL expressions in Pylons rather than creating a separate connection via the engine metadata.</p>
<p id="index-665">Now that you’ve seen how to create objects and how to use the session to save their data to their corresponding tables, it’s time to look at how to query the database to get data back out using the Object-Relational API instead of the SQL Expression API. Commit the page that has just been flushed, and you will continue the example as you look at queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-666">In a Pylons application, if you don’t call <tt class="docutils literal"><span class="pre">session.commit()</span></tt>, any changes you make will be discarded at the end of the request.</p>
</div>
<div class="section" id="queries">
<h3>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h3>
<p id="index-667">All SQLAlchemy Object-Relational API queries are performed with query objects that are created from the session. The simplest way to create and use a query object is like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page_q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_q</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span>
<span class="gp">...</span>
<span class="go">2008-09-04 22:13:03,885 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">2008-09-04 22:13:03,885 INFO sqlalchemy.engine.base.Engine.0x..30 []</span>
<span class="go">Test Page</span>
</pre></div>
</div>
<p>In this example, you have iterated over every page in the database, and SQLAlchemy has created a <tt class="docutils literal"><span class="pre">page</span></tt> object for each so that you can access its <tt class="docutils literal"><span class="pre">.id</span></tt> attribute and print its title. You can see the SQL used and that the title of the test page, being the only page in the database at the moment, is correctly printed.</p>
<p>Let’s take a closer look at some of the properties of the query object. You can use the same query object more than once, so let’s use its <tt class="docutils literal"><span class="pre">all()</span></tt> method to get all the pages in one go as a list of <tt class="docutils literal"><span class="pre">Page</span></tt> objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page_q</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;model.Page object at 0x72670&gt;]</span>
</pre></div>
</div>
<p>Query objects also have a <tt class="docutils literal"><span class="pre">one()</span></tt> method that returns just one object, raising an exception if there are zero or more than one results. Another useful method on query objects is <tt class="docutils literal"><span class="pre">first()</span></tt>, which returns the first result or <tt class="xref docutils literal"><span class="pre">None</span></tt> if there are no results, again the log output isn&#8217;t included:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;Test Page&#39;</span>
</pre></div>
</div>
<p>Query objects also allow you to set a <tt class="docutils literal"><span class="pre">LIMIT</span></tt> and <tt class="docutils literal"><span class="pre">OFFSET</span></tt> by treating the query object as a list that can be sliced. For example, to retrieve results only from 2 to 5, you would write this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page_q</span><span class="p">[</span><span class="mf">2</span><span class="p">:</span><span class="mf">5</span><span class="p">]</span>
<span class="go">2008-09-04 22:23:49,556 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go"> LIMIT 3 OFFSET 2</span>
<span class="go">2008-09-04 22:23:49,556 INFO sqlalchemy.engine.base.Engine.0x..30 []</span>
<span class="go">[]</span>
</pre></div>
</div>
<p id="index-668">Of course, you have only one page, so this returns an empty list, but you can see from the logged SQL that <tt class="docutils literal"><span class="pre">LIMIT</span></tt> and <tt class="docutils literal"><span class="pre">OFFSET</span></tt> were applied correctly.</p>
<p>Most of the time, you will want to be more specific about the results you return. SQLAlchemy allows you to do this in a number of ways. First, if you know the primary key of the row you are looking for, you can use the page query’s <tt class="docutils literal"><span class="pre">get()</span></tt> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="go">&lt;model.Page object at 0x72670&gt;</span>
</pre></div>
</div>
<p id="index-669">Notice this time that SQLAlchemy didn’t need to send any SQL to retrieve this object because it was already in the session from the queries you have already run. Query objects also have <tt class="docutils literal"><span class="pre">filter()</span></tt> and <tt class="docutils literal"><span class="pre">filter_by()</span></tt> methods. Both are similar, but <tt class="docutils literal"><span class="pre">filter()</span></tt> takes an expression of the type you saw earlier, whereas <tt class="docutils literal"><span class="pre">filter_by()</span></tt> takes keyword arguments representing attributes on the class you are querying. Their use is best demonstrated with examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">titles1</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="mf">1</span><span class="p">)]</span>
<span class="go">2008-09-04 22:40:24,236 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_ posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.id = ?</span>
<span class="go">2008-09-04 22:40:24,236 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">titles2</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mf">1</span><span class="p">)]</span>
<span class="go">2008-09-04 22:40:40,098 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.id = ?</span>
<span class="go">2008-09-04 22:40:40,101 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">titles1</span> <span class="o">==</span> <span class="n">titles2</span>
<span class="go">True</span>
</pre></div>
</div>
<p id="index-670">The same results are obtained whether the <tt class="docutils literal"><span class="pre">filter()</span></tt> or <tt class="docutils literal"><span class="pre">filter_by()</span></tt> syntax is used.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-671">You might not have seen the notation used in the previous example to generate both the title lists. It is called a <em>list comprehension</em> and is a handy way of quickly iterating over an object to produce a new list.</p>
</div>
<p>It is also possible to use table columns as an argument to <tt class="docutils literal"><span class="pre">filter()</span></tt> rather than object attributes. Here’s an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_page_q</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">u&#39;%page%&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">filtered_page_q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="go">2008-09-04 23:23:33,128 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_ posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.title LIKE ?</span>
<span class="go"> LIMIT 1 OFFSET 0</span>
<span class="go">2008-09-04 23:23:33,136 INFO sqlalchemy.engine.base.Engine.0x..30 [u&#39;%page%&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;Test Page&#39;</span>
</pre></div>
</div>
<p id="index-672">Notice that the return value from <tt class="docutils literal"><span class="pre">filter()</span></tt> or <tt class="docutils literal"><span class="pre">filter_by()</span></tt> is another query object, so you can further manipulate the results or apply more filters. You can also create more complex expressions using <tt class="docutils literal"><span class="pre">AND</span></tt>, <tt class="docutils literal"><span class="pre">OR</span></tt>, and <tt class="docutils literal"><span class="pre">NOT</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">and_</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">u&#39;%page%&#39;</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="mf">1</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="go">2008-09-04 23:24:51,196 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.title LIKE ? AND page.id = ?</span>
<span class="go"> LIMIT 1 OFFSET 0</span>
<span class="go">2008-09-04 23:24:51,196 INFO sqlalchemy.engine.base.Engine.0x..30 [u&#39;%page%&#39;, 1]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;Test Page&#39;</span>
</pre></div>
</div>
<p id="index-673">Notice that you can use either attributes of the class or columns of the table in the query. Using this technique you can even use SQL strings, bind parameters, or complex statements built using the SQLAlchemy expression language <tt class="docutils literal"><span class="pre">select()</span></tt> function. See the SQLAlchemy documentation for details.</p>
</div>
<div class="section" id="working-with-objects">
<h3>Working with Objects<a class="headerlink" href="#working-with-objects" title="Permalink to this headline">¶</a></h3>
<p id="index-674">The great thing about using the SQLAlchemy Object-Relational API is that you get actual Python objects returned from the queries rather than values. Any changes you make to the objects are then automatically reflected in the underlying database when you commit changes to the session. This means that working with the database becomes just like working with ordinary Python objects.</p>
<p>Let’s start by changing the title of the <tt class="docutils literal"><span class="pre">page</span></tt> object you’ve just selected:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">u&#39;New Title&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">2008-09-04 23:27:13,893 INFO sqlalchemy.engine.base.Engine.0x..30 UPDATE page SET title=? WHERE page.id = ?</span>
<span class="go">2008-09-04 23:27:13,893 INFO sqlalchemy.engine.base.Engine.0x..30 [u&#39;New Title&#39;, 1]</span>
<span class="go">2008-09-04 23:27:13,896 INFO sqlalchemy.engine.base.Engine.0x..30 COMMIT</span>
</pre></div>
</div>
<p>As you can see, SQLAlchemy automatically generated an <tt class="docutils literal"><span class="pre">UPDATE</span></tt> statement to update the column and then committed the change.</p>
<p id="index-675">Now let’s think about how you could add a comment to the page. One approach would be to insert a new row into the <tt class="docutils literal"><span class="pre">comment</span></tt> table using the SQL Expression API, ensuring that the <tt class="docutils literal"><span class="pre">pageid</span></tt> field contained the value <tt class="docutils literal"><span class="pre">1</span></tt> so that the comment was associated with the correct page via a foreign key. This would work perfectly well, but the Object-Relational API provides a better approach:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">comment1</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;James&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment1</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s">u&quot;james@example.com&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment1</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;This page needs a bit more detail ;-)&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment2</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Mike&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment2</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s">u&#39;mike@example.com&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">2008-09-04 23:38:52,900 INFO sqlalchemy.engine.base.Engine.0x..30 INSERT INTO comment (pageid, content, name, email, created) VALUES (?, ?, ?, ?, ?)</span>
<span class="go">2008-09-04 23:38:52,901 INFO sqlalchemy.engine.base.Engine.0x..30 [1, u&#39;This page needs a bit more detail ;-)&#39;, u&#39;James&#39;, u&#39;james@example.com&#39;, &#39;2008-09-04 22:12:24.775929&#39;]</span>
<span class="go">2008-09-04 23:38:52,903 INFO sqlalchemy.engine.base.Engine.0x..30 INSERT INTO comment (pageid, content, name, email, created) VALUES (?, ?, ?, ?, ?)</span>
<span class="go">2008-09-04 23:38:52,904 INFO sqlalchemy.engine.base.Engine.0x..30 [1, u&#39;&#39;, u&#39;Mike&#39;, u&#39;mike@example.com&#39;, &#39;2008-09-04 22:12:24.775929&#39;]</span>
<span class="go">2008-09-04 23:38:52,907 INFO sqlalchemy.engine.base.Engine.0x..30 COMMIT</span>
</pre></div>
</div>
<p id="index-676">You have created the comment objects in a similar way as you created the <tt class="docutils literal"><span class="pre">test_page</span></tt> object earlier in the chapter, assigning various attributes appropriate values. The interesting thing here is that rather than having to manually set the <tt class="docutils literal"><span class="pre">.pageid</span></tt> attribute on each of the columns with the <tt class="docutils literal"><span class="pre">id</span></tt> of the page, you simply appended the comments to the page’s <tt class="docutils literal"><span class="pre">.comments</span></tt> attribute. Really, the comments should have been added to the session with <tt class="docutils literal"><span class="pre">session.add_all([comment1,</span> <span class="pre">comment2])</span></tt>, but SQLAlchemy was smart enough to realize that if they had been appended to an object that was already in the session, then they needed to be added too. When <tt class="docutils literal"><span class="pre">session.commit()</span></tt> was called, the <tt class="docutils literal"><span class="pre">autoflush=True</span></tt> option to the session caused the session to be flushed, and the SQL for the two required <tt class="docutils literal"><span class="pre">INSERT</span></tt> statements to be sent to the database before being committed.</p>
<p>This behavior is possible only because of the relationships that were defined when the tables and mappers were created in the <tt class="docutils literal"><span class="pre">model.py</span></tt> file earlier in the chapter. If you recall, the mapper for the page table looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
   <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">),</span>
   <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p id="index-677">Notice that you specified a backref called <tt class="docutils literal"><span class="pre">page</span></tt> on the <tt class="docutils literal"><span class="pre">Comments</span></tt> class. This means  you should be able to access the page object from a comment’s <tt class="docutils literal"><span class="pre">.page</span></tt> attribute as well as accessing a list of comments from a page’s <tt class="docutils literal"><span class="pre">.comments</span></tt> attribute. Let’s see:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">comment_q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
<span class="go">2008-09-04 23:53:21,084 INFO sqlalchemy.engine.base.Engine.0x..30 BEGIN</span>
<span class="go">2008-09-04 23:53:21,085 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT comment.id AS comment_id, comment.pageid AS comment_pageid, comment.content AS comment_content, comment.name AS comment_name, comment.email AS comment_ email, comment.created AS comment_created</span>
<span class="go">FROM comment</span>
<span class="go">WHERE comment.id = ?</span>
<span class="go">2008-09-04 23:53:21,086 INFO sqlalchemy.engine.base.Engine.0x..30 [2]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">page</span>
<span class="go">2008-09-04 23:53:28,047 INFO sqlalchemy.engine.base.Engine.0x..30 SELECT page.id AS page_id, page.content AS page_content, page.posted AS page_posted, page.title AS page_title, page.heading AS page_heading</span>
<span class="go">FROM page</span>
<span class="go">WHERE page.id = ?</span>
<span class="go">2008-09-04 23:53:28,048 INFO sqlalchemy.engine.base.Engine.0x..30 [1]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span>
<span class="go">&lt;model.Page object at 0x72670&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span><span class="o">.</span><span class="n">title</span>
<span class="go">u&#39;New Title&#39;</span>
</pre></div>
</div>
<p id="index-678">As you can see, it is the same page with the updated title. You’ll see a lot more of the Object-Relational API as you read the SimpleSite tutorial chapters. As well as seeing how SQLAlchemy works in the context of a Pylons application, you’ll see how to work with tags as an example of a many-to-many relationship, how to use <tt class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span></tt> clauses with query objects, and how to hook SQLAlchemy up to FormEncode to validate data.</p>
</div>
<div class="section" id="declarative-api">
<h3>Declarative API<a class="headerlink" href="#declarative-api" title="Permalink to this headline">¶</a></h3>
<p id="index-679">SQLAlchemy 0.5 also has a Declarative API that offers a higher-level API to allow you to define <em>on one go</em> the same classes, tables, and mappers you added to your <tt class="docutils literal"><span class="pre">model.py</span></tt> file earlier in the chapter. For many applications, this is the only style of configuration needed.</p>
<p id="index-680">Let’s rewrite the <tt class="docutils literal"><span class="pre">model.py</span></tt> file using the Declarative API:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">schema</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">orm</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="c"># Assign the same metadata object we created earlier.</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

<span class="c"># We still need the pagetag table because we don&#39;t want to explicitly define a</span>
<span class="c"># Pagetag class but still</span>
<span class="c"># need to specify the table in the relation between pages and tags.</span>
<span class="n">pagetag_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;pagetag&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;pagetag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;tagid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;tag.id&#39;</span><span class="p">)),</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;page&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;page_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">posted</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;Untitled Page&#39;</span><span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">))</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="s">&quot;Comment&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&quot;page&quot;</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="s">&quot;Tag&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;comment&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;comment_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pageid</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">))</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;tag&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
       <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;tag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">page_table</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">__table__</span>
</pre></div>
</div>
<p id="index-681">As you can see, this example uses many of the same principles you’ve already learned about but in a more compact form. The table name has to be specified via a <tt class="docutils literal"><span class="pre">__tablename__</span></tt> attribute, but SQLAlchemy can infer the column names from the attribute names you’ve specified. When setting up the relationships, you can pass a string to <tt class="docutils literal"><span class="pre">relation()</span></tt> rather than a class because you might need to map a relationship before the class has been defined.</p>
<p>Classes that are mapped explicitly using <tt class="docutils literal"><span class="pre">mapper()</span></tt> can interact freely with declarative classes, and table definitions created explicitly can be used too, as you can see with the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table in the previous example.</p>
<p>Declarative classes get access to the underlying <tt class="docutils literal"><span class="pre">metadata</span></tt> object, and hence the underlying engine, because they are inherited from <tt class="docutils literal"><span class="pre">Base</span></tt>, and <tt class="docutils literal"><span class="pre">Base</span></tt> has access to <tt class="docutils literal"><span class="pre">metadata</span></tt> because it is passed as an argument to the <tt class="docutils literal"><span class="pre">declarative_base()</span></tt> function.</p>
<p>The underlying <tt class="docutils literal"><span class="pre">Table</span></tt> object created by the <tt class="docutils literal"><span class="pre">declarative_base()</span></tt> version of each of these classes is accessible via the class’s <tt class="docutils literal"><span class="pre">__table__</span></tt> attribute, as you can see from the last line in the example.</p>
<p>If you save the updated <tt class="docutils literal"><span class="pre">model.py</span></tt>, you will find that all the examples using the <tt class="docutils literal"><span class="pre">object_test</span></tt> module still work in the same way, even with the new model.</p>
<p id="index-682">Although the Declarative API can be more approachable to newcomers, most Pylons developers at the moment still choose to use the more explicit APIs you saw earlier, which is the approach you’ll follow for the rest of the book. If you are interested in using the Declarative API, you should read the SQLAlchemy documentation at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/plugins.html#plugins_declarative">http://www.sqlalchemy.org/docs/05/plugins.html#plugins_declarative</a>.</p>
</div>
</div>
<div class="section" id="maintaining-performance">
<h2>Maintaining Performance<a class="headerlink" href="#maintaining-performance" title="Permalink to this headline">¶</a></h2>
<p id="index-683">SQLAlchemy is a well-designed package, and although it isn’t ever going to be as fast as using the DB-API 2.0 directly, it should perform extremely well as long as you use it correctly.</p>
<p>One thing you should avoid at all costs is writing a query like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span>
</pre></div>
</div>
<p>This would select every page from the database and create a new <tt class="docutils literal"><span class="pre">page</span></tt> object from the <tt class="docutils literal"><span class="pre">Page</span></tt> class for each row in the table, just so that you can find the page with an <tt class="docutils literal"><span class="pre">id</span></tt> of 1. Since there is only one page in the database, this code isn’t too bad, but if you had 10,000 pages, that is 10,000 objects that need to be created and checked in Python rather than in the underlying RDBMS.</p>
<p>Iterating over results as Python objects is obviously a very inefficient way of searching through data in a table, because each row has to be loaded into memory as a Python object. SQL databases are designed to be very fast at performing complex queries, so it is much better to use one of SQLAlchemy’s filter methods to generate the SQL necessary to make the underlying database do all the hard work, or in this case, you can just use the <tt class="docutils literal"><span class="pre">get()</span></tt> method you saw earlier, which might not even have to contact the database if the page is already in memory in the session:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">page</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The final thing to remember is that the Object-Relational API isn’t always the best tool for the job. If you are updating or deleting multiple rows at once, for example, you are much better off using the SQL Expression API to allow SQLAlchemy to build a SQL statement that the underlying RDBMS can use to change the rows using its efficient C code. Remember that you can always mix and match the Object-Relational API code and the SQL Expression API code within the same transaction using the session’s <tt class="docutils literal"><span class="pre">execute()</span></tt> method. For example, to update a set of rows in one go, you might write the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">update</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">page_table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">page_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">==</span><span class="s">u&#39;New Title&#39;</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&quot;Updated Title&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p id="index-684">So, that was a whistle-stop tour of SQLAlchemy’s architecture. You’ll be using SQLAlchemy throughout the book, and it will all become much clearer as you use it. In the next chapter, you’ll begin creating a real application, and you’ll see how to use SQLAlchemy’s Object-Relational API to perform queries on the database.</p>
<p id="index-685">If you haven’t quite understood everything yet, it really is worth returning to this chapter and reading it again once you’ve read the rest of the book just to make sure everything is clear. A good understanding of SQLAlchemy will really help you write effective code in Pylons.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 7: Introducing the Model and SQLAlchemy</a><ul>
<li><a class="reference external" href="#storing-data-in-the-filesystem">Storing Data in the Filesystem</a></li>
<li><a class="reference external" href="#storing-data-in-amazon-s3">Storing Data in Amazon S3</a></li>
<li><a class="reference external" href="#exploring-database-approaches">Exploring Database Approaches</a><ul>
<li><a class="reference external" href="#object-databases">Object Databases</a></li>
<li><a class="reference external" href="#xml-databases">XML Databases</a></li>
<li><a class="reference external" href="#relational-database-management-systems">Relational Database Management Systems</a></li>
<li><a class="reference external" href="#object-relational-mappers">Object-Relational Mappers</a></li>
</ul>
</li>
<li><a class="reference external" href="#setting-up-sqlalchemy">Setting Up SQLAlchemy</a><ul>
<li><a class="reference external" href="#installing-the-db-api-driver">Installing the DB-API Driver</a></li>
<li><a class="reference external" href="#installing-sqlalchemy">Installing SQLAlchemy</a></li>
<li><a class="reference external" href="#creating-a-database">Creating a Database</a></li>
</ul>
</li>
<li><a class="reference external" href="#exploring-sqlalchemy-s-architecture">Exploring SQLAlchemy’s Architecture</a><ul>
<li><a class="reference external" href="#engine-api">Engine API</a></li>
<li><a class="reference external" href="#metadata-and-type-apis">Metadata and Type APIs</a></li>
<li><a class="reference external" href="#sql-expression-api">SQL Expression API</a><ul>
<li><a class="reference external" href="#sql-injection-attacks">SQL Injection Attacks</a></li>
<li><a class="reference external" href="#selecting-results">Selecting Results</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference external" href="#exploring-the-object-relational-api">Exploring the Object-Relational API</a><ul>
<li><a class="reference external" href="#object-relational-principles">Object-Relational Principles</a></li>
<li><a class="reference external" href="#more-metadata">More Metadata</a></li>
<li><a class="reference external" href="#classes-and-mappers">Classes and Mappers</a></li>
<li><a class="reference external" href="#understanding-the-session">Understanding the Session</a></li>
<li><a class="reference external" href="#exploring-the-session">Exploring the Session</a></li>
<li><a class="reference external" href="#queries">Queries</a></li>
<li><a class="reference external" href="#working-with-objects">Working with Objects</a></li>
<li><a class="reference external" href="#declarative-api">Declarative API</a></li>
</ul>
</li>
<li><a class="reference external" href="#maintaining-performance">Maintaining Performance</a></li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="working-with-forms-and-validators.html"
                                  title="previous chapter">Chapter 6: Working with Forms and Validators</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="starting-the-simplesite-tutorial.html"
                                  title="next chapter">Chapter 8: Starting the SimpleSite Tutorial</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/introducing-the-model-and-sqlalchemy.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="starting-the-simplesite-tutorial.html" title="Chapter 8: Starting the SimpleSite Tutorial"
             >next</a> |</li>
        <li class="right" >
          <a href="working-with-forms-and-validators.html" title="Chapter 6: Working with Forms and Validators"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/introducing-the-model-and-sqlalchemy.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:42:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>