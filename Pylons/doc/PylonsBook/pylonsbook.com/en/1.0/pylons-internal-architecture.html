<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/pylons-internal-architecture.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:41 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 17: Pylons’ Internal Architecture &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 18: Authentication and Authorization" href="authentication-and-authorization.html" />
    <link rel="prev" title="Chapter 16: The Web Server Gateway Interface (WSGI)" href="the-web-server-gateway-interface-wsgi.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="authentication-and-authorization.html" title="Chapter 18: Authentication and Authorization"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="the-web-server-gateway-interface-wsgi.html" title="Chapter 16: The Web Server Gateway Interface (WSGI)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-17-pylons-internal-architecture">
<h1>Chapter 17: Pylons’ Internal Architecture<a class="headerlink" href="#chapter-17-pylons-internal-architecture" title="Permalink to this headline">¶</a></h1>
<p id="index-730">Now that you’ve seen what WSGI is and how it works, in this chapter you’ll look at how Pylons’ architecture is built around the opportunities WSGI provides. Before getting into too much detail, though, it is helpful to put the Pylons architecture in context by looking at how it came about in the first place.</p>
<div class="section" id="a-bit-of-history">
<h2>A Bit of History<a class="headerlink" href="#a-bit-of-history" title="Permalink to this headline">¶</a></h2>
<p id="index-731">All web frameworks are fundamentally involved in the process of responding to HTTP requests and generating HTTP responses using APIs that are convenient for developers. These APIs might provide session handling, cookie handling, E-Tag caching, error reporting, or other features that read information from the HTTP request and affect the HTTP response. It turns out that the vast majority of HTTP services that web frameworks provide are easily implemented as WSGI middleware because, as you’ve just learned, middleware has the ability to change all aspects of the HTTP request and the HTTP response, which is exactly what most frameworks’ internal stacks have to do.</p>
<p id="index-732">Now, just because it is possible to do something doesn’t mean it is always a good idea, but it turns out that building a web framework stack out of WSGI middleware is very useful because once a piece of middleware has been written, it can be used between <em>any</em> WSGI-compatible web server and web application. This means it can be used in any web framework, which in turn means that for the first time WSGI allows web developers to reuse components at the web framework stack level. This is really important because it has three implications:</p>
<blockquote>
<ul class="simple">
<li>Developers can easily customize their WSGI frameworks by adding or removing their own middleware components.</li>
<li>Web framework developers no longer need to constantly reinvent the wheel because they can just use existing middleware components instead of creating their own custom implementations.</li>
<li>Users can write their own middleware, such as a custom transaction logger to be used with several applications.</li>
</ul>
</blockquote>
<p id="index-733">These more than any other reasons are why Pylons exists today. Once the WSGI standard was specified and tools such as Paste began to emerge, many people in the Python community were very keen to refactor existing frameworks such as Django and Zope to be built from WSGI middleware. Understandably, these communities were rather reluctant to stop development to refactor code to use WSGI middleware when it already worked perfectly well as it was. Doing so would benefit the wider Python community that could then reuse much of their code, but this was more effort than it was worth to the communities themselves. As a result, WSGI wasn’t adopted in any of the major frameworks of the time other than as an adaptor to allow them to run on WSGI servers. Finally, late in 2005 Ben Bangert and I started Pylons as a wake-up call to the other Python communities to demonstrate that writing a full-stack Python framework using WSGI middleware was not only possible but would also form the very best basis for developers because it put them in complete control of every aspect of their applications. It would also be the best solution for the wider community because it would create, as a side effect of its architecture, a huge variety of reusable Python components. This was the basis on which the Pylons WSGI architecture was born.</p>
<p id="index-734">At the same time, not every component a web framework provides is appropriate as WSGI middleware. In keeping with Pylons’ philosophy of developer choice and reusability, the Pylons developers decided early on not to code an integrated set of components for database access, templating, or form creation in the way Django does but rather to tackle the essence of the workflow and underlying technical requirements that each of these components has and provide APIs and written recommendations for how to use these components together. This loosely coupled architecture has meant that Pylons has been able to easily move from SQLObject to SQLAlchemy and from Myghty to Mako (while still supporting alternatives) and is able to support form generation systems as diverse as HTML Fill, ToscaWidgets, and FormAlchemy.</p>
<p id="index-735">As communities within Python continue to innovate on individual projects, Pylons will continue to be able to use them because the framework isn’t strongly dependent on the other components it recommends, whereas the perceived simplicity of other frameworks, notably Django, comes from its tight integration of components, and this limits that community’s ability to respond to changes. It also severely limits a developer’s opportunity to do things differently if the solution provided out of the box doesn’t quite fit your needs.</p>
<p>So, Pylons’ big secret is that actually it isn’t really a framework in the traditional sense at all; it favors the creation of reusable middleware components over an integrated framework stack and favors supporting other communities’ efforts over writing anything custom and tightly integrated. There are other subtle benefits to this that you might not notice at first. Because most of the components that make up Pylons are actually stand-alone projects in their own right, you will find the following:</p>
<blockquote>
<ul class="simple">
<li>You can generally get very good support because you can go to the component-specific mailing list as well as the Pylons one.</li>
<li>You can easily use the components (and the code you have written) outside the Pylons web environment because many of the components were designed to run stand-alone in the first place.</li>
<li>The skills you learn when developing a Pylons application are very transferable because the same tools are used by other companies and organizations in non-web environments.</li>
</ul>
</blockquote>
<p>With these ideas in mind in this chapter, let’s look in detail at how Pylons is really built beneath the surface. You’ll learn about the following:</p>
<blockquote>
<ul class="simple">
<li>The Paste Deploy package</li>
<li>The Pylons config file and how to use it to set up middleware</li>
<li>The Pylons middleware stack</li>
<li>The <tt class="docutils literal"><span class="pre">Cascade</span></tt></li>
<li>What actually happens during a request</li>
</ul>
</blockquote>
<p id="index-736">But before I can discuss these points, I must discuss one piece of technology that is critical to the way Pylons works: egg entry points.</p>
</div>
<div class="section" id="egg-entry-points">
<h2>Egg Entry Points<a class="headerlink" href="#egg-entry-points" title="Permalink to this headline">¶</a></h2>
<p id="index-737">As you’ll remember from Chapter 2, most of the components used by Pylons are distributed as Python eggs. Eggs have a number of useful features for Pylons developers, but one feature called <em>entry points</em> is particularly useful.</p>
<p>To understand how entry points work, let’s imagine you want to allow the SimpleSite application’s pages to support different types of content. At the moment, they support plain text, but you might want to support HTML, reStructuredText, or some other markup type. Let’s say you decide to design SimpleSite to use a plug-in architecture so that other people can write plug-ins to support each of the different formats. Each plug-in will need a <tt class="docutils literal"><span class="pre">display_name()</span></tt> function so SimpleSite can display a list of available plug-ins in an HTML select field, a <tt class="docutils literal"><span class="pre">markup_to_html()</span></tt> function that will be called every time a page was viewed, and a <tt class="docutils literal"><span class="pre">render_input_field()</span></tt> function that will return various HTML fragments necessary to display an edit field for the particular type of markup.</p>
<p>A plug-in developer can then create a new project that implements each of these functions and packages them up into another egg, but how does SimpleSite know whether the plug-in is installed? This is where egg entry points come in. The plug-in writer would list the functions SimpleSite needs in the entry points part of its <tt class="docutils literal"><span class="pre">setup.py</span></tt> file. The syntax is <tt class="docutils literal"><span class="pre">entry_point_name=package.module:object</span></tt>. Others who write similar plug-ins would define similar entry points.</p>
<p>Then a program that wants to use these plug-ins, be it SimpleSite or a different application, can ask for all the entry points in all the packages installed on the system to obtain a list of entry points. It can then select the packages that have the entry points it needs and load the functions pointed to by the entry points, and it can therefore use the plug-in.</p>
<p>Entry points are arranged in groups with names that can include a period (<tt class="docutils literal"><span class="pre">.</span></tt>), so the SimpleSite application might define entry points in a <tt class="docutils literal"><span class="pre">simplesite.content_plugin</span></tt> group. Each entry point in a group has a name, so the entry point that points to the <tt class="docutils literal"><span class="pre">render_input_field()</span></tt> function defined in the HTMLPlugin might just be called <tt class="docutils literal"><span class="pre">render</span></tt>. SimpleSite can then access the function by looking for the <tt class="docutils literal"><span class="pre">render</span></tt> entry point in the <tt class="docutils literal"><span class="pre">simplesite.content_plugin</span></tt> group. It doesn’t even need to know what the function’s name is in the HTMLPlugin package.</p>
<p id="index-738">The beauty of the entry points system is that entry points allow packages to expose fixed APIs that other plug-in packages can implement. This system is used a lot within Pylons itself, particularly in relation to the Pylons config files.</p>
<div class="section" id="entry-points-and-websetup-py">
<h3>Entry Points and websetup.py<a class="headerlink" href="#entry-points-and-websetup-py" title="Permalink to this headline">¶</a></h3>
<p id="index-739">If you look at the <tt class="docutils literal"><span class="pre">setup.py</span></tt> file for a Pylons project, this is what the entry point definition looks like:</p>
<div class="highlight-python"><pre>setup(
    ...
    entry_points="""
    [paste.app_factory]
    main = simplesite.config.middleware:make_app

    [paste.app_install]
    main = pylons.util:PylonsInstaller
    """,
)</pre>
</div>
<p>This means your Pylons application implements the functionality expected of an application supporting the <tt class="docutils literal"><span class="pre">main</span></tt> entry point of a <tt class="docutils literal"><span class="pre">paste.app_factory</span></tt> group and the <tt class="docutils literal"><span class="pre">main</span></tt> entry point for the <tt class="docutils literal"><span class="pre">paste.app_install</span></tt> group. In effect, your Pylons application behaves like a Paste app factory and as a Paste installer.</p>
<p id="index-740">You’ll see how the <tt class="docutils literal"><span class="pre">main</span></tt> entry point of a <tt class="docutils literal"><span class="pre">paste.app_factory</span></tt> group is used in the next section, so for the moment, let’s concentrate on the <tt class="docutils literal"><span class="pre">main</span></tt> entry point for the <tt class="docutils literal"><span class="pre">paste.app_install</span></tt> group, which is used by the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> command.</p>
<p>When you run the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> command, Paste Script discovers the Pylons application you want to set up by looking at the <tt class="docutils literal"><span class="pre">use</span></tt> line in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section of the config file. It looks like this:</p>
<div class="highlight-python"><pre>[app:main]
use = egg:SimpleSite</pre>
</div>
<p id="index-741">The Pylons config file is in a special format understood by the <tt class="docutils literal"><span class="pre">PasteDeploy</span></tt> package. The <tt class="docutils literal"><span class="pre">use</span></tt> line simply tells Paste Deploy which package to use and that the package is an egg. The <tt class="docutils literal"><span class="pre">use</span></tt> line can also be written like this:</p>
<div class="highlight-python"><pre>[app:main]
use = egg:SimpleSite#main</pre>
</div>
<p>This tells Paste Deploy that the entry point it is looking for is called <tt class="docutils literal"><span class="pre">main</span></tt>, but this is assumed to be the case anyway if the <tt class="docutils literal"><span class="pre">#main</span></tt> part is ignored.</p>
<p id="index-742">Once <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> knows the package to look for and the name of the entry point, it looks it up in the <tt class="docutils literal"><span class="pre">paste.app_install</span></tt> group with code similar to this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">load_entry_point</span>
<span class="n">entry_point</span> <span class="o">=</span> <span class="n">load_entry_point</span><span class="p">(</span><span class="s">&#39;SimpleSite&#39;</span><span class="p">,</span> <span class="s">&#39;paste.app_install&#39;</span><span class="p">,</span> <span class="s">&#39;main&#39;</span><span class="p">)</span>
<span class="n">installer</span> <span class="o">=</span> <span class="n">entry_point</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">load_entry_point()</span></tt> function can also take a version specification such as <tt class="docutils literal"><span class="pre">'SimpleSite&gt;=0.1.0'</span></tt> as its first argument.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-743">The <tt class="docutils literal"><span class="pre">pkg_resources</span></tt> package comes with <tt class="docutils literal"><span class="pre">setuptools</span></tt>, the same package that provides the <tt class="docutils literal"><span class="pre">easy_install</span></tt> script. There are other ways of loading objects using entry points too, which you can learn about in the entry points section of the <tt class="docutils literal"><span class="pre">pkg_resources</span></tt> page at <a class="reference external" href="http://peak.telecommunity.com/DevCenter/PkgResources#entry-points">http://peak.telecommunity.com/DevCenter/PkgResources#entry-points</a>.</p>
</div>
<p id="index-744">Now, Pylons applications are unusual in the sense that this entry point doesn’t point to an object in the Pylons project in which it is defined but in <tt class="docutils literal"><span class="pre">pylons.util</span></tt> instead. This means the object that is loaded is always <tt class="docutils literal"><span class="pre">pylons.util.PylonsInstaller</span></tt> no matter which Pylons project is being used. The <tt class="docutils literal"><span class="pre">PylonsInstaller</span></tt> object itself is responsible for then calling the <tt class="docutils literal"><span class="pre">setup_app()</span></tt> function in your project’s <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file.</p>
<p id="index-745">Now that you have seen how entry points can be used to set up a Pylons application, you can learn about how they are used when serving an application.</p>
</div>
</div>
<div class="section" id="the-pylons-config-file">
<h2>The Pylons Config File<a class="headerlink" href="#the-pylons-config-file" title="Permalink to this headline">¶</a></h2>
<p id="index-746">Pylons is designed to be as easy as possible for everyone to use, and this design philosophy also extends to end users of your Pylons application. People configuring your Pylons application might not be confident configuring WSGI applications in Python source code, so the Pylons config file provides a more familiar environment for them to make configuration changes. It also provides an API to allow them to set up some complex combinations of applications and middleware without needing to get involved in Python code.</p>
<p>In this section, you’ll look at the different ways a Pylons config file can be used and what is actually going on behind the scenes to convert sections from the config file into real Python objects. Then, later in the chapter, you’ll see how you can use the same API as the Pylons tools to construct Python objects directly from the config file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I won’t be discussing the logging configuration options in this chapter. Although the logging options look similar, they are actually used in a completely different way behind the scenes, so the techniques in this chapter for the other Pylons config options do not apply in any way to the logging options. Logging options are described in Chapter 20.</p>
</div>
<p id="index-747">When you serve a Pylons application via its config file with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span></tt> command, these are the steps that take place:</p>
<blockquote>
<ol class="arabic simple">
<li>The Paste Script package’s <tt class="docutils literal"><span class="pre">serve</span></tt> plug-in is loaded by <tt class="docutils literal"><span class="pre">paster</span></tt>.</li>
<li>The <tt class="docutils literal"><span class="pre">serve</span></tt> plug-in uses the Paste Deploy package to parse the config file.</li>
<li>Paste Deploy uses code in the <tt class="docutils literal"><span class="pre">[*:main]</span></tt> section to construct a valid WSGI application, pipeline, or composite application.</li>
<li>Paste Deploy uses code in the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section to load and configure a suitable WSGI server with the pipelines, filters, and application object, and then the server is started.</li>
</ol>
</blockquote>
<p id="index-748">In the following sections, you’ll concentrate on the work Paste Deploy does to parse the config file, but if you are interested in how to write Paste Script plug-ins so that you can create your own extensions to the <tt class="docutils literal"><span class="pre">paster</span></tt> program, you should read the Paste Script developer documentation at <a class="reference external" href="http://pythonpaste.org/script/developer.html">http://pythonpaste.org/script/developer.html</a>. You won’t be surprised to hear that plug-ins rely on entry points.</p>
<div class="section" id="default-config-options">
<h3>Default Config Options<a class="headerlink" href="#default-config-options" title="Permalink to this headline">¶</a></h3>
<p id="index-749">The first section in a Pylons config file is the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section. This contains a set of variables that will make up the global configuration, accessed in a Pylons application as <tt class="docutils literal"><span class="pre">config.global_conf</span></tt>. The options are also passed to each of the functions used to construct objects in other sections of the config file. These options are labeled <tt class="docutils literal"><span class="pre">DEFAULT</span></tt> rather than <tt class="docutils literal"><span class="pre">global_conf</span></tt> because they also work as if they were present in each of the other sections (apart from the logging sections). As an example, consider how the <tt class="docutils literal"><span class="pre">debug</span></tt> option works. In the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section, the <tt class="docutils literal"><span class="pre">debug</span></tt> option is set to <tt class="docutils literal"><span class="pre">true</span></tt>. This means that in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section, if no <tt class="docutils literal"><span class="pre">debug</span></tt> option is specified, <tt class="docutils literal"><span class="pre">debug</span></tt> in that section will also be set to <tt class="docutils literal"><span class="pre">true</span></tt>. In effect, options in the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section are providing defaults for the other sections. When the <tt class="docutils literal"><span class="pre">debug</span></tt> option is set to <tt class="docutils literal"><span class="pre">false</span></tt> in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section, the value in the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section is overridden, and debugging is disabled.</p>
<p id="index-750">Now that you understand the role of the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section, let’s see how Paste Deploy handles the other sections.</p>
</div>
<div class="section" id="constructing-a-server">
<h3>Constructing a Server<a class="headerlink" href="#constructing-a-server" title="Permalink to this headline">¶</a></h3>
<p id="index-751">When Paste Deploy parses a config file, the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section is inspected to find out which server to use. The Pylons config file typically has a section that looks like this:</p>
<div class="highlight-python"><pre>[server:main]
use = egg:Paste#http
host = 127.0.0.1
port = 5000</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">use</span></tt> line tells the Paste Script package’s server plug-in that it should look up an egg entry point in the Paste package named <tt class="docutils literal"><span class="pre">http</span></tt>. Because this is a <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section, Paste Script knows that the entry point will be in the <tt class="docutils literal"><span class="pre">paste.server_runner</span></tt> entry point group.</p>
<p>The <tt class="docutils literal"><span class="pre">host</span></tt> option tells the server specified in the <tt class="docutils literal"><span class="pre">use</span></tt> line which host to serve the application on. You’ll remember from Chapter 3 that if you want to serve an application on all interfaces, you will need to change the <tt class="docutils literal"><span class="pre">host</span></tt> option to 0.0.0.0 because it is set by default to 127.0.0.1 to prevent you from accidentally serving an application across a network when it is running in debug mode on your development machine. You can also specify a hostname or domain name as long as they can be correctly resolved on your computer.</p>
<p>The <tt class="docutils literal"><span class="pre">port</span></tt> option simply tells the server which port to serve on. For production use, you would use port 80, but for development use, port 5000 is fine.</p>
<p>Let’s take a closer look at how Paste Deploy loads the Paste HTTP server from the <tt class="docutils literal"><span class="pre">use</span></tt> line. First the Paste package has the following as part of its entry point definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry_points</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    ...</span>
<span class="s">    [paste.server_runner]</span>
<span class="s">    http = paste.httpserver:server_runner</span>
<span class="s">    ...</span>
<span class="s">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p id="index-752">The <tt class="docutils literal"><span class="pre">use</span> <span class="pre">=</span> <span class="pre">egg:Paste#http</span></tt> line therefore points to the <tt class="docutils literal"><span class="pre">server_runner()</span></tt> function in the <tt class="docutils literal"><span class="pre">paste.httpserver</span></tt> module. This function is responsible for taking the arguments Paste Deploy sends it from the information it parsed from the config file and returning a running server. The function looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">server_runner</span><span class="p">(</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">server_runner()</span></tt> function takes a dictionary of all the options in the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section of the config file as the <tt class="docutils literal"><span class="pre">global_conf</span></tt> argument and all the options specified in <tt class="docutils literal"><span class="pre">[server:main]</span></tt> as keyword arguments that are gathered up by <tt class="docutils literal"><span class="pre">**kwargs</span></tt> into a dictionary. In this case, the <tt class="docutils literal"><span class="pre">global_conf</span></tt> options aren’t used, but the <tt class="docutils literal"><span class="pre">port</span></tt> and <tt class="docutils literal"><span class="pre">host</span></tt> options passed as keyword arguments are. The <tt class="docutils literal"><span class="pre">wsgi_app</span></tt> argument is the WSGI application to serve. It is based on the other objects specified in the config file. I’ll cover these in the next sections.</p>
<p id="index-753">Once all the options are in place, the function is called, and this starts the server.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the next chapter, you’ll also see some extra options that can be used in the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section to configure the Paste HTTP server with SSL support.</p>
</div>
</div>
<div class="section" id="constructing-an-application">
<h3>Constructing an Application<a class="headerlink" href="#constructing-an-application" title="Permalink to this headline">¶</a></h3>
<p id="index-754">Constructing the application happens using a similar mechanism, except Paste Deploy starts by looking for either an <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section, a <tt class="docutils literal"><span class="pre">[composite:main]</span></tt> section, or a <tt class="docutils literal"><span class="pre">[pipeline:main]</span></tt> section in the config file. Only one section other than <tt class="docutils literal"><span class="pre">[server:main]</span></tt> can have the name <tt class="docutils literal"><span class="pre">:main</span></tt>. I’ll cover composite applications and pipelines later in the chapter, so let’s concentrate on what happens when your main section is an <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section.</p>
<p>The Pylons config file <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section starts like this:</p>
<div class="highlight-python"><pre>[app:main]
use = egg:SimpleSite
...</pre>
</div>
<p>Paste Deploy knows to look for <tt class="docutils literal"><span class="pre">paste.app_factory</span></tt> entry point group to load an application factory. As was the case earlier in the chapter, because no <tt class="docutils literal"><span class="pre">#name</span></tt> is specified after the definition, Paste Deploy will look for an entry point named <tt class="docutils literal"><span class="pre">main</span></tt>.</p>
<p>Let’s look at SimpleSite’s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file again to see whether it contains a <tt class="docutils literal"><span class="pre">paste.app_factory</span></tt> group:</p>
<div class="highlight-python"><pre>setup(
    ...
    entry_points="""
    [paste.app_factory]
    main = simplesite.config.middleware:make_app

    [paste.app_install]
    main = pylons.util:PylonsInstaller
    """,
)</pre>
</div>
<p>In this case, the <tt class="docutils literal"><span class="pre">main</span></tt> entry point in the <tt class="docutils literal"><span class="pre">paste.app_factory</span></tt> group points to the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function in <tt class="docutils literal"><span class="pre">simplesite.config.middleware</span></tt>, so it is this function that is responsible for assembling the Pylons application and middleware that will form the WSGI application and middleware.</p>
<p id="index-755">The <tt class="docutils literal"><span class="pre">make_app()</span></tt> function looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_app</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">full_stack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">app_conf</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p id="index-756">Once again, the config options from the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section get passed to the function as <tt class="docutils literal"><span class="pre">global_conf</span></tt>, just as they did when the server was being called, and once again the section-specific options get passed as named parameters that this time are gathered up into the <tt class="docutils literal"><span class="pre">app_conf</span></tt> dictionary.</p>
<p>The WSGI application returned by <tt class="docutils literal"><span class="pre">make_app()</span></tt> as <tt class="docutils literal"><span class="pre">app</span></tt> is what PasteScript’s <tt class="docutils literal"><span class="pre">serve</span></tt> plug-in passes as the first argument to the <tt class="docutils literal"><span class="pre">server_runner()</span></tt> function when it serves the application.</p>
<p>We’ll take a detailed look at what happens in the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function to turn the configuration options into a Pylons application later in the chapter, but there is one point worth noting first. Because the <tt class="docutils literal"><span class="pre">full_stack</span></tt> option is specified as an argument to <tt class="docutils literal"><span class="pre">make_app()</span></tt>, it doesn’t get added to the <tt class="docutils literal"><span class="pre">app_conf</span></tt> dictionary in the same way as all the other variables. There isn’t really a good reason for this, so it might change in a future version of Pylons to be more like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_app</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">app_conf</span><span class="p">):</span>
    <span class="n">full_stack</span> <span class="o">=</span> <span class="n">asbool</span><span class="p">(</span><span class="n">app_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;full_stack&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">))</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p id="index-757">As you’ve probably realized, the Pylons config file format is slightly more powerful than most frameworks’ config files. It turns out that you can actually use the config file to directly assemble a whole range of WSGI (and hence Pylons) applications into one <em>composite</em> application, and you can even add middleware to individual WSGI (or Pylons) applications using <em>filters</em> and <em>pipelines</em>. Let’s start with composite applications.</p>
</div>
<div class="section" id="composite-applications">
<h3>Composite Applications<a class="headerlink" href="#composite-applications" title="Permalink to this headline">¶</a></h3>
<p id="index-758">Composite applications are WSGI applications that are made up of other WSGI applications. A good example of a composite app is a URL mapper that mounts WSGI applications at different paths relative to the base URL. Here’s an example that mounts your Pylons application at the path <tt class="docutils literal"><span class="pre">/pylons</span></tt> and mounts an application for handling downloads at the path <tt class="docutils literal"><span class="pre">/downloads</span></tt>:</p>
<div class="highlight-python"><pre>[composite:main]
use = egg:Paste#urlmap
/pylons = pylons
/downloads = staticapp

[app:staticapp]
use = egg:Paste#static
document_root = /path/to/docroot

[app:pylons]
# The standard [app:main] section goes here
use = egg:SimpleSite
... etc</pre>
</div>
<p>When this config file is loaded, Paste Deploy will look for the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section and any other main section and find that this time, rather than the second main section being an <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section, it is a <tt class="docutils literal"><span class="pre">[composite:main]</span></tt> section. It will therefore look up the <tt class="docutils literal"><span class="pre">urlmap</span></tt> entry point name in the <tt class="docutils literal"><span class="pre">Paste</span></tt> package from the <tt class="docutils literal"><span class="pre">paste.composite_app</span></tt> group, and this in turn will load the <tt class="docutils literal"><span class="pre">paste.urlmap.urlmap_factory()</span></tt> to load a <tt class="docutils literal"><span class="pre">paste.urlmap.URLMap</span></tt>. The <tt class="docutils literal"><span class="pre">URLMap</span></tt> will be set up with the two WSGI applications (the Pylons app and the static app) at the appropriate paths.</p>
<p>Notice that for this to work the Pylons configuration section had to be renamed from <tt class="docutils literal"><span class="pre">[app:main]</span></tt> to <tt class="docutils literal"><span class="pre">[app:pylons]</span></tt>. If you hadn’t done this, the two main sections would have conflicted.</p>
<p>One reason for setting up other WSGI applications via a composite section in the config file rather than as a Pylons controller or from a Pylons controller action is that none of the Pylons middleware will be in place. This is useful if you find that the Pylons middleware interferes with some aspect of the behavior of the other WSGI app when it is mounted inside a Pylons application.</p>
<p id="index-759">It is worth noting that the Paste <tt class="docutils literal"><span class="pre">URLMap</span></tt> in this example will automatically adjust the <tt class="docutils literal"><span class="pre">SCRIPT_NAME</span></tt> and <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt> environment variables so that your WSGI applications mounted under it will be able to work out where they are. This means that as long as the applications you mount use the <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> helper (or their own equivalents), then the URLs generated by the WSGI applications under <tt class="docutils literal"><span class="pre">URLMap</span></tt> will still be correct even though they are mounted at a path other than <tt class="docutils literal"><span class="pre">/</span></tt>.</p>
</div>
<div class="section" id="pipelines-and-filters">
<h3>Pipelines and Filters<a class="headerlink" href="#pipelines-and-filters" title="Permalink to this headline">¶</a></h3>
<p id="index-760">Now let’s look at pipelines and filters. Filters are just Paste Deploy’s name for functions that set up WSGI middleware, and pipelines are just Paste Deploy’s name for a middleware chain.</p>
<p>To use filters, instead of specifying the main section to be your Pylons application or a composite application, you specify a pipeline. The pipeline takes just one configuration option, which is a list of the filters to use. The list should always end with the WSGI application you want to serve, which is usually your Pylons application.</p>
<p>Let’s use a pipeline to add the Gzip middleware you developed in the previous chapter. Remember that you added it to the <tt class="docutils literal"><span class="pre">simplesite.lib.middleware</span></tt> module you created. Here’s an example of how the relevant sections of the config file should be set up:</p>
<div class="highlight-python"><pre>[pipeline:main]
pipeline = gzip pylons

[filter:gzip]
use = egg:SimpleSite#gzip

[app:pylons]
# Your normal Pylons [app:main] section
use = egg:SimpleSite
...</pre>
</div>
<p id="index-761">Once again, because you’ve named the pipeline <tt class="docutils literal"><span class="pre">main</span></tt>, the section holding the configuration for Pylons will have to be renamed from <tt class="docutils literal"><span class="pre">[app:main]</span></tt> to something else, and once again this example uses <tt class="docutils literal"><span class="pre">[app:pylons]</span></tt> as a sensible name, so the WSGI application at the end of the pipeline list is named <tt class="docutils literal"><span class="pre">pylons</span></tt> to point to that section.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Pylons config files typically allow you to specify lists, such as the list of filters on the pipeline, on multiple lines. The whitespace will be removed, so you could also write this example like this:</p>
<div class="highlight-python"><pre>[pipeline:main]
pipeline = filter1
           filter2
           filter3
           app</pre>
</div>
<p class="last">This syntax makes it easier for you to comment out particular filters, which can sometimes be useful for debugging.</p>
</div>
<p id="index-762">There is just one problem with this example as it stands: the <tt class="docutils literal"><span class="pre">gzip</span></tt> entry point doesn’t exist in the SimpleSite application yet, so this example won’t be able to actually load your Gzip middleware. You could fix this by using the Paste Gzip middleware instead by using <tt class="docutils literal"><span class="pre">use</span> <span class="pre">=</span> <span class="pre">egg:Paste#gzip</span></tt>, but let’s update the SimpleSite project so that your middleware can be used. To do that, you need to know about factories.</p>
</div>
<div class="section" id="understanding-factories">
<h3>Understanding Factories<a class="headerlink" href="#understanding-factories" title="Permalink to this headline">¶</a></h3>
<p id="index-763">In the examples so far, the <tt class="docutils literal"><span class="pre">use</span></tt> option has been used to specify a named entry point within an entry point group in a package, and that entry point has been used to load a function that, when called with arguments reflecting config file options, results in the construction of a particular object such as a server or WSGI application. In Paste Deploy terminology, the function pointed to by the entry point is known as a <em>factory</em> because it produces the desired object.</p>
<p>As you’ve seen, different types of sections in the config file use different entry point groups, and these point to different types of factories. Server sections point to server factories, app sections point to application factories, composite sections point to composite factories, and filters point to filter factories. Factories effectively translate the config options passed to them into appropriate variables that can be used to construct the objects they create. For the Gzip middleware to be usable directly from the config file, you’ll need to create a filter app factory for it. A suitable factory would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_gzip_middleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">app_conf</span><span class="p">):</span>
    <span class="n">compresslevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;compresslevel&#39;</span><span class="p">,</span> <span class="mf">9</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">GzipMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="p">)</span>
</pre></div>
</div>
<p>This factory would be passed the options in <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> as the <tt class="docutils literal"><span class="pre">global_conf</span></tt> argument and the options in the section for that filter as keyword arguments that can be gathered up into the <tt class="docutils literal"><span class="pre">app_conf</span></tt> dictionary. The <tt class="docutils literal"><span class="pre">app</span></tt> is a WSGI application that the middleware should wrap. As you can see, the <tt class="docutils literal"><span class="pre">compresslevel</span></tt> argument (a number from 0–9 is used to specify how much compression should be applied) is turned into an integer if it is present, and if not, the default value of <tt class="docutils literal"><span class="pre">9</span></tt> is used. The WSGI application is then wrapped in the middleware and returned.</p>
<p>Add this factory to the SimpleSite <tt class="docutils literal"><span class="pre">lib/middleware.py</span></tt> file you created in the previous chapter if you want to test the example.</p>
<p>Now that the factory is in place, let’s set up the entry point. Filter factories are put in the <tt class="docutils literal"><span class="pre">paste.filter_app_factory</span></tt> entry point group. Edit the SimpleSite <tt class="docutils literal"><span class="pre">setup.py</span></tt> file to update the entry points section:</p>
<div class="highlight-python"><pre>setup(
    ...
    entry_points="""
    [paste.app_factory]
    main = simplesite.config.middleware:make_app

    [paste.app_install]
    main = pylons.util:PylonsInstaller

    [paste.filter_app_factory]
    gzip = simplesite.lib.middleware:make_gzip_middleware
    """,
)</pre>
</div>
<p id="index-764">You’ll need to run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></tt> again for the entry point change to be noticed; otherwise, you’ll see this error:</p>
<div class="highlight-python"><pre>LookupError: Entry point 'gzip' not found in egg 'SimpleSite' (dir: /home/james/Desktop/SimpleSite2b; protocols: paste.filter_factory, paste.filter_app_factory; entry_points: )</pre>
</div>
<p>Once you’ve reinstalled the application, you will be able to test the filter. Be sure to remove the <tt class="docutils literal"><span class="pre">app</span> <span class="pre">=</span> <span class="pre">GzipMiddleware(app,</span> <span class="pre">5)</span></tt> line from <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>; otherwise, you will get a <tt class="docutils literal"><span class="pre">Content-Encoding</span></tt> header with <tt class="docutils literal"><span class="pre">gzip</span></tt> specified twice. The browser won’t understand this and will expect normal CSS or JavaScript instead of compressed content and will therefore most likely complain about illegal characters.</p>
<p>Once the Gzip middleware is disabled in <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>, update the config file. The lines 7-13 are the ones that have been changed:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><div class="highlight"><pre>...
[server:main]
use = egg:Paste#http
host = 127.0.0.1
port = 5000

[pipeline:main]
pipeline = gzip pylons

[filter:gzip]
use = egg:SimpleSite#gzip

[app:pylons]
use = egg:SimpleSite
full_stack = true
cache_dir = %(here)s/data
beaker.session.key = simplesite
beaker.session.secret = somesecret
...
</pre></div>
</td></tr></table></div>
<p id="index-765">With these changes in place, if you test the SimpleSite application and use LiveHTTPHeaders or Firebug to inspect the response at a URL such as <a class="reference external" href="http://localhost:5000/page/edit/6">http://localhost:5000/page/edit/6</a>, you’ll see the <tt class="docutils literal"><span class="pre">.js</span></tt> and <tt class="docutils literal"><span class="pre">.css</span></tt> files are still being Gzipped.</p>
<p>There is also an alternative syntax you can use if you simply want to wrap a WSGI application in one piece of middleware. You can use the <tt class="docutils literal"><span class="pre">filter-with</span></tt> option. Here’s the config file with the <tt class="docutils literal"><span class="pre">[pipeline:main]</span></tt> section removed, the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section reintroduced, and the <tt class="docutils literal"><span class="pre">filter-with</span></tt> option being used. Lines 7 and 9 have changed:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></td><td class="code"><div class="highlight"><pre>...
[server:main]
use = egg:Paste#http
host = 127.0.0.1
port = 5000

[app:main]
use = egg:SimpleSite
filter-with = egg:SimpleSite#gzip
full_stack = true
cache_dir = %(here)s/data
beaker.session.key = simplesite
beaker.session.secret = somesecret
...
</pre></div>
</td></tr></table></div>
<p>If you test this setup, you’ll find it behaves in the same way as before and that the CSS and JavaScript files are Gzipped correctly.</p>
<p id="index-766">There is one complication with the setup described so far. Paste Deploy, and hence the Pylons config file, supports two types of filters. The one you are using here is called a <em>filter-app</em> because the WSGI application is passed along with the configuration options to the filter-app factory. Another type of factory is one that is passed only the configuration options and that returns a function that, when <em>called</em>, returns the WSGI application wrapped in the filter. Such a factory is called a <em>filter</em> and would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_gzip_middleware_filter</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">app_conf</span><span class="p">):</span>
    <span class="n">compresslevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;compresslevel&#39;</span><span class="p">,</span> <span class="mf">9</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GzipMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">filter</span>
</pre></div>
</div>
<p>Add this to the <tt class="docutils literal"><span class="pre">lib/middleware.py</span></tt> file too, and update the entry points in <tt class="docutils literal"><span class="pre">setup.py</span></tt> (lines 13-14):</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></td><td class="code"><div class="highlight"><pre>setup(
    ...
    entry_points=&quot;&quot;&quot;
    [paste.app_factory]
    main = simplesite.config.middleware:make_app

    [paste.app_install]
    main = pylons.util:PylonsInstaller

    [paste.filter_app_factory]
    gzip = simplesite.lib.middleware:make_gzip_middleware

    [paste.filter_factory]
    gzip = simplesite.lib.middleware:make_gzip_middleware_filter
    &quot;&quot;&quot;,
)
</pre></div>
</td></tr></table></div>
<p id="index-767">If you run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></tt> again, the new entry points will take effect. When you have both a filter and a filter-app for the same entry point name, Paste Deploy uses the filter, so the new function you’ve added will be used in preference to the previous one.</p>
</div>
<div class="section" id="alternative-ways-of-specifying-factories">
<h3>Alternative Ways of Specifying Factories<a class="headerlink" href="#alternative-ways-of-specifying-factories" title="Permalink to this headline">¶</a></h3>
<p id="index-768">So far in this chapter you’ve seen two ways to specify a factory. The first is to use an egg URI such as the following one to identify a factory via an entry point:</p>
<div class="highlight-python"><pre>[filter:gzip]
use = egg:SimpleSite#gzip</pre>
</div>
<p>The second approach is to refer to a different section within a config file and have that section be responsible for looking up the factory. You’ve just seen this in the discussion of pipelines where the items in the pipelines were the names of sections, for example:</p>
<div class="highlight-python"><pre>[pipeline:main]
use = gzip pylons</pre>
</div>
<p>In addition to these techniques, there are two other approaches. The first is to specify a section in an entirely different config file like this:</p>
<div class="highlight-python"><pre>[app:main]
use = config:development.ini#main</pre>
</div>
<p>You’ve actually seen this technique in Chapter 12 when it was used to ensure the test setup used the same configuration as the development setup. In that particular situation, you’ll recall that the approach also had unexpected consequences because the <tt class="docutils literal"><span class="pre">websetup.py</span> <span class="pre">setup_app()</span></tt> function was automatically called each time you ran the tests and this interfered with your development database setup.</p>
<p>The final way to specify a factory is to point to it in some Python code:</p>
<div class="highlight-python"><pre>[filter:gzip]
paste.filter_app_factory = simplesite.lib.middleware:make_gzip_middleware</pre>
</div>
<p id="index-769">In this last approach, rather than using the word <tt class="docutils literal"><span class="pre">use</span></tt>, you have to specify the entry point group name as the option name. This might seem slightly counterintuitive, but it is how the config file format works.</p>
</div>
<div class="section" id="configuration-inheritance">
<h3>Configuration Inheritance<a class="headerlink" href="#configuration-inheritance" title="Permalink to this headline">¶</a></h3>
<p id="index-770">Paste Deploy also supports a very simple form of inheritance so that if you have to specify multiple sections with similar configuration options, you don’t have to write them all out again. Here’s how it works:</p>
<div class="highlight-python"><pre>[app:main]
use = egg:AnimalTracker
cat = Tabby
dog = St Bernard

[app:other]
use = main
dog = Jack Russell</pre>
</div>
<p>In this example, the <tt class="docutils literal"><span class="pre">other</span></tt> app inherits all the options from the <tt class="docutils literal"><span class="pre">main</span></tt> app, including the value for the <tt class="docutils literal"><span class="pre">cat</span></tt> option, but it overrides the <tt class="docutils literal"><span class="pre">dog</span></tt> option with the value <tt class="docutils literal"><span class="pre">Jack</span> <span class="pre">Russell</span></tt>.</p>
<p id="index-771">The Pylons config file is actually a very flexible format. You can learn more about it at <a class="reference external" href="http://pythonpaste.org/deploy/">http://pythonpaste.org/deploy/</a>.</p>
</div>
</div>
<div class="section" id="accessing-the-pylons-wsgi-application-and-other-objects-programmatically">
<h2>Accessing the Pylons WSGI Application and Other Objects Programmatically<a class="headerlink" href="#accessing-the-pylons-wsgi-application-and-other-objects-programmatically" title="Permalink to this headline">¶</a></h2>
<p>It is all very well for the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span></tt> and <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> commands to be able to load WSGI applications and middleware from the config file, but sometimes you might want to be able to access them yourself. You frequently need to do this if you want to serve the application with a tool other than Paste’s HTTP server, as you’ll see when you learn about deployment in Chapter 21.</p>
<div class="section" id="accessing-the-server-application-and-filters">
<h3>Accessing the Server, Application, and Filters<a class="headerlink" href="#accessing-the-server-application-and-filters" title="Permalink to this headline">¶</a></h3>
<p id="index-772">Paste Deploy provides three functions to allow you to access servers, applications (pipeline, composite, and app sections), and filters:</p>
<dl class="docutils" id="index-773">
<dt><tt class="docutils literal"><span class="pre">loadserver(uri,</span> <span class="pre">name=None,</span> <span class="pre">**kw)</span></tt></dt>
<dd><p class="first">This function returns a server wrapper function that takes the WSGI application to serve as its first argument. When called, the function uses the options from the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section, together with the WSGI application passed to it, to start the server. If your config file defines multiple server sections, you can specify the one to use with <tt class="docutils literal"><span class="pre">name</span></tt>. For example, here you load the <tt class="docutils literal"><span class="pre">alternative</span></tt> server instead of the <tt class="docutils literal"><span class="pre">main</span></tt> one:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadserver</span>
<span class="n">server_wrapper</span> <span class="o">=</span> <span class="n">loadserver</span><span class="p">(</span><span class="s">&#39;config:/path/to/config.ini&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;alternative&#39;</span><span class="p">)</span>
<span class="c"># Serve the application with the options in ``[server:alternative]``</span>
<span class="n">server_wrapper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<dl class="docutils" id="index-774">
<dt><tt class="docutils literal"><span class="pre">loadapp(uri,</span> <span class="pre">name=None,</span> <span class="pre">**kw)</span></tt></dt>
<dd><p class="first">This is the function you are most likely to use, which returns a WSGI app based on the name of the application section you specify. If you don’t specify a section name, it assumes you want the main section so loads the application based on the information in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt>, <tt class="docutils literal"><span class="pre">[composite:main]</span></tt>, or <tt class="docutils literal"><span class="pre">[pipeline:main]</span></tt> section in the config file, depending on which you’ve used. For example:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">&#39;config:/path/to/config.ini&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<dl class="docutils" id="index-775">
<dt><tt class="docutils literal"><span class="pre">loadfilter(uri,</span> <span class="pre">name=None,</span> <span class="pre">**kw)</span></tt></dt>
<dd><p class="first">This function behaves similarly to <tt class="docutils literal"><span class="pre">loadserver()</span></tt> returning a wrapper function that, when called with a WSGI application, returns the application wrapped in the middleware specified in the filter section named <tt class="docutils literal"><span class="pre">name</span></tt> and constructed with the options from that section.</p>
<p>This doesn’t load filter-app factories, just filter factories.</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadfilter</span>
<span class="n">filter_wrapper</span> <span class="o">=</span> <span class="n">loadfilter</span><span class="p">(</span><span class="s">&#39;config:/path/to/config.ini&#39;</span><span class="p">)</span>
<span class="c"># Wrap the application with the middleware specified by ``[filter:main]``</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">filter_wrapper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p id="index-776">Notice that each of these functions takes a config URI, not simply a path to a config file as you might have expected. Each of these functions also takes a <tt class="docutils literal"><span class="pre">relative_to</span></tt> argument that you can use if you want to specify a relative location for the URI; you can use it like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadserver</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">loadserver</span><span class="p">(</span><span class="s">&#39;config:config.ini&#39;</span><span class="p">,</span> <span class="n">relative_to</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="c"># Start the server</span>
<span class="n">server</span><span class="p">(</span><span class="n">wsgi_app</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-777">If you try to use a relative path without specifying <tt class="docutils literal"><span class="pre">relative_to</span></tt>, you will get an error explaining <tt class="docutils literal"><span class="pre">no</span> <span class="pre">context</span> <span class="pre">keyword</span> <span class="pre">argument</span> <span class="pre">given</span></tt>. This error isn’t particularly informative, but specifying <tt class="docutils literal"><span class="pre">relative_to</span></tt> resolves this error.</p>
</div>
<div class="section" id="accessing-configuration-options">
<h3>Accessing Configuration Options<a class="headerlink" href="#accessing-configuration-options" title="Permalink to this headline">¶</a></h3>
<p id="index-778">There are occasions when even the functions described so far aren’t low level enough and you want to get directly at the individual options set. For this circumstance, Paste Deploy provides an <tt class="docutils literal"><span class="pre">appconfig()</span></tt> function that returns a config object. It has the following definition:</p>
<div class="highlight-python"><pre>def appconfig(uri, name=None, relative_to=None, global_conf=None)</pre>
</div>
<p>The config object returned has two attributes, <tt class="docutils literal"><span class="pre">local_conf</span></tt> and <tt class="docutils literal"><span class="pre">global_conf</span></tt>, both of which are dictionaries. The <tt class="docutils literal"><span class="pre">.global_conf</span></tt> dictionary contains all the options from the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section, and the <tt class="docutils literal"><span class="pre">.local_conf</span></tt> dictionary contains all the options from whichever application section you specified as the <tt class="docutils literal"><span class="pre">name</span></tt> argument to <tt class="docutils literal"><span class="pre">appconfig()</span></tt> defaulting to <tt class="docutils literal"><span class="pre">main</span></tt> if no <tt class="docutils literal"><span class="pre">name</span></tt> is specified.</p>
<p>The config object itself behaves like a dictionary too. It has all the keys of both the <tt class="docutils literal"><span class="pre">local_conf</span></tt> dictionary and the <tt class="docutils literal"><span class="pre">global_conf</span></tt> dictionary, but where two keys have different values, the <tt class="docutils literal"><span class="pre">local_conf</span></tt> value overrides the global conf value. The config object therefore has the same values you would access as <tt class="docutils literal"><span class="pre">pylons.config['app_conf']</span></tt> and the <tt class="docutils literal"><span class="pre">.global_conf</span></tt> attribute contains the same values you would access as <tt class="docutils literal"><span class="pre">pylons.config['global_conf']</span></tt>.</p>
<p>Here’s an example demonstrating this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">appconfig</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">config</span> <span class="o">=</span> <span class="n">appconfig</span><span class="p">(</span><span class="s">&#39;config:/path/to/config.ini&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">combined</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">combined</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">global_conf</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">combined</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">local_conf</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">==</span> <span class="n">combined</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="go">True</span>
</pre></div>
</div>
<p id="index-779">As you can see, the configuration in the <tt class="docutils literal"><span class="pre">config</span></tt> object itself matches that obtained by combining the <tt class="docutils literal"><span class="pre">global_conf</span></tt> and <tt class="docutils literal"><span class="pre">local_conf</span></tt> dictionaries.</p>
</div>
<div class="section" id="creating-a-pylons-application-with-paste-deploy">
<h3>Creating a Pylons Application with Paste Deploy<a class="headerlink" href="#creating-a-pylons-application-with-paste-deploy" title="Permalink to this headline">¶</a></h3>
<p id="index-780">Using the Paste Deploy <tt class="docutils literal"><span class="pre">loadapp()</span></tt> function described earlier is the best way of getting access to the Pylons WSGI application. At the start of this chapter, you learned how to use entry points to access the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function in your project’s <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> file. This function is a standard Paste Deploy app factory, so although you can create a Pylons WSGI application object by calling it directly with the configuration options you want to create the application with, it is usually much easier to use the <tt class="docutils literal"><span class="pre">loadapp()</span></tt> function. This function does both steps at once, looking up the entry point and calling the <tt class="docutils literal"><span class="pre">make_app()</span></tt> factory with the configuration options from the config file.</p>
<p>You can get the WSGI application object from your Pylons configuration file like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
<span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">&#39;config:/path/to/simplesite/development.ini&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can then serve the file using a WSGI server. Here is an example using the WSGI Reference Implementation server included in Python 2.5 and newer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
<span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">&#39;config:/path/to/config.ini&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">wsgiref</span> <span class="kn">import</span> <span class="n">simple_server</span>
<span class="n">httpd</span> <span class="o">=</span> <span class="n">simple_server</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="mf">8000</span><span class="p">),</span> <span class="n">simple_server</span><span class="o">.</span><span class="n">WSGIRequestHandler</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">wsgi_app</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-781">The <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span></tt> command you are used to using while developing Pylons projects combines these two steps of creating a WSGI app from the config file and serving the resulting file to give the illusion that it is serving the config file directly. You can test the example by visiting <a class="reference external" href="http://localhost:8000/">http://localhost:8000</a>.</p>
</div>
</div>
<div class="section" id="the-pylons-middleware-stack">
<h2>The Pylons Middleware Stack<a class="headerlink" href="#the-pylons-middleware-stack" title="Permalink to this headline">¶</a></h2>
<p id="index-782">Let’s just recap what you’ve learned so far about how a Pylons application is constructed:</p>
<blockquote>
<ul class="simple">
<li>A Pylons application is loaded from a config file in a format understood by the Paste Deploy package.</li>
<li>The Paste Deploy <tt class="docutils literal"><span class="pre">loadapp()</span></tt> function is called to parse the config file.</li>
<li>The <tt class="docutils literal"><span class="pre">use</span></tt> option in the main application section (be it an <tt class="docutils literal"><span class="pre">[app:main]</span></tt>, <tt class="docutils literal"><span class="pre">[pipeline:main]</span></tt>, or <tt class="docutils literal"><span class="pre">[composite:main]</span></tt> section) is used to determine the factory to use to create the Pylons application.</li>
<li>The <tt class="docutils literal"><span class="pre">make_app()</span></tt> factory in the project’s <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> file is called and returns the configured Pylons app ready to serve requests.</li>
</ul>
</blockquote>
<p id="index-783">If you open a Pylons project’s <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> file and look at the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function, you will see that a WSGI application named <tt class="docutils literal"><span class="pre">app</span></tt> is created. This is your Pylons application object and is what is ultimately responsible for calling the actions in the controllers you have created. The <tt class="docutils literal"><span class="pre">make_app()</span></tt> function looks like this at the time of writing:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_app</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">full_stack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">app_conf</span><span class="p">):</span>

    <span class="c"># Configure the Pylons environment</span>
    <span class="n">load_environment</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">app_conf</span><span class="p">)</span>

    <span class="c"># The Pylons WSGI app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">PylonsApp</span><span class="p">()</span>

    <span class="c"># CUSTOM MIDDLEWARE HERE (filtered by error handling middlewares)</span>

    <span class="c"># Routing/Session/Cache Middleware</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">RoutesMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;routes.map&#39;</span><span class="p">])</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">SessionMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">CacheMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">full_stack</span><span class="p">):</span>
        <span class="c"># Handle Python exceptions</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.errorware&#39;</span><span class="p">])</span>

        <span class="c"># Display error documents for 401, 403, 404 status codes (and</span>
        <span class="c"># 500 when debug is disabled)</span>
        <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]):</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="p">[</span><span class="mf">400</span><span class="p">,</span> <span class="mf">401</span><span class="p">,</span> <span class="mf">403</span><span class="p">,</span> <span class="mf">404</span><span class="p">,</span> <span class="mf">500</span><span class="p">])</span>

    <span class="c"># Establish the Registry for this application</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">RegistryManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># Static files (If running in production, and Apache or another web</span>
    <span class="c"># server is handling this static content, remove the following 2 lines)</span>
    <span class="n">static_app</span> <span class="o">=</span> <span class="n">StaticURLParser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.paths&#39;</span><span class="p">][</span><span class="s">&#39;static_files&#39;</span><span class="p">])</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Cascade</span><span class="p">([</span><span class="n">static_app</span><span class="p">,</span> <span class="n">app</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p id="index-784">After the <tt class="docutils literal"><span class="pre">app</span></tt> object is created, it is then wrapped in lots of different WSGI middleware components. Each of the components performs a different task:</p>
<dl class="docutils" id="index-785">
<dt><tt class="docutils literal"><span class="pre">RoutesMiddleware</span></tt></dt>
<dd>This is responsible for matching a URL against the route map you’ve specified in <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> and setting up the routing variables.</dd>
</dl>
<dl class="docutils" id="index-786">
<dt><tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt></dt>
<dd>This is responsible for providing the Pylons <tt class="docutils literal"><span class="pre">session</span></tt> global that provides the session functionality you used in Chapter 8 to create the flash message.</dd>
</dl>
<dl class="docutils" id="index-787">
<dt><tt class="docutils literal"><span class="pre">CacheMiddleware</span></tt></dt>
<dd>This sets up a Beaker <tt class="docutils literal"><span class="pre">CacheManager</span></tt> and provides the caching facility you saw in Chapter 5 when I covered caching templates. The <tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt> is also provided by the Beaker package.</dd>
</dl>
<dl class="docutils" id="index-788">
<dt><tt class="docutils literal"><span class="pre">ErrorHandler</span></tt></dt>
<dd>This catches any exceptions that have occurred during the processing of a request and, depending on the settings in the config file, either will return a 500 Internal Server Error for the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware mentioned next to handle, will email an error report or will start the Pylons interactive debugger you learned about in Chapter 4 to help you track down where the error occurred.</dd>
</dl>
<dl class="docutils" id="index-789">
<dt><tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt></dt>
<dd>This catches responses with certain HTTP status codes such as 401, 403, 404, and sometimes 500 and internally redirects the request to the error controller in your project’s <tt class="docutils literal"><span class="pre">controllers/error.py</span></tt> file so that a nice-looking error page can be generated.</dd>
</dl>
<dl class="docutils" id="index-790">
<dt><tt class="docutils literal"><span class="pre">RegistryManager</span></tt></dt>
<dd>This keeps track of which of the Pylons global variables should be used in each thread of execution so that information from one request doesn’t get confused with information from another request being handled by Pylons at the same time.</dd>
</dl>
<dl class="docutils" id="index-791">
<dt><tt class="docutils literal"><span class="pre">Cascade</span></tt></dt>
<dd>This handles two apps, a <tt class="docutils literal"><span class="pre">StaticURLParser</span></tt> application to serve files from the <tt class="docutils literal"><span class="pre">public</span></tt> directory and the Pylons <tt class="docutils literal"><span class="pre">app</span></tt> itself. On each request the two applications are called in turn until one of them is able to handle the request URL.</dd>
</dl>
<p id="index-792">The reason this architecture is so powerful is that you are free to add your own middleware to the stack, enabling you to completely change the way Pylons behaves if you want. For example, if you didn’t want the error documents support, you could comment out the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware. If you wanted all the responses to be Gzip compressed to save bandwidth, you can simply add Gzip middleware, as you’ve seen already.</p>
<div class="section" id="application-state-vs-request-state">
<h3>Application State vs. Request State<a class="headerlink" href="#application-state-vs-request-state" title="Permalink to this headline">¶</a></h3>
<p id="index-793">Once the application has been created with all the middleware components correctly set up, it is held in memory by the server, ready to receive a request. The application object, the middleware, and all the other Pylons objects that were configured when <tt class="docutils literal"><span class="pre">make_app()</span></tt> was called will persist between each request. This means the <tt class="docutils literal"><span class="pre">make_app()</span></tt> factory is called only once when the Pylons application is created, but the <tt class="docutils literal"><span class="pre">app</span></tt> object returned from <tt class="docutils literal"><span class="pre">make_app()</span></tt> is called on each request. This makes Pylons very fast because the <tt class="docutils literal"><span class="pre">app</span></tt> object doesn’t need to be re-created to handle a request, but it also means that the process of creating a Pylons application is completely separate from the process of handling a request.</p>
<p id="index-794">In the next sections, you’ll see in detail which processes occur when the <tt class="docutils literal"><span class="pre">app</span></tt> object is being set up and which occur before and after a request has been handled by a controller action.</p>
</div>
</div>
<div class="section" id="creating-an-application">
<h2>Creating an Application<a class="headerlink" href="#creating-an-application" title="Permalink to this headline">¶</a></h2>
<p>You’ve already seen the objects and middleware involved in the creation of an application, but in the following sections, you’ll see in detail what happens in each of the components as the application is created.</p>
<div class="section" id="loading-the-pylons-environment">
<h3>Loading the Pylons Environment<a class="headerlink" href="#loading-the-pylons-environment" title="Permalink to this headline">¶</a></h3>
<p id="index-795">The first thing that happens in <tt class="docutils literal"><span class="pre">make_app()</span></tt> is a call to load the environment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Configure the Pylons environment</span>
<span class="n">load_environment</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">app_conf</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is actually located in your project’s <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file and is responsible for any configuration of your application that you don’t want to expose to the end user of an application in the config file. You have to be slightly careful when editing <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> because some aspects of Pylons’ behavior rely on the objects that are set up there.</p>
<p id="index-796">The <tt class="docutils literal"><span class="pre">load_environment()</span></tt> function is responsible for the following:</p>
<blockquote>
<ul class="simple">
<li>Setting up the paths that will be used in your project to access controllers, static files, and templates. By default, the paths are configured to point to your project’s <tt class="docutils literal"><span class="pre">controllers</span></tt>, <tt class="docutils literal"><span class="pre">public</span></tt>, and <tt class="docutils literal"><span class="pre">templates</span></tt> directories, respectively.</li>
<li>Initializing the Pylons <tt class="docutils literal"><span class="pre">config</span></tt> object with information about the project including where the function to set up the routes is, which module should be used as the <tt class="docutils literal"><span class="pre">h</span></tt> object within templates, and which object should be used as the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object. By default, these are set to the <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> file’s <tt class="docutils literal"><span class="pre">make_map()</span></tt> function, the project’s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> module, and an instance of the <tt class="docutils literal"><span class="pre">Globals</span></tt> class in <tt class="docutils literal"><span class="pre">lib/app_globals.py</span></tt>, respectively.</li>
<li>Using the config object to indirectly attach a <tt class="docutils literal"><span class="pre">mako_lookup</span></tt> attribute to the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object, which will later be used by the <tt class="docutils literal"><span class="pre">render()</span></tt> function to render Mako templates. The <tt class="docutils literal"><span class="pre">mako_lookup</span></tt> attribute is actually an instance of a Mako <tt class="docutils literal"><span class="pre">TemplateLookup</span></tt> object, and as you’ll recall from Chapter 5, this can be customized to change Mako’s behavior or replaced if support for a different templating language is required.</li>
<li>Setting up a SQLAlchemy engine and initializing the model (if you chose a project template that included SQLAlchemy when running the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command). The way the engine is created and the role of <tt class="docutils literal"><span class="pre">init_engine()</span></tt> is explained in Chapter 7.</li>
</ul>
</blockquote>
<p>At the end of the <tt class="docutils literal"><span class="pre">load_environment()</span></tt> function are these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># CONFIGURATION OPTIONS HERE (note: all config options will override</span>
<span class="c"># any Pylons config options)</span>
</pre></div>
</div>
<p id="index-797">Any further customization you want to do should usually happen after these lines.</p>
</div>
<div class="section" id="the-pylonsapp-instance">
<h3>The PylonsApp Instance<a class="headerlink" href="#the-pylonsapp-instance" title="Permalink to this headline">¶</a></h3>
<p id="index-798">After the environment has been loaded to set up the <tt class="docutils literal"><span class="pre">app_globals</span></tt>, <tt class="docutils literal"><span class="pre">h</span></tt>, and <tt class="docutils literal"><span class="pre">config</span></tt> objects as well as the template engine and SQLAlchemy (if necessary), a Pylons application is created. This is done with the following lines in <tt class="docutils literal"><span class="pre">make_app()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># The Pylons WSGI app</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">PylonsApp</span><span class="p">()</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance is the very heart of your Pylons application; it is defined in the <tt class="docutils literal"><span class="pre">pylons.wsgiapp</span></tt> module, and its instance (<tt class="docutils literal"><span class="pre">app</span></tt>) is a valid WSGI application. At this stage, all <tt class="docutils literal"><span class="pre">app</span></tt> has to do is initialize itself with the <tt class="docutils literal"><span class="pre">config</span></tt> object, the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object, and the package name and various options that will be used to set up the <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> during a request. This all happens behind the scenes and is not something you would normally have to deal with. You’ll hear more about the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance when I discuss how it behaves during a request.</p>
</div>
<div class="section" id="the-middleware-chain">
<h3>The Middleware Chain<a class="headerlink" href="#the-middleware-chain" title="Permalink to this headline">¶</a></h3>
<p id="index-799">Next, the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance <tt class="docutils literal"><span class="pre">app</span></tt> is wrapped in a series of different middleware components, each of which is initialized:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Routing/Session/Cache Middleware</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">RoutesMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;routes.map&#39;</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">SessionMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">CacheMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>First the <tt class="docutils literal"><span class="pre">RoutesMiddleware</span></tt> is initialized and is passed the route map it will be expected to deal with via the <tt class="docutils literal"><span class="pre">config['routes.map']</span></tt> object that was set up in the call to <tt class="docutils literal"><span class="pre">load_environment()</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You might be wondering how the <tt class="docutils literal"><span class="pre">config</span></tt> object was set up even though it wasn’t passed directly to <tt class="docutils literal"><span class="pre">load_environment()</span></tt>. Both <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> and <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> import the object from the <tt class="docutils literal"><span class="pre">pylons</span></tt> module, which itself imports it from <tt class="docutils literal"><span class="pre">pylons.configuration</span></tt>. The <tt class="docutils literal"><span class="pre">config</span></tt> object is defined as a module global and is an instance of <tt class="docutils literal"><span class="pre">pylons.configuration.PylonsConfig</span></tt>. It isn’t an ordinary global, though; it is inherited from a <tt class="docutils literal"><span class="pre">paste.config.DispatchingConifg</span></tt> object, which can keep different configurations separate in different threads. Because both files are accessing the same object, changes made in <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> are reflected in <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>.</p>
</div>
<p>After the <tt class="docutils literal"><span class="pre">RoutesMiddleware</span></tt> is set up, <tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt> and <tt class="docutils literal"><span class="pre">CacheMiddleware</span></tt> are both set up. These use the <tt class="docutils literal"><span class="pre">beaker.*</span></tt> configuration options from the <tt class="docutils literal"><span class="pre">config</span></tt> object in order to initialize themselves. The options specify where the session and cache stores should be set up. By default, this happens in a <tt class="docutils literal"><span class="pre">data</span></tt> directory relative to the config file being used to serve the application.</p>
<p id="index-800">What happens next depends on whether you’ve set <tt class="docutils literal"><span class="pre">full_stack</span></tt> to <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt> in the configuration file. If it is <tt class="docutils literal"><span class="pre">true</span></tt>, which is the default, then the <tt class="docutils literal"><span class="pre">ErrorHandler</span></tt> and <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware will be set up; otherwise, they’ll be ignored.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">full_stack</span><span class="p">):</span>
    <span class="c"># Handle Python exceptions</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.errorware&#39;</span><span class="p">])</span>

    <span class="c"># Display error documents for 401, 403, 404 status codes (and</span>
    <span class="c"># 500 when debug is disabled)</span>
    <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="p">[</span><span class="mf">400</span><span class="p">,</span> <span class="mf">401</span><span class="p">,</span> <span class="mf">403</span><span class="p">,</span> <span class="mf">404</span><span class="p">,</span> <span class="mf">500</span><span class="p">])</span>
</pre></div>
</div>
<p>If the <tt class="docutils literal"><span class="pre">fullstack</span></tt> option is enabled, the <tt class="docutils literal"><span class="pre">ErrorHandler</span></tt> is set up with options from <tt class="docutils literal"><span class="pre">config['pylons.errorware']</span></tt>. These in turn are set up when the <tt class="docutils literal"><span class="pre">config</span></tt> object’s <tt class="docutils literal"><span class="pre">init_app()</span></tt> method is called in <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> and contain the options that will be used in error reporting such as the e-mail address to send error reports to, the SMTP server to use, and who the e-mail should appear to have come from. The values used are all obtained from the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section of the config file. The subject of the e-mail and the error log to use are also passed to the <tt class="docutils literal"><span class="pre">ErrorHandler</span></tt> in the same dictionary, but these values cannot be configured in the config file.</p>
<p>If debug mode is on, the <tt class="docutils literal"><span class="pre">ErrorHandler</span></tt> middleware sets up the WebError package’s <tt class="docutils literal"><span class="pre">EvalException</span></tt> middleware, which provides the Pylons Interactive Debugger you first saw in Chapter 4; otherwise, it sets up the WebError package’s <tt class="docutils literal"><span class="pre">ErrorMiddleware</span></tt> to handle the e-mail error reports.</p>
<p>The <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware doesn&#8217;t do anything particularly exciting during application initialization, it just wraps itself around the <tt class="docutils literal"><span class="pre">app</span></tt> object.</p>
<p>Next to be wrapped around the <tt class="docutils literal"><span class="pre">app</span></tt> object is the <tt class="docutils literal"><span class="pre">RegistryManager</span></tt> middleware. This doesn’t need any configuration as the application is being created, but its importance will become apparent when you look at how Pylons handles a request in the next section.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Establish the Registry for this application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">RegistryManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-801">The final piece of middleware is the <tt class="docutils literal"><span class="pre">Cascade</span></tt>. This is configured with an instance of a <tt class="docutils literal"><span class="pre">StaticURLParser</span></tt> as its first argument. The <tt class="docutils literal"><span class="pre">StaticURLParser</span></tt> will be responsible for serving static files and is configured with <tt class="docutils literal"><span class="pre">config['pylons.paths']['static_files']</span></tt>, which was set up in <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> to point to your project’s <tt class="docutils literal"><span class="pre">public</span></tt> directory. The second item in the list specified as an argument to the <tt class="docutils literal"><span class="pre">Cascade</span></tt> is the <tt class="docutils literal"><span class="pre">app</span></tt> object all the middleware components have been wrapping.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Static files (If running in production, and Apache or another web</span>
<span class="c"># server is handling this static content, remove the following 2 lines)</span>
<span class="n">static_app</span> <span class="o">=</span> <span class="n">StaticURLParser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.paths&#39;</span><span class="p">][</span><span class="s">&#39;static_files&#39;</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Cascade</span><span class="p">([</span><span class="n">static_app</span><span class="p">,</span> <span class="n">app</span><span class="p">])</span>
<span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p>At this point, the application state has been configured. All the middleware has been initialized, and the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> and <tt class="docutils literal"><span class="pre">StaticURLParser</span></tt> WSGI applications have been initialized. At this point, the <tt class="docutils literal"><span class="pre">app</span></tt> object is ready to handle a request, and this is where the middleware components play an important part.</p>
<p id="index-802">With the application state successfully configured, <tt class="docutils literal"><span class="pre">make_app()</span></tt> can return the <tt class="docutils literal"><span class="pre">app</span></tt> object to the server, ready to be called to handle a request.</p>
</div>
</div>
<div class="section" id="handling-a-request">
<h2>Handling a Request<a class="headerlink" href="#handling-a-request" title="Permalink to this headline">¶</a></h2>
<p id="index-803">You’ll remember from the previous chapter that when a WSGI application is called (whether wrapped in middleware or not), it is passed two arguments, the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary and the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable. Let’s assume for the moment that there are no pipelines or composite applications set up in the config file. In that case, because the <tt class="docutils literal"><span class="pre">Cascade</span></tt> middleware was the last middleware that wrapped the <tt class="docutils literal"><span class="pre">app</span></tt> object, it will be the first one to be passed the <tt class="docutils literal"><span class="pre">environ</span></tt> and <tt class="docutils literal"><span class="pre">start_response()</span></tt> arguments.</p>
<p id="index-804">This means that although the middleware components were set up from top to bottom when they were being initialized, it is actually the middleware at the bottom of the <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> file that receives the request information first, and the request information passes from the bottom of the middleware chain toward the top and eventually to the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance, <tt class="docutils literal"><span class="pre">app</span></tt>. Figure 17-1 illustrates this request behavior.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1701.png"><img alt="Figure 17-1. Middleware request architecture" src="_images/9349f1701.png" /></a>
<p class="caption">Figure 17-1. Middleware request architecture</p>
</div>
<div class="section" id="the-cascade">
<h3>The Cascade<a class="headerlink" href="#the-cascade" title="Permalink to this headline">¶</a></h3>
<p id="index-805">The first piece of middleware to be called on any request is the <tt class="docutils literal"><span class="pre">Cascade</span></tt>. When it is passed <tt class="docutils literal"><span class="pre">environ</span></tt> and <tt class="docutils literal"><span class="pre">start_response()</span></tt>, it first calls <tt class="docutils literal"><span class="pre">static_app</span></tt> to see whether the URL requested matches a file in your project’s <tt class="docutils literal"><span class="pre">public</span></tt> directory. If <tt class="docutils literal"><span class="pre">static_app</span></tt> returns a 404 Not Found response, the <tt class="docutils literal"><span class="pre">Cascade</span></tt> will instead call the main Pylons application.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is why you need to delete the <tt class="docutils literal"><span class="pre">public/index.html</span></tt> file before the root URL of the site will serve content from a controller. If you changed the order of the applications in the <tt class="docutils literal"><span class="pre">Cascade</span></tt>, you would not need to delete the file because the Pylons application would be checked first before the <tt class="docutils literal"><span class="pre">public</span></tt> directory, but since more files are likely to be handled by <tt class="docutils literal"><span class="pre">static_app</span></tt> than Pylons during each page view, it is usually more efficient to keep the order as it is.</p>
</div>
<p>The next middleware in the chain is the <tt class="docutils literal"><span class="pre">RegistryManager</span></tt>, which is responsible for managing the Pylons globals in a thread-safe way. Let’s look at it in detail before returning to the middleware chain.</p>
</div>
<div class="section" id="the-registry-manager-stackedobjectproxy-and-pylons-globals">
<h3>The Registry Manager, StackedObjectProxy, and Pylons Globals<a class="headerlink" href="#the-registry-manager-stackedobjectproxy-and-pylons-globals" title="Permalink to this headline">¶</a></h3>
<p id="index-806">Pylons aims to avoid the use of any complex Python code that appears to behave in a “magical” way, but there is one aspect of the Pylons architecture that often appears to be magic to those who haven’t seen anything similar before: the Pylons globals. People wonder how a module global such as the Pylons template context <tt class="docutils literal"><span class="pre">c</span></tt> can be available throughout an application and yet take a different value depending on the thread in which it is executing.</p>
<p id="index-807">The answer is that Pylons globals (such as <tt class="docutils literal"><span class="pre">c</span></tt>, <tt class="docutils literal"><span class="pre">request</span></tt>, and <tt class="docutils literal"><span class="pre">response</span></tt>) are all instances of the <tt class="docutils literal"><span class="pre">paste.registry.StackedObjectProxy</span></tt> class and not the objects they appear to be at all. When you access their properties or methods, they return the result of applying that action to the object they are associated with in the current thread so that they behave as if they were that object. Put another way, they <em>proxy</em> attributes to the correct object in a thread-safe way based on the scope of the request in which they run to give the illusion of being the objects themselves.</p>
<p>You can always access the underlying object for a particular global in the current request by calling the <tt class="docutils literal"><span class="pre">_current_obj()</span></tt> method on a <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt>. For example, to obtain the <em>actual</em> request object being used in a request, rather than the <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> that is <em>proxying</em> to it, you could use <tt class="docutils literal"><span class="pre">pylons.request._current_obj()</span></tt>.</p>
<p>Now that you know what a <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> is, let’s look at the role of the <tt class="docutils literal"><span class="pre">RegistryManager</span></tt> during a request. Here’s an example based on the Paste Registry documentation, which demonstrates how the globals are set up and used in a pure-WSGI environment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.registry</span> <span class="kn">import</span> <span class="n">RegistryManager</span><span class="p">,</span> <span class="n">StackedObjectProxy</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">StackedObjectProxy</span><span class="p">()</span>

<span class="c"># WSGI app stack (imagine the middleware stack in config/middleware.py)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">RegistryManager</span><span class="p">(</span><span class="n">App</span><span class="p">)</span>

<span class="c"># WSGI app (imagine the PylonsApp)</span>
<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>  <span class="c"># The request-like theread-local object you want</span>
                                <span class="c"># to access via pylons.myglobal</span>
        <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;paste.registry&#39;</span><span class="p">):</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;paste.registry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="o">...</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">RegistryManager</span></tt> adds a new <tt class="docutils literal"><span class="pre">Registry()</span></tt> as <tt class="docutils literal"><span class="pre">environ['paste.registry']</span></tt> on each request and calls the existing registry’s <tt class="docutils literal"><span class="pre">prepare()</span></tt> method to set it up for the new registry context.</p>
<p>The registration process involves telling the registry which objects in the current thread should be attached to which globals. This ensures that during the scope of the request, attributes from the correct real object will be returned any time you access an attribute or method of one of the Pylons global objects, even though the global is really a <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt>.</p>
<p>You’ll see in the section “The Role of PylonsApp” that the registration happens within the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance <tt class="docutils literal"><span class="pre">app</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-808">If you ever see <tt class="docutils literal"><span class="pre">StackedProxyObject</span></tt> errors in your Pylons application, it may be because you are trying to access one of the Pylons globals outside the scope of a request and therefore before Pylons has had a chance to set up and register the real object with the particular <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> global it is associated with.</p>
</div>
</div>
<div class="section" id="returning-to-the-middleware-chain">
<h3>Returning to the Middleware Chain<a class="headerlink" href="#returning-to-the-middleware-chain" title="Permalink to this headline">¶</a></h3>
<p id="index-809">Now that you have an idea of how the <tt class="docutils literal"><span class="pre">RegistryManager</span></tt> middleware works, let’s continue looking at how the other middleware components in the chain behave during a request.</p>
<p>If the <tt class="docutils literal"><span class="pre">full_stack</span></tt> option is set to <tt class="docutils literal"><span class="pre">true</span></tt>, the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> and <tt class="docutils literal"><span class="pre">ErrorHandler</span></tt> middleware are called. The <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware creates a copy of the request information, but it doesn’t do anything with it until it deals with the response after a controller action is called. Next, the <tt class="docutils literal"><span class="pre">CacheMiddleware</span></tt> and then the <tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt> are called, each adding information to the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary that the <tt class="docutils literal"><span class="pre">PylonsApp</span> <span class="pre">app</span></tt> instance will use when it is eventually called to set up the Pylons cache and session functionality.</p>
<p>Next, the <tt class="docutils literal"><span class="pre">RoutesMiddleware</span></tt> is called. This now assembles the request URL from the information in the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary it is passed and works through the route map as you saw in Chapter 9. It adds the routing variables it matches to the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary as <tt class="docutils literal"><span class="pre">environ['wsgiorg.routing_args']</span></tt>.</p>
<p>Finally, the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instance, <tt class="docutils literal"><span class="pre">app</span></tt>, gets called itself.</p>
</div>
<div class="section" id="the-role-of-pylonsapp">
<h3>The Role of PylonsApp<a class="headerlink" href="#the-role-of-pylonsapp" title="Permalink to this headline">¶</a></h3>
<p id="index-810">The ultimate responsibility of <tt class="docutils literal"><span class="pre">app</span></tt> is to call a Pylons controller action and return a response, but it has to do a number of things first. Each of these is handled by a different method on the <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> class, and they are called in the order described here:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">PylonsApp.setup_app_env()</span></tt></dt>
<dd>This creates all the global objects for the request including the Pylons <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects, the translator used for internationalization, and the Pylons template context global <tt class="docutils literal"><span class="pre">c</span></tt>. It adds these and other objects to the template context object as attributes and makes it available as <tt class="docutils literal"><span class="pre">pylons.pylons</span></tt> in the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary.</dd>
<dt><tt class="docutils literal"><span class="pre">PylonsApp.register_globals()</span></tt></dt>
<dd><p class="first">If the <tt class="docutils literal"><span class="pre">RegistryManager</span></tt> middleware is present, each of the Pylons globals is registered with the registry. This includes <tt class="docutils literal"><span class="pre">pylons.response</span></tt>, <tt class="docutils literal"><span class="pre">pylons.request</span></tt>, <tt class="docutils literal"><span class="pre">pylons.app_globals</span></tt>, <tt class="docutils literal"><span class="pre">pylons.config</span></tt>, <tt class="docutils literal"><span class="pre">pylons.h</span></tt>, <tt class="docutils literal"><span class="pre">pylons.c</span></tt>, and <tt class="docutils literal"><span class="pre">pylons.translator</span></tt>. It will also register <tt class="docutils literal"><span class="pre">pylons.session</span></tt> and <tt class="docutils literal"><span class="pre">pylons.cache</span></tt> if the <tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt> and <tt class="docutils literal"><span class="pre">CacheMiddleware</span></tt> are present. Pylons also adds a <tt class="docutils literal"><span class="pre">pylons.url</span></tt> object that is simply the current request URL.</p>
<p class="last">At this point, all of these objects, when imported from the <tt class="docutils literal"><span class="pre">pylons</span></tt> module in your application, will proxy the attributes and methods you call on them to the correct underlying objects for the current request thread (that is, the ones created in the <tt class="docutils literal"><span class="pre">PylonsApp.setup_app_env()</span></tt> call or as the request passed through the middleware stack).</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">PylonsApp.load_test_env()</span></tt></dt>
<dd>If Pylons is operating in testing mode, this method will be called to add the standard Pylons environment variables described earlier to <tt class="docutils literal"><span class="pre">environ['paste.testing_variables']</span></tt> so that they are available as attributes of the <tt class="docutils literal"><span class="pre">paste.fixture</span> <span class="pre">response</span></tt> object you learned about in Chapter 12. These currently include the attributes <tt class="docutils literal"><span class="pre">req</span></tt>, <tt class="docutils literal"><span class="pre">response</span></tt>, <tt class="docutils literal"><span class="pre">tmpl_context</span></tt> and its alias <tt class="docutils literal"><span class="pre">c</span></tt>, <tt class="docutils literal"><span class="pre">app_globals</span></tt> and its alias <tt class="docutils literal"><span class="pre">g</span></tt>, <tt class="docutils literal"><span class="pre">h</span></tt>, and <tt class="docutils literal"><span class="pre">config</span></tt>. If the session and cache middleware are present, it also sets up <tt class="docutils literal"><span class="pre">session</span></tt> and <tt class="docutils literal"><span class="pre">cache</span></tt> attributes.</dd>
</dl>
<p id="index-811">With all the objects correctly set up and registered, the dispatch to the controller action can begin. The following methods on <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> are called in this order:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">PylonsApp.resolve()</span></tt></dt>
<dd>This uses the routing arguments that the <tt class="docutils literal"><span class="pre">RoutesMiddleware</span></tt> added to <tt class="docutils literal"><span class="pre">environ['wsgiorg.routing_args']</span></tt> to retrieve a controller name and return the controller instance from the appropriate controller module.</dd>
<dt><tt class="docutils literal"><span class="pre">PylonsApp.dispatch()</span></tt></dt>
<dd>Finally, once the controller instance has been created, PylonsApp can call its <tt class="docutils literal"><span class="pre">__call__()</span></tt> method with <tt class="docutils literal"><span class="pre">environ</span></tt> and <tt class="docutils literal"><span class="pre">start_response()</span></tt> to begin the dispatch.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can override these last two methods to change how controllers are resolved and dispatched to if you want to customize Pylons’ behavior. You just need to use your derived object in <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> instead of <tt class="docutils literal"><span class="pre">PylonsApp</span></tt>.</p>
</div>
<p id="index-812">Even though the controller has now been dispatched, there is still some more you need to know about how the controller behaves to call the action.</p>
</div>
<div class="section" id="the-role-of-wsgicontroller">
<h3>The Role of WSGIController<a class="headerlink" href="#the-role-of-wsgicontroller" title="Permalink to this headline">¶</a></h3>
<p id="index-813">You’ll remember that your project’s controllers are inherited from <tt class="docutils literal"><span class="pre">BaseController</span></tt> in your project’s <tt class="docutils literal"><span class="pre">lib/base.py</span></tt> file and that <tt class="docutils literal"><span class="pre">BaseController</span></tt> is inherited from <tt class="docutils literal"><span class="pre">pylons.controller.core.WSGIController</span></tt>. This means that when <tt class="docutils literal"><span class="pre">PylonsApp</span></tt> instantiates and calls one of your project’s controllers, it is actually calling the <tt class="docutils literal"><span class="pre">WSGIController.__call__()</span></tt> method.</p>
<p>The <tt class="docutils literal"><span class="pre">WSGIController.__call__()</span></tt> method proceeds as follows. First, it checks to see whether the controller has a <tt class="docutils literal"><span class="pre">__before__()</span></tt> method. If it does, it calls its <tt class="docutils literal"><span class="pre">_inspect_call()</span></tt> method that then calls <tt class="docutils literal"><span class="pre">_get_method_args()</span></tt> to find out which arguments the method expects. The <tt class="docutils literal"><span class="pre">__before__()</span></tt> method is then called with those arguments.</p>
<p>Next, the controller action itself needs to be called. This is done with a call to the controller’s <tt class="docutils literal"><span class="pre">_dispatch_call()</span></tt> method, which finds out which action to call from the routing variables and then calls <tt class="docutils literal"><span class="pre">__inspect_call()</span></tt> itself to find out the arguments the action needs and to call the action with those arguments.</p>
<p>Finally, after the action is called, the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method checks to see whether an <tt class="docutils literal"><span class="pre">__after__()</span></tt> method exists. If it does, it will <em>always</em> be run on each request after the action, even if the action raises an exception or issues a redirect. Once again, <tt class="docutils literal"><span class="pre">__after__()</span></tt> is run by a call to the <tt class="docutils literal"><span class="pre">_inspect_call()</span></tt> method.</p>
<p id="index-814">If an action is not found to handle the request, the controller will raise an “Action Not Found” error in debug mode; otherwise, a 404 Not Found error will be returned.</p>
</div>
</div>
<div class="section" id="handling-the-response">
<h2>Handling the Response<a class="headerlink" href="#handling-the-response" title="Permalink to this headline">¶</a></h2>
<p id="index-815">Once the controller action is finally called, it can perform all manner of operations using the Pylons objects that have just been described. The whole of the first two parts of the book were dedicated to some of the ways Pylons could be used, so I won’t repeat them here.</p>
<p>The action can do any of the following:</p>
<blockquote>
<ul class="simple">
<li>Call the <tt class="docutils literal"><span class="pre">abort()</span></tt> or <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> functions to halt the request</li>
<li>Trigger an unexpected exception</li>
<li>Return a response that requires an error document</li>
<li>Return a function to stream content</li>
<li>Return a Unicode object or UTF-8 encoded string as a result</li>
</ul>
</blockquote>
<p>Let’s see how Pylons handles each of these cases.</p>
<div class="section" id="abort-redirect-to-and-httpexception">
<h3>abort(), redirect_to(), and HTTPException<a class="headerlink" href="#abort-redirect-to-and-httpexception" title="Permalink to this headline">¶</a></h3>
<p id="index-816">During each call to <tt class="docutils literal"><span class="pre">WSGIController``’s</span> <span class="pre">``_inspect_call()</span></tt> method when the request was being handled, the call to the method being inspected is wrapped in a <tt class="docutils literal"><span class="pre">try</span></tt>...``except`` block. If a certain type of exception known as an <tt class="docutils literal"><span class="pre">HTTPException</span></tt> occurs, Pylons will turn that exception into a normal HTTP response. This might seem like an odd behavior, but you’ll recall that Pylons provides the functions <tt class="docutils literal"><span class="pre">abort()</span></tt> and <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> in <tt class="docutils literal"><span class="pre">pylons.controllers.util</span></tt>. These functions work by raising an <tt class="docutils literal"><span class="pre">HTTPException</span></tt> when they are called, so it is the code in the <tt class="docutils literal"><span class="pre">_inspect_call()</span></tt> method that is responsible for making these functions result in the correct HTTP response.</p>
<p>Since the <tt class="docutils literal"><span class="pre">_inspect_call()</span></tt> method is also used to call the <tt class="docutils literal"><span class="pre">__before__()</span></tt> and <tt class="docutils literal"><span class="pre">__after__()</span></tt> actions if they exist, <tt class="docutils literal"><span class="pre">abort()</span></tt> and <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> can also be used in those actions.</p>
</div>
<div class="section" id="exception-handling">
<h3>Exception Handling<a class="headerlink" href="#exception-handling" title="Permalink to this headline">¶</a></h3>
<p id="index-817">When an exception that isn’t an <tt class="docutils literal"><span class="pre">HTTPException</span></tt> is raised, it goes straight through the <tt class="docutils literal"><span class="pre">try</span></tt>...``except`` block in <tt class="docutils literal"><span class="pre">_inspect_call()</span></tt> and isn’t caught until another <tt class="docutils literal"><span class="pre">try</span></tt>...``except`` block in the error-handling middleware. If debug mode was enabled, the <tt class="docutils literal"><span class="pre">EvalException</span></tt> middleware would have been set up. If not, the <tt class="docutils literal"><span class="pre">ErrorMiddleware</span></tt> would be in place.</p>
<p>If the <tt class="docutils literal"><span class="pre">EvalException</span></tt> middleware is set up, you will see the familiar Pylons Interactive Debugger. If not, an error report gets e-mailed, and the exception is turned into a 500 Internal Server Error response by the <tt class="docutils literal"><span class="pre">ErrorMiddleware</span></tt>.</p>
<p id="index-818">The <tt class="docutils literal"><span class="pre">StatusBasedRedirect</span></tt> middleware is below the error-handling middleware, so it receives the response <em>after</em> the error handler. At this point, the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware can’t distinguish between a 500 error triggered by the <tt class="docutils literal"><span class="pre">ErrorMiddleware</span></tt> or a 500 response from a Pylons controller action, so both are treated in the same way. In debug mode 500, responses are ignored by the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware; with debug mode disabled, an error document is displayed.</p>
</div>
<div class="section" id="error-documents">
<h3>Error Documents<a class="headerlink" href="#error-documents" title="Permalink to this headline">¶</a></h3>
<p id="index-819">When the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware receives a response that it was set up to intercept, it uses a copy of the request information (which it made when the request was passing through it toward the controller action) to start a subrequest to the error controller’s <tt class="docutils literal"><span class="pre">document()</span></tt> action to generate the familiar Pylons error page. You’ll see more about error documents, how they work, and how to customize them in Chapter 19.</p>
</div>
<div class="section" id="streaming-content">
<h3>Streaming Content<a class="headerlink" href="#streaming-content" title="Permalink to this headline">¶</a></h3>
<p id="index-820">If you need to stream content, you can always use one of the techniques described in Chapter 16 to mount a WSGI application in a Pylons application and set up the WSGI application to stream the content, but Pylons controller actions support streaming directly too.</p>
<p>You need to turn debug mode off to stream content because the exception middleware needs to have the entire response finished before it will pass on the result farther down the middleware chain.</p>
<p id="index-821">Turn off debug mode in your INI file by uncommenting the following line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#set debug = false</span>
</pre></div>
</div>
<p>Now that it’s disabled, returning an iterator object or a generator is sufficient to start streaming output. Here’s an example that sends a new number every two seconds:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">StreamingController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">output_pause</span><span class="p">():</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="k">while</span> <span class="mf">1</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">+=</span> <span class="mf">1</span>
                <span class="k">yield</span> <span class="n">number</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_pause</span><span class="p">()</span>
</pre></div>
</div>
<p>If you were to set this up in a Pylons project and visit <a class="reference external" href="http://localhost:5000/streaming/output">http://localhost:5000/streaming/output</a>, you should now see a number sent every two seconds, continuing forever. If not, ensure you have set <tt class="docutils literal"><span class="pre">debug</span></tt> to <tt class="docutils literal"><span class="pre">false</span></tt> in the config file.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-822">You have to be slightly careful when using <tt class="docutils literal"><span class="pre">time.sleep()</span></tt> in a production system because it causes the thread in which the Pylons application is running to simply sleep. If you are running Pylons on a multithreaded server using a worker pool of ten threads (which is the default setup you will be using when running <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span></tt>), there is a chance that in busy periods all your threads could just be sleeping rather than serving requests, and this will adversely affect the performance of your Pylons application.</p>
</div>
</div>
<div class="section" id="returning-unicode-from-an-action">
<h3>Returning Unicode from an Action<a class="headerlink" href="#returning-unicode-from-an-action" title="Permalink to this headline">¶</a></h3>
<p id="index-823">Now that you’ve seen some of the less usual cases for controller action responses, let’s look at what happens during a normal response when you return a string, most likely as a result of a call to <tt class="docutils literal"><span class="pre">render()</span></tt> to render a template.</p>
<p>First the response passes back from the <tt class="docutils literal"><span class="pre">WSGIController.__call__()</span></tt> method and the <tt class="docutils literal"><span class="pre">PylonsApp.dispatch()</span></tt> method to the middleware chain. The response will start at the middleware defined at the top of <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> and end with the ones defined at the bottom. As it passes through the <tt class="docutils literal"><span class="pre">SessionMiddleware</span></tt>, it will have a session cookie added to it if there was a session cookie in the request or if you called <tt class="docutils literal"><span class="pre">session.save()</span></tt> during the request to create a session store for the current user. The response will then pass back through the other middleware without being altered and eventually be sent back to the server where it is passed to the browser.</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This chapter covered a lot including entry points, the config file format, factories, and the details of Pylons’ request and response architecture. There is a lot going on in Pylons, but I hope this chapter will have given you a good enough overview for you to be able to explore the Pylons code for yourself.</p>
<p id="index-824">Pylons was always designed to be highly customizable and to expose all the relevant parts so that you can change it yourself if you need to do so. Feel free to read the Paste and Pylons source code to get a better idea of how they work and to experiment with alternative setups in your own Pylons applications.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 17: Pylons’ Internal Architecture</a><ul>
<li><a class="reference external" href="#a-bit-of-history">A Bit of History</a></li>
<li><a class="reference external" href="#egg-entry-points">Egg Entry Points</a><ul>
<li><a class="reference external" href="#entry-points-and-websetup-py">Entry Points and websetup.py</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-pylons-config-file">The Pylons Config File</a><ul>
<li><a class="reference external" href="#default-config-options">Default Config Options</a></li>
<li><a class="reference external" href="#constructing-a-server">Constructing a Server</a></li>
<li><a class="reference external" href="#constructing-an-application">Constructing an Application</a></li>
<li><a class="reference external" href="#composite-applications">Composite Applications</a></li>
<li><a class="reference external" href="#pipelines-and-filters">Pipelines and Filters</a></li>
<li><a class="reference external" href="#understanding-factories">Understanding Factories</a></li>
<li><a class="reference external" href="#alternative-ways-of-specifying-factories">Alternative Ways of Specifying Factories</a></li>
<li><a class="reference external" href="#configuration-inheritance">Configuration Inheritance</a></li>
</ul>
</li>
<li><a class="reference external" href="#accessing-the-pylons-wsgi-application-and-other-objects-programmatically">Accessing the Pylons WSGI Application and Other Objects Programmatically</a><ul>
<li><a class="reference external" href="#accessing-the-server-application-and-filters">Accessing the Server, Application, and Filters</a></li>
<li><a class="reference external" href="#accessing-configuration-options">Accessing Configuration Options</a></li>
<li><a class="reference external" href="#creating-a-pylons-application-with-paste-deploy">Creating a Pylons Application with Paste Deploy</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-pylons-middleware-stack">The Pylons Middleware Stack</a><ul>
<li><a class="reference external" href="#application-state-vs-request-state">Application State vs. Request State</a></li>
</ul>
</li>
<li><a class="reference external" href="#creating-an-application">Creating an Application</a><ul>
<li><a class="reference external" href="#loading-the-pylons-environment">Loading the Pylons Environment</a></li>
<li><a class="reference external" href="#the-pylonsapp-instance">The PylonsApp Instance</a></li>
<li><a class="reference external" href="#the-middleware-chain">The Middleware Chain</a></li>
</ul>
</li>
<li><a class="reference external" href="#handling-a-request">Handling a Request</a><ul>
<li><a class="reference external" href="#the-cascade">The Cascade</a></li>
<li><a class="reference external" href="#the-registry-manager-stackedobjectproxy-and-pylons-globals">The Registry Manager, StackedObjectProxy, and Pylons Globals</a></li>
<li><a class="reference external" href="#returning-to-the-middleware-chain">Returning to the Middleware Chain</a></li>
<li><a class="reference external" href="#the-role-of-pylonsapp">The Role of PylonsApp</a></li>
<li><a class="reference external" href="#the-role-of-wsgicontroller">The Role of WSGIController</a></li>
</ul>
</li>
<li><a class="reference external" href="#handling-the-response">Handling the Response</a><ul>
<li><a class="reference external" href="#abort-redirect-to-and-httpexception">abort(), redirect_to(), and HTTPException</a></li>
<li><a class="reference external" href="#exception-handling">Exception Handling</a></li>
<li><a class="reference external" href="#error-documents">Error Documents</a></li>
<li><a class="reference external" href="#streaming-content">Streaming Content</a></li>
<li><a class="reference external" href="#returning-unicode-from-an-action">Returning Unicode from an Action</a></li>
</ul>
</li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="the-web-server-gateway-interface-wsgi.html"
                                  title="previous chapter">Chapter 16: The Web Server Gateway Interface (WSGI)</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="authentication-and-authorization.html"
                                  title="next chapter">Chapter 18: Authentication and Authorization</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/pylons-internal-architecture.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="authentication-and-authorization.html" title="Chapter 18: Authentication and Authorization"
             >next</a> |</li>
        <li class="right" >
          <a href="the-web-server-gateway-interface-wsgi.html" title="Chapter 16: The Web Server Gateway Interface (WSGI)"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/pylons-internal-architecture.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:45 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>