<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/simplesite-tutorial-part-2.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:15 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 14: SimpleSite Tutorial Part 2 &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 15: CSS, JavaScript, and Ajax" href="css-javascript-and-ajax.html" />
    <link rel="prev" title="Chapter 13: Documentation" href="documentation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="css-javascript-and-ajax.html" title="Chapter 15: CSS, JavaScript, and Ajax"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="documentation.html" title="Chapter 13: Documentation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-14-simplesite-tutorial-part-2">
<h1>Chapter 14: SimpleSite Tutorial Part 2<a class="headerlink" href="#chapter-14-simplesite-tutorial-part-2" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can download the source for this chapter from <a class="reference external" href="http://www.apress.com/">http://www.apress.com</a>.</p>
</div>
<p id="index-825">Now that you’ve seen a bit more of Pylons and are more familiar with how it works, I’ll continue the SimpleSite tutorial. Here are the topics I’ll cover in this chapter:</p>
<blockquote>
<ul class="simple">
<li>Adding a comments system to demonstrate how to deal with one-to-many mappings</li>
<li>Adding a tags system to demonstrate many-to-many mappings as well as how to deal with forms containing multiple check boxes</li>
<li>Adding a navigation hierarchy involving sections and pages to demonstrate SQLAlchemy’s inheritance features as well as a custom Routes setup</li>
</ul>
</blockquote>
<p>Then in Chapter 15, I’ll cover JavaScript, Ajax, and YUI to show some improvements that you can make to both the visual appearance of the site and the usability.</p>
<p>There&#8217;s a lot to cover in this chapter and you might not want to tackle it all in one go. If not feel free to continue with the other chapters and come back to this one later.</p>
<div class="section" id="comments-system-one-to-many-mappings">
<h2>Comments System: One-to-Many Mappings<a class="headerlink" href="#comments-system-one-to-many-mappings" title="Permalink to this headline">¶</a></h2>
<p id="index-826">You’d like visitors to the web site to be able to leave comments about each page. The comments will consist of the date they were posted, the name of the poster, their e-mail address, and the comment itself.</p>
<p id="index-827">I discussed one-to-many mappings in Chapter 7. Situations where one entity (in this case, a page) can have one or more instances of another entity associated with it (in this case, comments) are known as <em>one-to-many</em> mappings, and they can all be dealt with in the same way, which in this case is by having a <em>foreign key</em> in the comments table represent the ID of the page with which the comment is associated.</p>
<p>Here is the table:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">comment_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;comment_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">()),</span>
<span class="p">)</span>
</pre></div>
</div>
<p id="index-828">You’ll recall that the table contains an <tt class="docutils literal"><span class="pre">id</span></tt> field so that each comment can be uniquely identified and that it contains a <tt class="docutils literal"><span class="pre">pageid</span></tt> field, which is a foreign key holding the <tt class="docutils literal"><span class="pre">id</span></tt> of the page to which the comment is associated.</p>
<p>The class definition for the comment looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The mapper for the page already takes into account that each page could have multiple comments:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">),</span>
    <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p id="index-829">You’ll recall that this mapper sets up a <tt class="docutils literal"><span class="pre">.comments</span></tt> property on <tt class="docutils literal"><span class="pre">Page</span></tt> instances for accessing a list of comments, and it also sets up a <tt class="docutils literal"><span class="pre">.page</span></tt> property on <tt class="docutils literal"><span class="pre">Comment</span></tt> instances for identifying the page associated with a comment. If you’ve been following the tutorial, you already added these to your model in Chapter 8.</p>
<div class="section" id="planning-the-controller">
<h3>Planning the Controller<a class="headerlink" href="#planning-the-controller" title="Permalink to this headline">¶</a></h3>
<p id="index-830">Let’s think about the requirements for the controller. You would need the following actions:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">view(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Displays a comment for a page</dd>
<dt><tt class="docutils literal"><span class="pre">new(self)</span></tt></dt>
<dd>Displays a form to create a new comment on a page</dd>
<dt><tt class="docutils literal"><span class="pre">create(self)</span></tt></dt>
<dd>Saves the information submitted from <tt class="docutils literal"><span class="pre">new()</span></tt> and redirects to <tt class="docutils literal"><span class="pre">view()</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">edit(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Displays a form for editing the comment <tt class="docutils literal"><span class="pre">id</span></tt> on a page</dd>
<dt><tt class="docutils literal"><span class="pre">save(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Saves the comment <tt class="docutils literal"><span class="pre">id</span></tt> and redirects to <tt class="docutils literal"><span class="pre">view()</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">list(self)</span></tt></dt>
<dd>Displays all comments on a page</dd>
<dt><tt class="docutils literal"><span class="pre">delete(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Deletes a comment from a page</dd>
</dl>
<p>The comment controller actions need to know which page the comment is associated with (or will be associated with in the case of <tt class="docutils literal"><span class="pre">new()</span></tt> and <tt class="docutils literal"><span class="pre">create()</span></tt>) so that they deal with the comments for a particular page only. This means in addition to the ID of the comment the actions are changing, they will also need to know the ID of the page the comment is associated with.</p>
<p id="index-831">With other frameworks, you might have to use hidden fields in your forms and query parameters in your URLs to keep track of the page ID, but Pylons provides a better method: modifying the routes to keep the page ID as part of the URLs used to route requests to the comment controller&#8217;s actions.</p>
</div>
<div class="section" id="modifying-the-routes">
<h3>Modifying the Routes<a class="headerlink" href="#modifying-the-routes" title="Permalink to this headline">¶</a></h3>
<p id="index-832">The URLs you will use will be in this form:</p>
<div class="highlight-python"><pre>/page/1/comment/view/4</pre>
</div>
<p>This URL would result in the comment with ID 4 being viewed on page 1. By setting up Routes to understand this URL and map it to the comment controller you will create in a minute, the issue of how to keep track of the page <tt class="docutils literal"><span class="pre">id</span></tt> goes away because it will automatically be added when you use <tt class="docutils literal"><span class="pre">url_for()</span></tt> and can always be accessed via <tt class="docutils literal"><span class="pre">request.urlvars</span></tt>.</p>
<p>To make this work, you need to add the following routes to <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> immediately after <tt class="docutils literal"><span class="pre">#</span> <span class="pre">CUSTOM</span> <span class="pre">ROUTES</span> <span class="pre">HERE</span></tt> and before the existing <tt class="docutils literal"><span class="pre">map.connect('/{controller}/{action}')</span></tt> route:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="s">&#39;/page/{pageid}/{controller}/{action}&#39;</span><span class="p">,</span>
    <span class="n">requirements</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="s">&#39;/page/{pageid}/{controller}/{action}/{id}&#39;</span><span class="p">,</span>
    <span class="n">requirements</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>These routes require that both the <tt class="docutils literal"><span class="pre">pageid</span></tt> and <tt class="docutils literal"><span class="pre">id</span></tt> routing variables are integers. Checking this here saves you from having to perform the check in each of the controller actions.</p>
<p>Now that you’ve learned about the <tt class="docutils literal"><span class="pre">explicit=True</span></tt> option to Routes’ <tt class="docutils literal"><span class="pre">Mapper</span></tt> object, let’s use this option in the SimpleSite project to disable route memory and implicit defaults as recommended in Chapter 9. Change the <tt class="docutils literal"><span class="pre">Mapper()</span></tt> lines in <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> to look like this, ensuring minimization is also disabled by setting <tt class="docutils literal"><span class="pre">map.minimization</span> <span class="pre">=</span> <span class="pre">False</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.paths&#39;</span><span class="p">][</span><span class="s">&#39;controllers&#39;</span><span class="p">],</span>
             <span class="n">always_scan</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">],</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">minimization</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
<p>With this change in place, you’ll also need to update the section links because when using <tt class="docutils literal"><span class="pre">explicit=True</span></tt>, you no longer need to override the route memory value for <tt class="docutils literal"><span class="pre">id</span></tt>. Edit <tt class="docutils literal"><span class="pre">templates/derived/page/view.html</span></tt> so that the first two links are changed from this:</p>
<div class="highlight-python"><pre>&lt;a href="${h.url_for(controller='page', action='list', id=None)}"&gt;All Pages&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='new', id=None)}"&gt;New Page&lt;/a&gt;</pre>
</div>
<p>to the following:</p>
<div class="highlight-python"><pre>&lt;a href="${h.url_for(controller='page', action='list')}"&gt;All Pages&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='new')}"&gt;New Page&lt;/a&gt;</pre>
</div>
<p>There’s one more subtle place where the change to explicit routing has a consequence: inside the paginator. Luckily, additional keyword arguments passed to the <tt class="docutils literal"><span class="pre">Page</span></tt> constructor are also passed to any calls the paginator makes to <tt class="docutils literal"><span class="pre">h.url_for()</span></tt>. This means you just have to specify <tt class="docutils literal"><span class="pre">controller</span></tt> and <tt class="docutils literal"><span class="pre">list</span></tt> explicitly as keyword arguments to the <tt class="docutils literal"><span class="pre">Page()</span></tt> constructor. Replace the current <tt class="docutils literal"><span class="pre">list()</span></tt> action with this, renaming the <tt class="docutils literal"><span class="pre">records</span></tt> variable to <tt class="docutils literal"><span class="pre">page_q</span></tt> at the same time to reflect that it is really a query object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">paginator</span> <span class="o">=</span> <span class="n">paginate</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span>
        <span class="n">page_q</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)),</span>
        <span class="n">items_per_page</span> <span class="o">=</span> <span class="mf">2</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/list.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-controller">
<h3>Creating the Controller<a class="headerlink" href="#creating-the-controller" title="Permalink to this headline">¶</a></h3>
<p id="index-833">Rather than creating the controller from scratch, let’s reuse the page controller you wrote in Chapter 8. Make a copy of it named <tt class="docutils literal"><span class="pre">comment.py</span></tt> in the <tt class="docutils literal"><span class="pre">controllers</span></tt> directory, and then replace every instance of the string <tt class="docutils literal"><span class="pre">page</span></tt> with <tt class="docutils literal"><span class="pre">comment</span></tt> and every instance of the string <tt class="docutils literal"><span class="pre">Page</span></tt> with <tt class="docutils literal"><span class="pre">Comment</span></tt>. If you are on a Linux or Unix platform, these commands will do it for you:</p>
<div class="highlight-python"><pre>$ cd simplesite/controllers
$ cp page.py comment.py
$ perl -pi -w -e 's/page/comment/g; s/Page/Comment/g;' comment.py</pre>
</div>
<p>Now let’s do the same with the templates:</p>
<div class="highlight-python"><pre>$ cd ../templates/derived
$ cp -r page comment
$ cd comment
$ perl -pi -w -e 's/page/comment/g; s/Page/Comment/g;' *.html</pre>
</div>
<p>You’ll need to correct the new comment controller’s <tt class="docutils literal"><span class="pre">list()</span></tt> action because some of the variables will have been accidentally renamed. Change it to look like this. You&#8217;ll need to change <tt class="docutils literal"><span class="pre">page</span></tt> and <tt class="docutils literal"><span class="pre">Page</span></tt> variables on lines 3, 5 and 6:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">comments_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">paginator</span> <span class="o">=</span> <span class="n">paginate</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span>
        <span class="n">comments_q</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)),</span>
        <span class="n">items_per_page</span> <span class="o">=</span> <span class="mf">10</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/comment/list.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="index-834">You’ll actually use this basic controller template again later in the tutorial when you create a controller to handle tags and sections, so take a copy of the comment controller and call it <tt class="docutils literal"><span class="pre">template.py.txt</span></tt> so that you can use it later (you are using a <tt class="docutils literal"><span class="pre">.py.txt</span></tt> extension so that the template isn’t accidentally treated as a controller):</p>
<div class="highlight-python"><pre>cd ../../../
$ cp comment.py template.py.txt</pre>
</div>
</div>
<div class="section" id="updating-the-controller-to-handle-comments">
<h3>Updating the Controller to Handle Comments<a class="headerlink" href="#updating-the-controller-to-handle-comments" title="Permalink to this headline">¶</a></h3>
<p id="index-835">Now that the basic structure of the comment controller is in place, it needs to be updated to correctly handle the fields and relationships of the <tt class="docutils literal"><span class="pre">comment</span></tt> table. Comment objects have a <tt class="docutils literal"><span class="pre">.content</span></tt> property for the comment text itself, a <tt class="docutils literal"><span class="pre">.name</span></tt> property to hold the name of the person who left the comment, and an <tt class="docutils literal"><span class="pre">.email</span></tt> property for their e-mail address. You’ll need fields for each of these so that a user can leave a comment. Let’s start by creating a FormEncode schema. Update the <tt class="docutils literal"><span class="pre">NewCommentForm</span></tt> schema to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewCommentForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;empty&#39;</span><span class="p">:</span><span class="s">&#39;Please enter a comment.&#39;</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The example uses the <tt class="docutils literal"><span class="pre">allow_extra_fields</span> <span class="pre">=</span> <span class="pre">True</span></tt> option so that the form’s submit button isn’t validated and uses the <tt class="docutils literal"><span class="pre">filter_extra_fields</span> <span class="pre">=</span> <span class="pre">True</span></tt> option so that it isn’t included in the results returned when the schema converts the form input to a Python dictionary. A custom error message is used if the user forgets to enter a comment, and the e-mail address uses an <tt class="docutils literal"><span class="pre">Email</span></tt> validator to make sure the user enters a string that looks like an e-mail address.</p>
<p id="index-836">You’ll also need to update the <tt class="docutils literal"><span class="pre">/templates/derived/comment/fields.html</span></tt> file so it represents the correct fields you’d like users to enter:</p>
<div class="highlight-python"><pre>${h.field(
    "Name",
    h.text(name='name'),
    required=True,
)}
${h.field(
    "Email",
    h.text(name='email'),
    required=True,
    field_desc = 'Use to help prevent spam but will not be published',
)}
${h.field(
    "Comment",
    h.textarea(name='content', rows=7, cols=40),
    required=True,
)}</pre>
</div>
<p>Notice that although the field name is called <tt class="docutils literal"><span class="pre">content</span></tt>, it is labeled <tt class="docutils literal"><span class="pre">Comment</span></tt>. This is to make it more obvious to the users of the application. After all, they don’t need to know that the comment text they enter is actually stored in the <tt class="docutils literal"><span class="pre">content</span></tt> column of the table.</p>
<p id="index-837">Next update the <tt class="docutils literal"><span class="pre">edit()</span></tt> action so that the correct values are prepared for the call to <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
    <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="index-838">Let’s also update the <tt class="docutils literal"><span class="pre">view.html</span></tt> template to display the comment information to look more like a comment. Update it to look like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Comment&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Comment&lt;/h1&gt;&lt;/%def&gt;

${c.comment.content}

&lt;p&gt;&lt;em&gt;Posted by ${c.comment.name} on ${c.comment.created.strftime('%c')}.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="${h.url_for(controller='page', action='view', id=c.comment.pageid)}"&gt;Visit the page this comment was posted on.&lt;/a&gt;&lt;/p&gt;</pre>
</div>
<p id="index-839">Finally, you’ll need to update the <tt class="docutils literal"><span class="pre">list.html</span></tt> template so that the <tt class="docutils literal"><span class="pre">pager()</span></tt> method of the paginator is named <tt class="docutils literal"><span class="pre">pager()</span></tt> rather than <tt class="docutils literal"><span class="pre">commentr()</span></tt> after the automatic rename and so that the paginator displays information relevant to the comments rather than pages. Here’s the updated version:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Comment List&lt;/h1&gt;&lt;/%def&gt;

&lt;%def name="buildrow(comment, odd=True)"&gt;
    &lt;tr class="${odd and 'odd' or 'even'}"&gt;
        &lt;td valign="top"&gt;
            ${h.link_to(
                comment.id,
                h.url_for(
                    controller=u'comment',
                    action='view',
                    id=unicode(comment.id)
                )
            )}
        &lt;/td&gt;
        &lt;td valign="top"&gt;
            ${h.link_to(
                comment.name,
                h.url_for(
                    controller=u'comment',
                    action='edit',
                    id=unicode(comment.id)
                )
            )}
        &lt;/td&gt;
        &lt;td valign="top"&gt;${comment.created.strftime('%c')}&lt;/td&gt;
    &lt;/tr&gt;
&lt;/%def&gt;

% if len(c.paginator):
&lt;p&gt;${ c.paginator.pager('$link_first $link_previous $first_item to $last_item of $item_count $link_next $link_last') }&lt;/p&gt;
&lt;table class="paginator"&gt;&lt;tr&gt;&lt;th&gt;Comment ID&lt;/th&gt;&lt;th&gt;Comment Title&lt;/th&gt;&lt;th&gt;Posted&lt;/th&gt;&lt;/tr&gt;
&lt;% counter=0 %&gt;
% for item in c.paginator:
    ${buildrow(item, counter%2)}
    &lt;% counter += 1 %&gt;
% endfor
&lt;/table&gt;
&lt;p&gt;${ c.paginator.pager('~2~') }&lt;/p&gt;
% else:
&lt;p&gt;
    No comments have yet been created.
    &lt;a href="${h.url_for(controller='comment', action='new')}"&gt;Add one&lt;/a&gt;.
&lt;/p&gt;
% endif</pre>
</div>
<p id="index-840">At this point, you would be able to perform all the usual actions on comments such as add, edit, and remove if it weren’t for the fact they also need a <tt class="docutils literal"><span class="pre">pageid</span></tt>.</p>
<p>Now you can start the server and see what you have:</p>
<div class="highlight-python"><pre>$ paster serve --reload development.ini</pre>
</div>
<p>Visit <a class="reference external" href="http://localhost:5000/comment/new">http://localhost:5000/comment/new</a>, and you should see the comment form shown in Figure 14-1.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1401.png"><img alt="Figure 14-1. The create comment form" src="_images/9349f1401.png" /></a>
<p class="caption">Figure 14-1. The create comment form</p>
</div>
</div>
<div class="section" id="setting-the-page-id-automatically">
<h3>Setting the Page ID Automatically<a class="headerlink" href="#setting-the-page-id-automatically" title="Permalink to this headline">¶</a></h3>
<p id="index-841">If you try to create a comment at the URL you’ve just visited, an <tt class="docutils literal"><span class="pre">IntegrityError</span></tt> will be raised specifying <tt class="docutils literal"><span class="pre">comment.pageid</span> <span class="pre">may</span> <span class="pre">not</span> <span class="pre">be</span> <span class="pre">NULL</span></tt> because no page ID has been specified. As I mentioned earlier in the chapter, you’ll obtain the page ID from the URL. To set this up, you are going to use the <tt class="docutils literal"><span class="pre">__before__()</span></tt> method that gets called before each of the Pylons actions. Add it right at the top of the controller before the <tt class="docutils literal"><span class="pre">view()</span></tt> action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CommentController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">pageid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">pageid</span> <span class="ow">and</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pageid</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
</pre></div>
</div>
<p>This code causes the variable <tt class="docutils literal"><span class="pre">c.page</span></tt> to be set before any actions are called. If the page ID is not included in the URL or the page doesn’t exist, a 404 Not Found response is returned. With this code in place, visiting <a class="reference external" href="http://localhost:5000/comment/new">http://localhost:5000/comment/new</a> results in a 404 Not Found response; visiting <a class="reference external" href="http://localhost:5000/page/1/comment/new">http://localhost:5000/page/1/comment/new</a> correctly displays the new comment form, but the comment will still not save because the form does not yet submit to <a class="reference external" href="http://localhost:5000/page/1/comment/create">http://localhost:5000/page/1/comment/create</a>. Let’s fix that by editing the <tt class="docutils literal"><span class="pre">new.html</span></tt> template to change the <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> call to include the page ID:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;
&lt;%namespace file="fields.html" name="fields" import="*"/&gt;

&lt;%def name="heading()"&gt;
    &lt;h1 class="main"&gt;Create a New Comment&lt;/h1&gt;
&lt;/%def&gt;

${h.form_start(h.url_for(pageid=c.page.id, controller='comment', action='create'), method="post")}
    ${fields.body()}
    ${h.field(field=h.submit(value="Create Comment", name='submit'))}
${h.form_end()}</pre>
</div>
<p>You’ll also need to change the <tt class="docutils literal"><span class="pre">edit.html</span></tt> template so that the form also includes the page ID. Change line 10 so the <tt class="docutils literal"><span class="pre">pageid</span></tt> is <tt class="docutils literal"><span class="pre">page.c.id</span></tt>:</p>
<div class="highlight-mako"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;%</span><span class="nb">inherit</span> <span class="na">file=</span><span class="s">&quot;/base/index.html&quot;</span> <span class="cp">/&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span><span class="nb">namespace</span> <span class="na">file=</span><span class="s">&quot;fields.html&quot;</span> <span class="na">name=</span><span class="s">&quot;fields&quot;</span> <span class="na">import=</span><span class="s">&quot;*&quot;</span><span class="cp">/&gt;</span><span class="x"></span>

<span class="cp">&lt;%</span><span class="nb">def</span> <span class="na">name=</span><span class="s">&quot;heading()&quot;</span><span class="cp">&gt;</span><span class="x"></span>
<span class="x">    &lt;h1 class=&quot;main&quot;&gt;Editing </span><span class="cp">${</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="cp">}</span><span class="x">&lt;/h1&gt;</span>
<span class="cp">&lt;/%</span><span class="nb">def</span><span class="cp">&gt;</span><span class="x"></span>

<span class="x">&lt;p&gt;Editing the source code for the </span><span class="cp">${</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="cp">}</span><span class="x"> comment:&lt;/p&gt;</span>

<span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">form_start</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;save&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]),</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">)</span><span class="cp">}</span><span class="x"></span>
<span class="x">    </span><span class="cp">${</span><span class="n">fields</span><span class="o">.</span><span class="n">body</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="x">    </span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;Save Changes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;submit&#39;</span><span class="p">))</span><span class="cp">}</span><span class="x"></span>
<span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">form_end</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
</pre></div>
</td></tr></table></div>
<p id="index-842">Let’s consider each of the actions of the comment controller in turn to decide how they should behave and how they will need to be modified:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">view()</span></tt></dt>
<dd><p class="first">The view method needs to be updated to ensure that the comment requested is actually a comment from the page specified in the URL. You can do this by updating the query used in the <tt class="docutils literal"><span class="pre">view()</span></tt> action from this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</pre></div>
</div>
<p>to the following:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt><tt class="docutils literal"><span class="pre">new()</span></tt></dt>
<dd>This action needs no change since it is responsible only for displaying the form for adding a new comment.</dd>
<dt><tt class="docutils literal"><span class="pre">create()</span></tt></dt>
<dd><p class="first">This action needs to know the page to which the comment is being added. Just before the comment is added to the session, add the following line to set the page ID:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">comment</span><span class="o">.</span><span class="n">pageid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
<p>You’ll also need to include the page ID in the URL to which the browser is redirected. Since you already learned about the <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> function in Chapter 9, let’s use it here. Replace the redirect lines with these:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="c"># Issue an HTTP redirect</span>
<span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><tt class="docutils literal"><span class="pre">edit()</span></tt></dt>
<dd><p class="first">The edit action needs a similar modification to the one made to the <tt class="docutils literal"><span class="pre">view()</span></tt> method. Although you know which page a comment is associated with, you want to make sure the URL requested has the same page ID as the comment. Change the query from this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>to the following:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt><tt class="docutils literal"><span class="pre">save()</span></tt></dt>
<dd><p class="first">Again, you’ll want to check that the page ID in the URL is the same as the one in the comment. Since the form doesn’t allow you to change the page ID, this can once again be ensured by adding <tt class="docutils literal"><span class="pre">c.page.id</span></tt> to the query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-843">Replace the redirect lines with this:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="c"># Issue an HTTP redirect</span>
<span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt><tt class="docutils literal"><span class="pre">list()</span></tt></dt>
<dd><p class="first">Only comments associated with the current page should be listed, so once again the query is modified to include the page ID. In this case, though, we also have to pass the <tt class="docutils literal"><span class="pre">pageid</span></tt> argument, which will in turn get passed to any <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> calls in the paginator.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">comments_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">comments_q</span> <span class="o">=</span> <span class="n">comments_q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">comment_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
    <span class="n">c</span><span class="o">.</span><span class="n">paginator</span> <span class="o">=</span> <span class="n">paginate</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span>
        <span class="n">comments_q</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)),</span>
        <span class="n">items_per_page</span><span class="o">=</span><span class="mf">10</span><span class="p">,</span>
        <span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">pageid</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/comment/list.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">Notice the use of <tt class="docutils literal"><span class="pre">order_by()</span></tt> to ensure that the earliest comments are displayed first. I’ve used the <tt class="docutils literal"><span class="pre">comment_table</span></tt> column metadata in the <tt class="docutils literal"><span class="pre">order_by()</span></tt> method just to remind you that you can use table metadata as well as class attributes when specifying query arguments, and I’ve used the <tt class="docutils literal"><span class="pre">.asc()</span></tt> method to specify that the results should be specified in ascending order.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">delete()</span></tt></dt>
<dd><p class="first">Again, this requires only a check that the page ID in the URL is the same as the one in the comment. Since the form doesn’t allow you to change the page ID, this can once again be ensured by adding <tt class="docutils literal"><span class="pre">c.page.id</span></tt> to the query:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
<p id="index-844">Now that all the changes have been made, let’s test the new controller. Start by adding a new comment to the home page by visiting <a class="reference external" href="http://localhost:5000/page/1/comment/new">http://localhost:5000/page/1/comment/new</a> and filling in the form. When you click Create Comment, you will see Figure 14-2.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1402.png"><img alt="Figure 14-2. The first comment" src="_images/9349f1402.png" /></a>
<p class="caption">Figure 14-2. The first comment</p>
</div>
<p>Finally, let’s update the comment view template <tt class="docutils literal"><span class="pre">derived/comment/view.html</span></tt> so that edit and delete links are added to the footer. Add the following at the end of the template:</p>
<div class="highlight-python"><pre>&lt;%def name="footer()"&gt;
## Add our comment links
&lt;p&gt;
  &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='edit', id=c.comment.id)}"&gt;Edit Comment&lt;/a&gt;
| &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='delete', id=c.comment.id)}"&gt;Delete Comment&lt;/a&gt;
&lt;/p&gt;
## Include the parent footer too
${parent.footer()}
&lt;/%def&gt;</pre>
</div>
<p id="index-845">Make sure you followed the instructions earlier in the chapter to update the <tt class="docutils literal"><span class="pre">values</span></tt> variable in the <tt class="docutils literal"><span class="pre">edit()</span></tt> action; you will then find you can easily edit or delete comments. There are still no links to display or add comments from the bottom of individual pages. You’ll fix that in the next section.</p>
</div>
</div>
<div class="section" id="updating-the-page-view">
<h2>Updating the Page View<a class="headerlink" href="#updating-the-page-view" title="Permalink to this headline">¶</a></h2>
<p id="index-846">SimpleSite will not display a list of comments on the page itself (although you could set it up to do so if you preferred) but will instead display a link at the bottom of each page of the form that says, for example, “Comments (8)” where the number in parentheses is the current number of comments on that page. Users can click this link to view the list of comments. There will also be an Add Comment link so that users can add a comment directly. Figure 14-3 shows what the updated screen will look like.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1403.png"><img alt="Figure 14-3. The updated page view screen" src="_images/9349f1403.png" /></a>
<p class="caption">Figure 14-3. The updated page view screen</p>
</div>
<p>For this to work, you need to modify both the page controller’s <tt class="docutils literal"><span class="pre">view()</span></tt> action and the template. Let’s start with the <tt class="docutils literal"><span class="pre">view()</span></tt> action. You need to add a SQLAlchemy query to count the number of pages associated with the page. Add this to the end of the action just before the <tt class="docutils literal"><span class="pre">return</span></tt> statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">comment_count</span> <span class="o">=</span>  <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-847">Then modify the <tt class="docutils literal"><span class="pre">templates/derived/page/view.html</span></tt> template so the <tt class="docutils literal"><span class="pre">footer()</span></tt> def includes comment links:</p>
<div class="highlight-python"><pre>&lt;%def name="footer()"&gt;
## Then add our page links
&lt;p&gt;
  &lt;a href="${h.url_for(controller='page', action='list')}"&gt;All Pages&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='new')}"&gt;New Page&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='edit', id=c.page.id)}"&gt;Edit Page&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='delete', id=c.page.id)}"&gt;Delete Page&lt;/a&gt;
&lt;/p&gt;
## Comment links
&lt;p&gt;
  &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='list')}"&gt;Comments (${str(c.comment_count)})&lt;/a&gt;
| &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='new')}"&gt;Add Comment&lt;/a&gt;
&lt;/p&gt;
## Include the parent footer too
${parent.footer()}
&lt;/%def&gt;</pre>
</div>
<p id="index-848">Now when you view a page, you will also be able to list or add comments, and by viewing comments individually, you can edit or delete them.</p>
<div class="section" id="handling-deleted-pages">
<h3>Handling Deleted Pages<a class="headerlink" href="#handling-deleted-pages" title="Permalink to this headline">¶</a></h3>
<p id="index-849">Now that comments are related to pages, you need to think about what to do with comments once a page is deleted. Since a comment without the page it is commenting on isn’t very useful, you can automatically delete all comments associated with a page when the page itself is deleted.</p>
<p>You could program this code manually in the <tt class="docutils literal"><span class="pre">delete()</span></tt> action of the page controller, but there is actually a better way. SQLAlchemy mappers support the concept of configurable cascade behavior on relations so that you can specify how child objects are dealt with on certain actions of the parents. The options are described in detail at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/documentation.html#unitofwork_cascades">http://www.sqlalchemy.org/docs/05/documentation.html#unitofwork_cascades</a>, but we are simply going to use the option <tt class="docutils literal"><span class="pre">all</span></tt> so that the comments are updated if the page ID changes and are deleted if the page they are for is deleted.</p>
<p>Modify the page mapper in <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt> so that the comments relation has <tt class="docutils literal"><span class="pre">cascade='all'</span></tt> specified like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
   <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
   <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Try creating a page, adding some comments, and then deleting the page. If you looked at the database table, you’d find that the comments are automatically deleted too.</p>
<p>If you are following along with a SQLite database named <tt class="docutils literal"><span class="pre">development.db</span></tt>, you could check this by connecting to the database with the <tt class="docutils literal"><span class="pre">sqlite3</span></tt> program:</p>
<div class="highlight-python"><pre>$ sqlite3 development.db</pre>
</div>
<p>Then by executing this SQL:</p>
<div class="highlight-python"><pre>SELECT id, pageid FROM comment;</pre>
</div>
<p id="index-850">you’d find that there were no comments for the page you just deleted because the SQLAlchemy cascade rules you specified led to SQLAlchemy deleting them for you.</p>
</div>
</div>
<div class="section" id="tags-many-to-many-mappings">
<h2>Tags: Many-to-Many Mappings<a class="headerlink" href="#tags-many-to-many-mappings" title="Permalink to this headline">¶</a></h2>
<p id="index-851">Now that you’ve seen how to handle a one-to-many mapping (sometimes called a <em>parent-child</em> relationship) between pages and comments, you can turn your attention to the many-to-many mapping between tags and pages. Once again, tags can be created, viewed, updated, or deleted. So, the controller that manipulates them would need the same actions as the page and comment controllers you’ve created so far. In addition, each page can have multiple tags, and each tag can be used on multiple pages so that tags can’t be considered children of pages any more than pages can be considered children of tags.</p>
<p>The way you’ll implement this is by once again starting with a simple controller and renaming the core variables with the word <em>tag</em>. You’ll then tweak the controller so that it correctly handles the columns of the <tt class="docutils literal"><span class="pre">tag</span></tt> table.</p>
<p id="index-852">After you’ve done this, users will be able to add, edit, remove, and list tags. I’ll then cover how to associate tags with pages. Ordinarily, you would need to create a second controller for handling the adding, editing, listing, and deleting of the <em>associations</em> between the <tt class="docutils literal"><span class="pre">page</span></tt> table and the <tt class="docutils literal"><span class="pre">tag</span></tt> table. In this case, though, you’ll take a shortcut. Rather than having a second controller to handle the interactions, you will simply display a check box group of all the available tags on each page. Users can then select the tags they want associated with the page, and SQAlchemy will handle how to store those associations in the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table for you automatically.</p>
<div class="section" id="creating-the-tag-controller">
<h3>Creating the tag Controller<a class="headerlink" href="#creating-the-tag-controller" title="Permalink to this headline">¶</a></h3>
<p id="index-853">Let’s start by creating the <tt class="docutils literal"><span class="pre">tag</span></tt> controller from the template copied earlier:</p>
<div class="highlight-python"><pre>$ cd simplesite/controllers
$ cp template.py.txt tag.py
$ perl -pi -w -e 's/comment/tag/g; s/Comment/Tag/g;' tag.py</pre>
</div>
<p>You’ll need to correct the new tag controller’s <tt class="docutils literal"><span class="pre">list()</span></tt> action too because some of the variables will have been accidentally renamed. Change it to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tag_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">paginator</span> <span class="o">=</span> <span class="n">paginate</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span>
        <span class="n">tag_q</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)),</span>
        <span class="n">items_per_page</span> <span class="o">=</span> <span class="mf">10</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/tag/list.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s do the same with the templates, but let’s use the page templates as a basis:</p>
<div class="highlight-python"><pre>$ cd ../templates/derived
$ cp -r page tag
$ cd tag
$ perl -pi -w -e 's/page/tag/g; s/Page/Tag/g;' *.html</pre>
</div>
<p>Once again, you’ll need to update <tt class="docutils literal"><span class="pre">list.html</span></tt> to use <tt class="docutils literal"><span class="pre">c.paginator.pager()</span></tt>, not <tt class="docutils literal"><span class="pre">c.paginator.tagr()</span></tt>.</p>
<p>Now restart the server if you stopped it to make these changes, and let’s get started with the updates:</p>
<div class="highlight-python"><pre>$ cd ../../../../
$ paster serve --reload development.ini</pre>
</div>
<p id="index-854">Tags have a name only, so update the <tt class="docutils literal"><span class="pre">NewTagForm</span></tt> schema to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewTagForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Change the <tt class="docutils literal"><span class="pre">edit()</span></tt> action so that the values passed to <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="index-855">Next, change the <tt class="docutils literal"><span class="pre">fields.html</span></tt> template so that it looks like this:</p>
<div class="highlight-python"><pre>${h.field(
    "Name",
    h.text(name='name'),
    required=True,
)}</pre>
</div>
<p id="index-856">Update the tag <tt class="docutils literal"><span class="pre">view.html</span></tt> template so it looks like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Tag&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Tag&lt;/h1&gt;&lt;/%def&gt;

${c.tag.name}

&lt;%def name="footer()"&gt;
## Add our tag links
&lt;p&gt;
  &lt;a href="${h.url_for(controller='tag', action='edit', id=c.tag.id)}"&gt;Edit Tag&lt;/a&gt;
| &lt;a href="${h.url_for(controller='tag', action='delete', id=c.tag.id)}"&gt;Delete Tag&lt;/a&gt;
&lt;/p&gt;
## Include the parent footer too
${parent.footer()}
&lt;/%def&gt;</pre>
</div>
<p id="index-857">Finally, update the <tt class="docutils literal"><span class="pre">tag/list.html</span></tt> template so it looks like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Tag List&lt;/h1&gt;&lt;/%def&gt;

&lt;%def name="buildrow(tag, odd=True)"&gt;
    &lt;tr class="${odd and 'odd' or 'even'}"&gt;
        &lt;td valign="top"&gt;
            ${h.link_to(
                tag.id,
                h.url_for(
                    controller=u'tag',
                    action='view',
                    id=unicode(tag.id)
                )
            )}
        &lt;/td&gt;
        &lt;td valign="top"&gt;
            ${tag.name}
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/%def&gt;

% if len(c.paginator):
&lt;p&gt;${ c.paginator.pager('$link_first $link_previous $first_item to $last_item of $item_count $link_next $link_last') }&lt;/p&gt;
&lt;table class="paginator"&gt;&lt;tr&gt;&lt;th&gt;Tag ID&lt;/th&gt;&lt;th&gt;Tag Name&lt;/th&gt;&lt;/tr&gt;
&lt;% counter=0 %&gt;
% for item in c.paginator:
    ${buildrow(item, counter%2)}
    &lt;% counter += 1 %&gt;
% endfor
&lt;/table&gt;
&lt;p&gt;${ c.paginator.pager('~2~') }&lt;/p&gt;
% else:
&lt;p&gt;
    No tags have yet been created.
    &lt;a href="${h.url_for(controller='tag', action='new')}"&gt;Add one&lt;/a&gt;.
&lt;/p&gt;
% endif</pre>
</div>
<p id="index-858">That’s it—the tag controller is complete, so you could now start creating tags by visiting <a class="reference external" href="http://localhost:5000/tag/new">http://localhost:5000/tag/new</a>; however, before you do, let’s add a few restrictions to what can be used as a tag name.</p>
</div>
<div class="section" id="constraining-tag-names">
<h3>Constraining Tag Names<a class="headerlink" href="#constraining-tag-names" title="Permalink to this headline">¶</a></h3>
<p id="index-859">You’ll put a restriction on tag names to ensure they can be made only from letters, numbers, and the space character and can consist of 20 characters or less. Also, you don’t want users to add a tag with a name that already exists. Of course, because of the constraints you set up when defining the model, you know that an exception will be raised if a nonunique tag name is added, but the 500 Internal Server Error page that will be generated doesn’t provide a way to let the user fix the error, so you need a FormEncode validator to check for the error before it occurs and to display an appropriate error message if necessary.</p>
<p id="index-860">First let’s create a validator to check for unique tags and update the <tt class="docutils literal"><span class="pre">NewTagForm</span></tt> schema to use it. Add this to the top of the tag controller instead of the current <tt class="docutils literal"><span class="pre">NewTagForm</span></tt> schema:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">UniqueTag</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Check we have a valid string first</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">20</span><span class="p">)</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c"># Check that tags are only letters, numbers, and the space character</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;[^a-zA-Z0-9 ]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;Tags can only contain letters, numbers and spaces&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c"># Ensure the tag is unique</span>
        <span class="n">tag_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;save&#39;</span><span class="p">:</span>
            <span class="c"># Ignore the existing name when performing the check</span>
            <span class="n">tag_q</span> <span class="o">=</span> <span class="n">tag_q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
        <span class="n">first_tag</span> <span class="o">=</span> <span class="n">tag_q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;This tag name already exists&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">NewTagForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">UniqueTag</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-861">There’s quite a lot going on in the <tt class="docutils literal"><span class="pre">UniqueTag</span></tt> validator, so let’s go through what it does. When the validator is called, the first thing that happens is a check to ensure the tag name is a valid string with 20 characters. If the check passes, a regular expression is used to ensure that only alphanumerics and the space character are used in the name. Next, a SQLAlchemy query object is set up to query any tags with a name equal to the name being validated. What happens next depends on whether the validator is used in the <tt class="docutils literal"><span class="pre">save()</span></tt> action decorator or the <tt class="docutils literal"><span class="pre">create()</span></tt> action decorator. You’ll recall that <tt class="docutils literal"><span class="pre">request.urlvars</span></tt> contains all the routing variables matched by Routes, so in this case the action is stored in <tt class="docutils literal"><span class="pre">request.urlvars['action']</span></tt>. If this is equal to <tt class="docutils literal"><span class="pre">'save'</span></tt>, the <tt class="docutils literal"><span class="pre">save()</span></tt> action is being called, and the tag query is filtered to exclude the tag with the same ID as the current request. This prevents the tag save from failing when someone saves a tag without changing its name. If a tag with the same name exists after the query has been set up and filtered, then an <tt class="docutils literal"><span class="pre">Invalid</span></tt> exception is raised, which results in an error message above the form field.</p>
<p id="index-862">With these changes in place, you can visit <a class="reference external" href="http://localhost:5000/tag/new">http://localhost:5000/tag/new</a> to test the new tag functionality. If you try to create two tags with the same name, you’ll see the error message shown in Figure 14-4.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1404.png"><img alt="Figure 14-4. The error message shown when you create two tags with the same name" src="_images/9349f1404.png" /></a>
<p class="caption">Figure 14-4. The error message shown when you create two tags with the same name</p>
</div>
<p id="index-863">That’s it! SimpleSite now supports tags, but you can’t yet add them to pages. Let’s look at this in the next section.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p id="index-864">Sharp-eyed readers might not be too happy with the validator I’ve just described. In this case, the validator uses <tt class="docutils literal"><span class="pre">model.Session</span></tt> and <tt class="docutils literal"><span class="pre">request</span></tt>, both of which are request-specific and should ordinarily be passed via the <tt class="docutils literal"><span class="pre">state</span></tt> argument to a schema’s <tt class="docutils literal"><span class="pre">to_python()</span></tt> method, as you’ll recall from Chapter 6. In this case, though, all the validation happens behind the scenes in Pylons’ <tt class="docutils literal"><span class="pre">&#64;vailidate</span></tt> decorator, so there isn’t an opportunity to specify a <tt class="docutils literal"><span class="pre">state</span></tt> argument. Luckily, both <tt class="docutils literal"><span class="pre">model.Session</span></tt> and <tt class="docutils literal"><span class="pre">request</span></tt> are special objects that Pylons ensures behave correctly during each request, even in a multithreaded environment, so this example is perfectly OK in this case.</p>
<p>If your validator accessed an object that wasn’t thread-safe, you could do the following:</p>
<ul class="simple">
<li>Assign the non-thread-safe object to the template context global <tt class="docutils literal"><span class="pre">c</span></tt> in the controller’s <tt class="docutils literal"><span class="pre">__before__()</span></tt> method to make it available in the validator’s <tt class="docutils literal"><span class="pre">_to_python()</span></tt> method before the validator is called.</li>
<li>Handle the entire validation process manually, explicitly passing a state object to the <tt class="docutils literal"><span class="pre">to_python()</span></tt> method as demonstrated in the <tt class="docutils literal"><span class="pre">process()</span></tt> action of the example in the “Solving the Repeating Fields Problem” section of Chapter 6 where the template context global <tt class="docutils literal"><span class="pre">c</span></tt> is itself used as the <tt class="docutils literal"><span class="pre">state</span></tt> argument.</li>
<li>Use a <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> object to give Pylons the responsibility of using the correct version of the object for the particular request that is running.</li>
</ul>
<p class="last" id="index-865">The first two alternatives are the preferred approaches, but see the section “The Registry Manager, StackedObjectProxy, and Pylons Globals” in Chapter 17 if you want to investigate the <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> approach.</p>
</div>
</div>
</div>
<div class="section" id="adding-tags-to-pages">
<h2>Adding Tags to Pages<a class="headerlink" href="#adding-tags-to-pages" title="Permalink to this headline">¶</a></h2>
<p id="index-866">Now that you have a system for adding and editing tags, you need a way of associating tags with pages. As was mentioned earlier, you can choose to do this in two ways. The first is with the <tt class="docutils literal"><span class="pre">pagetag</span></tt> controller to provide an interface to allow users to manually add entries to the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table to create the associations. If the <tt class="docutils literal"><span class="pre">tag</span></tt> table contained more fields or didn’t have a column that could be used naturally as a primary key, then this would be a good option. In this case, though, the tag name provides a unique way to specify the tag, so you can simply provide a list of all available tags on each page with a check box next to each, and users can simply select the boxes of the tags they want to use.</p>
<p>Figure 14-5 shows what a page will look like when you’ve finished this section and saved the tags associated with a page.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1405.png"><img alt="Figure 14-5. A page containing the tag list" src="_images/9349f1405.png" /></a>
<p class="caption">Figure 14-5. A page containing the tag list</p>
</div>
<p id="index-867">Let’s start by editing the page controller’s <tt class="docutils literal"><span class="pre">view()</span></tt> action to obtain a list of all the available tag names. Update it to look like this (adding lines 9, 10 and 11):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">comment_count</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">tag_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">available_tags</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_q</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">selected_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tags&#39;</span><span class="p">:[</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/view.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="index-868">In the <tt class="docutils literal"><span class="pre">templates/derived/page/view.html</span></tt> template, add a new form for the tags just before the <tt class="docutils literal"><span class="pre">footer()</span></tt> def. The code is wrapped in a def block because later in the section you’ll need to capture its output to use with HTMLFill to populate the fields:</p>
<div class="highlight-python"><pre>&lt;%def name="tags(available_tags)"&gt;
    &lt;h2&gt;Tags&lt;/h2&gt;
    ${h.form_start(h.url_for(controller='page', action='update_tags', id=c.page.id), method='post')}
        ${h.field(
            "Tags",
            h.checkbox_group('tags', selected_values=None, align="table", options=available_tags)
        )}
        ${h.field(field=h.submit(value="Save Tags", name='submit'))}
    ${h.form_end()}
&lt;/%def&gt;</pre>
</div>
<p id="index-869">For this to work, you’ll need to add the <tt class="docutils literal"><span class="pre">check</span> <span class="pre">box_group()</span></tt> helper to <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formbuild.helpers</span> <span class="kn">import</span> <span class="n">checkbox_group</span>
</pre></div>
</div>
<p>This form will submit to the page controller&#8217;s <tt class="docutils literal"><span class="pre">update_tags()</span></tt> action which you&#8217;ll create in a minute. Once again though, you&#8217;ll need to validate the result of any form submission. Since the check boxes are effectively a set of repeating fields, you could use a <tt class="docutils literal"><span class="pre">ForEach</span></tt> validator like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidTagsForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">foreach</span><span class="o">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Int</span><span class="p">())</span>
</pre></div>
</div>
<p id="index-870">Although this schema checks that the tags have integer values, it doesn’t actually check that the values are actually valid for the tags. To do this, you could derive your own validator from the <tt class="docutils literal"><span class="pre">Int</span></tt> validator and override its <tt class="docutils literal"><span class="pre">_to_python()</span></tt> method to check the value using a similar technique to the one used in <tt class="docutils literal"><span class="pre">UniqueTag</span></tt>, but then a separate database call would need to be made for each tag that needed to be validated. Instead, you’ll create a <em>chained validator</em> that will take the list of integers and validate them all in one go. It looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidTags</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Because this is a chained validator, values will contain</span>
        <span class="c"># a dictionary with a tags key associated with a list of</span>
        <span class="c"># integer values representing the selected tags.</span>
        <span class="n">all_tag_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">tag_id</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">tag_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_tag_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span>
                    <span class="s">&quot;One or more selected tags could not be found in the database&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="p">,</span>
                    <span class="n">state</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</pre></div>
</div>
<p id="index-871">Add the <tt class="docutils literal"><span class="pre">ValidTags</span></tt> validator to the top of the <tt class="docutils literal"><span class="pre">page.py</span></tt> controller after the existing schema, then add the  the <tt class="docutils literal"><span class="pre">ValidTagsForm</span></tt> schema to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidTagsForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">foreach</span><span class="o">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Int</span><span class="p">())</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValidTags</span><span class="p">()]</span>
</pre></div>
</div>
<p id="index-872">Now we can write the <tt class="docutils literal"><span class="pre">update_tags()</span></tt> action. Add this to the page controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">ValidTagsForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">tags_to_add</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">tagids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tagids</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;flash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Tags successfully updated.&#39;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>This code iterates over the real tags twice, deleting any unselected boxes first and adding any new associations from boxes that have just been selected.</p>
<p id="index-873">Now that the tags are correctly saving, you need to ensure that their values are correctly populated when the page is displayed. To do this, you’ll call the <tt class="docutils literal"><span class="pre">tags()</span></tt> def with Mako’s special <tt class="docutils literal"><span class="pre">capture()</span></tt> function to capture the HTML from the form and then pass the HTML through HTMLFill to populate the tags. This is a lot like the method you’ve been using for populating forms, but rather than calling <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> in the controller with the whole output from the template, you are just calling it in the template with the form output from the <tt class="docutils literal"><span class="pre">tags()</span></tt> def.</p>
<p>Update the page <tt class="docutils literal"><span class="pre">view.html</span></tt> template to call the <tt class="docutils literal"><span class="pre">tags()</span></tt> def you added earlier in this section. Add this just after the <tt class="docutils literal"><span class="pre">tags()</span></tt> def and before the <tt class="docutils literal"><span class="pre">footer()</span></tt> def:</p>
<div class="highlight-python"><pre>&lt;%!
    from formencode import htmlfill
    from webhelpers.html import literal
%&gt;

% if c.available_tags:
${literal(htmlfill.render(capture(self.tags, c.available_tags), c.selected_tags))}
% endif</pre>
</div>
<p>In this case, it should be safe to use <tt class="docutils literal"><span class="pre">literal()</span></tt> here since the output from <tt class="docutils literal"><span class="pre">self.tags</span></tt> will already be escaped and <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> correctly escapes the values passed in. Notice that Mako’s <tt class="docutils literal"><span class="pre">capture()</span></tt> function takes the def to capture as the first argument and any arguments to pass to that function as subsequent arguments. If you were to call <tt class="docutils literal"><span class="pre">capture(self.tags(c.available_tags))</span></tt>, the <tt class="docutils literal"><span class="pre">tags()</span></tt> def would be called, outputting its content to the buffer, and <tt class="docutils literal"><span class="pre">capture()</span></tt> would try to call the return value from the def instead of the def itself.</p>
<p id="index-874">There is one last change you need to make. Let’s add a link in the footer to enable users to add new tags (lines 14, 15 and 16):</p>
<div class="highlight-mako"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;%</span><span class="nb">def</span> <span class="na">name=</span><span class="s">&quot;footer()&quot;</span><span class="cp">&gt;</span>
<span class="cp">## Then add our page links</span><span class="x"></span>
<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;All Pages&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;New Page&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Edit Page&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Delete Page&lt;/a&gt;</span>
<span class="x">&lt;/p&gt;</span>
<span class="cp">## Comment links</span><span class="x"></span>
<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Comments (</span><span class="cp">${</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comment_count</span><span class="p">)</span><span class="cp">}</span><span class="x">)&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Add Comment&lt;/a&gt;</span>
<span class="x">&lt;/p&gt;</span>
<span class="cp">## Tag links</span><span class="x"></span>
<span class="x">&lt;p&gt;&lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;All Tags&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Add Tag&lt;/a&gt;&lt;/p&gt;</span>
<span class="cp">## Include the parent footer too</span><span class="x"></span>
<span class="cp">${</span><span class="n">parent</span><span class="o">.</span><span class="n">footer</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="cp">&lt;/%</span><span class="nb">def</span><span class="cp">&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table></div>
<div class="section" id="deleting-tags-and-pages">
<h3>Deleting Tags and Pages<a class="headerlink" href="#deleting-tags-and-pages" title="Permalink to this headline">¶</a></h3>
<p id="index-875">When a tag is deleted, it can no longer be used on a page, so all references to that tag need to be removed from the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table. Likewise, when a page is deleted, there is little point in keeping track of which tags used to be associated with it, so all references to that page should be removed from the <tt class="docutils literal"><span class="pre">pagetag</span></tt> table too.</p>
<p>Add the following line just before <tt class="docutils literal"><span class="pre">meta.Session.delete(page)</span></tt> in the <tt class="docutils literal"><span class="pre">delete()</span></tt> action in the page controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">pageid</span><span class="o">==</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>
</div>
<p>Now add this just before <tt class="docutils literal"><span class="pre">meta.Session.delete(tag)</span></tt> in the <tt class="docutils literal"><span class="pre">delete()</span></tt> action of the tag controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">tagid</span><span class="o">==</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>
</div>
<p>Both controllers will require the following import:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">delete</span>
</pre></div>
</div>
<p id="index-876">If you visit the home page at <a class="reference external" href="http://localhost:5000/page/view/1">http://localhost:5000/page/view/1</a> and create some tags, you’ll now be able to tag pages. The application should look like it did in Figure 14-5.</p>
</div>
</div>
<div class="section" id="creating-a-navigation-hierarchy">
<h2>Creating a Navigation Hierarchy<a class="headerlink" href="#creating-a-navigation-hierarchy" title="Permalink to this headline">¶</a></h2>
<p id="index-877">Now that the basic functionality of the web site is in place, I’ll cover how to add a navigation structure to turn the application into a full (albeit simple) content management system. In this second part of the chapter, you’ll learn about table inheritance and how to structure hierarchical data in SQLAlchemy.</p>
<p>Let’s start by thinking about how pages are typically structured on web sites. Pages can usually be thought of as being divided into sections, with each section containing pages and other sections. You will need top-level tabs for the top-level sections and then a navigation menu so that the pages within each section can be displayed. You’ll also need a breadcrumb trail so that the user can always navigate to a section higher up in the hierarchy.</p>
<p>The URL for each page will be determined by the URL path info part. If a URL resolves to a section rather than to a page, you need to render the index page for that section. The index page will simply be the page in the section named <tt class="docutils literal"><span class="pre">index</span></tt>. You’ll also set up the URLs such that those with a trailing slash (<tt class="docutils literal"><span class="pre">/</span></tt>) at the end always resolve to sections and those without resolve to a page. Thus, <tt class="docutils literal"><span class="pre">/dev</span></tt> will display a page, and <tt class="docutils literal"><span class="pre">/dev/</span></tt> will display the <tt class="docutils literal"><span class="pre">index</span></tt> page in the <tt class="docutils literal"><span class="pre">dev</span></tt> section. Some people find it a little strange to have pages without file extensions, but if you would prefer your pages to have URLs that end in <tt class="docutils literal"><span class="pre">.html</span></tt>, feel free to update the code as you work through the examples.</p>
<p>The following is the URL structure to create. The first part represents the URL, the second is the name of the page, and the third part explains whether it is a page or a section:</p>
<div class="highlight-python"><pre>/ Home (Section)
    home Home (Page)
    dev/ Development (Section)
        home Development Home (Page)
        SVN Details (Page)
    Contact (Page)</pre>
</div>
<p id="index-878">The top-level tabs will therefore show the text <em>Home</em>, <em>Development</em>, and <em>Contact</em>.</p>
<div class="section" id="using-inheritance-in-sqlalchemy">
<h3>Using Inheritance in SQLAlchemy<a class="headerlink" href="#using-inheritance-in-sqlalchemy" title="Permalink to this headline">¶</a></h3>
<p id="index-879">If you think about how pages and sections might work, you’ll notice that both pages and sections will need the following attributes:</p>
<blockquote>
<ul class="simple">
<li>Unique ID</li>
<li>Display name in the navigation structure</li>
<li>URL path fragment (for example, <tt class="docutils literal"><span class="pre">/dev</span></tt> or <tt class="docutils literal"><span class="pre">dev.html</span></tt>)</li>
<li>Parent section ID</li>
<li>The ID of the sibling node that this node appears before (or <tt class="xref docutils literal"><span class="pre">None</span></tt> if this is the last node in the section)</li>
</ul>
</blockquote>
<p>Because both the pages and the sections share the same attributes, it makes sense to store them both in the same table. This table will also need a Type column to describe whether the record represents a page or a section.</p>
<p id="index-880">You can also imagine a situation where other content types are supported, perhaps Word documents or PNG images. Although you won’t implement them, you can imagine that any such objects would also need these same attributes. The characteristic that pages, sections, and other types of objects share is that they can all be accessed via a URL and should appear in the navigation structure of the site. In effect, they all can be <em>navigated</em>, so let’s name the table that will store this information <tt class="docutils literal"><span class="pre">nav</span></tt>. The new <tt class="docutils literal"><span class="pre">nav</span></tt> table looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">nav_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;nav&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;nav_id_seq&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;Untitled Node&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;nav.id&#39;</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mf">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You will still want to be able to work with page and section objects in the model, so you’ll need to use SQLAlchemy’s powerful inheritance tools so that the <tt class="docutils literal"><span class="pre">Page</span></tt> and <tt class="docutils literal"><span class="pre">Section</span></tt> classes inherit information from a <tt class="docutils literal"><span class="pre">Nav</span></tt> class. Replace the existing <tt class="docutils literal"><span class="pre">Page</span></tt> class with these three classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Nav</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Nav</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Section</span><span class="p">(</span><span class="n">Nav</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p id="index-881">You’ll also need a new mapper for the <tt class="docutils literal"><span class="pre">Nav</span></tt> class, and you’ll need to tell SQLAlchemy that <tt class="docutils literal"><span class="pre">Page</span></tt> and <tt class="docutils literal"><span class="pre">Section</span></tt> will inherit from <tt class="docutils literal"><span class="pre">Nav</span></tt> and therefore should also have all the same properties a <tt class="docutils literal"><span class="pre">Nav</span></tt> object would have. Here’s what the updated mappers look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">comment_table</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">tag_table</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Nav</span><span class="p">,</span> <span class="n">nav_table</span><span class="p">,</span> <span class="n">polymorphic_on</span><span class="o">=</span><span class="n">nav_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">polymorphic_identity</span><span class="o">=</span><span class="s">&#39;nav&#39;</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Section</span><span class="p">,</span> <span class="n">section_table</span><span class="p">,</span> <span class="n">inherits</span><span class="o">=</span><span class="n">Nav</span><span class="p">,</span> <span class="n">polymorphic_identity</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">inherits</span><span class="o">=</span><span class="n">Nav</span><span class="p">,</span> <span class="n">polymorphic_identity</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
   <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
   <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>The important points to notice are that the <tt class="docutils literal"><span class="pre">Nav</span></tt> mapper specifies that <tt class="docutils literal"><span class="pre">Nav</span></tt> is polymorphic on <tt class="docutils literal"><span class="pre">nav_table.c.type</span></tt>, in other words, that the <tt class="docutils literal"><span class="pre">type</span></tt> column will contain a string to specify whether the record is a page or a section. The <tt class="docutils literal"><span class="pre">Section</span></tt> and <tt class="docutils literal"><span class="pre">Page</span></tt> mappers then specify that they inherit from <tt class="docutils literal"><span class="pre">Nav</span></tt> and specify the text to be used in the <tt class="docutils literal"><span class="pre">nav</span></tt> table’s <tt class="docutils literal"><span class="pre">type</span></tt> column to identify them. Now would be a good time to make these changes to your model if you haven’t already done so.</p>
<p>With the class and mapper changes set up, let’s think about how you need to modify the page table and what fields you’d like the section table to contain.</p>
<p id="index-882">In SimpleSite, the section table doesn’t need to hold any data other than an ID because all the attributes it needs are already inherited from the <tt class="docutils literal"><span class="pre">nav</span></tt> table. The ID for a section has to be the same as the corresponding ID in the nav table so that SQLAlchemy knows how sections and navs are related. This means the ID should be a foreign key. Add the section table like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">section_table</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;nav.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this particular case, the attributes required suggest you could have simply created a <tt class="docutils literal"><span class="pre">Section</span></tt> object and had the <tt class="docutils literal"><span class="pre">Page</span></tt> inherit from it rather than having a separate <tt class="docutils literal"><span class="pre">Nav</span></tt> object and choosing that <tt class="docutils literal"><span class="pre">Section</span></tt> and <tt class="docutils literal"><span class="pre">Page</span></tt> inherit from it. The important point to be aware of is that you should also look at how objects you are modeling relate to each other in the real world as well as looking at how their attributes suggest they could be related. Pages aren’t really like sections because they can’t contain other pages and sections, so it is not wise to structure your model in a way that assumes they are.</p>
</div>
<p>The page table remains unchanged because you still want page-specific data stored in the <tt class="docutils literal"><span class="pre">page</span></tt> table and navigation information about the page stored in the <tt class="docutils literal"><span class="pre">nav</span></tt> table. Once again, though, the page’s ID field needs to be a foreign key representing the ID of the record in the <tt class="docutils literal"><span class="pre">nav</span></tt> table from which it inherits. Change the definition for the <tt class="docutils literal"><span class="pre">id</span></tt> column of the <tt class="docutils literal"><span class="pre">page</span></tt> table to this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;nav.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</pre></div>
</div>
<p id="index-883">With these changes in place, our <tt class="docutils literal"><span class="pre">Page</span></tt> and <tt class="docutils literal"><span class="pre">Section</span></tt> objects will automatically have all the attributes of <tt class="docutils literal"><span class="pre">Nav</span></tt> objects even though the information is physically stored in a different table.</p>
</div>
<div class="section" id="setting-up-initial-data">
<h3>Setting Up Initial Data<a class="headerlink" href="#setting-up-initial-data" title="Permalink to this headline">¶</a></h3>
<p id="index-884">Now that the new model structure is in place, you’ll need to update the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file so that the project contains more appropriate initial data. Update <tt class="docutils literal"><span class="pre">websetup.py</span></tt> so that it looks like this (notice that you drop all the tables first if the function is being called with configuration from <tt class="docutils literal"><span class="pre">test.ini</span></tt> as described in Chapter 12):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Set up the SimpleSite application&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">simplesite</span> <span class="kn">import</span> <span class="n">model</span>

<span class="kn">from</span> <span class="nn">simplesite.config.environment</span> <span class="kn">import</span> <span class="n">load_environment</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup_app</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="nb">vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Place any commands to setup simplesite here&quot;&quot;&quot;</span>
    <span class="n">load_environment</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">local_conf</span><span class="p">)</span>

    <span class="c"># Load the models</span>
    <span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">engine</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s">&#39;test.ini&#39;</span><span class="p">:</span>
        <span class="c"># Permanently drop any existing tables</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Dropping existing tables...&quot;</span><span class="p">)</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Continue as before</span>
    <span class="c"># Create the tables if they aren&#39;t there already</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding home page...&quot;</span><span class="p">)</span>
    <span class="n">section_home</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">()</span>
    <span class="n">section_home</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;&#39;</span>
    <span class="n">section_home</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;Home Section&#39;</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">section_home</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">page_contact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="n">page_contact</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Contact Us&#39;</span>
    <span class="n">page_contact</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;contact&#39;</span>
    <span class="n">page_contact</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;Contact Us Page&#39;</span>
    <span class="n">page_contact</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;Contact us page&#39;</span>
    <span class="n">page_contact</span><span class="o">.</span><span class="n">section</span><span class="o">=</span><span class="n">section_home</span><span class="o">.</span><span class="n">id</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page_contact</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">section_dev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">()</span>
    <span class="n">section_dev</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;dev&#39;</span>
    <span class="n">section_dev</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;Development Section&#39;</span>
    <span class="n">section_dev</span><span class="o">.</span><span class="n">section</span><span class="o">=</span><span class="n">section_home</span><span class="o">.</span><span class="n">id</span>
    <span class="n">section_dev</span><span class="o">.</span><span class="n">before</span><span class="o">=</span><span class="n">page_contact</span><span class="o">.</span><span class="n">id</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">section_dev</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">page_svn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="n">page_svn</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;SVN Page&#39;</span>
    <span class="n">page_svn</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;svn&#39;</span>
    <span class="n">page_svn</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;SVN Page&#39;</span>
    <span class="n">page_svn</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;This is the SVN page.&#39;</span>
    <span class="n">page_svn</span><span class="o">.</span><span class="n">section</span><span class="o">=</span><span class="n">section_dev</span><span class="o">.</span><span class="n">id</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page_svn</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">page_dev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Development Home&#39;</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;index&#39;</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;Development Page&#39;</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">content</span><span class="o">=</span><span class="s">u&#39;This is the development home page.&#39;</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">section</span><span class="o">=</span><span class="n">section_dev</span><span class="o">.</span><span class="n">id</span>
    <span class="n">page_dev</span><span class="o">.</span><span class="n">before</span><span class="o">=</span><span class="n">page_svn</span><span class="o">.</span><span class="n">id</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page_dev</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">page_home</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Home&#39;</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">u&#39;index&#39;</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">u&#39;Home&#39;</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">content</span><span class="o">=</span><span class="s">u&#39;Welcome to the SimpleSite home page.&#39;</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">section</span><span class="o">=</span><span class="n">section_home</span><span class="o">.</span><span class="n">id</span>
    <span class="n">page_home</span><span class="o">.</span><span class="n">before</span><span class="o">=</span><span class="n">section_dev</span><span class="o">.</span><span class="n">id</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page_home</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Successfully set up.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-885">Now that you have updated the model and written a new <tt class="docutils literal"><span class="pre">websetup.py</span></tt>, you need the changes to be reflected in the underlying database. The easiest way of doing this is to create a new database from scratch. Once you’ve done this, you’ll continue with the tutorial.</p>
<div class="highlight-python"><pre>$ mv development.db development.db.old
$ paster setup-app development.ini</pre>
</div>
<p id="index-886">With these changes in place, IDs are shared between pages and sections. This means that nav ID 1 represents a section, whereas nav ID 2 represents a page. Visiting <a class="reference external" href="http://localhost:5000/page/view/1">http://localhost:5000/page/view/1</a> will therefore give a 404 Not Found response because there is no page with an ID of 1. In fact, the home page now has an ID of 6.</p>
</div>
<div class="section" id="creating-the-controllers">
<h3>Creating the Controllers<a class="headerlink" href="#creating-the-controllers" title="Permalink to this headline">¶</a></h3>
<p id="index-887">Now that the model correctly supports the navigation structure, you’ll need to think again about the controllers.</p>
<p>I mentioned before that you generally need a controller for every table in your database, but in this case you might think that there isn’t a lot of point in having a controller for the navigation table because the <tt class="docutils literal"><span class="pre">Section</span></tt> and <tt class="docutils literal"><span class="pre">Page</span></tt> objects in the model handle all the functionality for that table anyway. It turns out that it can be useful to have a navigation controller as long as it can’t be accessed directly because both the page and section controllers can inherit any functionality that affects only the nav table, such as the ability to move pages or sections. Create the navigation controller and a directory for its templates:</p>
<div class="highlight-python"><pre>$ paster controller nav
$ cd simplesite/templates/derived
$ mkdir nav</pre>
</div>
<p id="index-888">Now change the <tt class="docutils literal"><span class="pre">NavController</span></tt> class. Delete the <tt class="docutils literal"><span class="pre">index()</span></tt> action, and add a <tt class="docutils literal"><span class="pre">__before__()</span></tt> method that prevents any of the actions you’ll add later being called directly as a result of a URL being entered:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
</pre></div>
</div>
<p>You’ll also need to add the following imports:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>
</pre></div>
</div>
<p>With the nav controller in place, let’s start by thinking about the section controller.</p>
<p id="index-889">Your users will need to be able to add, edit, and remove sections just as they can with pages, but they probably won’t need to list all the sections. Let’s use the <tt class="docutils literal"><span class="pre">template.py.txt</span></tt> file you created earlier in the chapter as a starting point for the new controller:</p>
<div class="highlight-python"><pre>$ cd simplesite/controllers
$ cp template.py.txt section.py
$ perl -pi -w -e 's/comment/section/g; s/Comment/Section/g;' section.py</pre>
</div>
<p>Now let’s also create a set of templates:</p>
<div class="highlight-python"><pre>$ cd ../templates/derived
$ cp -r page section
$ cd section
$ perl -pi -w -e 's/page/section/g; s/Page/Section/g;' *.html</pre>
</div>
<p>Delete the <tt class="docutils literal"><span class="pre">section/list.html</span></tt> template because you won’t need it. Now restart the server if you stopped it to make these changes:</p>
<div class="highlight-python"><pre>$ cd ../../../../
$ paster serve --reload development.ini</pre>
</div>
<p id="index-890">As usual, let’s start by thinking about the FormEncode schema you’re going to need. You’ll need validators for each of the columns in the <tt class="docutils literal"><span class="pre">nav</span></tt> table. To validate the value of the <tt class="docutils literal"><span class="pre">before</span></tt> column (which is used to determine the order of pages and sections within a subsection), you’ll need a custom validator. Since pages also have a value of <tt class="docutils literal"><span class="pre">before</span></tt>, they will need the same validator, so rather than defining the custom validator in the section controller, let’s create the validators in the nav controller. Add this to the nav controller after the existing imports:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">formencode</span>

<span class="k">class</span> <span class="nc">ValidBefore</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks the ID specified in the before field is valid&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
        <span class="c"># Check the value for before is in the section</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">):</span>
            <span class="n">valid_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nav</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                <span class="n">section</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;Please check the section &quot;</span>
                    <span class="s">&quot;and before values&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

<span class="k">class</span> <span class="nc">NewNavForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s">&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class="p">)</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">before</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValidBefore</span><span class="p">()]</span>
</pre></div>
</div>
<p id="index-891">The <tt class="docutils literal"><span class="pre">NewNavForm</span></tt> schema handles each of the fields but uses the <tt class="docutils literal"><span class="pre">ValidBefore</span></tt> chained validator to also check that the navigation node specified in <tt class="docutils literal"><span class="pre">before</span></tt> is either <tt class="xref docutils literal"><span class="pre">None</span></tt> (which means add the new section at the end of the existing section) or is the ID of a navigation node, which does exist in that section. You’ll recall that chained validators are run only once after all the individual validators for each of the fields have been checked. The schema also uses a <tt class="docutils literal"><span class="pre">Regex</span></tt> validator to ensure that only allowed characters are used on the path.</p>
<p>Let’s now use the <tt class="docutils literal"><span class="pre">NewNavForm</span></tt> schema as a basis for creating a schema for new sections. Add this to the section controller in place of the existing <tt class="docutils literal"><span class="pre">NewSectionForm</span></tt> schema:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite.controllers.nav</span> <span class="kn">import</span> <span class="n">NewNavForm</span><span class="p">,</span> <span class="n">ValidBefore</span>

<span class="k">class</span> <span class="nc">UniqueSectionPath</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="s">&quot;Checks that there isn&#39;t already an existing section with the same path&quot;</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;save&#39;</span><span class="p">:</span>
            <span class="c"># Ignore the existing ID when performing the check</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;There is already a section in this &quot;</span>
                <span class="s">&quot;section with this path&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

<span class="k">class</span> <span class="nc">NewSectionForm</span><span class="p">(</span><span class="n">NewNavForm</span><span class="p">):</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValidBefore</span><span class="p">(),</span> <span class="n">UniqueSectionPath</span><span class="p">()]</span>
</pre></div>
</div>
<p id="index-892">The <tt class="docutils literal"><span class="pre">UniqueSectionPath</span></tt> validator ensures there isn’t another subsection with the same path in the section to which this section is being added. Although this code works well for adding a new section, there are some different constraints when editing a section. Sections cannot be moved to sections that are children of the section being moved. This means you need another validator to ensure that if the section is being edited, the new section is in a valid position. Here’s the new validator and an <tt class="docutils literal"><span class="pre">EditNavForm</span></tt> that uses it. Add them to the section controller after the <tt class="docutils literal"><span class="pre">NewSectionForm</span></tt> you just added:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidSectionPosition</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;section&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;section&#39;</span><span class="p">:</span>
            <span class="c"># Make sure the section we are moving to is not already</span>
            <span class="c"># a subsection of the current section</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="n">current_section</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">section</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="n">current_section</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;You cannot move a section to &quot;</span>
                        <span class="s">&quot;one of its subsections&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">values</span>

<span class="k">class</span> <span class="nc">EditSectionForm</span><span class="p">(</span><span class="n">NewNavForm</span><span class="p">):</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ValidBefore</span><span class="p">(),</span>
        <span class="n">UniqueSectionPath</span><span class="p">(),</span>
        <span class="n">ValidSectionPosition</span><span class="p">()</span>
    <span class="p">]</span>
</pre></div>
</div>
<p id="index-893">The <tt class="docutils literal"><span class="pre">ValidSectionPosition</span></tt> validator iterates through each of the parent sections of the section to which you are trying to move the section you are editing. If it reaches the top of the navigation tree without finding the section you are moving, then you are allowed to move the section.</p>
<p id="index-894">At this point, all the validators that will be shared between pages and sections are in the nav controller, and all the validators that the section needs are in the section controller, but they inherit from those in the navigation controller. You’ll make the necessary changes to the page controller later in the chapter, so now let’s think about the templates.</p>
<p id="index-895">Both the page and the section will need the extra fields from the <tt class="docutils literal"><span class="pre">nav</span></tt> table, so create a new file called <tt class="docutils literal"><span class="pre">fields.html</span></tt> in the <tt class="docutils literal"><span class="pre">templates/derived/nav/</span></tt> directory to be shared by the page and section templates. Add the following content:</p>
<div class="highlight-python"><pre>${h.field(
    "Name",
    h.text(name='name'),
    required=True,
)}
${h.field(
    "Path",
    h.text(name='path'),
    required=True,
)}
${h.field(
    'Section',
    h.select(
        "section",
        id='section',
        selected_values=[],
        options=c.available_sections,
    ),
    required=True
)}
${h.field(
    "Before",
    h.text(
        "before",
        id='before',
    ),
)}</pre>
</div>
<p id="index-896">These fields will be used by both the page controller and the section controller. Update the <tt class="docutils literal"><span class="pre">derived/section/fields.html</span></tt> file to import and use the fields you’ve just created:</p>
<div class="highlight-python"><pre>&lt;%namespace file="/derived/nav/fields.html" name="fields" import="*"/&gt;
## Nav fields
${fields.body()}
## Section fields would go here if there were any</pre>
</div>
<p>Because of the way the templates are set up, these fields will be used in both the <tt class="docutils literal"><span class="pre">derived/section/new.html</span></tt> and <tt class="docutils literal"><span class="pre">derived/section/edit.html</span></tt> templates. You’ll notice that the section field relies on the value of <tt class="docutils literal"><span class="pre">c.available_sections</span></tt>. You haven’t set this up yet, so let’s do that now by adding the following <tt class="docutils literal"><span class="pre">__before__()</span></tt> method to the section controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="n">nav_q</span><span class="o">=</span><span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nav_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">!=</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">available_sections</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nav</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav_q</span><span class="p">]</span>
</pre></div>
</div>
<p>Notice that you are using a query based on <tt class="docutils literal"><span class="pre">model.Nav</span></tt> here and specifying <tt class="docutils literal"><span class="pre">type='section'</span></tt> in the filter rather than querying <tt class="docutils literal"><span class="pre">model.Section</span></tt>. This is because the <tt class="docutils literal"><span class="pre">nav</span></tt> table contains the <tt class="docutils literal"><span class="pre">name</span></tt> column you need access to, but the section table doesn’t.</p>
<p>At this point you’ll be able to see the form for creating a new section by visiting <a class="reference external" href="http://localhost:5000/section/new">http://localhost:5000/section/new</a>. This is shown in Figure 14-6, but the section won’t save correctly yet.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1406.png"><img alt="Figure 14-6. The create section form" src="_images/9349f1406.png" /></a>
<p class="caption">Figure 14-6. The create section form</p>
</div>
<p id="index-897">Simply adding the section to the table isn’t enough. Because this is a hierarchy, you also need to modify the node this node appears before to update its value of <tt class="docutils literal"><span class="pre">before</span></tt> to point to the ID of the section the user is adding so that the ordering is correct. You could add a function to perform this task as a helper, but in this case the work mainly has to do with the model, so it would be better to add it there.</p>
<p>Rather than simply adding the function to the model module itself, you’re going to add it as a static method to the <tt class="docutils literal"><span class="pre">Nav</span></tt> class. A static method in Python is one that is associated with the class itself and not the instance of a class. As such, it doesn’t have a <tt class="docutils literal"><span class="pre">self</span></tt> argument. Update the <tt class="docutils literal"><span class="pre">Nav</span></tt> class in <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt> to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Nav</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_navigation_node</span><span class="p">(</span><span class="n">nav</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">before</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Nav</span><span class="p">)</span>
        <span class="n">new_before</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">before</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_before</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_before</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">nav</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">new_before</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
<p>You can now access this functionality as <tt class="docutils literal"><span class="pre">model.Nav.add_navigation_node()</span></tt> in your controllers without needing any additional imports, and it is clear what the functionality does. The <tt class="docutils literal"><span class="pre">Section</span></tt> and <tt class="docutils literal"><span class="pre">Page</span></tt> classes will also inherit this method, although you’ll use the version attached to <tt class="docutils literal"><span class="pre">Nav</span></tt> to keep what is happening more explicit.</p>
<p>Update the section controller’s <tt class="docutils literal"><span class="pre">create()</span></tt> action so that the navigation structure is correctly updated when a section is added by calling <tt class="docutils literal"><span class="pre">model.Nav.add_navigation_node()</span></tt>. Since a section isn’t a lot of use on its own, let’s also generate an index page for the section. To do this, you need to flush the session so that the <tt class="docutils literal"><span class="pre">section</span></tt> object gets assigned an ID. You can then use the ID to help create the index page. The finished code looks like this with new lines 9-19 and 22:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewSectionForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Add the new section to the database</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">add_navigation_node</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">])</span>
    <span class="c"># Flush the data to get the session ID.</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">index_page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="n">index_page</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">id</span>
    <span class="n">index_page</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">&#39;index&#39;</span>
    <span class="n">index_page</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Section Index&#39;</span>
    <span class="n">index_page</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Section Index&#39;</span>
    <span class="n">index_page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">&#39;This is the index page for this section.&#39;</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="index-898">Since you can’t actually <em>see</em> a section, there isn’t a lot of point in having the <tt class="docutils literal"><span class="pre">create()</span></tt> action redirect to a view of it. For this reason, delete the <tt class="docutils literal"><span class="pre">view()</span></tt> action and the <tt class="docutils literal"><span class="pre">view.html</span></tt> template because you won’t use them. For the time being, after you create a new section, you’ll get the error <tt class="docutils literal"><span class="pre">&quot;Action</span> <span class="pre">u'view'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">implemented&quot;</span></tt>. You’ll fix this later in the chapter.</p>
<p>Now that you can create sections, let’s think about editing them. First you’ll need to update the <tt class="docutils literal"><span class="pre">edit()</span></tt> action so that the <tt class="docutils literal"><span class="pre">values</span></tt> reflect those of a section. It should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
    <span class="s">&#39;section&#39;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">section</span><span class="p">,</span>
    <span class="s">&#39;before&#39;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">before</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When you save a section, there is a chance you are moving it to another section. If this is the case, you need to formally remove it from the node hierarchy before adding it in the new location. You already have an <tt class="docutils literal"><span class="pre">add_navigation_node()</span></tt> method, so here’s the <tt class="docutils literal"><span class="pre">remove_navigation_node()</span></tt> static method. Add this to the <tt class="docutils literal"><span class="pre">Nav</span></tt> class in <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt> too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">remove_navigation_node</span><span class="p">(</span><span class="n">nav</span><span class="p">):</span>
    <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Nav</span><span class="p">)</span>
    <span class="n">old_before</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">nav</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">nav</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">old_before</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">old_before</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">before</span>
</pre></div>
</div>
<p id="index-899">Update the section controller’s <tt class="docutils literal"><span class="pre">save()</span></tt> action to look like this. Make sure you update the redirect code and change the schema in the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator to use the <tt class="docutils literal"><span class="pre">EditSectionForm</span></tt> you created earlier. Lines 2, 8-12 and 20 are new or have changed.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">EditSectionForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">section_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">)</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">section_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">]</span> <span class="ow">and</span> \
        <span class="n">section</span><span class="o">.</span><span class="n">before</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">remove_navigation_node</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">add_navigation_node</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;flash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Section successfully updated.&#39;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Once again, when you save a section after editing, you will be redirected to the nonexistent <tt class="docutils literal"><span class="pre">view()</span></tt> action. You’ll fix this later too.</p>
<p id="index-900">Next you’ll need to look at the <tt class="docutils literal"><span class="pre">delete()</span></tt> action. Ideally you should not be able to delete a section while it still contains pages or subsections. However, if you deleted all the pages a section contained, then there would be no page on which to display a link to delete the section. Instead, you will set things up so that deleting a section also deletes its <tt class="docutils literal"><span class="pre">index</span></tt> page, but you can’t delete a section if any other pages or sections exist within the section you’re deleting. Update the <tt class="docutils literal"><span class="pre">delete()</span></tt> action so that it looks like this (lines 8-16 are new or have changed):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">section_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">)</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">section_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">path</span> <span class="o">!=</span> <span class="s">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/section/cannot_delete.html&#39;</span><span class="p">)</span>
    <span class="n">index_page</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">index_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">remove_navigation_node</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">index_page</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">remove_navigation_node</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/section/deleted.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="index-901">You’ll need to create the <tt class="docutils literal"><span class="pre">derived/section/cannot_delete.html</span></tt> file with this content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Cannot Delete&lt;/h1&gt;&lt;/%def&gt;

&lt;p&gt;You cannot delete a section which still contains pages or subsections
other than the index page. Please delete the pages and subsections
first.&lt;/p&gt;</pre>
</div>
<p id="index-902">That’s it—now you can also delete sections, but before we move on, let’s add the section links to the page footer so that users can access the functionality you’ve just implemented without having to type the URL directly. Edit <tt class="docutils literal"><span class="pre">templates/derived/page/view.html</span></tt> and update the <tt class="docutils literal"><span class="pre">footer()</span></tt> def to add the section links in lines 14-19, notice line 5 has changed too:</p>
<div class="highlight-mako"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;%</span><span class="nb">def</span> <span class="na">name=</span><span class="s">&quot;footer()&quot;</span><span class="cp">&gt;</span>
<span class="cp">## Then add our page links</span><span class="x"></span>
<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;All Pages&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">before</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;New Page&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Edit Page&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Delete Page&lt;/a&gt;</span>
<span class="x">&lt;/p&gt;</span>
<span class="cp">## Comment links</span><span class="x"></span>
<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Comments (</span><span class="cp">${</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comment_count</span><span class="p">)</span><span class="cp">}</span><span class="x">)&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Add Comment&lt;/a&gt;</span>
<span class="x">&lt;/p&gt;</span>
<span class="cp">## Section links</span><span class="x"></span>
<span class="x">&lt;p&gt;</span>
<span class="x">  &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">before</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;New Section&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">section</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Edit Section&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">section</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Delete Section and Index Page&lt;/a&gt;</span>
<span class="x">&lt;/p&gt;</span>
<span class="cp">## Tag links</span><span class="x"></span>
<span class="x">&lt;p&gt;&lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;All Tags&lt;/a&gt;</span>
<span class="x">| &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Add Tag&lt;/a&gt;&lt;/p&gt;</span>
<span class="cp">## Include the parent footer too</span><span class="x"></span>
<span class="cp">${</span><span class="n">parent</span><span class="o">.</span><span class="n">footer</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="cp">&lt;/%</span><span class="nb">def</span><span class="cp">&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table></div>
<p id="index-903">You’ll notice that the call to <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> to the section controller’s <tt class="docutils literal"><span class="pre">new()</span></tt> action contains some extra arguments, <tt class="docutils literal"><span class="pre">section</span></tt> and <tt class="docutils literal"><span class="pre">before</span></tt>. When Routes’ <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> function gets passed arguments, and it doesn’t recognize them; it will simply add them as parameters to the query string. In this case, the arguments represent information about the current page that can be used on the <tt class="docutils literal"><span class="pre">new()</span></tt> action to automatically populate some of the values. The URL generated might look like <tt class="docutils literal"><span class="pre">/section/new?section=1&amp;before=7</span></tt>. To take advantage of these arguments, you will have to update the section controller’s <tt class="docutils literal"><span class="pre">new()</span></tt> action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">u&#39;None&#39;</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/section/new.html&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-904">The <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> call to create a new page has also had a similar change. It now takes both the section and the before value of the current page as arguments too, so now you can turn your attention to updating the page controller.</p>
</div>
<div class="section" id="the-page-controller">
<h3>The Page Controller<a class="headerlink" href="#the-page-controller" title="Permalink to this headline">¶</a></h3>
<p id="index-905">Let’s start by updating the page controller’s <tt class="docutils literal"><span class="pre">new()</span></tt> action to accept the variables that will be passed to it when a user clicks the New Page link now that you’ve updated the arguments to <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> in the page view template footer. The new action should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">u&#39;None&#39;</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/new.html&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<p>The page controller also needs the same fields and functionality as the section controller. This is not surprising since both sections and pages inherit from the <tt class="docutils literal"><span class="pre">Nav</span></tt> class. Edit the <tt class="docutils literal"><span class="pre">derived/page/fields.html</span></tt> file to include fields from the <tt class="docutils literal"><span class="pre">derived/nav/fields.html</span></tt> file. Add the following at the top of the before the existing fields:</p>
<div class="highlight-python"><pre>&lt;%namespace file="/derived/nav/fields.html" name="fields" import="*"/&gt;
## Nav fields
${fields.body()}
## Page fields</pre>
</div>
<p id="index-906">Now that the extra fields are in place, let’s change the <tt class="docutils literal"><span class="pre">NewPageForm</span></tt> schema in the page controller to inherit from <tt class="docutils literal"><span class="pre">NewNavForm</span></tt> instead of <tt class="docutils literal"><span class="pre">formencode.Schema</span></tt> so that it has all the validators of <tt class="docutils literal"><span class="pre">NewNavForm</span></tt> as well as its own. You’ll also need a <tt class="docutils literal"><span class="pre">UniquePagePath</span></tt> validator to ensure there isn’t already a page with the same name in the current section. Add this to the top of <tt class="docutils literal"><span class="pre">page.py</span></tt> replacing the existing <tt class="docutils literal"><span class="pre">NewPageForm</span></tt> schema:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite.controllers.nav</span> <span class="kn">import</span> <span class="n">NewNavForm</span><span class="p">,</span> <span class="n">ValidBefore</span>

<span class="k">class</span> <span class="nc">UniquePagePath</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
            <span class="nb">type</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;save&#39;</span><span class="p">:</span>
            <span class="c"># Ignore the existing id when performing the check</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urlvars</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;There is already a page in this &quot;</span>
                <span class="s">&quot;section with this path&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

<span class="k">class</span> <span class="nc">NewPageForm</span><span class="p">(</span><span class="n">NewNavForm</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;empty&#39;</span><span class="p">:</span><span class="s">&#39;Please enter some content for the page. &#39;</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">ValidBefore</span><span class="p">(),</span> <span class="n">UniquePagePath</span><span class="p">()]</span>
</pre></div>
</div>
<p id="index-907">Notice that the <tt class="docutils literal"><span class="pre">NewPageForm</span></tt> schema also has the same <tt class="docutils literal"><span class="pre">ValidBefore()</span></tt> chained validator as the <tt class="docutils literal"><span class="pre">NewSectionForm</span></tt>.</p>
<p>Now modify the page controller’s <tt class="docutils literal"><span class="pre">create()</span></tt> action so that new pages are added in the correct place in the hierarchy and the redirect code is updated (lines 9, 10 and 13 have changed).</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Add the new page to the database</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">add_navigation_node</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">])</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>And just as with the section controller, update the redirect code and change the lines in the <tt class="docutils literal"><span class="pre">save()</span></tt> action before the line <tt class="docutils literal"><span class="pre">for</span> <span class="pre">k,v</span> <span class="pre">in</span> <span class="pre">self.form_result.items():</span></tt> (lines 8-12 and 20):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">]</span> <span class="ow">and</span> \
        <span class="n">page</span><span class="o">.</span><span class="n">before</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">remove_navigation_node</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">add_navigation_node</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;flash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Page successfully updated.&#39;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p id="index-908">Now you’ll need to update the <tt class="docutils literal"><span class="pre">edit()</span></tt> method so that it also populates all the new values (lines 2-5):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre>1
2
3
4
5
6
7
8
9</pre></td><td class="code"><div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
    <span class="s">&#39;section&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">section</span><span class="p">,</span>
    <span class="s">&#39;before&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">before</span><span class="p">,</span>
    <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
    <span class="s">&#39;heading&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">heading</span><span class="p">,</span>
    <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>For this to work, you’ll need a similar <tt class="docutils literal"><span class="pre">__before__()</span></tt> action used in the section controller to set <tt class="docutils literal"><span class="pre">c.available_sections</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__before__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">available_sections</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nav</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">nav</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>You’ll also need to update the <tt class="docutils literal"><span class="pre">delete()</span></tt> action. This is much easier than it is for sections; simply add line 10 below:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">pagetag_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">pageid</span><span class="o">==</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">remove_navigation_node</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/deleted.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="changing-the-routing">
<h2>Changing the Routing<a class="headerlink" href="#changing-the-routing" title="Permalink to this headline">¶</a></h2>
<p id="index-909">At this point you now have all the functionality necessary for a fully working web site. These are the only missing elements:</p>
<blockquote>
<ul class="simple">
<li>The ability to enter a proper URL rather than the ID of the page you want to view</li>
<li>Navigation controls such as tags, a menu, and breadcrumbs</li>
</ul>
</blockquote>
<p>Before I get into too much detail about the code, I’ll discuss exactly how these things will be implemented. You want a setup where the URL appears as if it is mapping to a directory structure of sections and subsections. So, rather than visiting <tt class="docutils literal"><span class="pre">/page/view/4</span></tt> to view the SVN page in the development section, you will be able to access it as <tt class="docutils literal"><span class="pre">/dev/svn</span></tt>. To do this, you need to get Routes to understand your alternative URL structure. You’ll also want some navigation components. You’ll use a set of tabs for the main navigation. Any page or section that is in the home section will be displayed on these tabs. For any page that isn’t in the home section, a navigation menu will be also generated to display the links in that section. Finally, you’ll have a breadcrumb trail so that users can see where they are in the navigation hierarchy. There’s a lot to do, so let’s get started.</p>
<p id="index-910">You’ll implement both these elements, but you’ll start with the routing. Ideally, you want to be able to specify a route that will handle a URL not already matched by the other routes. You can do this by using a wildcard part, as you learned in Chapter 9. One approach could be to add a route like this as the last route in SimpleSite’s <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;*url&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;nav&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This would redirect any URL not already matched by the other routes to the page controller’s <tt class="docutils literal"><span class="pre">nav()</span></tt> action from where the appropriate dispatch can be performed; however, there is also a slightly neater solution that involves having the page or section ID calculated as part of the matching process. This avoids needing to use a controller action for dispatch.</p>
<p id="index-911">Create a named route called <tt class="docutils literal"><span class="pre">path</span></tt> as the last route in the route map, and specify a function condition on the route called <tt class="docutils literal"><span class="pre">parse()</span></tt> and a filter on the route named <tt class="docutils literal"><span class="pre">build()</span></tt>. Conditions and filters are advanced Routes functionality that I discussed in Chapter 9. Here’s how the route map should look, with the new route on line 24:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_map</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create, configure and return the routes Mapper&quot;&quot;&quot;</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.paths&#39;</span><span class="p">][</span><span class="s">&#39;controllers&#39;</span><span class="p">],</span>
                 <span class="n">always_scan</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">],</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">minimization</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># The ErrorController route (handles 404/500 error pages); it should</span>
    <span class="c"># likely stay at the top, ensuring it can always be resolved</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/error/{action}&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/error/{action}/{id}&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">)</span>

    <span class="c"># CUSTOM ROUTES HERE</span>

    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="s">&#39;/page/{pageid}/{controller}/{action}&#39;</span><span class="p">,</span>
        <span class="n">requirements</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="s">&#39;/page/{pageid}/{controller}/{action}/{id}&#39;</span><span class="p">,</span>
        <span class="n">requirements</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&#39;\d+&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/{controller}/{action}&#39;</span><span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/{controller}/{action}/{id}&#39;</span><span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="s">&#39;*url&#39;</span><span class="p">,</span> <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;function&#39;</span><span class="p">:</span><span class="n">parse</span><span class="p">},</span> <span class="n">_filter</span><span class="o">=</span><span class="n">build</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">map</span>
</pre></div>
</td></tr></table></div>
<p>Add the <tt class="docutils literal"><span class="pre">parse()</span></tt> and <tt class="docutils literal"><span class="pre">build()</span></tt> functions to the top of the <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> file before the <tt class="docutils literal"><span class="pre">make_map()</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite</span> <span class="kn">import</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;simplesite.navigation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">navigation_from_path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NoPage</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;controller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;nav&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;nopage&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">section</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">path</span>
    <span class="k">except</span> <span class="n">NoSection</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;controller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;nav&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;nosection&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">section</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">path</span>
    <span class="k">except</span> <span class="n">NotFound</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># This causes the route to not match</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;controller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;page&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;view&#39;</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;simplesite.navigation&#39;</span><span class="p">][</span><span class="s">&#39;page&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">routing_variables</span><span class="p">):</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">routing_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;controller&#39;</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">routing_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;action&#39;</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">routing_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">routing_variables</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">routing_variables</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="o">.</span><span class="n">nav_to_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">routing_variables</span>
</pre></div>
</div>
<p id="index-912">When Routes can’t match any URL against the other routes, the <tt class="docutils literal"><span class="pre">'path'</span></tt> named route you’ve just added gets tested. This causes the <tt class="docutils literal"><span class="pre">parse()</span></tt> condition to be called, which in turn calls the <tt class="docutils literal"><span class="pre">navigation_from_path()</span></tt> function with the current URL as its argument.</p>
<p id="index-913">I’ll show you the <tt class="docutils literal"><span class="pre">navigation_from_path()</span></tt> function in a moment, but let’s think about what it has to do. Its main job is to match the URL entered against a section or page that already exists so that the correct routing variables can be set up. If the URL doesn’t match an existing section or a page, the function should ideally determine whether it is possible to create a page or section at that URL. If it is possible, you’ll need some mechanism to let the user know they can create a section or page. If it isn’t, a 404 Not Found response should be returned.</p>
<p>It turns out that performing these checks requires the <tt class="docutils literal"><span class="pre">navigation_from_path()</span></tt> function to look up each part of the URL to check that it exists and to determine whether it is a section or page. Since these checks are already being performed, it makes sense for the same function to also gather the information that will be required to generate the navigation components you’d like to use in the site including top-level tabs, a menu, and breadcrumbs. This is precisely what the function does, returning a dictionary with the following keys:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">breadcrumbs</span></tt></dt>
<dd>A list of all the sections in the navigation hierarchy up to the current node, followed by the final page or section. Each item in the list has an attribute added called <tt class="docutils literal"><span class="pre">path_info</span></tt>, which is the full URL <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt> to that page or section that can be used to help generate links.</dd>
<dt><tt class="docutils literal"><span class="pre">menu</span></tt></dt>
<dd>A list of all the pages and sections in the section to which the URL resolves.</dd>
<dt><tt class="docutils literal"><span class="pre">tabs</span></tt></dt>
<dd>The pages and sections in the topmost section. Used in the main navigation tabs.</dd>
<dt><tt class="docutils literal"><span class="pre">page</span></tt></dt>
<dd>The page object for the page the URL resolves to or the <tt class="docutils literal"><span class="pre">index</span></tt> page if the URL resolves to a section.</dd>
</dl>
<p>This dictionary returned is then added to the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary as the <tt class="docutils literal"><span class="pre">simplesite.navigation</span></tt> key so that it can be accessed in the rest of the application.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some people would argue that this sort of functionality is better implemented as Web Server Gateway Interface middleware. You’ll learn about middleware in Chapter 16 and are free to reimplement the previous functionality a different way if you prefer.</p>
</div>
<p id="index-914">The <tt class="docutils literal"><span class="pre">navigation_from_path()</span></tt> function is shown here together with the <tt class="docutils literal"><span class="pre">menu()</span></tt> function it relies on and three <tt class="docutils literal"><span class="pre">Exception</span></tt> classes that are used as part of the process. The code looks like this and should be added to the top of <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> after the <tt class="docutils literal"><span class="pre">build()</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NoPage</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">NoSection</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">NotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">navigation_from_path</span><span class="p">(</span><span class="n">path_info</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nav_q</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Nav</span><span class="p">)</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">path_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">path_info</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">path_info</span> <span class="o">+=</span> <span class="s">&#39;index&#39;</span>
    <span class="n">path_parts</span> <span class="o">=</span> <span class="n">path_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_parts</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path_info</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/index&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span><span class="o">-</span><span class="mf">2</span><span class="p">:</span>
                <span class="n">exception</span> <span class="o">=</span> <span class="n">NoSection</span><span class="p">(</span><span class="s">&#39;No section exists here&#39;</span><span class="p">)</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">exception</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s">&#39;No section can be created here&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span>
        <span class="n">section</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path_parts</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span><span class="o">-</span><span class="mf">1</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">NoPage</span><span class="p">(</span><span class="s">&#39;No page exists here&#39;</span><span class="p">)</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="s">&#39;No page can be created here&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">])</span>
    <span class="c"># Add the path_info</span>
    <span class="n">cur_path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">breadcrumb</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">]:</span>
        <span class="n">cur_path</span> <span class="o">+=</span><span class="n">breadcrumb</span><span class="o">.</span><span class="n">path</span>
        <span class="n">breadcrumb</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=</span> <span class="n">cur_path</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">breadcrumb</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">):</span>
            <span class="n">breadcrumb</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=</span> <span class="n">cur_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
            <span class="n">cur_path</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;menu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu</span><span class="p">(</span><span class="n">nav_q</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">.</span><span class="n">path_info</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;tabs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu</span><span class="p">(</span><span class="n">nav_q</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">path_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">nav_q</span><span class="p">,</span> <span class="n">sectionid</span><span class="p">,</span> <span class="n">path_info</span><span class="p">):</span>
    <span class="c"># There might also be child sections</span>
    <span class="n">last</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">navs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nav</span> <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">sectionid</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nav_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">before</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">navs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">before</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># This is our last node</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">nav</span>
            <span class="k">break</span>
    <span class="n">menu_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([[</span><span class="n">nav</span><span class="o">.</span><span class="n">before</span><span class="p">,</span> <span class="n">nav</span><span class="p">]</span> <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">navs</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No last node found&#39;</span><span class="p">)</span>
    <span class="c"># Iterate over the nodes building them up in the correct order</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="p">[</span><span class="n">last</span><span class="p">]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">menu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">navs</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">menu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">menu_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;This section doesn&#39;t have an item </span><span class="si">%s</span><span class="s"> to go &quot;</span>
                <span class="s">&quot;before </span><span class="si">%r</span><span class="s"> id </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">menu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">menu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">menu_dict</span><span class="p">[</span><span class="n">menu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="n">f_menu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">menu_item</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
        <span class="n">menu_item</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=</span> <span class="n">path_info</span> <span class="o">+</span> <span class="n">menu_item</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">menu_item</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Section</span><span class="p">):</span>
            <span class="n">menu_item</span><span class="o">.</span><span class="n">path_info</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="k">elif</span> <span class="n">menu_item</span><span class="o">.</span><span class="n">path_info</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/index&#39;</span><span class="p">):</span>
            <span class="n">menu_item</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=</span> <span class="n">menu_item</span><span class="o">.</span><span class="n">path_info</span><span class="p">[:</span><span class="o">-</span><span class="mf">5</span><span class="p">]</span>
        <span class="n">f_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menu_item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_menu</span>
</pre></div>
</div>
<p id="index-915">As you can see, the <tt class="docutils literal"><span class="pre">navigation_to_path()</span></tt> function looks at each part of path to check that it exists, building up a list of breadcrumbs as it does. If it matches a page or section, it will also generate data structures for top-level tabs and a navigation menu containing links to other sections and pages in the same section as the section to which the URL resolves.</p>
<p id="index-916">If the URL entered can’t be matched, the function checks to see whether it could represent a section if that section was created. If it does, a <tt class="docutils literal"><span class="pre">NoSection</span></tt> exception is raised. This is caught in the <tt class="docutils literal"><span class="pre">parse()</span></tt> function and results in the nav controller’s <tt class="docutils literal"><span class="pre">nosection()</span></tt> action being called. A similar thing happens if the URL resolves to a page that could exist if it were created, only a <tt class="docutils literal"><span class="pre">NoPage</span></tt> exception is raised, eventually resulting in a call to the nav controller’s <tt class="docutils literal"><span class="pre">nopage()</span></tt> action.</p>
<p>If the URL doesn’t resolve to a page or section and the component above it doesn’t exist either, then a <tt class="docutils literal"><span class="pre">NotFound</span></tt> exception is raised, causing the <tt class="docutils literal"><span class="pre">parse()</span></tt> function to return <tt class="xref docutils literal"><span class="pre">False</span></tt>, which in turn tells Routes that the <tt class="docutils literal"><span class="pre">'path'</span></tt> named route hasn’t matched. This results in a 404 Not Found page being displayed as normal.</p>
<p>Let’s implement the <tt class="docutils literal"><span class="pre">nosection()</span></tt> and <tt class="docutils literal"><span class="pre">nopage()</span></tt> actions. Replace the <tt class="docutils literal"><span class="pre">NavController</span></tt> class with this (you don’t need the <tt class="docutils literal"><span class="pre">__before__()</span></tt> method anymore):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NavController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">nopage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/nav/create_page.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nosection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/nav/create_section.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-917">You’ll also need to create the templates on which these actions rely. Create <tt class="docutils literal"><span class="pre">derived/nav/create_page.html</span></tt> like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Create Page&lt;/h1&gt;&lt;/%def&gt;
&lt;p&gt;&lt;a href="${h.url_for(controller='page', action='new',
    section=c.section, path=c.path)}"&gt;Create a new page here&lt;/a&gt;.&lt;/p&gt;</pre>
</div>
<p id="index-918">and create <tt class="docutils literal"><span class="pre">derived/nav/create_section.html</span></tt> like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Create Section&lt;/h1&gt;&lt;/%def&gt;
&lt;p&gt;&lt;a href="${h.url_for(controller='section', action='new',
    section=c.section, path=c.path)}"&gt;Create a new section here&lt;/a&gt;.&lt;/p&gt;</pre>
</div>
<p id="index-919">Now when you visit a URL that doesn’t exist but for which a page or a section could be created, you will be shown a page with a link allowing you to create it.</p>
<p>To view the page, the attributes <tt class="docutils literal"><span class="pre">c.menu</span></tt>, <tt class="docutils literal"><span class="pre">c.tabs</span></tt>, and <tt class="docutils literal"><span class="pre">c.breadcrumbs</span></tt> must be set. Add lines 12-14 to the end of the page controller’s <tt class="docutils literal"><span class="pre">view()</span></tt> method to obtain the values calculated during the processing of the routes and set them for use in the template.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">comment_count</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Comment</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">pageid</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">tag_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">available_tags</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_q</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">selected_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tags&#39;</span><span class="p">:[</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">]}</span>
    <span class="n">c</span><span class="o">.</span><span class="n">menu</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;simplesite.navigation&#39;</span><span class="p">][</span><span class="s">&#39;menu&#39;</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">tabs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;simplesite.navigation&#39;</span><span class="p">][</span><span class="s">&#39;tabs&#39;</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">breadcrumbs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;simplesite.navigation&#39;</span><span class="p">][</span><span class="s">&#39;breadcrumbs&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/view.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>For this to work, you need to use the named route <tt class="docutils literal"><span class="pre">'path'</span></tt> when generating URLs to the page or section controller’s <tt class="docutils literal"><span class="pre">view()</span></tt> actions so that the <tt class="docutils literal"><span class="pre">build()</span></tt> filter function can generate the correct URL.</p>
<p>Update all the calls to <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> in the page controllers to this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-920">Update all the calls to <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> in the section controller to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">return</span> <span class="n">redirect_to</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-921">This <tt class="docutils literal"><span class="pre">build()</span></tt> function relies on a <tt class="docutils literal"><span class="pre">nav_to_path()</span></tt> static method that you should add to the <tt class="docutils literal"><span class="pre">Nav</span></tt> class in your model after the existing static methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Nav</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">...</span> <span class="n">existing</span> <span class="n">methods</span> <span class="o">...</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">nav_to_path</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="n">nav_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Nav</span><span class="p">)</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s">&#39;section&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="k">while</span> <span class="n">nav</span><span class="o">.</span><span class="n">section</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">nav_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;section&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">nav</span><span class="o">.</span><span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">path</span>
        <span class="k">return</span> <span class="n">path</span>
</pre></div>
</div>
<p>There are two other places that need updating to use the new route. Edit <tt class="docutils literal"><span class="pre">templates/derived/page/list.html</span></tt>, and replace these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span>
    <span class="n">controller</span><span class="o">=</span><span class="s">u&#39;page&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span>
    <span class="nb">id</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>with the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>Then edit <tt class="docutils literal"><span class="pre">templates/derived/comment/view.html</span></tt>, and update the link back to the page the comment was posted on to look like this:</p>
<div class="highlight-python"><pre>&lt;p&gt;&lt;a href="${h.url_for('path', id=c.comment.pageid)}"&gt;Visit the page this comment was posted on.&lt;/a&gt;&lt;/p&gt;</pre>
</div>
<p>At this point, everything is in place to test the new code, but you are advised to create a new database because the navigation structure is fairly fragile if the validators aren’t in place and because it is possible that as you’ve been building and testing the functionality you may have introduced some errors.</p>
<p>Delete the database and run this:</p>
<div class="highlight-python"><pre>$ paster setup-app development.ini</pre>
</div>
<p id="index-922">Start the server again, visit <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a>, and you should see the home page exactly as if you had visited <a class="reference external" href="http://localhost:5000/page/view/6">http://localhost:5000/page/view/6</a> before making the routing changes.</p>
</div>
<div class="section" id="adding-the-navigation-elements">
<h2>Adding the Navigation Elements<a class="headerlink" href="#adding-the-navigation-elements" title="Permalink to this headline">¶</a></h2>
<p id="index-923">Now all you need to do is add the navigation elements to the pages. Start by editing <tt class="docutils literal"><span class="pre">templates/base/index.html</span></tt> to add this import to the top:</p>
<div class="highlight-python"><pre>&lt;%namespace name="navigation" file="/component/navigation.html" import="*" /&gt;\</pre>
</div>
<p id="index-924">Then add <tt class="docutils literal"><span class="pre">templates/component/navigation.html</span></tt> with the following content:</p>
<div class="highlight-python"><pre>&lt;%!
import simplesite.model as model
%&gt;
&lt;%def name="breadcrumbs()"&gt;
    % if c.page and c.page.id != 1:
    &lt;div id="breadcrumbs"&gt;&lt;p&gt;${render_breadcrumbs(c.breadcrumbs)}&lt;/p&gt;&lt;/div&gt;
    % endif
&lt;/%def&gt;

&lt;%def name="tabs()"&gt;
    % if c.tabs:
    &lt;div id="maintabs"&gt;
        &lt;ul class="draglist"&gt;
            ${render_list(c.tabs, c.breadcrumbs[1].path,
                type_=c.breadcrumbs[1].type, id='li1_', class_='list2')}
        &lt;/ul&gt;
    &lt;/div&gt;
    % endif
&lt;/%def&gt;

&lt;%def name="menu()"&gt;
% if len(c.breadcrumbs) &gt; 2:
    &lt;div id="menu"&gt;
        &lt;h2&gt;Section Links&lt;/h2&gt;
        &lt;ul class="draglist"&gt;
                ${render_list(c.menu, c.breadcrumbs[-1].path,
                    type_=c.breadcrumbs[1].type, id='li1_', class_='list2')}
        &lt;/ul&gt;
    &lt;/div&gt;
% endif
&lt;/%def&gt;

&lt;%def name="render_list(items, current, id, class_)"&gt;
% for item in items:
    % if item.path == current and item.type == type_:
&lt;li class="${class_} active" id="${id}${str(item.id)}"&gt;&lt;span class="current"&gt;&lt;a
    href="${item.path_info}" id="current"&gt;${item.name}&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;\
    % else:
&lt;li class="${class_}" id="${id}${str(item.id)}"
    onclick="document.location ='${item.path_info}'"
&gt;&lt;span&gt;&lt;a href="${item.path_info}"&gt;${item.name}&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;\
    % endif
% endfor
&lt;/%def&gt;

&lt;%def name="render_breadcrumbs(breadcrumbs)"&gt;
    % for i, item in enumerate(breadcrumbs):
    % if i &lt; len(breadcrumbs) - 1:
        &lt;a href="${item.path_info}"&gt;${item.name}&lt;/a&gt; &amp;gt;
    % elif isinstance(c.breadcrumbs[-1], model.Section):
        ${item.name} &amp;gt;
    % else:
        ${item.name}
    % endif
    % endfor
&lt;/%def&gt;</pre>
</div>
<p id="index-925">Finally,  edit <tt class="docutils literal"><span class="pre">templates/base/index.html</span></tt> again to replace the following defs:</p>
<div class="highlight-python"><pre>&lt;%def name="tabs()"&gt;&lt;/%def&gt;
&lt;%def name="menu()"&gt;&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;${c.heading or 'No Title'}&lt;/h1&gt;&lt;/%def&gt;
&lt;%def name="breadcrumbs()"&gt;&lt;/%def&gt;</pre>
</div>
<p>with the following versions:</p>
<div class="highlight-python"><pre>&lt;%def name="tabs()"&gt;${navigation.tabs()}&lt;/%def&gt;
&lt;%def name="menu()"&gt;${navigation.menu()}&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;${c.heading or 'No Title'}&lt;/h1&gt;&lt;/%def&gt;
&lt;%def name="breadcrumbs()"&gt;${navigation.breadcrumbs()}&lt;/%def&gt;</pre>
</div>
<p id="index-926">With these changes in place, as shown in Figure 14-7, you can test the navigation components you’ve created.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1407.png"><img alt="Figure 14-7. The breadcrumbs, main links, and section links" src="_images/9349f1407.png" /></a>
<p class="caption">Figure 14-7. The breadcrumbs, main links, and section links</p>
</div>
</div>
<div class="section" id="adding-some-style">
<h2>Adding Some Style<a class="headerlink" href="#adding-some-style" title="Permalink to this headline">¶</a></h2>
<p id="index-927">Now that all the functionality for the SimpleSite is in place, let’s add some style to <tt class="docutils literal"><span class="pre">public/css/main.css</span></tt>. It would be good if the navigation tabs looked like tabs rather than a bulleted list. These styles will fix this; add them to the end of the file:</p>
<div class="highlight-python"><pre>#maintabs ul {
    margin: 0px;
    padding: 0px;
    height: 23px;
}
#maintabs {
    background: #87AFD7;
    border-bottom: 3px solid #113958;
    margin: 0;
    padding: 10px 0 0px 17px;
}
#maintabs li {
    list-style: none;
    margin: 0;
    display: inline;
}
#maintabs li a {
    padding: 6px 10px;
    margin-left: 3px;
    border-bottom: none;
    text-decoration: none;
}
#maintabs li a:link { color: #113958; }
#maintabs li a:visited { color: #113958; }
#maintabs li a:hover {
    color: #000;
    background: #fff;
    border-color: #227;
}
#maintabs li a#current
{
    background: #113958;
    color: #fff;
    font-weight: bold;
    border-right: 2px solid #468AC7;
}</pre>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-928">If you find yourself frequently styling bulleted lists in this way, a useful site is listamatic at <a class="reference external" href="http://css.maxdesign.com.au/listamatic/">http://css.maxdesign.com.au/listamatic/</a>; it provides quite a few different styles to apply to the same style sheet.</p>
</div>
<p id="index-929">At this point, all the core functionality of SimpleSite is in place. You can add comments, tag pages, create sections and subsections, and move pages and sections around. Now is a good time to test the application to check that it behaves as you expect it to and that you haven’t made any mistakes.</p>
<p>Figure 14-8 shows what the application looks like with some tags added.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1408.png"><img alt="Figure 14-8. CSS and tags" src="_images/9349f1408.png" /></a>
<p class="caption">Figure 14-8. CSS and tags</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p id="index-930">You accomplished an awful lot in this chapter. You implemented a full comment and tag system, used SQLAlchemy’s sophisticated inheritance features, shared code between different validators and templates, and built some sophisticated extensions to Routes.</p>
<p id="index-931">In the next chapter, you’ll learn about JavaScript and CSS. You’ll then update SimpleSite to use a CSS grid. You’ll add some Ajax so that the <tt class="docutils literal"><span class="pre">before</span></tt> text field is implemented as a select field whose values change when you select a different section, and you’ll add some animation to the flash message.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 14: SimpleSite Tutorial Part 2</a><ul>
<li><a class="reference external" href="#comments-system-one-to-many-mappings">Comments System: One-to-Many Mappings</a><ul>
<li><a class="reference external" href="#planning-the-controller">Planning the Controller</a></li>
<li><a class="reference external" href="#modifying-the-routes">Modifying the Routes</a></li>
<li><a class="reference external" href="#creating-the-controller">Creating the Controller</a></li>
<li><a class="reference external" href="#updating-the-controller-to-handle-comments">Updating the Controller to Handle Comments</a></li>
<li><a class="reference external" href="#setting-the-page-id-automatically">Setting the Page ID Automatically</a></li>
</ul>
</li>
<li><a class="reference external" href="#updating-the-page-view">Updating the Page View</a><ul>
<li><a class="reference external" href="#handling-deleted-pages">Handling Deleted Pages</a></li>
</ul>
</li>
<li><a class="reference external" href="#tags-many-to-many-mappings">Tags: Many-to-Many Mappings</a><ul>
<li><a class="reference external" href="#creating-the-tag-controller">Creating the tag Controller</a></li>
<li><a class="reference external" href="#constraining-tag-names">Constraining Tag Names</a></li>
</ul>
</li>
<li><a class="reference external" href="#adding-tags-to-pages">Adding Tags to Pages</a><ul>
<li><a class="reference external" href="#deleting-tags-and-pages">Deleting Tags and Pages</a></li>
</ul>
</li>
<li><a class="reference external" href="#creating-a-navigation-hierarchy">Creating a Navigation Hierarchy</a><ul>
<li><a class="reference external" href="#using-inheritance-in-sqlalchemy">Using Inheritance in SQLAlchemy</a></li>
<li><a class="reference external" href="#setting-up-initial-data">Setting Up Initial Data</a></li>
<li><a class="reference external" href="#creating-the-controllers">Creating the Controllers</a></li>
<li><a class="reference external" href="#the-page-controller">The Page Controller</a></li>
</ul>
</li>
<li><a class="reference external" href="#changing-the-routing">Changing the Routing</a></li>
<li><a class="reference external" href="#adding-the-navigation-elements">Adding the Navigation Elements</a></li>
<li><a class="reference external" href="#adding-some-style">Adding Some Style</a></li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="documentation.html"
                                  title="previous chapter">Chapter 13: Documentation</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="css-javascript-and-ajax.html"
                                  title="next chapter">Chapter 15: CSS, JavaScript, and Ajax</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/simplesite-tutorial-part-2.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="css-javascript-and-ajax.html" title="Chapter 15: CSS, JavaScript, and Ajax"
             >next</a> |</li>
        <li class="right" >
          <a href="documentation.html" title="Chapter 13: Documentation"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/simplesite-tutorial-part-2.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>