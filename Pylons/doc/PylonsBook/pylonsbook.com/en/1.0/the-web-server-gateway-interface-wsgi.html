<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/the-web-server-gateway-interface-wsgi.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:39 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 16: The Web Server Gateway Interface (WSGI) &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 17: Pylons’ Internal Architecture" href="pylons-internal-architecture.html" />
    <link rel="prev" title="Chapter 15: CSS, JavaScript, and Ajax" href="css-javascript-and-ajax.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pylons-internal-architecture.html" title="Chapter 17: Pylons’ Internal Architecture"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="css-javascript-and-ajax.html" title="Chapter 15: CSS, JavaScript, and Ajax"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-16-the-web-server-gateway-interface-wsgi">
<h1>Chapter 16: The Web Server Gateway Interface (WSGI)<a class="headerlink" href="#chapter-16-the-web-server-gateway-interface-wsgi" title="Permalink to this headline">¶</a></h1>
<p id="index-1152">The Web Server Gateway Interface is a Python standard created in 2003 by Philip J. Eby and the Python web community. Back in 2003 Python suffered from a very fragmented web framework community where applications written with code from one framework wouldn’t run on the server component from a different framework. The Web Server Gateway Interface standard (known as WSGI and pronounced “wizgy” by those in the Python community) was designed to change that and enable a degree of cross-framework interoperability.</p>
<p id="index-1153">In the first part of this chapter, you’ll learn how a simple WSGI application works, how you can use WSGI applications as Pylons controllers, how WSGI servers work, and how WSGI leads to new classes of components called <em>middleware</em>.</p>
<p>Internally Pylons relies on middleware components to provide some of its core functionality, so in the second part of the chapter, I’ll explain the different ways of writing WSGI middleware, and you’ll develop your own Gzip middleware (mentioned in the previous chapter) for compressing your Pylons projects’ CSS and JavaScript code.</p>
<p id="index-1154">In the normal course of Pylons development, you don’t need to write WSGI applications because you will use Pylons controllers and actions instead. You don’t need to know how to develop WSGI middleware yourself either because Pylons already provides all the middleware you need as well as specific APIs that are much easier to work with than their underlying WSGI APIs (for example, those exposed by the <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects). For these reasons, you might want to skip the “Writing WSGI Middleware” section in the second half of the chapter if it doesn’t apply to you yet and move straight onto the next chapter at that point. You should still read “Introducing WSGI” in this chapter, though.</p>
<div class="section" id="introducing-wsgi">
<h2>Introducing WSGI<a class="headerlink" href="#introducing-wsgi" title="Permalink to this headline">¶</a></h2>
<p id="index-1155">The WSGI standard defines three different classes of component: <em>applications</em>, <em>servers</em>, and <em>middleware</em>. I’ll cover each of these types of components in turn and explain how they are relevant to a Pylons application.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you want to know the details of WSGI programming, there is no substitute for reading its formal specification, which is called Python Enhancement Proposal 333 and is at <a class="reference external" href="http://www.python.org/dev/peps/pep-0333/">http://www.python.org/dev/peps/pep-0333/</a>.</p>
</div>
<div class="section" id="wsgi-applications">
<h3>WSGI Applications<a class="headerlink" href="#wsgi-applications" title="Permalink to this headline">¶</a></h3>
<p id="index-1156">You’ll remember from all the way back in Chapter 3 that at its heart Pylons deals with the HTTP protocol, that communication with the browser involves a request and a response, and that all the HTTP request information, together with information about the server, is encapsulated in a CGI-like environment dictionary.</p>
<p>In Pylons, a controller action to handle a request and return some plain text might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
    <span class="k">return</span> <span class="s">&quot;Hello World!&quot;</span>
</pre></div>
</div>
<p>The equivalent WSGI application would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Hello World!&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Technically speaking, setting the response status to <tt class="docutils literal"><span class="pre">'200</span> <span class="pre">OK'</span></tt> in the Pylons example isn’t necessary because it is the default, but I’ve added it to the example to emphasize the similarity between the two cases. Let’s compare each of the examples by their main features:</p>
<dl class="docutils" id="index-1157">
<dt><em>Request information</em></dt>
<dd>In Pylons, all the request information is available as a global object called <tt class="docutils literal"><span class="pre">request</span></tt>. In the WSGI application, the request information is all contained in the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary passed as the first positional parameter to the WSGI application. In Pylons, <tt class="docutils literal"><span class="pre">request.environ</span></tt> is actually the same dictionary that would be passed to a WSGI application as the <tt class="docutils literal"><span class="pre">environ</span></tt> argument.</dd>
</dl>
<dl class="docutils" id="index-1158">
<dt><em>HTTP response status</em></dt>
<dd>In Pylons, the status is set by changing the <tt class="docutils literal"><span class="pre">status</span></tt> attribute of the global <tt class="docutils literal"><span class="pre">response</span></tt> object. In a WSGI application, it is set by passing a string as the first argument to the <tt class="docutils literal"><span class="pre">start_response()</span></tt> function, which itself is passed into the WSGI application as its second positional parameter.</dd>
</dl>
<dl class="docutils" id="index-1159">
<dt><em>HTTP headers</em></dt>
<dd>In Pylons, common HTTP headers such as <tt class="docutils literal"><span class="pre">Content-Type</span></tt> have their own attributes that you can set on the global <tt class="docutils literal"><span class="pre">response</span></tt> object. Others have to be added to <tt class="docutils literal"><span class="pre">response.headers</span></tt>, as in <tt class="docutils literal"><span class="pre">response.headers['X-Some-Header']</span> <span class="pre">=</span> <span class="pre">'value'</span></tt>. In a WSGI application, the headers are passed as the second argument to <tt class="docutils literal"><span class="pre">start_response()</span></tt> as a list of tuples where the first string in a tuple is a string containing the header name and the second is a string containing the value. Here’s an example: <tt class="docutils literal"><span class="pre">[('Content-type',</span> <span class="pre">'text/plain'),</span> <span class="pre">('X-Some-Header',</span> <span class="pre">'value')]</span></tt>.</dd>
</dl>
<dl class="docutils" id="index-1160">
<dt><em>The response</em></dt>
<dd>In Pylons, the response is simply the string returned from the action. If you return Unicode from a Pylons controller action, it will be encoded into UTF-8 automatically. In a WSGI application, it is an iterable, which should yield strings when it is iterated over. A list made up of strings is an example of an iterable that fulfils this criterion. The WSGI response cannot contain Unicode. Any Unicode must be encoded to an encoding such as UTF-8 before it is used in an iterable.</dd>
</dl>
<p id="index-1161">On the surface, the WSGI application is really fairly similar to the Pylons controller action except it doesn’t use the simplifying global variables <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> that Pylons provides; however, you need to be aware of a couple of complications when writing WSGI applications, which Pylons takes care of for you when you use a controller action:</p>
<blockquote>
<ul class="simple" id="index-1162">
<li>The <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable that gets passed to the WSGI application as its second argument can be called only <em>once</em> (except in rare circumstances when an error occurs, as you’ll see in the “Handling Errors” section later in the chapter).</li>
<li><tt class="docutils literal"><span class="pre">start_response()</span></tt> <em>must</em> be called <em>before</em> the application returns any response data.</li>
<li>After being called, <tt class="docutils literal"><span class="pre">start_response()</span></tt> returns a writable object that can be used to write response data directly without having to return it as an iterable from a WSGI application.</li>
</ul>
</blockquote>
<p>Here is the same example you saw earlier but written to use the writable object returned from <tt class="docutils literal"><span class="pre">start_response()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">writable</span> <span class="o">=</span> <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="n">writable</span><span class="p">(</span><span class="s">&quot;Hello &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&quot;World!&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Here the first part of the output was written via the writable returned by <tt class="docutils literal"><span class="pre">start_response()</span></tt>, and the rest was returned normally by returning the iterable as before.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-1163">This way of returning response data to the browser was included in the specification because some servers weren’t capable of buffering data returned in any other way. It is really considered very bad practice to use this approach; in fact, this functionality may be removed in a future version of the WSGI specification because it significantly complicates the writing of middleware components.</p>
</div>
<div class="section" id="using-instances-of-classes">
<h4>Using Instances of Classes<a class="headerlink" href="#using-instances-of-classes" title="Permalink to this headline">¶</a></h4>
<p id="index-1164">So far, you’ve seen only how to write WSGI applications as functions, but they can also be written as iterators, as generators, or as class instances. Writing applications as class instances can be useful if you want to write a more complex WSGI application. Take a look at this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Hello</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello World!&#39;</span><span class="p">]</span>

<span class="n">hello</span> <span class="o">=</span> <span class="n">Hello</span><span class="p">()</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Hello</span></tt> class itself isn’t a WSGI application, but if you think about how the <tt class="docutils literal"><span class="pre">hello</span></tt> instance will behave, you’ll realize that when it is called, it accepts two positional parameters; it calls <tt class="docutils literal"><span class="pre">start_response()</span></tt> and returns an iterable, which in this case is just a list with one string. These are exactly the conditions outlined in the previous section to describe how a WSGI application should behave, so the class <em>instance</em> is a valid WSGI application. This approach is very handy for two main reasons:</p>
<blockquote>
<ul class="simple">
<li>It provides a way to group related WSGI applications together by having the <tt class="docutils literal"><span class="pre">__call__()</span></tt> dispatch the request to different methods.</li>
<li>It provides a way to configure an application by passing arguments to the <tt class="docutils literal"><span class="pre">__init__()</span></tt> method.</li>
</ul>
</blockquote>
<p>Let’s see an example demonstrating these two uses:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/hello&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/goodbye&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodbye</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;404 Not Found&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/html&#39;</span><span class="p">)])</span>
            <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Not found&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/html&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">goodbye</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/html&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Goodbye </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="s">&#39;Harry&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1165">In this example, you can see that the method that is executed depends on the path in the URL and that the text returned from the two methods depends on the name that was given when the WSGI application was created. You might notice that this is beginning to look like an ordinary Pylons controller, and as you’ll find out in the next section, it turns out that Pylons is designed to be able to run WSGI applications like this as Pylons controllers.</p>
<div class="admonition caution" id="index-1166">
<p class="first admonition-title">Caution</p>
<p>It is easy to fall into a trap when using class instances in this way as WSGI applications. You might be tempted to pass variables between the class methods by assigning values to <tt class="docutils literal"><span class="pre">self</span></tt> and then calling other methods. This would be fine if you were using the application only outside of a multithreaded environment or if you re-created the application on each request, but in a multithreaded environment there would be no guarantee that the value attached to <tt class="docutils literal"><span class="pre">self</span></tt> in one method call would be the same value that was used in the next method call, because another thread of execution might have taken place in between.</p>
<p>If that sounds a bit confusing, just remember the simple rule that you should never set or change a variable assigned to <tt class="docutils literal"><span class="pre">self</span></tt> in a WSGI application outside the <tt class="docutils literal"><span class="pre">__init__()</span></tt> method.</p>
<p class="last">This isn’t a problem in a Pylons controller because Pylons controller instances are re-created on each request.</p>
</div>
</div>
</div>
<div class="section" id="wsgi-in-pylons-controllers">
<h3>WSGI in Pylons Controllers<a class="headerlink" href="#wsgi-in-pylons-controllers" title="Permalink to this headline">¶</a></h3>
<p id="index-1167">If you look at a Pylons controller, you will see it is derived from <tt class="docutils literal"><span class="pre">BaseController</span></tt>, which is defined in your project’s <tt class="docutils literal"><span class="pre">lib/base.py</span></tt> file. The <tt class="docutils literal"><span class="pre">BaseController</span></tt> class is itself derived from <tt class="docutils literal"><span class="pre">pylons.controllers.WSGIController</span></tt>, but in fact Pylons is designed so that any valid WSGI application can be used as a controller. This means you don’t actually need to use a Pylons controller class in your controller at all; any WSGI application will work as long as you give it the same name your controller would have had so that Pylons can find it.</p>
<p>For example, if you added a <tt class="docutils literal"><span class="pre">hello</span></tt> controller to a Pylons application by running the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">controller</span> <span class="pre">hello</span></tt> command, you could replace the entire contents of the <tt class="docutils literal"><span class="pre">hello.py</span></tt> file with this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">HelloController</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello World!&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Pylons will call your custom WSGI application in the same way as it would call a normal <tt class="docutils literal"><span class="pre">WSGIController</span></tt> instance. To test the example you&#8217;ll need to visit a URL which will resolve to the controller such as <tt class="docutils literal"><span class="pre">/hello/index</span></tt> or add a new route so that the controller can be accessed as <tt class="docutils literal"><span class="pre">/hello</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/hello&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You will still have all the session, debugging, and error-handling facilities a normal Pylons controller has. The only difference is that although Pylons would instantiate a new <tt class="docutils literal"><span class="pre">WSGIController</span></tt> on each request, it will assume that any WSGI application you use either is a function (such as the <tt class="docutils literal"><span class="pre">HelloController()</span></tt> function earlier) or is already instantiated and ready to handle multiple requests at once. This means if you want to write a WSGI application as a class and want it to be used as a controller, the class <em>instance</em> would have to be named <tt class="docutils literal"><span class="pre">HelloController</span></tt>, not the class itself. Here’s an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloControllerApplication</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello World!&#39;</span><span class="p">]</span>

<span class="n">HelloController</span> <span class="o">=</span> <span class="n">HelloControllerApplication</span><span class="p">()</span>
</pre></div>
</div>
<p>Pylons avoids this problem with controllers derived from <tt class="docutils literal"><span class="pre">pylons.controllers.WSGIController</span></tt> because it automatically creates a new controller instance on each request before it calls it.</p>
<p>Being able to mount WSGI applications as Pylons controllers is very useful because it gives you the basis for integrating Pylons applications with third-party WSGI-enabled software such as MoinMoin or Mercurial. As an example, it is perfectly possible to mount an entire Trac instance as a Pylons controller. This has the benefit that Trac will be able to use the same authentication and authorization system that you are using with Pylons and will also benefit from Pylons’ automatic error documents and interactive debugger.</p>
<p id="index-1168">There may be occasions where you don’t want to replace your entire controller with a WSGI application but simply want to run a WSGI application from within a particular controller action. For example, if you had a WSGI application called <tt class="docutils literal"><span class="pre">wsgi_app</span></tt>, you could call it from the <tt class="docutils literal"><span class="pre">index()</span></tt> controller action like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># WSGI application</span>
<span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;&lt;html&gt;</span><span class="se">\n</span><span class="s">&lt;body&gt;</span><span class="se">\n</span><span class="s">Hello World!</span><span class="se">\n</span><span class="s">&lt;/body&gt;</span><span class="se">\n</span><span class="s">&lt;/html&gt;&#39;</span><span class="p">]</span>

<span class="c"># Pylons controller</span>
<span class="k">class</span> <span class="nc">RunwsgiController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the WSGI objects <tt class="docutils literal"><span class="pre">environ</span></tt> and <tt class="docutils literal"><span class="pre">start_response</span></tt> are automatically passed to the Pylons controller action if it has their names as arguments. This is another feature of the Pylons dispatch designed to make working with WSGI applications easier, but you’ll remember from Chapter 9 that this is why you shouldn’t choose routing variables with the same names.</p>
<p>Not all WSGI applications can be run as or from Pylons controllers. Some of the problems are as follows:</p>
<blockquote>
<ul class="simple">
<li>Python cannot support more than one version of the same library in the same interpreter at the same time, so the WSGI application cannot use a different version of one of the libraries Pylons is already using.</li>
<li>Not all WSGI applications are written correctly to be mounted at a URL other than <tt class="docutils literal"><span class="pre">/</span></tt>, so when you use them as part of a Pylons controller at a URL such as <tt class="docutils literal"><span class="pre">/controller/action</span></tt>, they might break.</li>
<li>Not all WSGI applications are compatible with the WSGI middleware components Pylons uses. For example, they might not expect the presence of error documents middleware that could get in the way of some of their responses.</li>
</ul>
</blockquote>
<p id="index-1169">Despite these potential difficulties, a lot of WSGI applications will run from within Pylons, and this can lead to interesting new ways of using those applications.</p>
</div>
<div class="section" id="wsgi-servers">
<h3>WSGI Servers<a class="headerlink" href="#wsgi-servers" title="Permalink to this headline">¶</a></h3>
<p id="index-1170">Now that you’ve seen what WSGI applications are and how, in many cases, they can be run from a Pylons controller, it is time to turn your attention to what happens with WSGI servers. Luckily, you are very unlikely to have to write a WSGI server yourself because WSGI is now an established standard and almost all the common web servers are now WSGI compatible. Nevertheless, it is still useful to know how they work since their interface forms the basis for WSGI middleware.</p>
<p id="index-1171">A WSGI server must do a few things. First, it must prepare the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary and <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable and pass them as the first and second positional parameters to a WSGI application. The WSGI application always calls the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable to set the status and HTTP headers before it starts returning data (as you’ve seen), so the server has to assemble <tt class="docutils literal"><span class="pre">start_response()</span></tt> in such a way that, when it is called, the status and headers get sent to the web browser. You’ll remember that according to the specification, WSGI applications are allowed to use the writable returned from <tt class="docutils literal"><span class="pre">start_response()</span></tt>, so servers must also assemble <tt class="docutils literal"><span class="pre">start_response()</span></tt> to return a compatible object.</p>
<p id="index-1172">It is also the server’s responsibility to set certain WSGI-specific variables in the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary that give the application some information about the type of server they are running on. Table 16-1 lists the variables that are set.</p>
<table border="1" class="docutils">
<colgroup>
<col width="3%" />
<col width="97%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Variable</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">wsgi.version</span></tt></td>
<td>The tuple <tt class="docutils literal"><span class="pre">(1,0)</span></tt>, representing WSGI version 1.0.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt></td>
<td>A string representing the “scheme” portion of the URL at which the application is being invoked. Normally, this will have the value <tt class="docutils literal"><span class="pre">&quot;http&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;https&quot;</span></tt>, as appropriate.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.input</span></tt></td>
<td>An input stream (file-like object) from which the HTTP request body can be read. (The server or gateway may perform reads on demand as requested by the application, it may preread the client’s request body and buffer it in memory or on disk, or it may use any other technique for providing such an input stream, according to its preference.)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.errors</span></tt></td>
<td>An output stream (file-like object) to which error output can be written, for the purpose of recording program or other errors in a standardized and possibly centralized location. This should be a “text mode” stream; that is, applications should use <tt class="docutils literal"><span class="pre">&quot;\n&quot;</span></tt> as a line ending and assume it will be converted to the correct line ending by the server/gateway.For many servers, <tt class="docutils literal"><span class="pre">wsgi.errors</span></tt> will be the server’s main error log. Alternatively, this may be <tt class="docutils literal"><span class="pre">sys.stderr</span></tt> or a log file of some sort. The server’s documentation should include an explanation of how to configure this or where to find the recorded output. A server or gateway may supply different error streams to different applications, if this is desired.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.multithread</span></tt></td>
<td>This value should evaluate <tt class="docutils literal"><span class="pre">true</span></tt> if the application object may be simultaneously invoked by another thread in the same process and should evaluate <tt class="docutils literal"><span class="pre">false</span></tt> otherwise.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.multiprocess</span></tt></td>
<td>This value should evaluate <tt class="docutils literal"><span class="pre">true</span></tt> if an equivalent application object may be simultaneously invoked by another process and should evaluate <tt class="docutils literal"><span class="pre">false</span></tt> otherwise.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">wsgi.run_once</span></tt></td>
<td>This value should evaluate <tt class="docutils literal"><span class="pre">true</span></tt> if the server or gateway expects (but does not guarantee!) that the application will be invoked only this one time during the life of its containing process. Normally, this will be <tt class="docutils literal"><span class="pre">true</span></tt> only for a gateway based on CGI (or something similar).</td>
</tr>
</tbody>
</table>
<p>Table 16-1. The WSGI Variables and Their Meanings According to PEP 333</p>
<p id="index-1173">Of particular interest to a Pylons developer are the <tt class="docutils literal"><span class="pre">wsgi.multithread</span></tt> and <tt class="docutils literal"><span class="pre">wsgi.multiprocess</span></tt> variables that tell the WSGI application whether it is being run in a multithreaded or multiprocess environment. You’ll learn more about the differences between multithreading and mulitprocess servers in Chapter 21, but for now you just need to know that these variables can be accessed from the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary to discover what sort of server is being used.</p>
<p id="index-1174">The <tt class="docutils literal"><span class="pre">wsgi.errors</span></tt> variable is also interesting and will become particularly relevant when you look at application logging in Chapter 20. It provides a file-like object that the server provides for you to log error messages to. By using this for your log messages, you can be sure that your Pylons application logs will always be logged in an appropriate manner no matter which server they are running on. There are downsides to this approach too, though, which you’ll see in Chapter 20.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Because Pylons is a WSGI framework and runs on WSGI servers, these variables are also available in Pylons through the <tt class="docutils literal"><span class="pre">request.environ</span></tt> dictionary. For example, to find out whether your application is running on a multithreaded web server, you could do this:</p>
<div class="last highlight-python"><pre>if bool(request.environ['wsgi.multithreaded']):
    # Multithreaded
else:
    # Not multithreaded</pre>
</div>
</div>
<p>Rather than write a full WSGI HTTP server as an example, let’s consider a much simpler case. Imagine you already have a CGI server that was capable of running the CGI script you saw all the way back in Chapter 1. If you wanted to write an adaptor that would be able to run a WSGI application in a CGI environment, you would need to implement the WSGI server API.</p>
<p id="index-1175">Here’s the code you would use:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run_with_cgi</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>

    <span class="n">environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.version&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.multithread&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.run_once&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTPS&#39;</span><span class="p">,</span><span class="s">&#39;off&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">):</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;https&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>

    <span class="n">headers_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">headers_sent</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">headers_set</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;write() before start_response()&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">headers_sent</span><span class="p">:</span>
             <span class="c"># Before the first output, send the stored headers</span>
             <span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span> <span class="o">=</span> <span class="n">headers_sent</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">headers_set</span>
             <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Status: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">response_headers</span><span class="p">:</span>
                 <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">header</span><span class="p">)</span>
             <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">response_headers</span><span class="p">,</span><span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">headers_sent</span><span class="p">:</span>
                    <span class="c"># Re-raise original exception if headers sent</span>
                    <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># avoid dangling circular ref</span>
        <span class="k">elif</span> <span class="n">headers_set</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;Headers already set!&quot;</span><span class="p">)</span>

        <span class="n">headers_set</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span><span class="n">response_headers</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">write</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>            <span class="c"># don&#39;t send headers until body appears</span>
                <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">headers_sent</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>           <span class="c"># send headers now if body was empty</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p id="index-1176">This example forms part of the WSGI specification in PEP 333, so I won’t discuss it in detail, but notice that it sets up an <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary and a <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable before calling the WSGI application in line 50. The information returned from the WSGI application forms the body of the response, and the information passed to the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable from the application is used to set the HTTP status and headers. Notice that the example also sets up a <tt class="docutils literal"><span class="pre">write()</span></tt> function that is returned from <tt class="docutils literal"><span class="pre">start_response()</span></tt> and that the application can also use to output information. As noted earlier, though, the vast majority of WSGI applications should return their data as an iterable. It’s also worth drawing your attention to <tt class="docutils literal"><span class="pre">wsgi.errors</span></tt>. Here the <tt class="docutils literal"><span class="pre">wsgi.errors</span></tt> key simply points to <tt class="docutils literal"><span class="pre">sys.stderr</span></tt>, so any log messages your application sends when using <tt class="docutils literal"><span class="pre">run_with_cgi()</span></tt> just get sent to the standard error stream.</p>
<p id="index-1177">Let’s write a sample CGI script that uses <tt class="docutils literal"><span class="pre">run_with_cgi()</span></tt> to run the <tt class="docutils literal"><span class="pre">hello()</span></tt> WSGI application from earlier in the chapter. The script would look like the following, but be sure to specify the correct path to the <tt class="docutils literal"><span class="pre">python</span></tt> executable. This is likely to be the one in your virtual Python environment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/home/james/env/bin/python</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run_with_cgi</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">same</span> <span class="k">as</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">example</span> <span class="n">above</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Hello World!&quot;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run_with_cgi</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also run this CGI script from the command line because CGI applications send their output to the standard output. Save the previous example as <tt class="docutils literal"><span class="pre">wsgi_test.py</span></tt>, and you can run it like this:</p>
<div class="highlight-python"><pre>$ chmod 755 wsgi_test.py
$ ./wsgi_test.py
Status: 200 OK
Content-type: text/plain

Hello World!</pre>
</div>
<p>This sort of setup can sometimes be useful for debugging problems too because you can customize how the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary is set up in <tt class="docutils literal"><span class="pre">run_with_cgi()</span></tt> to simulate different sorts of requests.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Running a WSGI application through a CGI script is generally very inefficient because the WSGI application (along with the Python interpreter and the CGI script itself) has to be re-created on each request. Most WSGI applications (including your Pylons application) are designed to be loaded into memory once and then executed lots of times without being re-created, and this is a lot more efficient.</p>
</div>
<p id="index-1178">Since Python 2.5, WSGI has been built into the Python standard library in the form of the <tt class="docutils literal"><span class="pre">wsgiref</span></tt> module, which provides basic WSGI tools including a WSGI server. The server is built using the same methodology as the other servers that make up the Python Standard Library including <tt class="docutils literal"><span class="pre">BaseHTTPServer</span></tt>. Here’s how you would use it to serve the same <tt class="docutils literal"><span class="pre">hello</span></tt> WSGI application used in the previous example, although you could use the same code to serve <em>any</em> WSGI application just by changing the argument to <tt class="docutils literal"><span class="pre">httpd.set_app()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wsgiref</span> <span class="kn">import</span> <span class="n">simple_server</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Hello World!&quot;</span><span class="p">]</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">simple_server</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mf">8000</span><span class="p">),</span>
    <span class="n">simple_server</span><span class="o">.</span><span class="n">WSGIRequestHandler</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>If you are running a version of Python prior to 2.5, you will need to install the <tt class="docutils literal"><span class="pre">wsgiref</span></tt> package from the Python Package Index to run the example. You can do that with the following:</p>
<div class="last highlight-python"><pre>$ easy_install wsgiref</pre>
</div>
</div>
<p id="index-1179">If you run this application, you’ll find the server running on port 8000 and available on all IP addresses. You change which interface or port the WSGI application is served from by changing the first argument to <tt class="docutils literal"><span class="pre">simple_server.WSGIServer()</span></tt>. Once the server is running, you can visit <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> to see the <tt class="docutils literal"><span class="pre">hello</span></tt> application running.</p>
<p id="index-1180">Now you have seen how to write WSGI applications and servers and understand the API for each, it should be clear that any WSGI application can run on any WSGI server without any modification needed to either the server or the application. In the next chapter, you’ll learn how to obtain a WSGI application object from a Pylons application through its config file. Because Pylons applications are also WSGI applications, it means they can be deployed on a large range of WSGI servers without modification. You can serve these Pylons WSGI applications in the same ways you saw the <tt class="docutils literal"><span class="pre">hello</span></tt> application being served in the examples in this chapter. You’d just swap <tt class="docutils literal"><span class="pre">hello</span></tt> for the Pylons WSGI application. You’ll learn about some of the more common deployment setups in Chapter 21.</p>
</div>
<div class="section" id="wsgi-middleware">
<h3>WSGI Middleware<a class="headerlink" href="#wsgi-middleware" title="Permalink to this headline">¶</a></h3>
<p id="index-1181">Now that you’ve learned about WSGI applications and servers, it is time to learn about another type of component that sits in the middle between a server and an application and is known as <em>middleware</em>.</p>
<p id="index-1182">WSGI middleware are components that, from a WSGI application’s point of view, appear as though they are a WSGI server because they provide the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary and <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable when they call the WSGI application and iterate over the result to return the response in the same way a WSGI server would. The reason middleware components are not WSGI servers, though, is that they look to a server as if they are a WSGI application. They are callables that accept the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary and <tt class="docutils literal"><span class="pre">start_response()</span></tt> arguments and return an iterable response.</p>
<p>This dual nature puts middleware components in a unique position to be able to change all the HTTP information an application receives from a server and to change all the HTTP information a server receives from the application. This turns out to be extremely useful and means that middleware can therefore do any of the following things or a combination of them:</p>
<blockquote>
<ul class="simple">
<li>Change any of the request information by modifying the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary</li>
<li>Change the HTTP status returned from an application</li>
<li>Intercept an error</li>
<li>Add, remove, or change HTTP headers returned from an application</li>
<li>Change a response</li>
</ul>
</blockquote>
<p id="index-1183">Middleware is therefore extremely powerful and can build a broad range of discrete components that can be used with different WSGI servers and applications. For example, a middleware component can do the following:</p>
<blockquote>
<ul class="simple">
<li>Produce error documents when certain status codes are received (typically responding to 404 and 500 codes)</li>
<li>E-mail error reports to a developer if a problem occurs</li>
<li>Provide interactive debugging facilities</li>
<li>Forward requests to other parts of the application</li>
<li>Test the API compliance of applications and servers to the WSGI standard</li>
<li>Authenticate a user</li>
<li>Cache pages</li>
<li>Provide a session store</li>
<li>Handle cookies</li>
<li>Gzip the response</li>
</ul>
</blockquote>
<p id="index-1184">Since a WSGI application wrapped in a piece of WSGI middleware is still a valid WSGI application, you can also wrap the combined middleware+application in another piece of middleware. You can keep adding middleware components until your middleware stack provides all the functionality you need. Doing so is called creating a <em>middleware chain</em>. This is exactly what is happening in your Pylons application’s <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> file in the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function that you’ll look at in detail in the next chapter.</p>
</div>
</div>
<div class="section" id="writing-wsgi-middleware">
<h2>Writing WSGI Middleware<a class="headerlink" href="#writing-wsgi-middleware" title="Permalink to this headline">¶</a></h2>
<p id="index-1185">Now that you’ve seen a bit about how WSGI works and how middleware components in particular can be used to change the behavior of a Pylons application, it is time to look in detail at how you can write WSGI middleware yourself. As was noted in the introduction to the chapter, writing your own middleware isn’t necessary to develop Pylons applications, so feel free to skip the rest of this chapter if it doesn’t interest you at this stage; however, bear in mind that if you have an understanding of how it is done, you will be better able to understand how components such as AuthKit work. If you want to become a Pylons expert or want to contribute to Pylons itself, a good understanding of WSGI applications and middleware is essential.</p>
<p>Let’s start off by looking at middleware that does nothing at all so that you can see its constituent parts:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Middleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>You can use this middleware like this to wrap the <tt class="docutils literal"><span class="pre">hello</span></tt> WSGI application you saw earlier:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Middleware</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
</pre></div>
</div>
<p>The combined <tt class="docutils literal"><span class="pre">app</span></tt> object is itself a valid WSGI application, and since the middleware doesn’t do anything, it would behave in the same way as the <tt class="docutils literal"><span class="pre">hello</span></tt> application on its own. Let’s think about what happens when it is called by a WSGI server to handle a request.</p>
<p>When the <tt class="docutils literal"><span class="pre">app</span></tt> object is created, the <tt class="docutils literal"><span class="pre">Middleware</span></tt> object is instantiated with the <tt class="docutils literal"><span class="pre">hello</span></tt> application as its first argument, which gets set as <tt class="docutils literal"><span class="pre">self.app</span></tt>. The <tt class="docutils literal"><span class="pre">app</span></tt> object is a class instance, but since it has a <tt class="docutils literal"><span class="pre">__call__()</span></tt> method, it can be called and therefore can behave as a WSGI application in a similar manner to the way you saw a class instance being used as a WSGI application earlier in the chapter.</p>
<p>When the instance is called, it in turn calls the <tt class="docutils literal"><span class="pre">hello</span></tt> application (<tt class="docutils literal"><span class="pre">self.app</span></tt>) and then returns its result to the server, which will iterate over the result from <tt class="docutils literal"><span class="pre">Middleware.__call__()</span></tt> in the same way as it would have iterated over the result from <tt class="docutils literal"><span class="pre">hello()</span></tt> if <tt class="docutils literal"><span class="pre">Middleware</span></tt> wasn’t present.</p>
<p id="index-1186">Now that you’ve seen the basic API of a middleware component, let’s look at an example of each of the things mentioned in the previous section, which you can do with a middleware component starting with modifying the environment.</p>
<div class="section" id="modifying-the-environment">
<h3>Modifying the Environment<a class="headerlink" href="#modifying-the-environment" title="Permalink to this headline">¶</a></h3>
<p id="index-1187">Let’s write some middleware that modifies the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary to add a key specifying a message. You’ll also add a facility allowing the message to be configured when the middleware is instantiated:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Middleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;example.message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>This middleware adds a key to the <tt class="docutils literal"><span class="pre">environ</span></tt> called <tt class="docutils literal"><span class="pre">example.message</span></tt>. All WSGI <tt class="docutils literal"><span class="pre">environ</span></tt> keys have to be strings containing just one <tt class="docutils literal"><span class="pre">.</span></tt> character, so here, <tt class="docutils literal"><span class="pre">example.message</span></tt> is a valid key. A WSGI application can now access this modified example. Here’s a new version of the <tt class="docutils literal"><span class="pre">hello</span></tt> application that uses this key to display a message and an example of how it is used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">custom_message</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;example.message&#39;</span><span class="p">]]</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Middleware</span><span class="p">(</span><span class="n">custom_message</span><span class="p">,</span> <span class="s">&quot;Hello world again!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1188">This time, the <tt class="docutils literal"><span class="pre">Middleware</span></tt> class takes a <tt class="docutils literal"><span class="pre">message</span></tt> parameter that is set as <tt class="docutils literal"><span class="pre">self.message</span></tt>. When the application is called, the middleware adds this message as a key in the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary, which the application can now extract from the environment.</p>
</div>
<div class="section" id="changing-the-status-and-headers">
<h3>Changing the Status and Headers<a class="headerlink" href="#changing-the-status-and-headers" title="Permalink to this headline">¶</a></h3>
<p id="index-1189">Next I’ll cover how to change the status or the headers in a piece of middleware. The WSGI application calls <tt class="docutils literal"><span class="pre">start_response()</span></tt> to set the status and headers, so all the middleware has to do is provide its own <tt class="docutils literal"><span class="pre">start_response()</span></tt> function that performs any modifications before calling the <tt class="docutils literal"><span class="pre">start_response()</span></tt> function it has been passed. This example simply sets a cookie named <tt class="docutils literal"><span class="pre">name</span></tt> with the value <tt class="docutils literal"><span class="pre">value</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Middleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">custom_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="s">&quot;name=value&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">custom_start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that <tt class="docutils literal"><span class="pre">custom_start_response()</span></tt> returns the value of calling the original <tt class="docutils literal"><span class="pre">start_response()</span></tt>. This is very important so that the writable returned from the application calling the function it receives as <tt class="docutils literal"><span class="pre">start_response()</span></tt> can use the writable object returned by the server. It is also important that you remember to pass the custom start response callable as the second argument when calling the WSGI application, rather than the original <tt class="docutils literal"><span class="pre">start_response()</span></tt> the middleware receives.</p>
</div>
<div class="section" id="handling-errors">
<h3>Handling Errors<a class="headerlink" href="#handling-errors" title="Permalink to this headline">¶</a></h3>
<p id="index-1190">To be able to deal with errors, you need to know that the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable you have been using throughout this chapter takes an optional third parameter named <tt class="docutils literal"><span class="pre">exc_info</span></tt>, which defaults to <tt class="xref docutils literal"><span class="pre">None</span></tt>.</p>
<p>If an error occurs in your application (or even in one of the middleware components), you might want to have that error intercepted so that you could log the error, send an e-mail error report, or display a traceback to the user for debugging. It is possible that the server hasn’t actually sent the HTTP headers yet, so the middleware doing the intercepting has an opportunity to call <tt class="docutils literal"><span class="pre">start_response()</span></tt> itself with any status or headers it needs in order to display the traceback or indicate an error. Since the error-handling middleware doesn’t know whether the server has actually sent the headers, it behaves as if it hasn’t and calls the server as usual to generate the required response, but it also specifies the <tt class="docutils literal"><span class="pre">exc_info</span></tt> argument to <tt class="docutils literal"><span class="pre">start_response()</span></tt> as a Python <tt class="docutils literal"><span class="pre">sys.exc_info()</span></tt> tuple representing the error that occurred.</p>
<p>When <tt class="docutils literal"><span class="pre">start_response()</span></tt> is called with the <tt class="docutils literal"><span class="pre">exc_info</span></tt> argument, the server will check whether the headers have already been sent and raise the exception passed to it via the <tt class="docutils literal"><span class="pre">exc_info</span></tt> argument if they have. If they haven’t, it can use the new headers specified by the error-handling middleware.</p>
<p>If you refer to the <tt class="docutils literal"><span class="pre">run_with_cgi()</span></tt> example from earlier in the chapter, you can see this behavior is implemented in the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">response_headers</span><span class="p">,</span><span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">headers_sent</span><span class="p">:</span>
                <span class="c"># Re-raise original exception if headers sent</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>             <span class="c"># avoid dangling circular ref</span>
    <span class="k">elif</span> <span class="n">headers_set</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;Headers already set!&quot;</span><span class="p">)</span>

    <span class="n">headers_set</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span><span class="n">response_headers</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">write</span>
</pre></div>
</div>
<p>In this example, if the headers have already been set and there is no <tt class="docutils literal"><span class="pre">exc_info()</span></tt> argument, an <tt class="docutils literal"><span class="pre">AssertionError</span></tt> is raised to indicate that it is likely the <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable has been called twice by mistake.</p>
<p id="index-1191">With a good understanding of how the <tt class="docutils literal"><span class="pre">exc_info</span></tt> argument works, let’s go ahead and write an example that simply displays a traceback using the <tt class="docutils literal"><span class="pre">cgitb</span></tt> module from the Python Standard Library:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cgitb</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">format_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="n">dummy_file</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">cgitb</span><span class="o">.</span><span class="n">Hook</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">dummy_file</span><span class="p">)</span>
        <span class="n">hook</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dummy_file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">start_response</span><span class="p">(</span>
                <span class="s">&#39;500 Internal Server Error&#39;</span><span class="p">,</span>
                <span class="p">[(</span><span class="s">&#39;content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html&#39;</span><span class="p">)],</span>
                <span class="n">exc_info</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_info</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1192">As you can see, the middleware just uses a simple <tt class="docutils literal"><span class="pre">try</span></tt>... <tt class="docutils literal"><span class="pre">except</span></tt> block, and if it encounters an error, it calls <tt class="docutils literal"><span class="pre">start_response()</span></tt> with the <tt class="docutils literal"><span class="pre">exc_info</span></tt> argument so that the server can raise an exception if the headers have already been sent. Then it calls its <tt class="docutils literal"><span class="pre">format_exception()</span></tt> method, which uses the <tt class="docutils literal"><span class="pre">cgitb</span></tt> module to generate an HTML error page that it then returns.</p>
</div>
<div class="section" id="altering-the-response">
<h3>Altering the Response<a class="headerlink" href="#altering-the-response" title="Permalink to this headline">¶</a></h3>
<p id="index-1193">Another thing you can do with WSGI middleware is alter the response returned from a WSGI application. In Chapter 15, I discussed ways of speeding up the time it takes a browser to render a page from a Pylons application, and one of the recommendations was to compress JavaScript or CSS files using Gzip compression so that they took less time to download from a server. One way of doing this is with middleware, so let’s write some middleware to Gzip JavaScript and CSS files before they are sent to the browser.</p>
<p>The example is quite complex, so rather than showing you the final code, let’s build up the middleware in steps. First you need to know how to use Gzip compression in Python. Here’s an example function that just compresses its input:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">9</span><span class="p">):</span>
    <span class="c"># The GZipFile object expects to operate on a file, not a string</span>
    <span class="c"># so we create a file-like buffer for it to write the output to</span>
    <span class="nb">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

    <span class="c"># Now let&#39;s create the GzipFile object which compresses any</span>
    <span class="c"># strings written to it and adds the output to the buffer</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span>
        <span class="n">compresslevel</span><span class="o">=</span><span class="n">compresslevel</span><span class="p">,</span>
        <span class="n">fileobj</span><span class="o">=</span><span class="nb">buffer</span>
    <span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># Finally we get the compressed string out of the buffer</span>
    <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p id="index-1194">Let’s make a first attempt at applying this technique to some middleware:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="c"># CAUTION: This doesn&#39;t work correctly yet</span>

<span class="k">class</span> <span class="nc">GzipMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span> <span class="o">=</span> <span class="n">compresslevel</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span>
            <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span><span class="p">,</span>
            <span class="n">fileobj</span><span class="o">=</span><span class="nb">buffer</span>
        <span class="p">)</span>
        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">app_iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
</pre></div>
</div>
<p id="index-1195">When the middleware is called, the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method behaves in a similar way to the <tt class="docutils literal"><span class="pre">compress()</span></tt> function from the previous example. A buffer is set up to receive the compressed data, and a <tt class="docutils literal"><span class="pre">GzipFile</span></tt> object is created to do the work of compressing any data passed to it via its <tt class="docutils literal"><span class="pre">write()</span></tt> method. The WSGI application the middleware wraps is then called, and its result is iterated over, writing each line to the <tt class="docutils literal"><span class="pre">GzipFile</span></tt> object <tt class="docutils literal"><span class="pre">output</span></tt>. Notice that any time you iterate over the result, you are also responsible for calling the <tt class="docutils literal"><span class="pre">close()</span></tt> method on the iterator if it has one. This is to support resource release by the application and is intended to complement PEP 325’s generator support and other common iterables with <tt class="docutils literal"><span class="pre">close()</span></tt> methods. Once the iterator has been closed, the method returns the compressed contents of the buffer to the middleware beneath it as a list.</p>
<p>The example so far correctly generates a compressed response, but there are some problems with it:</p>
<blockquote>
<ul class="simple">
<li>Not all browsers support Gzip compression, so this middleware would break the application on those browsers.</li>
<li>Any data written to the writable object returned by <tt class="docutils literal"><span class="pre">start_response()</span></tt> wouldn’t be compressed.</li>
<li>If a <tt class="docutils literal"><span class="pre">Content-Length</span></tt> was set, it would now be incorrect because the response has changed.</li>
<li>Not all content should be compressed; only JavaScript and CSS files should be.</li>
</ul>
</blockquote>
<p id="index-1196">Let’s start by writing a custom <tt class="docutils literal"><span class="pre">start_response()</span></tt> function that returns the <tt class="docutils literal"><span class="pre">GzipFile</span></tt> object. This object has a <tt class="docutils literal"><span class="pre">write()</span></tt> method which can be returned to fulfil the requirement of the WSGI specification for <tt class="docutils literal"><span class="pre">start_response()</span></tt> to return a writable object. At the same time, update the code to check that the browser supports Gzip compression. The new code looks like this (lines 12, 13, 22, 23 and 25 have been modified):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="c"># CAUTION: This doesn&#39;t work correctly yet</span>

<span class="k">class</span> <span class="nc">GzipMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span> <span class="o">=</span> <span class="n">compresslevel</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;gzip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT_ENCODING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span>
            <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span><span class="p">,</span>
            <span class="n">fileobj</span><span class="o">=</span><span class="nb">buffer</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">dummy_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">write</span>

        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">dummy_start_response</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">app_iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p id="index-1197">If the browser doesn’t support Gzip encoding, the middleware does nothing, returning the application as it stands. If Gzip encoding is supported, a <tt class="docutils literal"><span class="pre">dummy_start_respose()</span></tt> function is returned that, when called by the application, returns the object <tt class="docutils literal"><span class="pre">output</span></tt>. Although this code fixes two of the problems, it introduces a third. The <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable that is passed to the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method isn’t called itself, so the headers and status won’t actually get passed to the server, which you’ll recall is responsible for providing <tt class="docutils literal"><span class="pre">start_response()</span></tt> in the first place. To call the <tt class="docutils literal"><span class="pre">start_response()</span></tt> function, you’ll need to know the status and headers it should be called with.</p>
<p id="index-1198">The problem here is that <tt class="docutils literal"><span class="pre">status</span></tt>, <tt class="docutils literal"><span class="pre">headers</span></tt>, and <tt class="docutils literal"><span class="pre">exc_info</span></tt> are only locally available in your <tt class="docutils literal"><span class="pre">dummy_start_response()</span></tt> function, and you need to be able to access them in the scope of the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method in order to call <tt class="docutils literal"><span class="pre">start_response()</span></tt> after the WSGI application is called. If you were to set them as globals, they become globally available, not just available in the scope of the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method, so you definitely don’t want to do that. The solution is to create a list variable in the scope of the <tt class="docutils literal"><span class="pre">__call__()</span></tt> method and then append the <tt class="docutils literal"><span class="pre">status</span></tt>, <tt class="docutils literal"><span class="pre">headers</span></tt>, and <tt class="docutils literal"><span class="pre">exc_info</span></tt> to it from the scope of the <tt class="docutils literal"><span class="pre">dummy_start_response()</span></tt> function; then after the application has been called, the variables will have been set, so you can iterate over the result based on the values in the list. Let’s update the code to call the real <tt class="docutils literal"><span class="pre">start_response()</span></tt> callable (lines 22-27 and 37 have changed):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="c"># CAUTION: This doesn&#39;t work correctly yet</span>

<span class="k">class</span> <span class="nc">GzipMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span> <span class="o">=</span> <span class="n">compresslevel</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;gzip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT_ENCODING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span>
            <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span><span class="p">,</span>
            <span class="n">fileobj</span><span class="o">=</span><span class="nb">buffer</span>
        <span class="p">)</span>

        <span class="n">start_response_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">dummy_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">write</span>

        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">dummy_start_response</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">app_iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">start_response</span><span class="p">(</span><span class="o">**</span><span class="n">start_response_args</span><span class="p">)</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p id="index-1199">This version correctly calls <tt class="docutils literal"><span class="pre">start_response()</span></tt>, but two problems are left to fix. First you need to update the <tt class="docutils literal"><span class="pre">Content-Length</span></tt> header to contain the correct length of the new compressed content, and then you need to ensure that only JavaScript and CSS files are compressed. Since this example will be used in the SimpleSite application, let’s enable compression for any URL that ends in <tt class="docutils literal"><span class="pre">.js</span></tt> or <tt class="docutils literal"><span class="pre">.css</span></tt>. Here’s the final version of the code (lines 12-13 and 36-42 have changed):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="k">class</span> <span class="nc">GzipMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span> <span class="o">=</span> <span class="n">compresslevel</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;gzip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT_ENCODING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s">&#39;.js&#39;</span> <span class="ow">and</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">][</span><span class="o">-</span><span class="mf">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s">&#39;.css&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span>
            <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compresslevel</span><span class="p">,</span>
            <span class="n">fileobj</span><span class="o">=</span><span class="nb">buffer</span>
        <span class="p">)</span>

        <span class="n">start_response_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">dummy_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">start_response_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">write</span>

        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">dummy_start_response</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">app_iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">start_response_args</span><span class="p">[</span><span class="mf">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;content-length&#39;</span><span class="p">:</span>
                 <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))))</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;gzip&#39;</span><span class="p">))</span>
        <span class="n">start_response</span><span class="p">(</span><span class="n">start_response_args</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">start_response_args</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p id="index-1200">As you can see, this version will work correctly, but it wasn’t exactly a piece of cake to write. Although changing the response is one of the more difficult things you can do with middleware, it really makes you appreciate all the things Pylons does for you!</p>
</div>
<div class="section" id="testing-the-gzip-middleware">
<h3>Testing the Gzip Middleware<a class="headerlink" href="#testing-the-gzip-middleware" title="Permalink to this headline">¶</a></h3>
<p id="index-1201">Let’s test this middleware. Add the previous code to a new file in the SimpleSite project’s <tt class="docutils literal"><span class="pre">lib</span></tt> directory called <tt class="docutils literal"><span class="pre">middleware.py</span></tt>. Then edit the project’s config file to include this import at the top:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite.lib.middleware</span> <span class="kn">import</span> <span class="n">GzipMiddleware</span>
</pre></div>
</div>
<p>Then change the code at the end of <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt> so that it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Static files (If running in production, and Apache or another web</span>
<span class="c"># server is handling this static content, remove the following 1 lines)</span>
<span class="n">static_app</span> <span class="o">=</span> <span class="n">StaticURLParser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.paths&#39;</span><span class="p">][</span><span class="s">&#39;static_files&#39;</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Cascade</span><span class="p">([</span><span class="n">static_app</span><span class="p">,</span> <span class="n">app</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">GzipMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mf">5</span><span class="p">)</span>
<span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p>If you start the SimpleSite server on your local machine and reload one of the pages that uses JavaScript such as <a class="reference external" href="http://localhost:5000/page/edit/6">http://localhost:5000/page/edit/6</a>, you might find it actually loads more slowly than it did before. Take a look at the Net tab of Firebug to find out. This is because it is running on your local computer, so your machine has to do the extra work of compressing and uncompressing the data. If you were viewing the page over a network, the extra time it takes your browser to uncompress the data should be less than the time saved in sending the file across the network.</p>
<p>Here are the relevant headers from Firebug when the <tt class="docutils literal"><span class="pre">yahoo-dom-event.js</span></tt> file is requested before the Gzip middleware is in place:</p>
<div class="highlight-python"><pre>Server            PasteWSGIServer/0.5 Python/2.5.2
Date              Fri, 10 Oct 2008 19:31:22 GMT
Content-Type      application/x-javascript
...
Content-Length    31637</pre>
</div>
<p>Here are the headers with the Gzip middleware:</p>
<div class="highlight-python"><pre>Server            PasteWSGIServer/0.5 Python/2.5.2
Date              Fri, 10 Oct 2008 19:30:44 GMT
Content-Type      application/x-javascript
...
Content-Length    10577
Content-Encoding  gzip</pre>
</div>
<p id="index-1202">As you can see, the Gzip middleware has reduced the file size by about 20KB, which on a very slow connection could save up to half a second in the page load time.</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This chapter has been a whistle-stop tour of the Web Server Gateway Interface. I hope you can see that WSGI is actually a very powerful API. If you managed to follow all the examples in the chapter, you might be keen to start writing WSGI middleware. If you are, that’s great. A good place to start is the WSGI specification defined in PEP 333, but WSGI is best learned from examples. The Paste package that is installed with Pylons is particularly rich in WSGI middleware and is a good place to look to see how different situations are handled with WSGI.</p>
<p id="index-1203">Here are some links for further reading:</p>
<blockquote>
<ul class="simple">
<li>PEP 333, <a class="reference external" href="http://www.python.org/dev/peps/pep-0333/">http://www.python.org/dev/peps/pep-0333/</a></li>
<li>The WSGI web site, <a class="reference external" href="http://wsgi.org/">http://wsgi.org</a></li>
<li>Introducing WSGI—Python’s Secret Web Weapon Part 1, <a class="reference external" href="http://www.xml.com/pub/a/2006/09/27/introducing-wsgi-pythons-secret-web-weapon.html">http://www.xml.com/pub/a/2006/09/27/introducing-wsgi-pythons-secret-web-weapon.html</a></li>
<li>Introducing WSGI—Python’s Secret Web Weapon Part 2, <a class="reference external" href="http://www.xml.com/pub/a/2006/10/04/introducing-wsgi-pythons-secret-web-weapon-part-two.html">http://www.xml.com/pub/a/2006/10/04/introducing-wsgi-pythons-secret-web-weapon-part-two.html</a></li>
</ul>
</blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 16: The Web Server Gateway Interface (WSGI)</a><ul>
<li><a class="reference external" href="#introducing-wsgi">Introducing WSGI</a><ul>
<li><a class="reference external" href="#wsgi-applications">WSGI Applications</a><ul>
<li><a class="reference external" href="#using-instances-of-classes">Using Instances of Classes</a></li>
</ul>
</li>
<li><a class="reference external" href="#wsgi-in-pylons-controllers">WSGI in Pylons Controllers</a></li>
<li><a class="reference external" href="#wsgi-servers">WSGI Servers</a></li>
<li><a class="reference external" href="#wsgi-middleware">WSGI Middleware</a></li>
</ul>
</li>
<li><a class="reference external" href="#writing-wsgi-middleware">Writing WSGI Middleware</a><ul>
<li><a class="reference external" href="#modifying-the-environment">Modifying the Environment</a></li>
<li><a class="reference external" href="#changing-the-status-and-headers">Changing the Status and Headers</a></li>
<li><a class="reference external" href="#handling-errors">Handling Errors</a></li>
<li><a class="reference external" href="#altering-the-response">Altering the Response</a></li>
<li><a class="reference external" href="#testing-the-gzip-middleware">Testing the Gzip Middleware</a></li>
</ul>
</li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="css-javascript-and-ajax.html"
                                  title="previous chapter">Chapter 15: CSS, JavaScript, and Ajax</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="pylons-internal-architecture.html"
                                  title="next chapter">Chapter 17: Pylons’ Internal Architecture</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/the-web-server-gateway-interface-wsgi.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pylons-internal-architecture.html" title="Chapter 17: Pylons’ Internal Architecture"
             >next</a> |</li>
        <li class="right" >
          <a href="css-javascript-and-ajax.html" title="Chapter 15: CSS, JavaScript, and Ajax"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/the-web-server-gateway-interface-wsgi.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:41 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>