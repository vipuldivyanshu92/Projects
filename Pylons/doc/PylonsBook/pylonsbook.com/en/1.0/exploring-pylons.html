<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/exploring-pylons.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:41:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 3: Exploring Pylons &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 4: Tracking Down and Handling Problems" href="tracking-down-problems-and-handling-errors.html" />
    <link rel="prev" title="Chapter 2: Installing Pylons" href="installing-pylons.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tracking-down-problems-and-handling-errors.html" title="Chapter 4: Tracking Down and Handling Problems"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installing-pylons.html" title="Chapter 2: Installing Pylons"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-3-exploring-pylons">
<h1>Chapter 3: Exploring Pylons<a class="headerlink" href="#chapter-3-exploring-pylons" title="Permalink to this headline">¶</a></h1>
<p id="index-278">Now that you have seen how to set up a Python environment and have used Easy Install to install Pylons and its dependencies, it is time to create your first Pylons project. In time-honored tradition, I’ll start with an example that outputs the words <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">world!</span></tt> to the web browser.</p>
<p>In this chapter, you’ll also learn the basics of the Hypertext Transfer Protocol, learn about Pylons’ request and response objects, and begin learning how Pylons works and about the other objects Pylons sets up for you.</p>
<div class="section" id="exploring-pylons-dependencies">
<h2>Exploring Pylons’ Dependencies<a class="headerlink" href="#exploring-pylons-dependencies" title="Permalink to this headline">¶</a></h2>
<p id="index-279">As you learned in Chapter 1, Pylons is more like a collection of very carefully chosen separate components than a tightly integrated framework, but it can often be difficult to work out exactly how each of the components fits together. You’ll learn this over the course of the book, but let’s take a quick look at the packages that were installed along with Pylons so that you can get an idea of the big picture.</p>
<p id="index-280">If you followed the installation instructions from the previous chapter, take a look at the <tt class="docutils literal"><span class="pre">lib/python2.5/site-packages</span></tt> directory in your virtual Python environment. You will see all of Pylons’ dependencies as well as the <tt class="docutils literal"><span class="pre">easy-install.pth</span></tt> and <tt class="docutils literal"><span class="pre">setuptools.pth</span></tt> files, which Easy Install uses to keep track of the installed eggs. If you’ve installed other packages too, you will also see them.</p>
<p>The following list contains the components relevant to Pylons 0.9.7. Of course, the version numbers might change slightly over time and future versions of Pylons might have slightly different dependencies, but the following list is correct at the time of this writing:</p>
<dl class="docutils" id="index-281">
<dt><tt class="docutils literal"><span class="pre">Beaker-0.9.5-py2.5.egg</span></tt></dt>
<dd>Beaker is a piece of software used internally by Pylons to implement its caching and session functionality. The Pylons <tt class="docutils literal"><span class="pre">session</span></tt> global described later in the chapter uses Beaker, as does Pylons’ caching functionality described in the Pylons Cookbook at <a class="reference external" href="http://wiki.pylonshq.com/display/pylonsdocs/Caching+in+Templates+and+Controllers">http://wiki.pylonshq.com/display/pylonsdocs/Caching+in+Templates+and+Controllers</a>, but you would never normally interact with Beaker yourself directly.</dd>
</dl>
<dl class="docutils" id="index-282">
<dt><tt class="docutils literal"><span class="pre">decorator-2.2.0-py2.5.egg</span></tt></dt>
<dd>This is a simple tool used by Pylons to create the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> and <tt class="docutils literal"><span class="pre">&#64;jsonify</span></tt> decorators. You’ll learn about <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> in Chapter 6, and you’ll learn about <tt class="docutils literal"><span class="pre">&#64;jsonify</span></tt> in Chapter 15. Once again, you won’t normally use <tt class="docutils literal"><span class="pre">decorator</span></tt> in your own programs because you’ll usually use the decorators provided by Pylons.</dd>
</dl>
<dl class="docutils" id="index-283">
<dt><tt class="docutils literal"><span class="pre">FormEncode-1.0.1-py2.5.egg</span></tt></dt>
<dd>FormEncode is a library for validating form submissions from web sites. Although Pylons doesn’t use it internally, Pylons users work with it so often that it is considered an essential part of Pylons. The FormEncode package also includes a module named <tt class="docutils literal"><span class="pre">formencode.htmlfill</span></tt> that can be used to populate a string containing HTML fields with values and error messages. Together FormEncode and HTML Fill make an ideal tool set for handling forms in a Pylons application. Chapter 6 is dedicated to explaining how to use FormEncode and HTML Fill in a Pylons application.</dd>
</dl>
<dl class="docutils" id="index-284">
<dt><tt class="docutils literal"><span class="pre">Mako-0.2.0-py2.5.egg</span></tt></dt>
<dd>Mako is one of the three template languages that Pylons 0.9.7 supports out of the box. The others are Genshi (an XML template language) and Jinja (based on Django’s template system). You have to install Genshi and Jinja separately if you want to use them, whereas Mako is included in the default Pylons installation because it is the recommended template language to use. Using Mako to generate your views is described in detail in Chapter 5.</dd>
</dl>
<dl class="docutils" id="index-285">
<dt><tt class="docutils literal"><span class="pre">nose-0.10.3-py2.5.egg</span></tt></dt>
<dd>This provides tools to help you write and run automated unit tests. Testing is described in Chapter 12.</dd>
</dl>
<dl class="docutils" id="index-286">
<dt><tt class="docutils literal"><span class="pre">Paste-1.6-py2.5.egg</span></tt>, <tt class="docutils literal"><span class="pre">PasteDeploy-1.3.2-py2.5.egg</span></tt>, and <tt class="docutils literal"><span class="pre">PasteScript-1.6.3-py2.5.egg</span></tt></dt>
<dd><p class="first">Paste comes in three packages for the benefit of framework developers who require only one part of its functionality. Pylons uses all three packages for a wide variety of things throughout the framework, but once again, as a Pylons application developer, you won’t normally directly interact with the Paste components yourself.</p>
<p>Over time, the functionality in the Paste modules has been split up into custom packages. For example, the <tt class="docutils literal"><span class="pre">paste.wsgiwrappers</span></tt> module, which provided the <tt class="docutils literal"><span class="pre">pylons.request</span></tt> and <tt class="docutils literal"><span class="pre">pylons.response</span></tt> objects in Pylons 0.9.6, is now replaced by WebOb, which provides the Pylons 0.9.7 versions of those Pylons objects. The <tt class="docutils literal"><span class="pre">paste.eval_exception</span></tt> module, which provided the 0.9.6 error handling, is replaced by WebError in Pylons 0.9.7, and even the <tt class="docutils literal"><span class="pre">paste.auth</span></tt> functionality has been built upon and improved in AuthKit, which you’ll learn about in Chapter 18. Don’t be surprised if future versions of Pylons include even more projects spun out from their roots in Paste.</p>
<p class="last">Despite the gradual shift to separate packages, Pylons still relies on Paste for its configuration files, registry manager, development HTTP server, project template creation, test fixtures, error documents, and more. The various parts of Paste are described throughout the book as they are encountered.</p>
</dd>
</dl>
<dl class="docutils" id="index-287">
<dt><tt class="docutils literal"><span class="pre">Pylons-0.9.7-py2.5.egg</span></tt></dt>
<dd>This is where everything needed to glue together the other components of Pylons is found. Pylons itself is relatively small, so if you are the curious type, feel free to look at its code to get a feel for how everything works.</dd>
</dl>
<dl class="docutils" id="index-288">
<dt><tt class="docutils literal"><span class="pre">Routes-1.9-py2.5.egg</span></tt></dt>
<dd>Pylons uses a system called Routes that allows you to map a URL to a set of variables usually including <tt class="docutils literal"><span class="pre">controller</span></tt> and <tt class="docutils literal"><span class="pre">action</span></tt>. These variables are then used to determine which Pylons controller class and method should be used to handle the request. At the same time, Routes allows you to specify a set of variables and have a URL generated from them so that you never need to hard-code URLs into your application. I’ll introduce Routes in this chapter, but you will learn the details of all of Route’s powerful features in Chapter 9.</dd>
</dl>
<dl class="docutils" id="index-289">
<dt><tt class="docutils literal"><span class="pre">setuptools-0.6c8-py2.5.egg</span></tt></dt>
<dd>This contains the methods used by the <tt class="docutils literal"><span class="pre">easy_install</span></tt> script to provide all of its features and allow the use of egg files.</dd>
</dl>
<dl class="docutils" id="index-290">
<dt><tt class="docutils literal"><span class="pre">simplejson-1.8.1-py2.5-linux-x86_64.egg</span></tt></dt>
<dd>This package converts data back and forth between JSON and Python formats and is used by the <tt class="docutils literal"><span class="pre">&#64;jsonify</span></tt> decorator mentioned earlier. Pylons application developers also occasionally use <tt class="docutils literal"><span class="pre">simplejson</span></tt> directly in their controllers.</dd>
</dl>
<dl class="docutils" id="index-291">
<dt><tt class="docutils literal"><span class="pre">Tempita-0.2-py2.5.egg</span></tt></dt>
<dd>Tempita is a small template language that is a dependency of Paste. It is used only behind the scenes for simple variable substitutions when you create a new Pylons project directory with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command described later in this chapter.</dd>
</dl>
<dl class="docutils" id="index-292">
<dt><tt class="docutils literal"><span class="pre">WebError-0.8-py2.5.egg</span></tt></dt>
<dd>WebError provides Pylons’ powerful interactive debugging and traceback functionality described in Chapter 4.</dd>
</dl>
<dl class="docutils" id="index-293">
<dt><tt class="docutils literal"><span class="pre">WebHelpers-0.6-py2.5.egg</span></tt></dt>
<dd>WebHelpers is a collection of stand-alone functions and classes that provide useful functionality such as generating common HTML tags and form fields, handling multiple pages of results, and doing much more.</dd>
</dl>
<dl class="docutils" id="index-294">
<dt><tt class="docutils literal"><span class="pre">WebOb-0.9.2-py2.5.egg</span></tt></dt>
<dd>This provides the new <tt class="docutils literal"><span class="pre">pylons.request</span></tt> and <tt class="docutils literal"><span class="pre">pylons.response</span></tt> objects in Pylons 0.9.7.</dd>
</dl>
<p id="index-295">You might have noticed that SQLAlchemy, a database toolkit you’ll learn about in Chapter 7, and AuthKit, a toolkit you’ll learn about in Chapter 18, are not included in the list of packages installed automatically with Pylons. This is because Pylons can be used perfectly well without them, and although most users will choose to install them, some developers will want to choose alternatives instead.</p>
<p id="index-296">Installing Pylons also installs some scripts. If you look in your virtual Python environment’s <tt class="docutils literal"><span class="pre">bin</span></tt> directory (or the <tt class="docutils literal"><span class="pre">Scripts</span></tt> directory on Windows), you will see the following:</p>
<dl class="docutils" id="index-297">
<dt><tt class="docutils literal"><span class="pre">activate</span></tt> (or <tt class="docutils literal"><span class="pre">activate.bat</span></tt> on Windows)</dt>
<dd>This is an optional script described in Chapter 2 for activating a virtual Python environment to make the other scripts available automatically on the current shell or command prompt without having to type the full path to the virtual Python environment.</dd>
</dl>
<dl class="docutils" id="index-298">
<dt><tt class="docutils literal"><span class="pre">nosetests</span></tt></dt>
<dd>This is a script used for running your Pylons tests; it is provided by the <tt class="docutils literal"><span class="pre">nose</span></tt> package, which was mentioned earlier and will be described in Chapter 12.</dd>
</dl>
<dl class="docutils" id="index-299">
<dt><tt class="docutils literal"><span class="pre">python</span></tt></dt>
<dd>This is the Python executable you should use for all work within the virtual Python environment.</dd>
</dl>
<dl class="docutils" id="index-300">
<dt><tt class="docutils literal"><span class="pre">easy_install</span></tt></dt>
<dd>This is the Easy Install program for installing software into your virtual environment described in Chapter 2.</dd>
<dt><tt class="docutils literal"><span class="pre">mako-render</span></tt></dt>
<dd>This is a simple script installed with Mako that takes a single file containing Mako template markup as an argument and outputs the rendered template to the standard output on your console. This isn’t very useful for Pylons development.</dd>
</dl>
<dl class="docutils" id="index-301">
<dt><tt class="docutils literal"><span class="pre">paster</span></tt></dt>
<dd>This is a very useful script that uses the Paste Script package and has a number of subcommands including <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> and <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span></tt>, which you’ll see later in this chapter, that are for creating a new Pylons project and serving a Pylons application, respectively. You’ll also see <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">make-config</span></tt> and <tt class="docutils literal"><span class="pre">paster</span>&nbsp; <span class="pre">setup-app</span></tt>, which are for handling the creation of a config file from a distributed Pylons project and for setting it up. These are advanced features you’ll learn about in the SimpleSite tutorial throughout the book.</dd>
</dl>
<p id="index-302">Your <tt class="docutils literal"><span class="pre">bin</span></tt> (or <tt class="docutils literal"><span class="pre">Scripts</span></tt>) directory might also see a file such as <tt class="docutils literal"><span class="pre">easy_install-2.5</span></tt>, which is simply a Python 2.5 version of the <tt class="docutils literal"><span class="pre">easy_install</span></tt> script, or a <tt class="docutils literal"><span class="pre">python2.5</span></tt> script, which is a Python 2.5 version of the <tt class="docutils literal"><span class="pre">python</span></tt> script if you are using multiple versions of Python on your system. You should generally use the <tt class="docutils literal"><span class="pre">easy_install</span></tt> and <tt class="docutils literal"><span class="pre">python</span></tt> versions because they match the version of Python you used when you ran the <tt class="docutils literal"><span class="pre">python</span> <span class="pre">virtual_python.py</span> <span class="pre">env</span></tt> command in Chapter 2.</p>
<p>Don’t worry if you don’t understand everything I’ve mentioned in this section; it will all become clear as you get more familiar with Pylons.</p>
</div>
<div class="section" id="creating-a-pylons-project">
<h2>Creating a Pylons Project<a class="headerlink" href="#creating-a-pylons-project" title="Permalink to this headline">¶</a></h2>
<p id="index-303">Now that you’ve seen a quick overview of all the Pylons components, it’s time to create your first Pylons project.</p>
<p>Let’s get started by using Paste’s <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command to automatically generate a Pylons project directory structure for you. You are completely free to create all the files and directories yourself if you prefer, but the Pylons project template provides a useful starting point that most people prefer to use.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-304">In Pylons terminology, there are two different types of template, and it is important not to get confused between the two. <em>View templates</em> are text files that contain a mixture of Python and HTML and are used to generate HTML fragments to return to the browser as the view component of the MVC architecture. Any template written with Mako is a view template. <em>Project templates</em> are sets of files and directories that are used by the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command to generate a complete project directory structure to use as a basis for a new Pylons application.</p>
</div>
<p>Create a new project named <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> based on the Pylons default project template with this command:</p>
<div class="highlight-python"><pre>$ paster create --template=pylons HelloWorld</pre>
</div>
<p id="index-305">The <tt class="docutils literal"><span class="pre">--template</span></tt> option tells the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command which project template to use to create the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> project. You will also see examples using <tt class="docutils literal"><span class="pre">-t</span></tt> instead of <tt class="docutils literal"><span class="pre">--template</span></tt>, but both have the same effect:</p>
<div class="highlight-python"><pre>$ paster create -t pylons HelloWorld</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p id="index-306">If you have problems running the previous <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command, it is likely you have forgotten to include the full path to the <tt class="docutils literal"><span class="pre">paster</span></tt> script (or the <tt class="docutils literal"><span class="pre">paster.exe</span></tt> executable in the case of Windows). You might see a message such as <tt class="docutils literal"><span class="pre">paster:</span> <span class="pre">command</span> <span class="pre">not</span> <span class="pre">found</span></tt> or <tt class="docutils literal"><span class="pre">'paster'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">recognized</span> <span class="pre">as</span> <span class="pre">an</span> <span class="pre">internal</span> <span class="pre">or</span> <span class="pre">external</span> <span class="pre">command,</span> <span class="pre">operable</span> <span class="pre">program</span> <span class="pre">or</span> <span class="pre">batch</span> <span class="pre">file</span></tt>.</p>
<p class="last">Remember that if you are using a virtual Python environment, you will need to type the full path to the executable (for example, <tt class="docutils literal"><span class="pre">env/bin/paster</span></tt> or <tt class="docutils literal"><span class="pre">C:\env\Scritps\paster</span></tt>) or modify your <tt class="docutils literal"><span class="pre">PATH</span></tt> as described in Chapter 2, either directly or by using the <tt class="docutils literal"><span class="pre">activate</span></tt> or <tt class="docutils literal"><span class="pre">activate.bat</span></tt> script. The examples in this book assume you have read Chapter 2 and will type whatever is appropriate for your installation.</p>
</div>
<p id="index-307">The project template used in the previous <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command is called <tt class="docutils literal"><span class="pre">pylons</span></tt>, which is the default for Pylons. You can always see which project templates are available with the <tt class="docutils literal"><span class="pre">--list-templates</span></tt> option shown here, but bear in mind that because Paste is a general-purpose library, not all the templates available will be for generating Pylons projects. In Chapter 19, you’ll learn how to create your own Pylons project template to add to this list:</p>
<div class="highlight-python"><pre>$ paster create --list-templates
Available templates:
  basic_package:   A basic setuptools-enabled package
  paste_deploy:    A web application deployed through paste.deploy
  pylons:          Pylons application template
  pylons_minimal:  Pylons minimal application template</pre>
</div>
<p id="index-308">Advanced users might like to experiment with the <tt class="docutils literal"><span class="pre">pylons_minimal</span></tt> application template, which leaves you to do more configuration yourself.</p>
<p id="index-309">Now let’s return to the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> example. Once you have run the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span> <span class="pre">--template=pylons</span> <span class="pre">HelloWorld</span></tt> command, you will be asked some questions about how you want your project set up. You can choose which view template language you want to use for the project and whether you want SQLAlchemy support built in. For this example, choose the defaults of Mako for the view template language and no SQLAlchemy support since you haven’t installed SQLAlchemy yet anyway. Just press Enter at each of the prompts, and the script will quickly generate your new project.</p>
</div>
<div class="section" id="serving-a-pylons-application">
<h2>Serving a Pylons Application<a class="headerlink" href="#serving-a-pylons-application" title="Permalink to this headline">¶</a></h2>
<p>Now that you have a sample project application, it is a good idea to run it with a web server to see what the default project provides; however, before you can serve the Pylons application you’ve just created, you need to learn about configuration files.</p>
<div class="section" id="configuration-files">
<h3>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h3>
<p id="index-310">Configuration files enable you to set up the same Pylons application on different servers with different settings and for different purposes without having to change the source code for the project.</p>
<p id="index-311">The project template you have used creates two configuration files for you in the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> directory, one named <tt class="docutils literal"><span class="pre">development.ini</span></tt> and one named <tt class="docutils literal"><span class="pre">test.ini</span></tt>. The <tt class="docutils literal"><span class="pre">development.ini</span></tt> file contains settings to run the Pylons application in a development environment such as your local workstation, whereas the <tt class="docutils literal"><span class="pre">test.ini</span></tt> file contains the settings you want to use when testing the application. You create a new configuration file called <tt class="docutils literal"><span class="pre">production.ini</span></tt> when you are ready to serve the application file in production.</p>
<p id="index-312">The following code is the top part of the <tt class="docutils literal"><span class="pre">development.ini</span></tt> file generated as part of the application template. There is also some logging configuration, which you’ll learn about in Chapter 20.</p>
<div class="highlight-python"><pre>#
# helloworld - Pylons development environment configuration
#
# The %(here)s variable will be replaced with the parent directory of this file
#
[DEFAULT]
debug = true
# Uncomment and replace with the address which should receive any error reports
#email_to = you@yourdomain.com
smtp_server = localhost
error_email_from = paste@localhost

[server:main]
use = egg:Paste#http
host = 127.0.0.1
port = 5000

[app:main]
use = egg:helloworld
full_stack = true
cache_dir = %(here)s/data
beaker.session.key = helloworld
beaker.session.secret = somesecret
# If you'd like to fine-tune the individual locations of the cache data dirs
# for the Cache data, or the Session saves, un-comment the desired settings
# here:
#beaker.cache.data_dir = %(here)s/data/cache
#beaker.session.data_dir = %(here)s/data/sessions

# WARNING: *THE LINE BELOW MUST BE UNCOMMENTED ON A PRODUCTION ENVIRONMENT*
# Debug mode will enable the interactive debugging tool, allowing ANYONE to
# execute malicious code after an exception is raised.
#set debug = false</pre>
</div>
<p id="index-313">As you can see, the configuration file is in three parts. The <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section contains global configuration options that can be overridden in other sections. The <tt class="docutils literal"><span class="pre">[server:main]</span></tt> part contains information for the server used to serve the Pylons application, and the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section contains configuration options for the Pylons application. All the option values can contain the string <tt class="docutils literal"><span class="pre">%(here)s</span></tt>, which gets replaced with the location of the config file, enabling you to easily specify relative paths.</p>
<p>Let’s discuss the options available:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">debug</span></tt></dt>
<dd>This can be <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>. If <tt class="docutils literal"><span class="pre">true</span></tt>, the Pylons interactive debugger is enabled to allow you to track down problems, as you’ll learn about in the next chapter. You should always disable the interactive debugger in production environments by setting <tt class="docutils literal"><span class="pre">debug</span></tt> to <tt class="docutils literal"><span class="pre">false</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">email_to</span></tt>, <tt class="docutils literal"><span class="pre">smtp_server</span></tt>, <tt class="docutils literal"><span class="pre">error_email_from</span></tt></dt>
<dd>These options specify where error reports should be sent if the interactive debugger is disabled, but they could potentially be used by third-party components too since they are specified in the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section and are therefore available to all components using the configuration file.</dd>
<dt><tt class="docutils literal"><span class="pre">host</span></tt>, <tt class="docutils literal"><span class="pre">port</span></tt></dt>
<dd>These specify the IP address and port the server should listen on for requests. Only the server uses them.</dd>
<dt><tt class="docutils literal"><span class="pre">full_stack</span></tt></dt>
<dd>You can set this to <tt class="docutils literal"><span class="pre">false</span></tt> to disable Pylons interactive debugging, error report support, and error documents support, but you’ll usually leave this set to <tt class="docutils literal"><span class="pre">true</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">cache_dir</span></tt></dt>
<dd>This is the directory where components can store information on the filesystem. Session information from Beaker and cached view templates from Mako are stored in this directory. You can manually override where Beaker stores its session information with the <tt class="docutils literal"><span class="pre">beaker.cache.data_dir</span></tt> and <tt class="docutils literal"><span class="pre">beaker.session.data_dir</span></tt> options, but you won’t usually need to do so.</dd>
<dt><tt class="docutils literal"><span class="pre">beaker.session.key</span></tt></dt>
<dd>This should be something unique to your application so that other applications using Beaker can’t access your application’s data.</dd>
</dl>
<dl class="docutils" id="index-314">
<dt><tt class="docutils literal"><span class="pre">beaker.session.secret</span></tt></dt>
<dd>This is a random string of letters and numbers used to make the cookie value representing the session harder to guess to reduce the risk of a malicious user trying to gain access to someone else’s session information. You should always change this to something other than <tt class="docutils literal"><span class="pre">somesecret</span></tt> if you are using Pylons session functionality.</dd>
</dl>
</div>
<div class="section" id="the-paste-http-server">
<h3>The Paste HTTP Server<a class="headerlink" href="#the-paste-http-server" title="Permalink to this headline">¶</a></h3>
<p id="index-315">To run your application for development purposes, it is recommended you use the Paste HTTP server from the Paste package that was installed as one of Pylons’ dependencies. The Paste HTTP server does for Pylons applications what Apache does for PHP and other languages; it listens for HTTP requests and dispatches them to the running application, returning the result via HTTP to the user’s browser.</p>
<p>The Paste HTTP server has two features that make it more suitable for Pylons development than most web servers:</p>
<blockquote>
<ul class="simple">
<li>It can be made to automatically reload when you change the source code.</li>
<li>It understands the configuration files used by Pylons, so they can be used directly. As you’ll see in Chapter 19, other servers require the assistance of the Paste Deploy package to turn a Pylons config file into an application.</li>
</ul>
</blockquote>
<p id="index-316">You can start the server with your development configuration with this command:</p>
<div class="highlight-python"><pre>$ cd HelloWorld
$ paster serve --reload development.ini
Starting subprocess with file monitor
Starting server in PID 17586.
serving on 127.0.0.1:5000 view at http://127.0.0.1:5000</pre>
</div>
<p>If you are Windows user, you may be prompted to unblock Python on port 5000 depending on your firewall settings.</p>
<p>The <tt class="docutils literal"><span class="pre">--reload</span></tt> option puts the Paste HTTP server into a very useful mode where the server carefully monitors all Python modules used by your application as well as the <tt class="docutils literal"><span class="pre">development.ini</span></tt> configuration file. If any of them change, the server is automatically reloaded so that you can immediately test your changes. This is useful during development because it saves you from having to manually stop and start the server every time you make a change.</p>
<p id="index-317">To stop the server, you can press Ctrl+C (or Ctrl+D if you’re running Windows), but don’t stop it yet. If you visit <a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> in your web browser when the server is running, you will see the welcome page shown in Figure 3-1.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0301.png"><img alt="Figure 3-1. The Pylons default page" src="_images/9349f0301.png" /></a>
<p class="caption">Figure 3-1. The Pylons default page</p>
</div>
</div>
<div class="section" id="static-files">
<h3>Static Files<a class="headerlink" href="#static-files" title="Permalink to this headline">¶</a></h3>
<p id="index-318">Now that the server is running, try creating a new file named <tt class="docutils literal"><span class="pre">hello.html</span></tt> in the <tt class="docutils literal"><span class="pre">HelloWorld/helloworld/public</span></tt> directory with the following content:</p>
<div class="highlight-python"><pre>&lt;html&gt;
    &lt;body&gt;
        Hello world!
    &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>If you visit <a class="reference external" href="http://127.0.0.1:5000/hello.html">http://127.0.0.1:5000/hello.html</a>, you will see the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">world!</span></tt> message.</p>
<p id="index-319">A Pylons project’s <tt class="docutils literal"><span class="pre">public</span></tt> folder is a bit like an <tt class="docutils literal"><span class="pre">htdocs</span></tt> directory in Apache. Any files in the <tt class="docutils literal"><span class="pre">public</span></tt> directory are treated as static files and are served treating the URL as the path to the file to serve. If the URL represents a directory and that directory contains an <tt class="docutils literal"><span class="pre">index.html</span></tt> file, it will be served instead; however, for security reasons, Pylons does not provide a directory index facility, so if no <tt class="docutils literal"><span class="pre">index.html</span></tt> file is present in a directory, a “404 File Not Found” response is returned.</p>
<p id="index-320">Pylons automatically provides E-Tag caching for static files in the <tt class="docutils literal"><span class="pre">public</span></tt> directory. This allows browsers that support E-Tag caching to check to see whether a file has changed since the last time they fetched it. If it hasn’t changed, the browser won’t download the file a second time.</p>
</div>
<div class="section" id="a-word-about-ip-addresses-hosts-and-security">
<h3>A Word About IP Addresses, Hosts, and Security<a class="headerlink" href="#a-word-about-ip-addresses-hosts-and-security" title="Permalink to this headline">¶</a></h3>
<p id="index-321">The numbers 127.0.0.1 in the URL you have been using to test your <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> application represent the IP address on which the Paste HTTP server is serving the Pylons application. The IP address 127.0.0.1 is a special IP address that references your own computer. This means your Pylons application can be accessed only from the computer on which you are running the Paste HTTP server. This is actually very important because, as you will learn in the next chapter, Pylons comes with a powerful interactive debugging tool that is enabled by default when using the <tt class="docutils literal"><span class="pre">development.ini</span></tt> configuration file. If people could access your running development instance and an error occurred, they might be able to use the interactive debugger to enter malicious commands, so this is why as of Pylons 0.9.7 the default configuration file instructs the Paste HTTP server to bind to 127.0.0.1 so it answers requests only from the local computer.</p>
<p id="index-322">If you want to test how the application works from a different computer, you can change the IP address the Paste HTTP server uses by editing the <tt class="docutils literal"><span class="pre">host</span></tt> option in the <tt class="docutils literal"><span class="pre">[server:main]</span></tt> section of the <tt class="docutils literal"><span class="pre">development.ini</span></tt> file. You can also change the port on which the server runs by changing the <tt class="docutils literal"><span class="pre">port</span></tt> variable. If you don’t want <tt class="docutils literal"><span class="pre">:5000</span></tt> in your URLs, you should set the server to run on port 80. Browsers will connect to port 80 by default for HTTP requests if no port is specified in the URL. Most production systems run on port 80 for this reason, but for development it is fine to run your application on port 5000.</p>
<p id="index-323">The IP address 0.0.0.0 is also worth knowing about. Setting the <tt class="docutils literal"><span class="pre">host</span></tt> option to 0.0.0.0 will cause the Paste HTTP server to respond to requests on all IP addresses on your server. This is the setting normally used in production configurations when the Pylons interactive debugger has been disabled.</p>
<p id="index-324">Servers frequently have hostnames mapped to particular IP addresses, and you can specify a server’s hostname instead of the IP address if you prefer. It is a convention on most platforms that the hostname localhost will refer to the IP address 127.0.0.1, so for the majority of the time, you can use localhost rather than the IP address 127.0.0.1. With the Paste HTTP server still running, try visiting <a class="reference external" href="http://localhost:5000/hello.html">http://localhost:5000/hello.html</a>; chances are you will still see the same <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">World!</span></tt> message you did before.</p>
</div>
</div>
<div class="section" id="exploring-a-pylons-project-s-directory-structure">
<h2>Exploring a Pylons Project’s Directory Structure<a class="headerlink" href="#exploring-a-pylons-project-s-directory-structure" title="Permalink to this headline">¶</a></h2>
<p id="index-325">Now that you’ve seen a simple Pylons application serving static files from the <tt class="docutils literal"><span class="pre">public</span></tt> directory, I’ll take the opportunity to show you the rest of the files and directories that the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command generated for you from the default <tt class="docutils literal"><span class="pre">pylons</span></tt> application template.</p>
<p>The main <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> directory contains the following files and directories:</p>
<dl class="docutils" id="index-326">
<dt><tt class="docutils literal"><span class="pre">docs</span></tt></dt>
<dd>This directory is where you can keep documentation for your project. Pylons applications are often documented in a language called reStructuredText. The reStructuredText files can then be converted to HTML using tools such as Sphinx. Both reStructuredText and Sphinx are discussed in Chapter 13.</dd>
<dt><tt class="docutils literal"><span class="pre">helloworld</span></tt></dt>
<dd>This is the main application directory, but its name depends on the package name you gave as the argument to the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command when the project was generated. Pylons applications are usually given a package name in CamelCase, but the application directory itself is the lowercase version of the package name. In this case, you specified the package name as <tt class="docutils literal"><span class="pre">HelloWorld</span></tt>, so the main Pylons application directory is named <tt class="docutils literal"><span class="pre">helloworld</span></tt>. If you were to write <tt class="docutils literal"><span class="pre">import</span> <span class="pre">helloworld</span></tt>, it would be this directory’s files that are imported. I’ll return to this directory in a moment to explore the subdirectories it contains.</dd>
<dt><tt class="docutils literal"><span class="pre">HelloWorld.egg-info</span></tt></dt>
<dd>This is a special directory that contains metadata about your project in a format that is used by <tt class="docutils literal"><span class="pre">setuptools</span></tt> when you treat the application as an egg.</dd>
<dt><tt class="docutils literal"><span class="pre">development.ini</span></tt> and <tt class="docutils literal"><span class="pre">test.ini</span></tt></dt>
<dd>These are the configuration files I discussed in the previous section.</dd>
</dl>
<dl class="docutils" id="index-327">
<dt><tt class="docutils literal"><span class="pre">ez_setup.py</span></tt></dt>
<dd>Your Pylons application relies on some features provided by the <tt class="docutils literal"><span class="pre">setuptools</span></tt> module, but not every Python installation comes with the <tt class="docutils literal"><span class="pre">setuptools</span></tt> module already installed, because it isn’t an official part of the Python distribution. The <tt class="docutils literal"><span class="pre">ez_setup.py</span></tt> file is therefore included to automatically install <tt class="docutils literal"><span class="pre">setuptools</span></tt> if someone without it tries to install your Pylons application.</dd>
</dl>
<dl class="docutils" id="index-328">
<dt><tt class="docutils literal"><span class="pre">MANIFEST.in</span></tt></dt>
<dd>Your Pylons application contains various files that aren’t Python modules such as the templates and static files. These files are included in a Python package only if they are specified in a <tt class="docutils literal"><span class="pre">MANIFEST.in</span></tt> file. The <tt class="docutils literal"><span class="pre">MANIFEST.in</span></tt> file in your project’s directory forces these files to be included.</dd>
</dl>
<dl class="docutils" id="index-329">
<dt><tt class="docutils literal"><span class="pre">README.txt</span></tt></dt>
<dd>Having a <tt class="docutils literal"><span class="pre">README</span></tt> file in a project’s root directory is standard practice, so this file is simply there for you to describe your project to anyone looking at its source code. You can customize it as you see fit.</dd>
</dl>
<dl class="docutils" id="index-330">
<dt><tt class="docutils literal"><span class="pre">setup.cfg</span></tt> and <tt class="docutils literal"><span class="pre">setup.py</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">setup.py</span></tt> and <tt class="docutils literal"><span class="pre">setup.cfg</span></tt> files control various aspects of how your Pylons application is packaged when you distribute it. They also contain metadata about the project. You’ll see them being used as you read the SimpleSite tutorial chapters.</dd>
</dl>
<p id="index-331">You may also notice a <tt class="docutils literal"><span class="pre">data</span></tt> directory that contains cached session and template information. It is created the first time you run a Pylons application that needs it to be present. The location of this directory can be configured with the <tt class="docutils literal"><span class="pre">cache_dir</span></tt> option you saw a moment ago when I discussed configuration file options.</p>
<p id="index-332">Now let’s take a look at the main Pylons application directory. As mentioned a moment ago, this will have a name based on the package name, so it will be different in each Pylons project. In this case, it is called <tt class="docutils literal"><span class="pre">helloworld</span></tt> and contains the following files and directories:</p>
<dl class="docutils" id="index-333">
<dt><tt class="docutils literal"><span class="pre">config</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">config</span></tt> directory is where most Pylons functionality is exposed to your application for you to customize.</dd>
</dl>
<dl class="docutils" id="index-334">
<dt><tt class="docutils literal"><span class="pre">controllers</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">controllers</span></tt> directory is where your application controllers are written. Controllers are the core of your application. They allow you to handle requests, load or save data from your model, and pass information to your view templates for rendering; they are also responsible for returning information to the browser. You’ll create your first controller in the next section.</dd>
</dl>
<dl class="docutils" id="index-335">
<dt><tt class="docutils literal"><span class="pre">lib</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">lib</span></tt> directory is where you can put Python code that is used between different controllers, third-party code, or any other code that doesn’t fit in well elsewhere.</dd>
</dl>
<dl class="docutils" id="index-336">
<dt><tt class="docutils literal"><span class="pre">model</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">model</span></tt> directory is for your model objects; if you’re using an object-relational mapper such as SQLAlchemy, this is where your tables, classes, and relations should be defined. You’ll look at using SQLAlchemy as a model in Chapter 7.</dd>
</dl>
<dl class="docutils" id="index-337">
<dt><tt class="docutils literal"><span class="pre">public</span></tt></dt>
<dd>You’ve already seen the <tt class="docutils literal"><span class="pre">public</span></tt> directory. It is similar to the <tt class="docutils literal"><span class="pre">htdocs</span></tt> directory in Apache and is where you put all your HTML, images, JavaScript, CSS, and other static files.</dd>
</dl>
<dl class="docutils" id="index-338">
<dt><tt class="docutils literal"><span class="pre">templates</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">templates</span></tt> directory is where view templates are stored.</dd>
</dl>
<dl class="docutils" id="index-339">
<dt><tt class="docutils literal"><span class="pre">tests</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">tests</span></tt> directory is where you can put automated unit tests for your application.</dd>
</dl>
<dl class="docutils" id="index-340">
<dt><tt class="docutils literal"><span class="pre">__init__.py</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file is present so that the <tt class="docutils literal"><span class="pre">helloworld</span></tt> directory can be imported as a Python module within the egg.</dd>
</dl>
<dl class="docutils" id="index-341">
<dt><tt class="docutils literal"><span class="pre">websetup.py</span></tt></dt>
<dd>The <tt class="docutils literal"><span class="pre">websetup.py</span></tt> contains any code that should be executed when an end user has installed your Pylons application and needs to initialize it. It frequently contains code to create the database tables required by your application, for example. We’ll discuss this in Chapter 8.</dd>
</dl>
</div>
<div class="section" id="creating-a-controller-and-modifying-the-routes">
<h2>Creating a Controller and Modifying the Routes<a class="headerlink" href="#creating-a-controller-and-modifying-the-routes" title="Permalink to this headline">¶</a></h2>
<p id="index-342">It’s now time to learn how to generate the message dynamically using a Pylons <em>controller</em>. Controllers are the basic building blocks of Pylons applications. They contain all the programming logic and can be thought of as mini-applications. Controllers are implemented as Python classes. Each method of the class is known in Pylons as an <em>action</em>. On each request Pylons routes the HTTP information to a particular controller action based on the URL that was requested. The action should return a response, which Pylons passes back to the server and on to the browser.</p>
<p>Let’s see this in practice by creating a controller. Once again you can use a <tt class="docutils literal"><span class="pre">paster</span></tt> command to help you get started quickly:</p>
<div class="highlight-python"><pre>$ paster controller hello</pre>
</div>
<p>This command creates a skeleton <tt class="docutils literal"><span class="pre">controllers/hello.py</span></tt> file for you as well as a <tt class="docutils literal"><span class="pre">helloworld/tests/functional/test_hello.py</span></tt> file that is used for running some of the functional tests of the controller discussed in Chapter 12. If you are using the Subversion revision control system to manage the source files in a Pylons project, the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">controller</span></tt> command will also automatically add both files to your working copy.</p>
<p>Modify the <tt class="docutils literal"><span class="pre">index()</span></tt> action of the <tt class="docutils literal"><span class="pre">HelloController</span></tt> to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Hello from the index() action!&#39;</span>
</pre></div>
</div>
<p>Let’s test this code. With the server still running, visit <a class="reference external" href="http://127.0.0.1:5000/hello/index">http://127.0.0.1:5000/hello/index</a>, and you should be greeted with the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">index()</span> <span class="pre">action!</span></tt> message.</p>
<p id="index-343">Let’s look closely at that URL. If you have used ASP, PHP, or CGI scripts, you’ll know that the URL the user visits directly represents the path on the filesystem of the script the server should execute. Pylons is much more flexible than this; it uses a system called Routes to map sets of URLs to particular controllers. This means your URLs don’t always have to directly represent the controllers that handle them. By default, Routes is set up so that the first URL fragment after the hostname and port represents the controller and the second part represents the action. In this case, <tt class="docutils literal"><span class="pre">/hello/index</span></tt> means use the <tt class="docutils literal"><span class="pre">index</span></tt> action of the <tt class="docutils literal"><span class="pre">hello</span></tt> controller, and so the URL you just visited results in the <tt class="docutils literal"><span class="pre">index()</span></tt> method of <tt class="docutils literal"><span class="pre">HelloController</span></tt> being called to display the response.</p>
<p id="index-344">One very common requirement is the ability to map the root URL <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a> to a controller action. After all, you wouldn’t want to be limited to having a static file as the root URL. To do this, you need to add a line to the routes configuration. Add a new line to the top of the main route map in <tt class="docutils literal"><span class="pre">helloworld/config/routing.py</span></tt> just after the <tt class="docutils literal"><span class="pre">#</span> <span class="pre">CUSTOM</span> <span class="pre">ROUTES</span> <span class="pre">HERE</span></tt> comment so that the routes are defined like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># CUSTOM ROUTES HERE</span>

<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/{controller}/{action}&#39;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/{controller}/{action}/{id}&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This tells Routes that the root URL <tt class="docutils literal"><span class="pre">/</span></tt> should be mapped to the <tt class="docutils literal"><span class="pre">index</span></tt> action of <tt class="docutils literal"><span class="pre">HelloController</span></tt>. Otherwise, Routes should look for URLs in the form <tt class="docutils literal"><span class="pre">/controller/action/</span></tt>, and <tt class="docutils literal"><span class="pre">/controller/action/id</span></tt>. This, along with other details of Routes, is described in detail in Chapter 9.</p>
<p>Since you have made changes to a Python file used by the project, you would need to restart the server for the changes to be picked up. Because you started the server with the <tt class="docutils literal"><span class="pre">--reload</span></tt> option, though, this will happen automatically.</p>
<p>If you visit <a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> again, you will notice that the static welcome page is still there. This is because Pylons looks in the <tt class="docutils literal"><span class="pre">public</span></tt> directory for files to serve before attempting to match a controller. Because the <tt class="docutils literal"><span class="pre">public/index.html</span></tt> file still exists, Pylons serves that file.</p>
<p id="index-345">If you delete the <tt class="docutils literal"><span class="pre">public/index.html</span></tt> file, you should see the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">index()</span> <span class="pre">action!</span></tt> message you were expecting.</p>
</div>
<div class="section" id="understanding-how-http-works">
<h2>Understanding How HTTP Works<a class="headerlink" href="#understanding-how-http-works" title="Permalink to this headline">¶</a></h2>
<p>At this point it is worth taking a step back from Pylons to understand what is actually going on to display the <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">index()</span> <span class="pre">action!</span></tt> message.</p>
<p id="index-346">At its heart, web development is all about the Hypertext Transfer Protocol (HTTP). Any web page you visit that starts with <tt class="docutils literal"><span class="pre">http://</span></tt> is using HTTP to communicate between the browser and the server. Other protocols are used on the Internet too, such as the File Transfer Protocol (FTP), but for creating data-driven web sites with Pylons, HTTP is the only one you need to understand.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last" id="index-347">If you’re new to web development, it is important not to get confused between HTTP and HTML. HTTP is the protocol with which the browser communicates with a server, whereas HTML is a markup language used to create web pages.</p>
</div>
<p id="index-348">To understand exactly what is going on when you create a web page, it is useful to be able to see the HTTP information being sent back and forth between a web browser and a Pylons application. One good tool for doing this is the LiveHTTPHeaders extension for the Firefox web browser, which you can download from <a class="reference external" href="http://livehttpheaders.mozdev.org/">http://livehttpheaders.mozdev.org/</a>. Once you have installed it, you can select View -&gt; Sidebar -&gt; LiveHTTPHeaders from the menu to load the extension in the sidebar, and it will display all the HTTP information sent and received on each request.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p id="index-349">You can download the Firefox web browser from <a class="reference external" href="http://mozilla.com/products/firefox">http://mozilla.com/products/firefox</a>. It will run on the Windows, Mac OS X, Linux, and BSD platforms. It is particularly useful for web development because of the extensions available that give you fuller access to the processes going on within the web browser.</p>
<p>Another particularly useful extension is the Web Developer toolbar available from <a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/60">https://addons.mozilla.org/en-US/firefox/addon/60</a>, which offers facilities for managing cookies and style sheets as well as for outlining block-level elements and tables.</p>
<p class="last">Firefox also has powerful extensions such as Firebug, which in addition to its JavaScript and DOM manipulation facilities allows you to analyze page load times. I will discuss Firebug in Chapter 15 when I cover Ajax.</p>
</div>
<p id="index-350">When you request a page, the browser sends an HTTP request to the server. When the server receives that request, it will calculate an HTTP response. Depending on the request, it may retrieve information from a database or read a file from the filesystem to prepare the response.</p>
<p id="index-351">HTTP supports different types of requests. You are probably already familiar with the GET method used to retrieve information from a URL and the POST method used primarily to send form data, but there are other less well-known methods such as HEAD, OPTIONS, PUT, DELETE, TRACE, and CONNECT.</p>
<p>Figure 3-2 shows a simple HTTP GET request where you can see the HTTP information sent when visiting <a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a>.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0302.png"><img alt="Figure 3-2. An HTTP request in LiveHTTPHeaders" src="_images/9349f0302.png" /></a>
<p class="caption">Figure 3-2. An HTTP request in LiveHTTPHeaders</p>
</div>
<p id="index-352">Figure 3-3 shows the response returned.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0303.png"><img alt="Figure 3-3. An HTTP response in LiveHTTPHeaders" src="_images/9349f0303.png" /></a>
<p class="caption">Figure 3-3. An HTTP response in LiveHTTPHeaders</p>
</div>
<p id="index-353">As you can see, the browser sends quite a lot of information to the server. The application then processes this information and performs any necessary operations before returning a status and any HTTP headers it wants to send back. Of particular note is the <tt class="docutils literal"><span class="pre">Content-type</span></tt> header that tells the browser what sort of content is going to be sent (in this case <tt class="docutils literal"><span class="pre">text/html</span></tt>). Finally, the application returns the content that will be displayed by the browser (in this case the HTML that makes up the page). The server may add extra HTTP headers or perform other modifications before the response is returned.</p>
<p id="index-354">In this example, the HTTP status code is 200, which means everything went fine and no error occurred. The application and server can use many other status codes to tell the browser what happened while processing the request. Table 3-1 describes some of the most commonly used codes.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Status Code</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>200 OK</td>
<td>The request has succeeded.</td>
</tr>
<tr><td>401 Unauthorized</td>
<td>The request requires user authentication.</td>
</tr>
<tr><td>403 Forbidden</td>
<td>The server won’t let the user access what was requested, perhaps because the user doesn’t have the appropriate permissions.</td>
</tr>
<tr><td>404 Not Found</td>
<td>The server has not found anything matching the request URI.</td>
</tr>
<tr><td>500 Internal Server Error</td>
<td>The server encountered an unexpected condition that prevented it from fulfilling the request.</td>
</tr>
</tbody>
</table>
<p>Table 3-1. Commonly Used HTTP Status Codes</p>
<p id="index-355">For the vast majority of web development situations, the areas of the protocol I have discussed are all you need to know, but if you are interested in the details of HTTP, you can find the full specification at <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616.txt">http://www.w3.org/Protocols/rfc2616/rfc2616.txt</a>, including an explanation of all the request methods and status codes.</p>
</div>
<div class="section" id="exploring-the-environment">
<h2>Exploring the Environment<a class="headerlink" href="#exploring-the-environment" title="Permalink to this headline">¶</a></h2>
<p id="index-356">Information about the HTTP request as well other information is presented to your Pylons application through environment variables. These are a set of dynamic values set by the web server on each request. Exactly which variables are set depends on the web server, the browser, and the action the user is trying to perform. Once Pylons receives these variables from the environment, they are passed to the Pylons <tt class="docutils literal"><span class="pre">request</span></tt> object for use in your controllers. You wouldn’t usually access environment variables directly, but it is useful to know where the Pylons <tt class="docutils literal"><span class="pre">request</span></tt> object gets its information from.</p>
<p>If you have ever written CGI scripts or used PHP, you will most likely be familiar with using environment variables already, in which case many of the variables mentioned in this section will be familiar. It is worth remembering, though, that Pylons controllers aren’t executed in the same way as CGI or PHP scripts, so consequently some of these variables have slightly different meanings in the Pylons context.</p>
<p id="index-357">The following variable is set for all requests and are not request specific:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">SERVER_NAME</span></tt></dt>
<dd>The server’s hostname, DNS alias, or IP address as it would appear in self-referencing URLs.</dd>
</dl>
<p>The following are specific to the request:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">SERVER_PORT</span></tt></dt>
<dd>This is the number of the port to which the request was sent.</dd>
<dt><tt class="docutils literal"><span class="pre">SERVER_PROTOCOL</span></tt></dt>
<dd>This is the name and revision of the protocol used in the request. Usually it is <tt class="docutils literal"><span class="pre">HTTP/1.1</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">REQUEST_METHOD</span></tt></dt>
<dd>This is the method with which the request was made, such as GET, HEAD, POST, and so on.</dd>
<dt><tt class="docutils literal"><span class="pre">REMOTE_HOST</span></tt></dt>
<dd>This is the hostname making the request (set only if the server has this information).</dd>
<dt><tt class="docutils literal"><span class="pre">REMOTE_ADDR</span></tt></dt>
<dd>This is the IP address of the remote host making the request.</dd>
<dt><tt class="docutils literal"><span class="pre">REMOTE_USER</span></tt></dt>
<dd>This is the username of an authenticated user but is set only if a user is signed in.</dd>
<dt><tt class="docutils literal"><span class="pre">AUTH_TYPE</span></tt></dt>
<dd>If the server supports user authentication, this is the authentication method used to validate the user.</dd>
<dt><tt class="docutils literal"><span class="pre">CONTENT_TYPE</span></tt></dt>
<dd>If the request was an HTTP POST or PUT, then there could be content sent by the client. This is the content type of the data.</dd>
<dt><tt class="docutils literal"><span class="pre">CONTENT_LENGTH</span></tt></dt>
<dd>If a <tt class="docutils literal"><span class="pre">CONTENT_TYPE</span></tt> is specified, this is the length of that content.</dd>
<dt><tt class="docutils literal"><span class="pre">QUERY_STRING</span></tt></dt>
<dd>This is the part of the URL after a <tt class="docutils literal"><span class="pre">?</span></tt>, such as <tt class="docutils literal"><span class="pre">foo1=bar1&amp;foo2=bar2</span></tt>.</dd>
</dl>
<dl class="docutils" id="index-358">
<dt><tt class="docutils literal"><span class="pre">SCRIPT_NAME</span></tt> and <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt></dt>
<dd>In a Pylons application, <tt class="docutils literal"><span class="pre">SCRIPT_NAME</span></tt> is the part of the URL before the URL the Pylons application would treat as its site root, and <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt> is the part of the URL after it. If you are serving the application, normally <tt class="docutils literal"><span class="pre">SCRIPT_NAME</span></tt> will be <tt class="docutils literal"><span class="pre">''</span></tt> and <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt> will be the part of the URL before the query string. If you were to mount the Pylons application at, say, <tt class="docutils literal"><span class="pre">/myapp</span></tt>, then <tt class="docutils literal"><span class="pre">SCRIPT_NAME</span></tt> would be <tt class="docutils literal"><span class="pre">/myapp</span></tt> and <tt class="docutils literal"><span class="pre">PATH_INFO</span></tt> would be the part of the URL after it and before the query string.</dd>
</dl>
<p id="index-359">In addition to these environment variables, any HTTP headers that are sent in the request and not dealt with by previous environment variables are also included after being prefixed with <tt class="docutils literal"><span class="pre">HTTP_</span></tt> and having any <tt class="docutils literal"><span class="pre">-</span></tt> characters replaced with <tt class="docutils literal"><span class="pre">_</span></tt> characters. Since these are set by the user’s browser, they warrant more suspicion than the previous environment variables. Here are some of the more familiar ones as examples:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">HTTP_HOST</span></tt></dt>
<dd>This is the hostname and domain name portion of the URL, such as www.pylonshq.com.</dd>
<dt><tt class="docutils literal"><span class="pre">HTTP_COOKIE</span></tt></dt>
<dd>This is the content of the client’s cookie(s).</dd>
<dt><tt class="docutils literal"><span class="pre">HTTP_USER_AGENT</span></tt></dt>
<dd>This is the user-agent string to identify the browser type and version.</dd>
</dl>
<p id="index-360">Although you would normally access these variables through the more convenient <tt class="docutils literal"><span class="pre">request</span></tt> object, Pylons is all about giving power to the developer, so you can still access environment variables directly in your controllers if you choose. They are available as the <tt class="docutils literal"><span class="pre">request.environ</span></tt> dictionary. You’ll see how to use the <tt class="docutils literal"><span class="pre">request</span></tt> object in a few moments.</p>
<p id="index-361">In addition to the CGI-style variables listed earlier, the server running your Pylons application also adds extra information to the environment called <em>WSGI variables</em>, which can sometimes be useful to know about for use in your Pylons application.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-362">WSGI stands for the Web Server Gateway Interface, and although you don’t need to know anything about it to develop Pylons applications, it is actually a very powerful API on which much of Pylons is based, so I’ll cover it in detail in Chapters 16 and 17.</p>
</div>
<p>Here are the WSGI variables you will also find in the Pylons <tt class="docutils literal"><span class="pre">request.environ</span></tt> dictionary:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">wsgi.version</span></tt></dt>
<dd>This is a tuple, <tt class="docutils literal"><span class="pre">(1,0)</span></tt>, representing WSGI version 1.0.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt></dt>
<dd>This is a string representing the “scheme” portion of the URL at which the application is being invoked. Normally, this will have the value <tt class="docutils literal"><span class="pre">http</span></tt> or <tt class="docutils literal"><span class="pre">https</span></tt>, as appropriate.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.input</span></tt></dt>
<dd>This is an input stream (a file-like object) from which the HTTP request body can be read for PUT and POST requests.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.errors</span></tt></dt>
<dd>This is a text mode output stream (a file-like object) to which error output can be written. Applications should use <tt class="docutils literal"><span class="pre">\n</span></tt> as a line ending and assume it will be converted to the correct line ending. For many servers, <tt class="docutils literal"><span class="pre">wsgi.errors</span></tt> will be the server’s main error log.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.multithread</span></tt></dt>
<dd>This evaluates to <tt class="docutils literal"><span class="pre">true</span></tt> if the application object can be simultaneously invoked by another thread in the same process; it evaluates to <tt class="docutils literal"><span class="pre">false</span></tt> otherwise. It typically takes the value <tt class="docutils literal"><span class="pre">0</span></tt> or <tt class="docutils literal"><span class="pre">1</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.multiprocess</span></tt></dt>
<dd>This evaluates to <tt class="docutils literal"><span class="pre">true</span></tt> if an equivalent application object can be simultaneously invoked by another process, and it evaluates to <tt class="docutils literal"><span class="pre">false</span></tt> otherwise. It typically takes the value <tt class="docutils literal"><span class="pre">0</span></tt> or <tt class="docutils literal"><span class="pre">1</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">wsgi.run_once</span></tt></dt>
<dd>This evaluates to <tt class="docutils literal"><span class="pre">true</span></tt> if the server or gateway expects that the application will be invoked only this one time during the life of its containing process. Normally, this will be <tt class="docutils literal"><span class="pre">true</span></tt> only if your Pylons application is being run from a CGI script.</dd>
</dl>
<p id="index-363">Once again, you will rarely need to access WSGI variables directly because the components in Pylons that add them also present a clean API for their use, but it is useful to know they are there.</p>
<p id="index-364">To see all the environment variables that Pylons sets up for you, add another action called <tt class="docutils literal"><span class="pre">environ()</span></tt> to the <tt class="docutils literal"><span class="pre">HelloController</span></tt> you created earlier so that it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Hello from the index() action!&#39;</span>

    <span class="k">def</span> <span class="nf">environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Environ&lt;/h1&gt;&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s"> &lt;br /&gt;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p id="index-365">If you visit <a class="reference external" href="http://127.0.0.1:5000/hello/environ">http://127.0.0.1:5000/hello/environ</a>, you will see all the keys and values displayed, including the WSGI variables and the traditional CGI-style environment variables.</p>
</div>
<div class="section" id="understanding-the-pylons-request-and-response">
<h2>Understanding the Pylons Request and Response<a class="headerlink" href="#understanding-the-pylons-request-and-response" title="Permalink to this headline">¶</a></h2>
<p>Now that you have learned about the fundamentals of HTTP and the environment, let’s return to learning about Pylons, specifically, the <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects.</p>
<p id="index-366">The <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects together represent all the information Pylons receives about the HTTP request and all the information Pylons is going to send in the response. Let’s start by looking at the <tt class="docutils literal"><span class="pre">request</span></tt> object.</p>
<div class="section" id="request">
<h3>Request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h3>
<p id="index-367">The Pylons <tt class="docutils literal"><span class="pre">request</span></tt> object is actually a subclass of the <tt class="docutils literal"><span class="pre">webob.Request</span></tt> class provided by the WebOb package, which was automatically installed as one of Pylons’ dependencies. A new instance of the class is created on each request based on the HTTP information Pylons receives via the environment. The object is available as the <tt class="docutils literal"><span class="pre">pylons.request</span></tt> object and is automatically imported at the top of any controllers you create with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">controller</span></tt> command.</p>
<p id="index-368">You can look at the API reference on the WebOb web site at <a class="reference external" href="http://pythonpaste.org/webob/">http://pythonpaste.org/webob/</a> for full details of the <tt class="docutils literal"><span class="pre">Webob.Request</span></tt> object’s API and on the Pylons web site at <a class="reference external" href="http://docs.pylonshq.com/modules/controllers_util/#pylons.controllers.util.Request">http://docs.pylonshq.com/modules/controllers_util/#pylons.controllers.util.Request</a> for details of the subclass, but there are a few methods and attributes that are particularly worth mentioning now:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">request.environ</span></tt></dt>
<dd>You’ve already seen this when I discussed the environment. It is a dictionary that contains CGI-style environment variables, WSGI variables, and request header information, but it is not normally used directly. Instead, other attributes of the <tt class="docutils literal"><span class="pre">request</span></tt> global are used to obtain Python representations of the information it contains.</dd>
<dt><tt class="docutils literal"><span class="pre">request.headers</span></tt></dt>
<dd>This is a dictionary representing all the HTTP request headers. The dictionary is case insensitive.</dd>
<dt><tt class="docutils literal"><span class="pre">request.method</span></tt></dt>
<dd>This is the HTTP method used to request the URL; typically, it is GET or POST but could be PUT, DELETE, or others.</dd>
<dt><tt class="docutils literal"><span class="pre">request.GET</span></tt></dt>
<dd>This is a dictionary-like object with all the variables in the query string.</dd>
<dt><tt class="docutils literal"><span class="pre">request.POST</span></tt></dt>
<dd>This is a dictionary-like object with all the variables in the request body. This has variables only if the request was a POST and it is a form submission.</dd>
<dt><tt class="docutils literal"><span class="pre">request.params</span></tt></dt>
<dd>This is a dictionary-like object with a combination of everything in <tt class="docutils literal"><span class="pre">request.GET</span></tt> and <tt class="docutils literal"><span class="pre">request.POST</span></tt>. You will generally use <tt class="docutils literal"><span class="pre">request.params</span></tt> rather than <tt class="docutils literal"><span class="pre">request.GET</span></tt> or <tt class="docutils literal"><span class="pre">request.POST</span></tt>, although they all share the same API. I’ll cover <tt class="docutils literal"><span class="pre">request.params</span></tt> more closely in a minute because it is the main object you will use to deal with form submissions.</dd>
<dt><tt class="docutils literal"><span class="pre">request.body</span></tt></dt>
<dd>This is a file-like object representing the body of a POST request.</dd>
<dt><tt class="docutils literal"><span class="pre">request.cookies</span></tt></dt>
<dd>This is a dictionary containing the cookies present.</dd>
<dt><tt class="docutils literal"><span class="pre">request.url</span></tt></dt>
<dd>This is the full request URL, with the query string, such as <a class="reference external" href="http://localhost/app-root/doc?article_id=10">http://localhost/app-root/doc?article_id=10</a>. There are also other attributes and methods for obtaining different parts of the URL and even for generating URLs relative to the current URL.</dd>
</dl>
<p id="index-369">The <tt class="docutils literal"><span class="pre">request</span></tt> object also has attributes for most of the common HTTP request headers, such as <tt class="docutils literal"><span class="pre">request.accept_language</span></tt>, <tt class="docutils literal"><span class="pre">request.content_length</span></tt>, and <tt class="docutils literal"><span class="pre">request.user_agent</span></tt>. These properties expose the parsed form of each header for whatever parsing makes sense. For instance, <tt class="docutils literal"><span class="pre">request.if_modified_since</span></tt> returns a <tt class="docutils literal"><span class="pre">datetime</span></tt> object (or <tt class="xref docutils literal"><span class="pre">None</span></tt> if the header was not provided).</p>
<p id="index-370">Although the <tt class="docutils literal"><span class="pre">request</span></tt> object has plenty of useful attributes and methods, the one you are likely to use the most is <tt class="docutils literal"><span class="pre">request.params</span></tt>. This contains a <tt class="docutils literal"><span class="pre">MultiDict</span></tt> object representing all the GET and POST parameters of the request. Of course, you can access the GET and POST parameters separately via the <tt class="docutils literal"><span class="pre">request.GET</span></tt> and <tt class="docutils literal"><span class="pre">request.POST</span></tt> attributes, but most of the time you are unlikely to be trying to obtain GET and POST parameters at once, so you can just use <tt class="docutils literal"><span class="pre">request.params</span></tt> that combines the data from each.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <tt class="docutils literal"><span class="pre">MultiDict</span></tt> object is a dictionary-like object defined in the WebOb package that allows multiple values with the same key.</p>
</div>
<p>The <tt class="docutils literal"><span class="pre">request.params</span></tt> object can be treated in a number of ways. Imagine you’ve visited the URL <a class="reference external" href="http://localhost:5000/hello/index?a=1&amp;a=2">http://localhost:5000/hello/index?a=1&amp;a=2</a>; you could then use the <tt class="docutils literal"><span class="pre">request.params</span></tt> object in the following ways:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span>
<span class="go">MultiDict([(&#39;a&#39;, &#39;1&#39;), (&#39;a&#39;, &#39;2&#39;)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span>
<span class="go">&#39;1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;Not present&#39;</span><span class="p">)</span>
<span class="go">&#39;1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;Not present&#39;</span><span class="p">)</span>
<span class="go">&#39;Not present&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="go">[&#39;1&#39;,&#39;2&#39;]</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">If you are used to programming with Python’s <tt class="docutils literal"><span class="pre">cgi</span></tt> module, the way <tt class="docutils literal"><span class="pre">request.params</span></tt> works might surprise you because if the request has two parameters with the same name, as is the case with our example variable <tt class="docutils literal"><span class="pre">a</span></tt>, using <tt class="docutils literal"><span class="pre">request.params['a']</span></tt> and <tt class="docutils literal"><span class="pre">request.get('a')</span></tt> returns only the first value rather than returning a list. Also, the methods described return the actual value, not an object whose <tt class="docutils literal"><span class="pre">.value</span></tt> attribute contains the value of the parameter.</p>
</div>
<p id="index-371">There is also one other method, <tt class="docutils literal"><span class="pre">request.params.getone()</span></tt>, which returns just one value for the parameter it is getting. In this case, calling <tt class="docutils literal"><span class="pre">request.params.getone('a')</span></tt> raises an error because there is more than one value for <tt class="docutils literal"><span class="pre">a</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getone</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">    raise KeyError(&#39;Multiple values match %r: %r&#39; % (key, v))</span>
<span class="go">KeyError: &quot;Multiple values match &#39;a&#39;: [&#39;1&#39;, &#39;2&#39;]&quot;</span>
</pre></div>
</div>
<p id="index-372">To avoid problems obtaining just one value for a parameter when you expected many or obtaining many when you expected just one, you are encouraged to use the <tt class="docutils literal"><span class="pre">request.params.getone()</span></tt> and <tt class="docutils literal"><span class="pre">request.params.getall()</span></tt> methods in your own code rather than the dictionary-like interface.</p>
</div>
<div class="section" id="response">
<h3>Response<a class="headerlink" href="#response" title="Permalink to this headline">¶</a></h3>
<p id="index-373">Now that you’ve looked in detail at the <tt class="docutils literal"><span class="pre">request</span></tt> object, you can turn your attention to the <tt class="docutils literal"><span class="pre">response</span></tt> object. You have actually been implicitly using the <tt class="docutils literal"><span class="pre">response</span></tt> object already if you’ve been following the examples in this chapter. Any time you return a string from a controller action, Pylons automatically writes it to the <tt class="docutils literal"><span class="pre">response</span></tt> object for you. Pylons then uses the <tt class="docutils literal"><span class="pre">response</span></tt> object to generate the HTTP information it returns to the browser, so any changes you make to the <tt class="docutils literal"><span class="pre">response</span></tt> object affect the HTTP response returned. Let’s look at the <tt class="docutils literal"><span class="pre">response</span></tt> object in more detail.</p>
<p id="index-374">The <tt class="docutils literal"><span class="pre">response</span></tt> object is also a subclass of <tt class="docutils literal"><span class="pre">webob.Response</span></tt>, and once again you can find full details on the WebOb web site and the Pylons documentation web site at the same URLs as mentioned for the <tt class="docutils literal"><span class="pre">request</span></tt> object, but there are some features worth drawing your attention to here.</p>
<p id="index-375">The <tt class="docutils literal"><span class="pre">response</span></tt> object has three fundamental parts:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">response.status</span></tt></dt>
<dd>This is the response code plus message, like <tt class="docutils literal"><span class="pre">'200</span> <span class="pre">OK'</span></tt>. To set the code without the reason, use <tt class="docutils literal"><span class="pre">response.status_int</span> <span class="pre">=</span> <span class="pre">200</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">response.headerlist</span></tt></dt>
<dd>This is a list of all the headers, like <tt class="docutils literal"><span class="pre">[('Content-Type',</span> <span class="pre">'text/html')]</span></tt>. There’s a case-insensitive dictionary-like object in <tt class="docutils literal"><span class="pre">response.headers</span></tt> that also allows you to access these headers as well as add your own.</dd>
<dt><tt class="docutils literal"><span class="pre">response.app_iter</span></tt></dt>
<dd>This is an iterable (such as a list or generator) that will produce the content of the response. You rarely need to access this in a Pylons application, though, because Pylons automatically uses this to produce the content of the response for you.</dd>
</dl>
<p>Everything else derives from this underlying state. Here are the highlights:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">response.content_type</span></tt></dt>
<dd>This is the content type not including the <tt class="docutils literal"><span class="pre">charset</span></tt> parameter.</dd>
<dt><tt class="docutils literal"><span class="pre">response.set_cookie(key,</span> <span class="pre">value,</span> <span class="pre">max_age=None,</span> <span class="pre">path='/',</span> <span class="pre">domain=None,</span> <span class="pre">secure=None,</span> <span class="pre">httponly=False,</span> <span class="pre">version=None,</span> <span class="pre">comment=None)</span></tt></dt>
<dd>This sets a cookie. The keyword arguments control the various cookie parameters. The <tt class="docutils literal"><span class="pre">max_age</span></tt> argument is the length for the cookie to live in seconds (you can also use a <tt class="docutils literal"><span class="pre">datetime.timedelta</span></tt> object). The <tt class="docutils literal"><span class="pre">Expires</span></tt> key will also be set based on the value of <tt class="docutils literal"><span class="pre">max_age</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">response.delete_cookie(key,</span> <span class="pre">path='/',</span> <span class="pre">domain=None)</span></tt></dt>
<dd>This deletes a cookie from the client. This sets <tt class="docutils literal"><span class="pre">max_age</span></tt> to <tt class="docutils literal"><span class="pre">0</span></tt> and the cookie value to <tt class="docutils literal"><span class="pre">''</span></tt>.</dd>
</dl>
<p>Looking at the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> example from earlier in the chapter, you might have noticed that although the <tt class="docutils literal"><span class="pre">Content-type</span></tt> header sent to the browser was <tt class="docutils literal"><span class="pre">text/html</span></tt>, the message you returned was actually plain text, so the <tt class="docutils literal"><span class="pre">Content-type</span></tt> header should have been set to <tt class="docutils literal"><span class="pre">text/plain</span></tt>. Now that you have learned about the <tt class="docutils literal"><span class="pre">response</span></tt> object, you can correct this. Update the <tt class="docutils literal"><span class="pre">index()</span></tt> action of the hello controller so that it uses this response:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
    <span class="k">return</span> <span class="s">&#39;Hello from the index() action!&#39;</span>
</pre></div>
</div>
<p id="index-376">The server will reload when you save the change, and you can test the example again by visiting <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a>. This time, the browser treats the message as plain text instead of HTML. If you are using the Firefox browser, you may notice it uses a different font to display the message this time.</p>
</div>
</div>
<div class="section" id="understanding-pylons-globals">
<h2>Understanding Pylons Globals<a class="headerlink" href="#understanding-pylons-globals" title="Permalink to this headline">¶</a></h2>
<p id="index-377">The <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects you learned about in the previous section are referred to as Pylons <em>globals</em> because Pylons takes great care behind the scenes to make sure they can be used throughout your application including in your project’s controllers and its templates. In this section, I’ll cover all the other Pylons globals you can use in your application. Let’s start by looking at the objects made available by default in your controllers.</p>
<p>If you look at the <tt class="docutils literal"><span class="pre">controllers/hello.py</span></tt> file in the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> project I’ve been using as an example, you will see the following imports at the top:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect_to</span>
</pre></div>
</div>
<p>These lines are for importing the core Pylons globals, but in addition to these globals, there are also some other imports Pylons developers can add to their controllers to import optional Pylons globals:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">helloworld.lib.helpers</span> <span class="kn">as</span> <span class="nn">h</span>
<span class="kn">from</span> <span class="nn">helloworld.lib</span> <span class="kn">import</span> <span class="n">app_globals</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span>
</pre></div>
</div>
<p>You’ve already learned about the <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> globals, and I’ll cover <tt class="docutils literal"><span class="pre">h</span></tt>, <tt class="docutils literal"><span class="pre">app_globals</span></tt>, and the template context object <tt class="docutils literal"><span class="pre">c</span></tt> in detail in the following sections, so let’s just concentrate on <tt class="docutils literal"><span class="pre">session</span></tt>, <tt class="docutils literal"><span class="pre">abort</span></tt>, <tt class="docutils literal"><span class="pre">redirect_to</span></tt>, and <tt class="docutils literal"><span class="pre">config</span></tt> for the time being:</p>
<dl class="docutils" id="index-378">
<dt><tt class="docutils literal"><span class="pre">abort(status_code=None,</span> <span class="pre">detail=&quot;&quot;,</span> <span class="pre">headers=None,</span> <span class="pre">comment=None)</span></tt></dt>
<dd><p class="first">Occasionally you might want to immediately stop execution of the request and return a response bypassing the normal flow of execution of your application. You can do this with the <tt class="docutils literal"><span class="pre">abort()</span></tt> function, which is used like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_USER&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">401</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="s">&quot;Hello </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">username</span>
</pre></div>
</div>
<p>In this example, if no <tt class="docutils literal"><span class="pre">REMOTE_USER</span></tt> environment variable is set, it means that no user has signed in, so the request is immediately aborted and returns a 401 status code (the correct HTTP status code for when a user has not been authenticated and is therefore not authorized to see a particular resource).</p>
<p>The function also allows you to add some text to form part of the status as well as any extra headers that should be set. If you use a 300 status code, the <tt class="docutils literal"><span class="pre">detail</span></tt> option should be the location to redirect to, but you would be better using the <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> function in such circumstances.</p>
<p class="last">Internally, the <tt class="docutils literal"><span class="pre">abort()</span></tt> function uses WebOb HTTPExceptions, which you’ll learn about in Chapter 17.</p>
</dd>
</dl>
<dl class="docutils" id="index-379">
<dt><tt class="docutils literal"><span class="pre">config</span></tt></dt>
<dd>This contains configuration information about the running application. It is described at <a class="reference external" href="http://docs.pylonshq.com/modules/configuration/">http://docs.pylonshq.com/modules/configuration/</a>.</dd>
</dl>
<dl class="docutils" id="index-380">
<dt><tt class="docutils literal"><span class="pre">redirect_to(*args,</span> <span class="pre">**kwargs)</span></tt></dt>
<dd><p class="first">This function takes the same arguments as the <tt class="docutils literal"><span class="pre">url_for()</span></tt> function you will learn about in the next section. It allows you to specify a URL to redirect to by stating the routing variables that you want the URL to produce once it is called.</p>
<p>It is also possible to specify the HTTP status code you want to use with the <tt class="docutils literal"><span class="pre">_code</span></tt> argument.</p>
<p>For example:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;other_action&#39;</span><span class="p">,</span> <span class="n">_code</span><span class="o">=</span><span class="mf">303</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<dl class="docutils" id="index-381">
<dt><tt class="docutils literal"><span class="pre">session</span></tt></dt>
<dd>This is a proxy to the Beaker session object that can be used as a session store with various back ends. By default, the session information is stored in your project’s <tt class="docutils literal"><span class="pre">data</span></tt> directory, and cookies are used to keep track of the sessions. You’ll learn how to use sessions in Chapter 8 when you implement a flash message system.</dd>
</dl>
<p>In Chapter 11, you will also learn about four more Pylons globals named <tt class="docutils literal"><span class="pre">translator</span></tt>, <tt class="docutils literal"><span class="pre">ungettext()</span></tt>, <tt class="docutils literal"><span class="pre">_()</span></tt>, and <tt class="docutils literal"><span class="pre">N_()</span></tt>, but these are too advanced for now.</p>
<div class="section" id="helpers">
<h3>Helpers<a class="headerlink" href="#helpers" title="Permalink to this headline">¶</a></h3>
<p id="index-382">Helper functions (or <em>helpers</em> as they are known) are a concept borrowed from Ruby on Rails and are simply useful functions that you will find yourself using over and over again to perform common tasks such as generating form fields or creating links. Helper functions are all kept in the <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> module in your project directory structure, but you must manually import them into your controllers if you want to use them. Since helpers are used frequently, it is common to import them using the shortened module name <tt class="docutils literal"><span class="pre">h</span></tt> rather than the full name <tt class="docutils literal"><span class="pre">helpers</span></tt> to save on typing:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">helloworld.lib.helpers</span> <span class="kn">as</span> <span class="nn">h</span>
</pre></div>
</div>
<p id="index-383">One of the most useful helpers is <tt class="docutils literal"><span class="pre">h.url_for()</span></tt>, which is a function that comes from the Routes package to help you generate URLs. You’ve already seen how the Routes system maps a URL to a particular controller action. Well, the <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> helper does the reverse, mapping a controller and action to a URL. For example, to generate a URL for the <tt class="docutils literal"><span class="pre">environ</span></tt> action of the <tt class="docutils literal"><span class="pre">hello</span></tt> controller, you would use the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;environ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In Pylons it is generally considered bad practice to ever write a URL manually in your code because at some point in the future you might want to change your URL structure, or your Pylons application might be mounted at a different URL. By using <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> to generate your URLs, you avoid these problems since the correct URL is always generated automatically.</p>
<p id="index-384">The Routes system is actually extremely powerful, and you will see some of the details of the way it works in Chapter 9. One aspect worth mentioning now is that you can also specify extra variables in your route maps. For example, if you wanted URLs in the format <tt class="docutils literal"><span class="pre">/calendar/view/2007/06/15</span></tt>, you might set up a map that treats <tt class="docutils literal"><span class="pre">calendar</span></tt> as the controller and <tt class="docutils literal"><span class="pre">view</span></tt> as the action and then assigns <tt class="docutils literal"><span class="pre">2007</span></tt> to a variable <tt class="docutils literal"><span class="pre">year</span></tt>, <tt class="docutils literal"><span class="pre">06</span></tt> to a variable <tt class="docutils literal"><span class="pre">month</span></tt>, and <tt class="docutils literal"><span class="pre">15</span></tt> to a variable called <tt class="docutils literal"><span class="pre">day</span></tt>. When Pylons called your controller action, it would pass in <tt class="docutils literal"><span class="pre">year</span></tt>, <tt class="docutils literal"><span class="pre">month</span></tt>, and <tt class="docutils literal"><span class="pre">day</span></tt> as the parameters, so your action would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;This is the page for </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-385">In this way, the URL itself can contain important information about what the page should display, and this both saves you having to pass such variables around your application as hidden fields and means your URL structure much better matches what is actually going on in your application.</p>
<p id="index-386">You can use many other useful helpers to make your programming easier, but one of the great things about Pylons is that you can easily add your own too. Adding a new helper to the <tt class="docutils literal"><span class="pre">h</span></tt> object is as simple as importing a new function into your project’s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> module or defining a new object in it. As an example, let’s refactor the code you wrote earlier to print the environment into a useful helper. At the end of your project’s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file, add the following function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">format_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>Then after importing the helpers as <tt class="docutils literal"><span class="pre">h</span></tt>, you can update your action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">format_environ</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">In this case, the helper function needed access to the environment that formed part of the request, so if you are a keen object-oriented programmer and had wanted to refactor the environment formatting code, you might have been tempted to add a private method to the controller rather than create a helper function that needs the request information passed in. Generally speaking, it is a lot better to add useful code that you intend to use a lot as a simple helper object than to add methods to controller classes because then they can easily be accessed throughout your Pylons application rather than just in controller actions.</p>
</div>
<p id="index-387">You’ll see more of the built-in Pylons helpers when I cover form handling in Chapter 6.</p>
</div>
<div class="section" id="context-object">
<h3>Context Object<a class="headerlink" href="#context-object" title="Permalink to this headline">¶</a></h3>
<p id="index-388">When you develop a real Pylons application, you will quickly find you need to pass request-specific information to different parts of your code. For example, you might need to set some variables to be used in a template or in a form validator.</p>
<p>Because Pylons is designed to work in a multithreaded environment, it is important that this information is passed around your application in a thread-safe way so that variables associated with one request don’t get confused with variables from any other requests that are being executed at the same time.</p>
<p>Pylons provides the context object <tt class="docutils literal"><span class="pre">tmpl_context</span></tt> for precisely this purpose, and again, since it is used so frequently, it is imported by default into your controllers as the <tt class="docutils literal"><span class="pre">c</span></tt> object. The <tt class="docutils literal"><span class="pre">c</span></tt> object is a <tt class="docutils literal"><span class="pre">StackedObjectProxy</span></tt> that always returns the correct data for the current request.</p>
<p id="index-389">You can assign attributes to the <tt class="docutils literal"><span class="pre">c</span></tt> object like this, and they will be available throughout the application:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">my_data</span> <span class="o">=</span> <span class="s">&#39;Important data&#39;</span>
</pre></div>
</div>
<p>You can choose any attribute name you want to assign variables to as long as they don’t start with the <tt class="docutils literal"><span class="pre">_</span></tt> character and are a valid Python name. They will then be available throughout your templates and application code and will always contain the correct data for the thread that is handling a particular request.</p>
<p id="index-390">As was mentioned in the discussion about helpers, the Routes system Pylons uses allows you to use parts of the URL as variables in your application. Since you frequently need to access these variables in templates and other areas of your code, Pylons automatically sets up the <tt class="docutils literal"><span class="pre">c</span></tt> object to have any of the Routes variables that your action specified attached to it. You could therefore modify the helpers example from earlier to look like this, and it would still work in the same way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;This is the page for </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-391">There is one more important aspect to learn about the <tt class="docutils literal"><span class="pre">c</span></tt> variable that you might not expect at first. If you access an attribute that doesn’t exist, the value returned will be the empty string <tt class="docutils literal"><span class="pre">''</span></tt> rather than an <tt class="docutils literal"><span class="pre">AttributeError</span></tt> being raised as you might expect. This enables you to write code such as this without needing to test each part of the statement to check that the attribute exists:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">some_value</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">some_other_value</span> <span class="ow">or</span> <span class="s">&quot;Not specified&quot;</span>
</pre></div>
</div>
<p>This code will set <tt class="docutils literal"><span class="pre">data</span></tt> to be <tt class="docutils literal"><span class="pre">c.some_value</span></tt> if it exists and otherwise <tt class="docutils literal"><span class="pre">c.some_other_value</span></tt> if that exists; if neither exist, the value will be set to <tt class="docutils literal"><span class="pre">&quot;Not</span> <span class="pre">specified&quot;</span></tt>.</p>
<p id="index-392">This style of code can be useful occasionally, but if you are not used to writing code like this, I strongly recommend you stick to explicitly testing values of attributes you are not sure about to avoid the risk of errors. You can do this with the Python functions <tt class="docutils literal"><span class="pre">hasattr()</span></tt> and <tt class="docutils literal"><span class="pre">getattr()</span></tt>, which are used like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">foo</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
<span class="n">y</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-393">To use the strict version of the <tt class="docutils literal"><span class="pre">c</span></tt> global, edit your project’s <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file, and add the following line just before the lines to customize your templating options:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.strict_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c"># Customize templating options via this variable</span>
</pre></div>
</div>
<p>With the <tt class="docutils literal"><span class="pre">strict_c</span></tt> option enabled, <tt class="docutils literal"><span class="pre">c</span></tt> will raise an <tt class="docutils literal"><span class="pre">AttributeError</span></tt> as you would expect. It is strongly recommended you set the <tt class="docutils literal"><span class="pre">strict_c</span></tt> option if you are a Pylons beginner.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-394">If you come across an error you can’t quite understand when performing some operation on an attribute of <tt class="docutils literal"><span class="pre">c</span></tt>, it is possible that you have forgotten to specify the attribute and that the empty string is being returned instead. Trying to perform an operation on the string when you expected it to be a different object may be what is causing the error.</p>
</div>
</div>
<div class="section" id="app-globals-object">
<h3>App Globals Object<a class="headerlink" href="#app-globals-object" title="Permalink to this headline">¶</a></h3>
<p id="index-395">Sometimes you might want information to be available to all controllers and not be reset on each request. For example, you might want to set up a database connection pool when the application is loaded rather than creating a connection on each request. You can achieve this with the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In previous versions of Pylons, the <tt class="docutils literal"><span class="pre">app_globals</span></tt> global was simply named <tt class="docutils literal"><span class="pre">g</span></tt>. New Pylons applications should use the full name <tt class="docutils literal"><span class="pre">app_globals</span></tt> instead.</p>
</div>
<p>The <tt class="docutils literal"><span class="pre">app_globals</span></tt> variable is actually just an instance of your <tt class="docutils literal"><span class="pre">Globals</span></tt> class in your application’s <tt class="docutils literal"><span class="pre">lib/app_globals.py</span></tt> file. It gets set up in the <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file of your project.</p>
<p>Any attributes set to <tt class="docutils literal"><span class="pre">self</span></tt> in the <tt class="docutils literal"><span class="pre">__init__()</span></tt> method of the <tt class="docutils literal"><span class="pre">Globals</span></tt> class will be available as attributes of <tt class="docutils literal"><span class="pre">app_globals</span></tt> throughout your Pylons application. Any attributes set on <tt class="docutils literal"><span class="pre">app_globals</span></tt> during one request will remain changed for all subsequent requests, so you have to be very careful not to accidentally change any global data by mistake.</p>
<p>Here is a simple counter example that demonstrates how the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object works. First modify your <tt class="docutils literal"><span class="pre">lib/app_globals.py</span> <span class="pre">Globals</span></tt> class so that the <tt class="docutils literal"><span class="pre">__init__.py</span></tt> method looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visits</span> <span class="o">=</span> <span class="mf">0</span>
</pre></div>
</div>
<p>You will now be able to access the <tt class="docutils literal"><span class="pre">visits</span></tt> attribute as <tt class="docutils literal"><span class="pre">app_globals.visits</span></tt> in your controllers. First import the global from Pylons:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">app_globals</span>
</pre></div>
</div>
<p>Next add a new action to the end of the <tt class="docutils literal"><span class="pre">HelloController</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">app_globals_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">app_globals</span><span class="o">.</span><span class="n">visits</span> <span class="o">+=</span> <span class="mf">1</span>
    <span class="k">return</span> <span class="s">&quot;You are visitor number </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">app_globals</span><span class="o">.</span><span class="n">visits</span>
</pre></div>
</div>
<p>If you restart the Paste HTTP server and visit <a class="reference external" href="http://localhost:5000/hello/app_globals_test">http://localhost:5000/hello/app_globals_test</a>, you should see the message <tt class="docutils literal"><span class="pre">You</span> <span class="pre">are</span> <span class="pre">visitor</span> <span class="pre">number</span> <span class="pre">1</span></tt>. If you visit the page again, the message will be changed to <tt class="docutils literal"><span class="pre">You</span> <span class="pre">are</span> <span class="pre">visitor</span> <span class="pre">number</span> <span class="pre">2</span></tt>. On each subsequent request, the counter will increase.</p>
<p>If you restart the server, you will see that the value of <tt class="docutils literal"><span class="pre">app_globals.visits</span></tt> is reset to 0 because a new instance of the <tt class="docutils literal"><span class="pre">helloworld.lib.app_globals.Globals</span></tt> class is created when the server starts.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-396">Because the <tt class="docutils literal"><span class="pre">app_globals</span></tt> object is persistent across requests, it can be modified by any thread. This means it is possible that a value attached to <tt class="docutils literal"><span class="pre">app_globals</span></tt> might be different at the start of a request than at the end if another thread has changed its value in between. This doesn’t matter in our example, but it is something to be aware of if you aren’t used to working in multithreaded environments.</p>
</div>
</div>
</div>
<div class="section" id="configuring-pylons">
<h2>Configuring Pylons<a class="headerlink" href="#configuring-pylons" title="Permalink to this headline">¶</a></h2>
<p id="index-397">You configure Pylons applications in two places. The first is the configuration file you saw earlier in the chapter when you looked at the <tt class="docutils literal"><span class="pre">HelloWorld</span></tt> project’s <tt class="docutils literal"><span class="pre">development.ini</span></tt> file. The configuration file is where any per-instance configuration options should be put. For example, the port and hostname might vary between a production deployment of your Pylons application and a development installation, so these are options that are set in the configuration file.</p>
<p>Any configuration that should affect the whole application and should not be customizable on a per-instance basis is set in Python code in one of the files in your project’s <tt class="docutils literal"><span class="pre">config</span></tt> directory. These are the following:</p>
<dl class="docutils" id="index-398">
<dt><tt class="docutils literal"><span class="pre">middleware.py</span></tt></dt>
<dd>This is where the Pylons application is constructed and where you can change the Pylons middleware stack itself. Middleware is considered an advanced topic and is dealt with in Part 3 of the book.</dd>
</dl>
<dl class="docutils" id="index-399">
<dt><tt class="docutils literal"><span class="pre">routing.py</span></tt></dt>
<dd>This is where you define your application’s routes. You saw a simple example earlier in the chapter and will look at routing in much more detail in Chapter 9.</dd>
</dl>
<dl class="docutils" id="index-400">
<dt><tt class="docutils literal"><span class="pre">environment.py</span></tt></dt>
<dd>This is where you configure most of Pylons’ internal options, although you generally don’t need to because the defaults are very sensible. One time when you might need to set some options in this file is if you want to use a different templating language to the Pylons default, which is Mako. You’ll learn about this in Chapter 5.</dd>
</dl>
<p id="index-401">Once you have configured your application, whether in the configuration file or the <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file, you will want to be able to access that configuration in your Pylons application. All configuration is contained in the <tt class="docutils literal"><span class="pre">config</span></tt> global, which can be imported into a controller like this: <tt class="docutils literal"><span class="pre">from</span> <span class="pre">pylons</span> <span class="pre">import</span> <span class="pre">config</span></tt>. The <tt class="docutils literal"><span class="pre">config</span></tt> object has a number of attributes representing different aspects of Pylons configuration. These are described in detail at <a class="reference external" href="http://docs.pylonshq.com/modules/configuration/">http://docs.pylonshq.com/modules/configuration/</a>, but these are two that you are likely to use frequently:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">config.app_conf</span></tt></dt>
<dd>This is a dictionary of all the application options set in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> part of the config file being used including any custom options used by your application. For example, to access the location of the cache directory, you could use <tt class="docutils literal"><span class="pre">config.app_conf['cache_dir']</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">config.global_conf</span></tt></dt>
<dd>This is very similar to <tt class="docutils literal"><span class="pre">config.app_conf</span></tt>, but rather than providing a dictionary interface to the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section of the config file, this attribute represents the global options specified in the <tt class="docutils literal"><span class="pre">[DEFAULT]</span></tt> section.</dd>
</dl>
<p id="index-402">There are also attributes for the package name, default character set, paths to look for templates, and more. See the documentation for full details.</p>
</div>
<div class="section" id="controller-imports">
<h2>Controller Imports<a class="headerlink" href="#controller-imports" title="Permalink to this headline">¶</a></h2>
<p>In addition to the Pylons globals I’ve described, there are a number of other useful objects that Pylons provides for you to use in your controllers. Each of these objects is described in detail in the Pylons module documentation, which you can browse online at <a class="reference external" href="http://docs.pylonshq.com/modules/">http://docs.pylonshq.com/modules/</a>, but they are worth mentioning here so that you are aware of them.</p>
<p id="index-403">First let’s look at the available decorators:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.jsonify(func)</span></tt></dt>
<dd>Given a function that will return content, this decorator will turn the result into JSON, with a content type of <tt class="docutils literal"><span class="pre">text/javascript</span></tt>, and output it.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.validate(...)</span></tt></dt>
<dd>This validates input either for a FormEncode schema or for individual validators. This is discussed in detail in Chapter 6.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.secure.authenticate_form(func)</span></tt></dt>
<dd>This decorator uses an authorization token stored in the client’s session for prevention of certain cross-site request forgery (CSRF) attacks.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.secure.https(*redirect_args,</span> <span class="pre">**redirect_kwargs)</span></tt></dt>
<dd>This decorator redirects to the SSL version of a page if not currently using HTTPS.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.rest.dispatch_on(**method_map)</span></tt></dt>
<dd>This dispatches to alternate controller methods based on the HTTP method.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.rest.restrict(*methods)</span></tt></dt>
<dd>This restricts access to the function depending on the HTTP method. You’ll see it used in Chapter 8.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.decorators.cache.beaker_cache(...)</span></tt></dt>
<dd>This cache decorator utilizes Beaker. This caches the action or other function that returns a “pickleable” object as a result.</dd>
</dl>
<p id="index-404">Pylons also provides two different types of controllers:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">pylons.controllers.core.WSGIController</span></tt></dt>
<dd>This is the controller that your project’s <tt class="docutils literal"><span class="pre">BaseController</span></tt> is inherited from and is the only controller you will use in this book.</dd>
<dt><tt class="docutils literal"><span class="pre">pylons.controllers.xmlrpc.XMLRPCController</span></tt></dt>
<dd>This controller handles XML-RPC responses and complies with the XML-RPC specification as well as the XML-RPC Introspection specification. It is useful if you want to build XML-RPC web services in Pylons.</dd>
</dl>
<p>Finally, it is worth mentioning three more objects you are likely to use a lot in your controllers, but each of these has their own chapter and will be dealt with later in the book:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">render</span></tt></dt>
<dd>This is used for rendering templates and is discussed in Chapter 5.</dd>
<dt><tt class="docutils literal"><span class="pre">model</span></tt></dt>
<dd>This is used for the model component of your application and is discussed in Chapter 7.</dd>
<dt><tt class="docutils literal"><span class="pre">log</span></tt></dt>
<dd>This is used to output log messages.</dd>
</dl>
<p>In its simplest form, you can simply write <tt class="docutils literal"><span class="pre">log.error('Log</span> <span class="pre">this</span> <span class="pre">message')</span></tt> in a controller, and the message will be logged to the console of the Paste HTTP server. Logging is described in detail in Chapter 20.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This chapter covered quite a lot of ground, including using static files, understanding HTTP and the environment, using the <tt class="docutils literal"><span class="pre">request</span></tt> and <tt class="docutils literal"><span class="pre">response</span></tt> objects, and understanding the basics of Routes. In the next chapter, you’ll take a detailed look at how to track down problems when they occur and how to handle them so that the user is presented with an appropriate error message. After that, you’ll be ready to get properly stuck into Pylons development, so you’ll learn how to use templates before looking at how forms are handled.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 3: Exploring Pylons</a><ul>
<li><a class="reference external" href="#exploring-pylons-dependencies">Exploring Pylons’ Dependencies</a></li>
<li><a class="reference external" href="#creating-a-pylons-project">Creating a Pylons Project</a></li>
<li><a class="reference external" href="#serving-a-pylons-application">Serving a Pylons Application</a><ul>
<li><a class="reference external" href="#configuration-files">Configuration Files</a></li>
<li><a class="reference external" href="#the-paste-http-server">The Paste HTTP Server</a></li>
<li><a class="reference external" href="#static-files">Static Files</a></li>
<li><a class="reference external" href="#a-word-about-ip-addresses-hosts-and-security">A Word About IP Addresses, Hosts, and Security</a></li>
</ul>
</li>
<li><a class="reference external" href="#exploring-a-pylons-project-s-directory-structure">Exploring a Pylons Project’s Directory Structure</a></li>
<li><a class="reference external" href="#creating-a-controller-and-modifying-the-routes">Creating a Controller and Modifying the Routes</a></li>
<li><a class="reference external" href="#understanding-how-http-works">Understanding How HTTP Works</a></li>
<li><a class="reference external" href="#exploring-the-environment">Exploring the Environment</a></li>
<li><a class="reference external" href="#understanding-the-pylons-request-and-response">Understanding the Pylons Request and Response</a><ul>
<li><a class="reference external" href="#request">Request</a></li>
<li><a class="reference external" href="#response">Response</a></li>
</ul>
</li>
<li><a class="reference external" href="#understanding-pylons-globals">Understanding Pylons Globals</a><ul>
<li><a class="reference external" href="#helpers">Helpers</a></li>
<li><a class="reference external" href="#context-object">Context Object</a></li>
<li><a class="reference external" href="#app-globals-object">App Globals Object</a></li>
</ul>
</li>
<li><a class="reference external" href="#configuring-pylons">Configuring Pylons</a></li>
<li><a class="reference external" href="#controller-imports">Controller Imports</a></li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="installing-pylons.html"
                                  title="previous chapter">Chapter 2: Installing Pylons</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="tracking-down-problems-and-handling-errors.html"
                                  title="next chapter">Chapter 4: Tracking Down and Handling Problems</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/exploring-pylons.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tracking-down-problems-and-handling-errors.html" title="Chapter 4: Tracking Down and Handling Problems"
             >next</a> |</li>
        <li class="right" >
          <a href="installing-pylons.html" title="Chapter 2: Installing Pylons"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/exploring-pylons.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:42:03 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>