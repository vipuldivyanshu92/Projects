<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/starting-the-simplesite-tutorial.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:42:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 8: Starting the SimpleSite Tutorial &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 9: URLs, Routing and Dispatch" href="urls-routing-and-dispatch.html" />
    <link rel="prev" title="Chapter 7: Introducing the Model and SQLAlchemy" href="introducing-the-model-and-sqlalchemy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="urls-routing-and-dispatch.html" title="Chapter 9: URLs, Routing and Dispatch"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="introducing-the-model-and-sqlalchemy.html" title="Chapter 7: Introducing the Model and SQLAlchemy"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-8-starting-the-simplesite-tutorial">
<h1>Chapter 8: Starting the SimpleSite Tutorial<a class="headerlink" href="#chapter-8-starting-the-simplesite-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can download the source code for this chapter from <a class="reference external" href="http://www.apress.com/">http://www.apress.com</a>.</p>
</div>
<p id="index-1017">You’ve now learned about many of the most important components of an application. The previous chapters have been fairly detailed, so don’t worry if you haven’t understood everything you’ve read or if you’ve skipped over one or two sections. Once you have used Pylons a little more, you will appreciate having all the information on a particular topic in one place, even if it seems a lot to take in on the first reading.</p>
<p id="index-1018">In this chapter, I’ll recap many of the important points as I show how to create a simple web site from scratch so that you can see how all the components you’ve learned about in the preceding chapters fit together. The example will be created in a way that will also make it a really good basis for your own Pylons projects.</p>
<p>You’ll use SQLAlchemy to store the individual pages in the site in such a way that users can add, edit, or remove them so that the application behaves like a simple wiki. Each of the pages will also support comments and tags, so you can use some of the knowledge gained in the previous chapter to help you create the application. You’ll also use FormEncode and HTML Fill to handle the forms.</p>
<p>Later in the book you’ll return to SimpleSite and add authentication and authorization facilities, and you’ll add a navigation hierarchy so that pages can be grouped into sections at different URLs. You’ll implement some JavaScript to animate messages and use some Ajax to populate one of the form fields. The application will also have a navigation hierarchy so that you can see how to create navigation components such as breadcrumbs, tabs, and navigation menus using Mako.</p>
<p id="index-1019">Figure 8-1 shows what the finished application will look like after the SimpleSite tutorial chapters  (this chapter, Chapter 14, part of Chapter 15, and Chapter 19).</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0801.png"><img alt="Figure 8-1. The finished wiki with a customized front page" src="_images/9349f0801.png" /></a>
<p class="caption">Figure 8-1. The finished wiki with a customized front page</p>
</div>
<div class="section" id="getting-started-with-simplesite">
<h2>Getting Started with SimpleSite<a class="headerlink" href="#getting-started-with-simplesite" title="Permalink to this headline">¶</a></h2>
<p id="index-1020">The first thing you need to do is create a new Pylons project called <tt class="docutils literal"><span class="pre">SimpleSite</span></tt>. You’ll remember from Chapter 3 that the command to do this is as follows:</p>
<div class="highlight-python"><pre>$ paster create --template=pylons SimpleSite</pre>
</div>
<p>You’ll use Mako and SQLAlchemy in this chapter, so in particular note that you need to answer <tt class="xref docutils literal"><span class="pre">True</span></tt> to the SQLAlchemy question so that SQLAlchemy support is included for you:</p>
<div class="highlight-python"><pre>Selected and implied templates:
  Pylons#pylons  Pylons application template

Variables:
  egg:      SimpleSite
  package:  simplesite
  project:  SimpleSite
Enter template_engine (mako/genshi/jinja/etc: Template language) ['mako']:
Enter sqlalchemy (True/False: Include SQLAlchemy 0.4 configuration) [False]: True
Creating template pylons</pre>
</div>
<p>All these options are configurable later, but it is easier to have Pylons configure them for you when you create the project.</p>
<p id="index-1021">Once the application template has been created, start the server, and see what you have:</p>
<div class="highlight-python"><pre>$ cd SimpleSite
$ paster serve --reload development.ini</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Notice that the server is started with the <tt class="docutils literal"><span class="pre">--reload</span></tt> switch. You’ll remember that this means any changes you make to the code will cause the server to restart so that your changes are immediately available for you to test in the web browser.</p>
</div>
<p id="index-1022">If you visit <a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000</a>, you will see the standard Pylons introduction page served from the application’s <tt class="docutils literal"><span class="pre">public/index.html</span></tt> file as before.</p>
<p id="index-1023">Pylons looks for resources in the order applications are specified in the cascade object in <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>. You’ll learn more about the cascade object in Chapter 17, but it causes static files such as the introduction page to be served in preference to content generated by your Pylons controllers for the same URL. You will want the SimpleSite controllers to handle the site’s home page, so remove the welcome page HTML file:</p>
<div class="highlight-python"><pre>$ cd simplesite
$ rm public/index.html</pre>
</div>
<p>If you now refresh the page, the Pylons built-in error document support will kick in and display a 404 Not Found page to tell you that the URL requested could not be matched by Pylons.</p>
<p id="index-1024">You’ll now customize the controller so that it can display pages. Each of the pages is going to have its own ID, which the controller will obtain from the URL. Here are some example URLs that the controller will handle:</p>
<div class="highlight-python"><pre>/page/view/1
/page/view/2
... etc
/page/view/10</pre>
</div>
<p>You’ll also recall that Pylons comes with a routing system named Routes, which you saw in Chapter 3 and will learn about in detail in the next chapter. The default Routes setup analyzes the URL requested by the browser to find the controller, action, and ID. This means that to handle the URLs, you simply need a controller named <tt class="docutils literal"><span class="pre">page</span></tt> that has an action named <tt class="docutils literal"><span class="pre">view</span></tt> and that takes a parameter named <tt class="docutils literal"><span class="pre">id</span></tt>.</p>
<p id="index-1025">Let’s create the page controller. Once again, Pylons comes with a tool to help with this in the form of a plug-in to Paste. You create the controller like this (notice that the command doesn’t include the <tt class="docutils literal"><span class="pre">create</span></tt> part, which is used when creating a project template):</p>
<div class="highlight-python"><pre>$ paster controller page
Creating /Users/james/Desktop/SimpleSite/simplesite/controllers/page.py
Creating /Users/james/Desktop/SimpleSite/simplesite/tests/functional/test_page.py</pre>
</div>
<p>This creates two files—one for any tests you are going to add for this controller (see Chapter 12) and the other for the controller itself. The command would also add these files to Subversion automatically if your Pylons application were already being managed in a Subversion repository.</p>
<p id="index-1026">The <tt class="docutils literal"><span class="pre">controllers/page.py</span></tt> file that is added looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect_to</span>

<span class="kn">from</span> <span class="nn">simplesite.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>
<span class="c">#import simplesite.model as model</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PageController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Return a rendered template</span>
        <span class="c">#   return render(&#39;/template.mako&#39;)</span>
        <span class="c"># or, Return a response</span>
        <span class="k">return</span> <span class="s">&#39;Hello World&#39;</span>
</pre></div>
</div>
<p>This is a skeleton controller that you’ll customize to handle pages. The first few lines import some of the useful objects described in Chapter 3 so that they are ready for you to use. The controller itself has one action named <tt class="docutils literal"><span class="pre">index()</span></tt>, which simply returns a <tt class="docutils literal"><span class="pre">Hello</span> <span class="pre">World</span></tt> message.</p>
<p>Replace the <tt class="docutils literal"><span class="pre">index()</span></tt> action with a <tt class="docutils literal"><span class="pre">view()</span></tt> action that looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;Page goes here&quot;</span>
</pre></div>
</div>
<p>The Paste HTTP server should reload when you save the change (as long as you used the <tt class="docutils literal"><span class="pre">--reload</span></tt> option), so you can now visit the URL <a class="reference external" href="http://localhost:5000/page/view/1">http://localhost:5000/page/view/1</a>. You should see the message <tt class="docutils literal"><span class="pre">Page</span> <span class="pre">goes</span> <span class="pre">here</span></tt>.</p>
<p id="index-1027">The page isn’t very exciting so far and isn’t even HTML, so now I’ll cover how to create some templates to generate real HTML pages.</p>
</div>
<div class="section" id="exploring-the-template-structure">
<h2>Exploring the Template Structure<a class="headerlink" href="#exploring-the-template-structure" title="Permalink to this headline">¶</a></h2>
<p id="index-1028">Most web sites have the following features:</p>
<blockquote>
<ul class="simple">
<li>Header and footer regions</li>
<li>Sign-in and sign-out regions</li>
<li>Top-level navigation tabs</li>
<li>Second-level navigation tabs</li>
<li>A page heading</li>
<li>Breadcrumbs</li>
<li>Content</li>
<li>A head region for extra CSS and JavaScript</li>
</ul>
</blockquote>
<p>The SimpleSite application will need all these features too, so the template structure needs to be able to provide them.</p>
<p>You’ll remember from Chapter 5 that Pylons uses the Mako templating language by default, although as is the case with most aspects of Pylons, you are free to deviate from the default if you prefer. This is particularly useful if you are building a Pylons application to integrate with legacy code, but since you are creating a new application here, you are going to use Mako.</p>
<p id="index-1029">Because you are going to need a few templates that will all look similar, you can take advantage of Mako’s inheritance chain features you learned about in Chapter 5 and use a single base template for all the different pages. You’ll also need to create some derived templates and some templates containing the navigation components.</p>
<p>You’ll structure these templates as follows:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">templates/base</span></tt></dt>
<dd>All the base templates.</dd>
<dt><tt class="docutils literal"><span class="pre">templates/derived</span></tt></dt>
<dd>All the templates that are derived from any of the base templates. There is likely to be a subdirectory for every controller you create. Since Pylons has already created an <tt class="docutils literal"><span class="pre">error</span></tt> controller, you’ll create a subdirectory for it, and you’ll need a subdirectory for the <tt class="docutils literal"><span class="pre">page</span></tt> controller templates too.</dd>
<dt><tt class="docutils literal"><span class="pre">templates/derived/error</span></tt></dt>
<dd>Templates for the <tt class="docutils literal"><span class="pre">error</span></tt> controller to render error documents.</dd>
<dt><tt class="docutils literal"><span class="pre">templates/component</span></tt></dt>
<dd>Any components that are used in multiple templates.</dd>
</dl>
<p id="index-1030">This structure is useful because it keeps templates that serve different purposes in different directories. If you are following along by creating the application yourself, you should create these directories now.</p>
<p id="index-1031">Let’s start by creating the base template. Save the following template as <tt class="docutils literal"><span class="pre">templates/base/index.html</span></tt>:</p>
<div class="highlight-python"><pre>## -*- coding: utf-8 -*-

&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;${self.title()}&lt;/title&gt;
    ${self.head()}
&lt;/head&gt;
&lt;body&gt;
    ${self.header()}
    ${self.tabs()}
    ${self.menu()}
    ${self.heading()}
    ${self.breadcrumbs()}
    ${next.body()}
    ${self.footer()}
&lt;/body&gt;
&lt;/html&gt;

&lt;%def name="title()"&gt;SimpleSite&lt;/%def&gt;
&lt;%def name="head()"&gt;&lt;/%def&gt;
&lt;%def name="header()"&gt;&lt;a name="top"&gt;&lt;/a&gt;&lt;/%def&gt;
&lt;%def name="tabs()"&gt;&lt;/%def&gt;
&lt;%def name="menu()"&gt;&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;${c.heading or 'No Title'}&lt;/h1&gt;&lt;/%def&gt;
&lt;%def name="breadcrumbs()"&gt;&lt;/%def&gt;
&lt;%def name="footer()"&gt;&lt;p&gt;&lt;a href="#top"&gt;Top ^&lt;/a&gt;&lt;/p&gt;&lt;/%def&gt;</pre>
</div>
<p id="index-1032">This template should be fairly self-explanatory. It is a simple HTML document with eight defs defined. Each of the calls to <tt class="docutils literal"><span class="pre">${self.somedef()}</span></tt> will execute the def using either the definition in this base template or the definition in the template that inherits from it. The <tt class="docutils literal"><span class="pre">${next.body()}</span></tt> call will be replaced with the body of the template that inherits this one.</p>
<p>You’ll also see that the <tt class="docutils literal"><span class="pre">header()</span></tt> and <tt class="docutils literal"><span class="pre">footer()</span></tt> defs already contain some HTML, allowing the user to quickly click to the top of the page. The <tt class="docutils literal"><span class="pre">title()</span></tt> def contains some code that will set the title to SimpleSite, and the <tt class="docutils literal"><span class="pre">heading()</span></tt> def will obtain its content from the value of <tt class="docutils literal"><span class="pre">c.heading</span></tt> or will just use <tt class="docutils literal"><span class="pre">'No</span> <span class="pre">title'</span></tt> if no heading has been set.</p>
<p><tt class="docutils literal"><span class="pre">##</span> <span class="pre">-*-</span> <span class="pre">coding:</span> <span class="pre">utf-8</span> <span class="pre">-*-</span></tt> has been added at the top of the file so that Unicode characters can be used when the template is saved as UTF-8 (you’ll learn more about Unicode in Chapter 10).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you prefer using the <tt class="docutils literal"><span class="pre">strict_c</span></tt> option to ensure that accessing an attribute of the template context global raises an exception if that attribute doesn’t exist, you should change the content of the <tt class="docutils literal"><span class="pre">heading</span></tt> def to look like this:</p>
<div class="highlight-python"><pre>&lt;h1&gt;${hasattr(c, 'heading') and c.heading or 'No Title'}&lt;/h1&gt;</pre>
</div>
<p class="last">This ensures that the <tt class="docutils literal"><span class="pre">heading</span></tt> attribute exists before testing its value.</p>
</div>
<p id="index-1033">Now that the base template is in place, you can start creating the templates for the web site content. Create a new template in the <tt class="docutils literal"><span class="pre">templates/derived/page</span></tt> directory called <tt class="docutils literal"><span class="pre">view.html</span></tt>. This will be the template used by the <tt class="docutils literal"><span class="pre">page</span></tt> controller’s <tt class="docutils literal"><span class="pre">view</span></tt> action. Add the following content to it:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

${c.content}</pre>
</div>
<p>You’ll now need to update the <tt class="docutils literal"><span class="pre">view()</span></tt> action in the controller to use this template:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Greetings&#39;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="s">&#39;Sample Page&#39;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">&quot;This is page </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">id</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/view.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1034">Now when you visit <a class="reference external" href="http://localhost:5000/page/view/1">http://localhost:5000/page/view/1</a>, you should see the page shown in Figure 8-2.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0802.png"><img alt="Figure 8-2. A basic page being rendered from a template" src="_images/9349f0802.png" /></a>
<p class="caption">Figure 8-2. A basic page being rendered from a template</p>
</div>
</div>
<div class="section" id="using-sqlalchemy-in-pylons">
<h2>Using SQLAlchemy in Pylons<a class="headerlink" href="#using-sqlalchemy-in-pylons" title="Permalink to this headline">¶</a></h2>
<p id="index-1035">Now that you have the project’s templates and controller set up, you need to start thinking about the model. As you’ll recall from Chapter 1, Pylons is set up to use a Model View Controller architecture, and SQLAlchemy is what is most often used as the model. Chapter 7 explained SQLAlchemy in detail, but now you’ll see how to apply that theory to a real Pylons project. If you haven&#8217;t already done so you&#8217;ll need to install SQLAlchemy 0.5 which is the version used in this book. You can do so with this command:</p>
<div class="highlight-python"><pre>$ easy_install "SQLAlchemy&gt;=0.5,&lt;=0.5.99"</pre>
</div>
<p>Let’s begin by setting up the <em>engine</em>. Open your project’s <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file, and after <tt class="docutils literal"><span class="pre">from</span> <span class="pre">pylons</span> <span class="pre">import</span> <span class="pre">config</span></tt>, you’ll see the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
</pre></div>
</div>
<p id="index-1036">You learned about engines in Chapter 7 when you created one directly. Pylons uses the <tt class="docutils literal"><span class="pre">engine_from_config()</span></tt> function to create an engine from configuration options in your project’s config file instead. It looks for any options starting with <tt class="docutils literal"><span class="pre">sqlalchemy.</span></tt> in the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section of your <tt class="docutils literal"><span class="pre">development.ini</span></tt> config file and creates the engine based on these options. This means that all you need to do to configure SQLAlchemy is set the correct options in the config file.</p>
<div class="section" id="configuring-the-engine">
<h3>Configuring the Engine<a class="headerlink" href="#configuring-the-engine" title="Permalink to this headline">¶</a></h3>
<p id="index-1037">The main configuration option you need is <tt class="docutils literal"><span class="pre">sqlalchemy.url</span></tt>. This specifies the data source name (DSN) for your database and takes the format <tt class="docutils literal"><span class="pre">engine://username:password&#64;host:port/database?foo=bar</span></tt>, where <tt class="docutils literal"><span class="pre">foo=bar</span></tt> sets an engine-specific argument named <tt class="docutils literal"><span class="pre">foo</span></tt> with the value <tt class="docutils literal"><span class="pre">bar</span></tt>. Once again, this is the same setting you learned about in Chapter 7 during the discussion of engines.</p>
<p>For SQLite, you might use an option like this to specify a database in the same directory as the config file:</p>
<div class="highlight-python"><pre>sqlalchemy.url = sqlite:///%(here)s/databasefile.sqlite</pre>
</div>
<p>Here <tt class="docutils literal"><span class="pre">databasefile.sqlite</span></tt> is the SQLite database file, and <tt class="docutils literal"><span class="pre">%(here)s</span></tt> represents the directory containing the <tt class="docutils literal"><span class="pre">development.ini</span></tt> file. If you’re using an absolute path, use four slashes after the colon: <tt class="docutils literal"><span class="pre">sqlite:////var/lib/myapp/databasefile.sqlite</span></tt>. The example has three slashes because the value of <tt class="docutils literal"><span class="pre">%(here)s</span></tt> always starts with a slash on Unix-like platforms. Windows users should use four slashes because <tt class="docutils literal"><span class="pre">%(here)s</span></tt> on Windows starts with the drive letter.</p>
<p>For MySQL, you might use these options:</p>
<div class="highlight-python"><pre>sqlalchemy.url = mysql://username:password@host:port/database
sqlalchemy.pool_recycle = 3600</pre>
</div>
<p>Enter your username, your password, the host, the port number (usually 3306), and the name of your database.</p>
<p id="index-1038">It’s important to set the <tt class="docutils literal"><span class="pre">pool_recycle</span></tt> option for MySQL to prevent “MySQL server has gone away” errors. This is because MySQL automatically closes idle database connections without informing the application. Setting the connection lifetime to 3600 seconds (1 hour) ensures that the connections will be expired and re-created before MySQL notices they’re idle. <tt class="docutils literal"><span class="pre">pool_recycle</span></tt> is one of many engine options SQLAlchemy supports. Some of the others are listed at <a class="reference external" href="http://www.sqlalchemy.org/docs/05/dbengine.html#dbengine_options">http://www.sqlalchemy.org/docs/05/dbengine.html#dbengine_options</a> and are used in the same way, prefixing the option name with <tt class="docutils literal"><span class="pre">sqlalchemy.</span></tt>.</p>
<p>For PostgreSQL, your DSN will usually look like this:</p>
<div class="highlight-python"><pre>sqlalchemy.url = postgres://username:password@host:port/database</pre>
</div>
<p>The options are the same as for MySQL, but you don’t generally need to use the <tt class="docutils literal"><span class="pre">pool_recycle</span></tt> option with PostgreSQL.</p>
<p id="index-1039">By default, Pylons sets up the DSN <tt class="docutils literal"><span class="pre">sqlalchemy.url</span> <span class="pre">=</span> <span class="pre">sqlite:///%(here)s/development.db</span></tt>, so if you don’t change it, this is what will be used. Whichever DSN you use, you still need to make sure you have installed SQLAlchemy along with the appropriate DB-API driver you want to use; otherwise, SQLAlchemy won’t be able to connect to the database. Again, see Chapter 7 for more information.</p>
</div>
<div class="section" id="creating-the-model">
<h3>Creating the Model<a class="headerlink" href="#creating-the-model" title="Permalink to this headline">¶</a></h3>
<p id="index-1040">Once you have configured the engine, it is time to configure the model. This is easy to do; you simply add all your classes, tables, and mappers to the end of <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt>. The SimpleSite application will use the structures you worked through in the previous chapter, so I won’t discuss them in detail here.</p>
<p id="index-1041">Change <tt class="docutils literal"><span class="pre">model.__init__.py</span></tt> to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;The application&#39;s model objects&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="kn">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">orm</span>

<span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>

<span class="c"># Add these two imports:</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">schema</span><span class="p">,</span> <span class="n">types</span>

<span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call me before using any of the tables or classes in the model&quot;&quot;&quot;</span>
    <span class="c">## Reflected tables must be defined and mapped here</span>
    <span class="c">#global reflected_table</span>
    <span class="c">#reflected_table = sa.Table(&quot;Reflected&quot;, meta.metadata, autoload=True,</span>
    <span class="c">#                           autoload_with=engine)</span>
    <span class="c">#orm.mapper(Reflected, reflected_table)</span>

    <span class="c"># We are using SQLAlchemy 0.5 so transactional=True is replaced by</span>
    <span class="c"># autocommit=False</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">autoflush</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="n">meta</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>

<span class="c"># Replace the rest of the file with the model objects we created in</span>
<span class="c"># chapter 7</span>

<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">page_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;page_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;posted&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;Untitled Page&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;heading&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">comment_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;comment_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s">u&#39;&#39;</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">()),</span>
<span class="p">)</span>

<span class="n">pagetag_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;pagetag&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;pagetag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;pageid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;page.id&#39;</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;tagid&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;tag.id&#39;</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">tag_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;tag_seq_id&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mf">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">comment_table</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">tag_table</span><span class="p">)</span>
<span class="n">orm</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">page_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
   <span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">),</span>
   <span class="s">&#39;tags&#39;</span><span class="p">:</span><span class="n">orm</span><span class="o">.</span><span class="n">relation</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">pagetag_table</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The book was written against Pylons 0.9.7rc2 but the actual release of Pylons 0.9.7 uses SQLAlchemy 0.5 by default. This means the <tt class="docutils literal"><span class="pre">init_model()</span></tt> function in your project might look slightly different to the version shown above. You should keep the version generated by Pylons rather than using the version above. In Pylons 0.9.7 the <tt class="docutils literal"><span class="pre">sessionmaker()</span></tt> call is still made, but it happens in your project&#8217;s <tt class="docutils literal"><span class="pre">model/meta.py</span></tt> file instead of <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt>.</p>
</div>
<p id="index-1042">As I mentioned, this will look very familiar because it is a similar setup to the one you used in the previous chapter. There are some points to note about this code, though:</p>
<blockquote>
<ul class="simple" id="index-1043">
<li>The <tt class="docutils literal"><span class="pre">MetaData</span></tt> object Pylons uses is defined in <tt class="docutils literal"><span class="pre">model/meta.py</span></tt> so is accessed here as <tt class="docutils literal"><span class="pre">meta.metadata</span></tt>, whereas in the previous chapter the examples just used <tt class="docutils literal"><span class="pre">metadata</span></tt>.</li>
</ul>
<ul class="simple" id="index-1044">
<li>Pylons generated the <tt class="docutils literal"><span class="pre">init_model()</span></tt> function when the project was created. It gets called after the engine has been created each time your application starts from <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> to connect the model to the database.</li>
</ul>
</blockquote>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last" id="index-1045">Pylons generates a project to use SQLAlchemy 0.4, but many users will want to use the newer SQLAlchemy 0.5 described in Chapter 7. They are very similar, but the <tt class="docutils literal"><span class="pre">transactional=True</span></tt> argument to <tt class="docutils literal"><span class="pre">orm.sessionmaker()</span></tt> in <tt class="docutils literal"><span class="pre">init_model()</span></tt> is deprecated. Instead, you should specify <tt class="docutils literal"><span class="pre">autocommit=False</span></tt>. This has the same behavior but will not generate a deprecation warning.</p>
</div>
</div>
<div class="section" id="creating-the-database-tables">
<h3>Creating the Database Tables<a class="headerlink" href="#creating-the-database-tables" title="Permalink to this headline">¶</a></h3>
<p id="index-1046">Pylons has a built-in facility to allow users who download your application to easily set it up. The process is described in detail in the later SimpleSite tutorial chapters (Chapters 14 and 19), but you’ll use it here too so that you can easily set up the tables you need.</p>
<p id="index-1047">The idea is that users of your application can simply run <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span> <span class="pre">development.ini</span></tt> to have the database tables and any initial data created for them automatically. You can set up this facility through your project’s <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file.</p>
<p>The default <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file for a SQLAlchemy project looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Setup the SimpleSite application&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">simplesite.config.environment</span> <span class="kn">import</span> <span class="n">load_environment</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup_app</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="nb">vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Place any commands to setup simplesite here&quot;&quot;&quot;</span>
    <span class="n">load_environment</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">local_conf</span><span class="p">)</span>

    <span class="c"># Load the models</span>
    <span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">engine</span>

    <span class="c"># Create the tables if they aren&#39;t there already</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>When the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> command is run, Pylons calls the <tt class="docutils literal"><span class="pre">setup_app()</span></tt> function and loads the Pylons environment, setting up a SQLAlchemy engine as it does so. It then binds the engine to the metadata and calls <tt class="docutils literal"><span class="pre">metadata.create_all(checkfirst=True)</span></tt> to create any tables that don’t already exist.</p>
<p id="index-1048">Binding the metadata in this way connects the engine to the <tt class="docutils literal"><span class="pre">metadata</span></tt> object used by the classes, tables, and mappers in the model. You can think of it as a shortcut to set up the model without the complexity of a session.</p>
<p id="index-1049">You’ll now customize the default code so that it also adds a home page to the database. Add the following to the end of the <tt class="docutils literal"><span class="pre">setup_app()</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding homepage...&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
<span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Home Page&#39;</span>
<span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">u&#39;Welcome to the SimpleSite home page.&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Successfully set up.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You’ll also need to add this import at the top:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite</span> <span class="kn">import</span> <span class="n">model</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The recommended way of adding an object to the SQLAlchemy session in SQLAlchemy 0.4 was to call the session&#8217;s <tt class="docutils literal"><span class="pre">save()</span></tt> method. The session in SQLAlchemy 0.5 provides the <tt class="docutils literal"><span class="pre">add()</span></tt> method instead. Since this book covers SQLAlchemy 0.5, the examples will use the <tt class="docutils literal"><span class="pre">add()</span></tt> method.</p>
</div>
<p id="index-1050">To test this functionality, you should first make SimpleSite available in your virtual Python environment. Rather than installing SimpleSite as you would install a normal Python package, you can instead use a special feature of the <tt class="docutils literal"><span class="pre">setuptools</span></tt> package used by Easy Install called <em>development mode</em>. This has the effect of making other Python packages treat your Pylons project’s source directory as if it were an installed Python egg even though it is actually just a directory structure in the filesystem.</p>
<p>It works by adding a <tt class="docutils literal"><span class="pre">SimpleSite.egg-link</span></tt> file to your virtual Python installation&#8217;s site-packages directory containing the path to the application. It also adds an entry to the <tt class="docutils literal"><span class="pre">easy_install.pth</span></tt> file so that the project is added to the Python path. This is very handy because it means that any changes you make to the SimpleSite project are instantly available without you having to create and install the package every time you make a change. Set up your project in development mode by entering this command:</p>
<div class="highlight-python"><pre>$ python setup.py develop</pre>
</div>
<p>If you haven’t specified <tt class="docutils literal"><span class="pre">sqlalchemy.url</span></tt> in your <tt class="docutils literal"><span class="pre">development.ini</span></tt> config file, you should do so now. Then you are ready to run the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt> command to set up your tables:</p>
<div class="highlight-python"><pre>$ paster setup-app development.ini</pre>
</div>
<p id="index-1051">If all goes well, you should see quite a lot of log output produced, ending with the following lines and the message that everything was successfully set up:</p>
<div class="highlight-python"><pre>12:37:36,429 INFO  [simplesite.websetup] Adding homepage...
12:37:36,446 INFO  [sqlalchemy.engine.base.Engine.0x..70] BEGIN
12:37:36,449 INFO  [sqlalchemy.engine.base.Engine.0x..70] INSERT INTO page (content, posted, title, heading) VALUES (?, ?, ?, ?)
12:37:36,449 INFO  [sqlalchemy.engine.base.Engine.0x..70] [u'Welcome to the SimpleSite home page.', '2008-09-12 12:37:36.449094', u'Home Page', None]
12:37:36,453 INFO  [sqlalchemy.engine.base.Engine.0x..70] COMMIT
12:37:36,460 INFO  [simplesite.websetup] Successfully set up.</pre>
</div>
</div>
<div class="section" id="querying-data">
<h3>Querying Data<a class="headerlink" href="#querying-data" title="Permalink to this headline">¶</a></h3>
<p id="index-1052">Now that the home page data is in SQLAlchemy, you need to update the <tt class="docutils literal"><span class="pre">view()</span></tt> action to use it. You’ll recall that you query SQLAlchemy using a <em>query</em> object. Here’s how:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/view.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that since the heading is optional, you are using the title as the heading if the heading is empty.</p>
<p>To use this, you need to uncomment the following line at the top of the controller file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#import simplesite.model as model</span>
</pre></div>
</div>
<p>Now add some more imports the controller will need:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">simplesite.model.meta</span> <span class="kn">as</span> <span class="nn">meta</span>
<span class="kn">import</span> <span class="nn">simplesite.lib.helpers</span> <span class="kn">as</span> <span class="nn">h</span>
</pre></div>
</div>
<p>Finally, you’ll need to update the <tt class="docutils literal"><span class="pre">templates/derived/page/view.html</span></tt> template to use the <tt class="docutils literal"><span class="pre">page</span></tt> object:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;${c.page.title}&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;${c.page.heading or c.page.title}&lt;/h1&gt;&lt;/%def&gt;

${c.page.content}</pre>
</div>
<p>The new heading def will display the heading if there is one and the title if no heading has been set.</p>
<p id="index-1053">Visit <a class="reference external" href="http://localhost:5000/page/view/1">http://localhost:5000/page/view/1</a> again, and you should see the data loaded from the database (Figure 8-3). You’ll need to restart the server if you stopped it to run <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">setup-app</span></tt>.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0803.png"><img alt="Figure 8-3. A basic page being rendered with data from the database" src="_images/9349f0803.png" /></a>
<p class="caption">Figure 8-3. A basic page being rendered with data from the database</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p id="index-1054">Generally speaking, it is a good idea to try to keep your model and templates as separate as possible. You should always perform all model operations in your controller and never in a template. This is so that you, and other people working on your project, always know where changes to your model are happening so that code is easy to maintain.</p>
<p class="last">To avoid the risk of a lazy programmer performing operations on the model from within a template, you might prefer not to pass model objects directly to the controller and instead pass the useful attributes. In this case, rather than passing <tt class="docutils literal"><span class="pre">c.page</span></tt>, you might instead pass <tt class="docutils literal"><span class="pre">c.title</span></tt>, <tt class="docutils literal"><span class="pre">c.content</span></tt>, and other useful attributes rather than the whole object. In this book, I’ll be strict about only using model objects for read-only access in templates, so it is OK to pass them in directly.</p>
</div>
</div>
<div class="section" id="understanding-the-role-of-the-base-controller">
<h3>Understanding the Role of the Base Controller<a class="headerlink" href="#understanding-the-role-of-the-base-controller" title="Permalink to this headline">¶</a></h3>
<p id="index-1055">Every Pylons project has a base controller in the project’s <tt class="docutils literal"><span class="pre">lib/base.py</span></tt> file. All your project’s controllers are by default derived from the <tt class="docutils literal"><span class="pre">BaseController</span></tt> class, so this means that if you want to change the behavior of all the controllers in your project, you can make changes to the base controller. Of course, if you want to derive your controllers directly from <tt class="docutils literal"><span class="pre">pylons.controllers.WSGIController</span></tt>, you are free to do so too.</p>
<p id="index-1056">The SimpleSite base controller looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;The base Controller API</span>

<span class="sd">Provides the BaseController class for subclassing.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pylons.controllers</span> <span class="kn">import</span> <span class="n">WSGIController</span>
<span class="kn">from</span> <span class="nn">pylons.templating</span> <span class="kn">import</span> <span class="n">render_mako</span> <span class="k">as</span> <span class="n">render</span>

<span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>

<span class="k">class</span> <span class="nc">BaseController</span><span class="p">(</span><span class="n">WSGIController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoke the Controller&quot;&quot;&quot;</span>
        <span class="c"># WSGIController.__call__ dispatches to the Controller method</span>
        <span class="c"># the request is routed to. This routing information is</span>
        <span class="c"># available in environ[&#39;pylons.routes_dict&#39;]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WSGIController</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-1057">All the individual controllers that you create with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">controller</span></tt> command also import the <tt class="docutils literal"><span class="pre">render()</span></tt> function from this file, so if you want to change the templating language for all your controllers, you can change the <tt class="docutils literal"><span class="pre">render()</span></tt> import in this file, and all the other controllers will automatically use the new function. Of course, you will have to set up the templating language in your project’s <tt class="docutils literal"><span class="pre">config/environment.py</span></tt> file too. This was described in Chapter 5.</p>
</div>
<div class="section" id="using-a-sqlalchemy-session-in-pylons">
<h3>Using a SQLAlchemy Session in Pylons<a class="headerlink" href="#using-a-sqlalchemy-session-in-pylons" title="Permalink to this headline">¶</a></h3>
<p id="index-1058">You’ve learned about SQLAlchemy sessions in some detail in Chapter 7, but now let’s take a brief look at how sessions are used in Pylons.</p>
<p>The relevant lines to set up the session are found in your <tt class="docutils literal"><span class="pre">model/__init__.py</span></tt> file’s <tt class="docutils literal"><span class="pre">init_model()</span></tt> function and look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sm</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">autoflush</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">meta</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1059">The <tt class="docutils literal"><span class="pre">meta.Session</span></tt> class created here acts as a thread-safe wrapper around ordinary SQLAlchemy session objects so that data from one Pylons request doesn’t get mixed up with data from other requests in a multithreaded environment. Calling <tt class="docutils literal"><span class="pre">meta.Session()</span></tt> returns the thread’s actual session object, but you wouldn’t normally need to access it in this way because when you call the class’s <tt class="docutils literal"><span class="pre">meta.Session.query()</span></tt> method, it will automatically return a query object from the correct hidden session object. You can then use the query object as normal to fetch data from the database.</p>
<p>Since a new session is created for each request, it is important that sessions that are no longer needed are removed. Because you chose to use a SQLAlchemy setup when you created the project, Pylons has added a line to remove any SQLAlchemy session at the end of the <tt class="docutils literal"><span class="pre">BaseController</span></tt> class’s <tt class="docutils literal"><span class="pre">__call__()</span></tt> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-1060">This simply removes the session once your controller has returned the data for the response.</p>
</div>
</div>
<div class="section" id="updating-the-controller-to-support-editing-pages">
<h2>Updating the Controller to Support Editing Pages<a class="headerlink" href="#updating-the-controller-to-support-editing-pages" title="Permalink to this headline">¶</a></h2>
<p id="index-1061">To quickly recap, you’ve set up the model, configured the database engine, set up the templates, and written an action to view pages based on their IDs. Next, you need to write the application logic and create the forms to enable a user to create, list, add, edit, and delete pages.</p>
<p>You’ll need the following actions:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">view(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Displays a page</dd>
<dt><tt class="docutils literal"><span class="pre">new(self)</span></tt></dt>
<dd>Displays a form to create a new page</dd>
<dt><tt class="docutils literal"><span class="pre">create(self)</span></tt></dt>
<dd>Saves the information submitted from <tt class="docutils literal"><span class="pre">new()</span></tt> and redirects to <tt class="docutils literal"><span class="pre">view()</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">edit(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Displays a form for editing the page <tt class="docutils literal"><span class="pre">id</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">save(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Saves the page <tt class="docutils literal"><span class="pre">id</span></tt> and redirects to <tt class="docutils literal"><span class="pre">view()</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">list(self)</span></tt></dt>
<dd>Lists all pages</dd>
<dt><tt class="docutils literal"><span class="pre">delete(self,</span> <span class="pre">id)</span></tt></dt>
<dd>Deletes a page</dd>
</dl>
<p>This structure forms a good basis for a large number of the cases you are likely to program with a relational database.</p>
<div class="section" id="view">
<h3>view()<a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h3>
<p id="index-1062">The existing <tt class="docutils literal"><span class="pre">view()</span></tt> method correctly displays a page but currently raises an error if you try to display a page that doesn’t exist. This is because <tt class="docutils literal"><span class="pre">page_q.get()</span></tt> returns None when the page doesn&#8217;t exist so that <tt class="docutils literal"><span class="pre">c.page</span></tt> is set to None. This causes an exception in the template when <tt class="docutils literal"><span class="pre">c.page.title</span></tt> is accessed.</p>
<p id="index-1063">Also, if a URL cannot be found, the HTTP specification says that a 404 page should be returned. You can use the <tt class="docutils literal"><span class="pre">abort()</span></tt> function to immediately stop the request and trigger the Pylons error documents middleware to display a 404 Not Found page. You should also display a 404 page if the user doesn’t specify a page ID. Here’s what the updated code looks like. Notice that the action arguments have been changed so that <tt class="docutils literal"><span class="pre">id</span></tt> is now optional.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/view.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">When you are testing a condition that involves <tt class="xref docutils literal"><span class="pre">None</span></tt> in Python, you should use the <tt class="docutils literal"><span class="pre">is</span></tt> operator rather than the <tt class="docutils literal"><span class="pre">==</span></tt> operator.</p>
</div>
</div>
<div class="section" id="new">
<h3>new()<a class="headerlink" href="#new" title="Permalink to this headline">¶</a></h3>
<p id="index-1064">You also need a template for pages that don’t already exist. It needs to display a form and submit it to the <tt class="docutils literal"><span class="pre">create()</span></tt> action to create the page. Most of the functionality to display the form will take place in the templates. Here’s what the action looks like; add this to the controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/new.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Thinking ahead, the <tt class="docutils literal"><span class="pre">edit()</span></tt> action will also display a form, and it is likely to have many of the same fields. You’ll therefore implement the fields in one template where they can be shared and create the form itself in another.</p>
<p id="index-1065">First let’s create the fields in <tt class="docutils literal"><span class="pre">templates/derived/page/fields.html</span></tt>. Here’s what the file looks like:</p>
<div class="highlight-python"><pre>${h.field(
    "Heading",
    h.text(name='heading'),
    required=False,
)}
${h.field(
    "Title",
    h.text(name='title'),
    required=True,
    field_desc = "Used as the heading too if you didn't specify one above"
)}
${h.field(
    "Content",
    h.textarea(name='content', rows=7, cols=40),
    required=True,
    field_desc = 'The text that will make up the body of the page'
)}</pre>
</div>
<p>Remember that <tt class="docutils literal"><span class="pre">h</span></tt> is simply another name for your project’s <tt class="docutils literal"><span class="pre">simplesite.lib.helpers</span></tt> module and that it is available in both the templates and the controllers. In this case, you’re using a helper called <tt class="docutils literal"><span class="pre">field()</span></tt> that generates the HTML for a row in a table containing a label for a field and the field itself. It also allows you to specify <tt class="docutils literal"><span class="pre">field_desc</span></tt>, which is a line of text that appears immediately below the HMTL field, or <tt class="docutils literal"><span class="pre">label_desc</span></tt>, which is for text appearing immediately below the label. Specifying <tt class="docutils literal"><span class="pre">required=True</span></tt> adds an asterisk (<tt class="docutils literal"><span class="pre">*</span></tt>) to the start of the label, but it doesn’t affect how the controller handles whether fields are actually required.</p>
<p id="index-1066">To use the <tt class="docutils literal"><span class="pre">field</span></tt> helper, you need to first import it into the <tt class="docutils literal"><span class="pre">helpers</span></tt> module. You’ll also use <tt class="docutils literal"><span class="pre">form_start()</span></tt> and <tt class="docutils literal"><span class="pre">form_end()</span></tt>, so let’s import them at the same time. At the top of <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>, add the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formbuild.helpers</span> <span class="kn">import</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">formbuild</span> <span class="kn">import</span> <span class="n">start_with_layout</span> <span class="k">as</span> <span class="n">form_start</span><span class="p">,</span> <span class="n">end_with_layout</span> <span class="k">as</span> <span class="n">form_end</span>
<span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p id="index-1067">Notice that you are using a package called FormBuild here. You could equally well code all your field structures in HTML, but FormBuild will help create a structure for you. FormBuild actually contains some extra functionality too, but you will use it only for its <tt class="docutils literal"><span class="pre">field()</span></tt>, <tt class="docutils literal"><span class="pre">start_with_layout()</span></tt>, and <tt class="docutils literal"><span class="pre">end_with_layout()</span></tt> helpers in the book. At some point in the future, these helpers are likely to be added to the Pylons WebHelpers package. Install FormBuild like this:</p>
<div class="highlight-python"><pre>$ easy_install "FormBuild&gt;=2.0,&lt;2.99"</pre>
</div>
<p id="index-1068">You should also add it as a dependency to your project by editing the <tt class="docutils literal"><span class="pre">setup.py</span></tt> file and adding FormBuild to the end of the <tt class="docutils literal"><span class="pre">install_requires</span></tt> argument, and updating the SQLAlchemy line to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
    <span class="s">&quot;Pylons&gt;=0.9.7&quot;</span><span class="p">,</span>
    <span class="s">&quot;SQLAlchemy&gt;=0.5,&lt;=0.5.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;Mako&quot;</span><span class="p">,</span>
    <span class="s">&quot;FormBuild&gt;=2.0,&lt;2.99&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p>Next you need the form itself. Like the <tt class="docutils literal"><span class="pre">view.html</span></tt> page, this can be based on the <tt class="docutils literal"><span class="pre">/base/index.html</span></tt> page using Mako’s template inheritance. Here’s how <tt class="docutils literal"><span class="pre">/derived/page/new.html</span></tt> looks:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;
&lt;%namespace file="fields.html" name="fields" import="*"/&gt;

&lt;%def name="heading()"&gt;
    &lt;h1 class="main"&gt;Create a New Page&lt;/h1&gt;
&lt;/%def&gt;

${h.form_start(h.url_for(controller='page', action='create'), method="post")}
    ${fields.body()}
    ${h.field(field=h.submit(value="Create Page", name='submit'))}
${h.form_end()}</pre>
</div>
<p>This template imports the defs in the <tt class="docutils literal"><span class="pre">fields.html</span></tt> file into the <tt class="docutils literal"><span class="pre">fields</span></tt> namespace. It then calls its <tt class="docutils literal"><span class="pre">body()</span></tt> def to render the form fields. <tt class="docutils literal"><span class="pre">h.form_start()</span></tt> and <tt class="docutils literal"><span class="pre">h.form_end()</span></tt> create the HTML <tt class="docutils literal"><span class="pre">&lt;form&gt;</span></tt> tags as well as the <tt class="docutils literal"><span class="pre">&lt;table&gt;</span></tt> tags needed to wrap the rows generated by each call to <tt class="docutils literal"><span class="pre">h.field()</span></tt>.</p>
<p>You’ll also need to add the <tt class="docutils literal"><span class="pre">url_for()</span></tt> helper to <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>. This is a function from Routes that you’ll learn about in Chapter 9. For the time being, it is enough to know that it takes a controller, action, and ID and will generate a URL that, when visited, will result in the controller and action being called with the ID you specified. Routes is highly customizable and is one of the central components Pylons provides to make building sophisticated web applications easier. Add this line to the <tt class="docutils literal"><span class="pre">import</span></tt> statements in <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">routes</span> <span class="kn">import</span> <span class="n">url_for</span>
</pre></div>
</div>
<p>You can now test the form by visiting <a class="reference external" href="http://localhost:5000/page/new">http://localhost:5000/page/new</a>.</p>
<p id="index-1069">When the user clicks the Create Page button, the information they enter is submitted to the <tt class="docutils literal"><span class="pre">create()</span></tt> action, so you need to write that next.</p>
</div>
<div class="section" id="create">
<h3>create()<a class="headerlink" href="#create" title="Permalink to this headline">¶</a></h3>
<p id="index-1070">The <tt class="docutils literal"><span class="pre">create()</span></tt> action needs to perform the following tasks:</p>
<blockquote>
<ul class="simple">
<li>Validate the form</li>
<li>Redisplay it with error messages if any data is invalid</li>
<li>Add the valid data to the database</li>
<li>Redirect the user to the newly created page</li>
</ul>
</blockquote>
<p id="index-1071">Let’s start by creating a FormEncode schema to validate the data submitted. You need to import <tt class="docutils literal"><span class="pre">formencode</span></tt> at the top of the page controller and then import <tt class="docutils literal"><span class="pre">htmlfill</span></tt>, which will be used by the <tt class="docutils literal"><span class="pre">edit()</span></tt> method later in the chapter:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">formencode</span>
<span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>
</pre></div>
</div>
<p>Next define the schema, which looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewPageForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
        <span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;empty&#39;</span><span class="p">:</span><span class="s">&#39;Please enter some content for the page.&#39;</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Setting the <tt class="docutils literal"><span class="pre">allow_extra_fields</span></tt> and <tt class="docutils literal"><span class="pre">filter_extra_fields</span></tt> options to <tt class="xref docutils literal"><span class="pre">True</span></tt> means that FormEncode won’t raise <tt class="docutils literal"><span class="pre">Invalid</span></tt> exceptions for fields such as the Create Page button, which aren’t listed in the schema, but will filter them out so that they don’t affect the results.</p>
<p id="index-1072">You’ll notice that <tt class="docutils literal"><span class="pre">title</span></tt> and <tt class="docutils literal"><span class="pre">content</span></tt> are required fields because they have <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> specified. You’ll also notice that the <tt class="docutils literal"><span class="pre">content</span></tt> field has a customized error message so that if no text is entered, the error <tt class="docutils literal"><span class="pre">Please</span> <span class="pre">enter</span> <span class="pre">some</span> <span class="pre">content</span> <span class="pre">for</span> <span class="pre">the</span> <span class="pre">page.</span></tt> will be displayed. Notice also that although you specified <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> in the <tt class="docutils literal"><span class="pre">formencode.validators.String</span></tt> validator, the key corresponding to the message is the string <tt class="docutils literal"><span class="pre">'empty'</span></tt>. This might catch you out if you expected the key to be <tt class="docutils literal"><span class="pre">'not_empty'</span></tt>.</p>
<p>To handle the validation and redisplay of the form if there are any errors, you’ll use the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator you learned about in Chapter 4. This requires another import:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons.decorators</span> <span class="kn">import</span> <span class="n">validate</span>
</pre></div>
</div>
<p>You want it to redisplay the result of calling the <tt class="docutils literal"><span class="pre">new()</span></tt> action if an error occurs, so this is how you use it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p id="index-1073">Calling an action wrapped by <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> using a GET request will bypass the validation and call the action anyway. You need to make sure this doesn’t pose a security risk in your application. You could prevent this by testing whether a GET or a POST is being used in the body of the action. You can determine the request method using <tt class="docutils literal"><span class="pre">request.method</span></tt>, or Pylons provides another decorator called <tt class="docutils literal"><span class="pre">&#64;restrict</span></tt> that you can use.</p>
<p>Let’s use the new decorator and add the body of the action to create the page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Add the new page to the database</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_int</span> <span class="o">=</span> <span class="mf">302</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;Moved temporarily&quot;</span>
</pre></div>
</div>
<p>You’ll also need another import:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons.decorators.rest</span> <span class="kn">import</span> <span class="n">restrict</span>
</pre></div>
</div>
<p id="index-1074">If the data entered is valid, it will be available in the action as the dictionary <tt class="docutils literal"><span class="pre">self.form_result</span></tt>. Here you’re using a trick where you can iterate over the dictionary and set one of the page attributes for each of the values in the schema. Finally, you save the page to the session and then commit the changes to the database. You don’t need to explicitly call <tt class="docutils literal"><span class="pre">meta.Session.flush()</span></tt> because the Pylons session is set to automatically flush changes when you call <tt class="docutils literal"><span class="pre">meta.Session.commit()</span></tt> (this was the <tt class="docutils literal"><span class="pre">autoflush=True</span></tt> argument to <tt class="docutils literal"><span class="pre">sessionmaker()</span></tt> in the model). Once the page has been flushed and committed, SQLAlchemy assigns it an <tt class="docutils literal"><span class="pre">id</span></tt>, so you use this to redirect the browser to the <tt class="docutils literal"><span class="pre">view()</span></tt> action for the new page using an HTTP redirect.</p>
<p>Issuing an HTTP redirect to the <tt class="docutils literal"><span class="pre">view()</span></tt> action is preferable to simply returning the page because if a user clicks Refresh, it is the <tt class="docutils literal"><span class="pre">view()</span></tt> action that is called again, not the <tt class="docutils literal"><span class="pre">create()</span></tt> action. This avoids the possibility that the user will accidentally add two identical pages by mistake by resubmitting the form.</p>
<p>This can cause other problems; for example, how do you pass information obtained during the call to <tt class="docutils literal"><span class="pre">create()</span></tt> to the <tt class="docutils literal"><span class="pre">view()</span></tt> action called next? Because the two pages are generated in two separate HTTP requests, you need to use a session to store information that can be used across the requests. You’ll learn about this later in the chapter.</p>
<p id="index-1075">This is a good point to test your new application. If the server isn’t already running, start it with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span> <span class="pre">--reload</span> <span class="pre">development.ini</span></tt> command. Visit <a class="reference external" href="http://localhost:5000/page/new">http://localhost:5000/page/new</a>, and you should see the form. If you try to submit the form without adding any information, you will see that the validation system repopulates the form with errors.</p>
<p>The errors don’t show up too well, so let’s add some styles. Create the directory <tt class="docutils literal"><span class="pre">public/css</span></tt>, and add the following as <tt class="docutils literal"><span class="pre">main.css</span></tt>:</p>
<div class="highlight-python"><pre>span.error-message, span.required {
    font-weight: bold;
    color: #f00;
}</pre>
</div>
<p>You want to be able to use this style sheet in all the templates, so update the <tt class="docutils literal"><span class="pre">head()</span></tt> def of the <tt class="docutils literal"><span class="pre">/templates/base/index.html</span></tt> base template so that it looks like this:</p>
<div class="highlight-python"><pre>&lt;%def name="head()"&gt;
    ${h.stylesheet_link(h.url_for('/css/main.css'))}
&lt;/%def&gt;</pre>
</div>
<p id="index-1076">Once again, you’ll need to import the <tt class="docutils literal"><span class="pre">stylesheet_link()</span></tt> helper into your <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="n">stylesheet_link</span>
</pre></div>
</div>
<p id="index-1077">The helper takes any number of URLs as input and generates link tags for each. Any keyword arguments are added as attributes to each tag. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">stylesheet_link</span><span class="p">(</span><span class="s">&#39;style.css&#39;</span><span class="p">,</span> <span class="s">&#39;main.css&#39;</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s">&quot;print&quot;</span><span class="p">)</span>
<span class="go">&lt;link href=&quot;/stylesheets/style.css&quot; media=&quot;print&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;</span>
<span class="go">&lt;link href=&quot;/stylesheets/main.css&quot; media=&quot;print&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;</span>
</pre></div>
</div>
<p>You should find that all the error messages appear in red, which will make any mistakes much more obvious to your users (see Figure 8-4). Why not go ahead and create a test page? If you enter any characters such as <tt class="docutils literal"><span class="pre">&lt;</span></tt>, <tt class="docutils literal"><span class="pre">&gt;</span></tt>, or <tt class="docutils literal"><span class="pre">&amp;</span></tt>, you will find they are correctly escaped by Mako because they haven’t been created as HTML literals. This means you can be confident that users of your application can’t embed HTML into the page that could pose a cross-site scripting (XSS) attack risk, as explained in Chapter 4.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0804.png"><img alt="Figure 8-4. The error message in red" src="_images/9349f0804.png" /></a>
<p class="caption">Figure 8-4. The error message in red</p>
</div>
<p id="index-1078">If you save the page with valid data, you’ll see you are correctly redirected to the page you have created at the URL <a class="reference external" href="http://localhost:5000/page/view/2">http://localhost:5000/page/view/2</a>.</p>
</div>
<div class="section" id="edit-and-save">
<h3>edit() and save()<a class="headerlink" href="#edit-and-save" title="Permalink to this headline">¶</a></h3>
<p id="index-1079">Now that you’ve implemented the code to create new pages, let’s look at the very similar code required to edit them. Once again, you’ll have an action to display the form (in this case <tt class="docutils literal"><span class="pre">edit()</span></tt>) and an action to handle saving the code (in this case <tt class="docutils literal"><span class="pre">save()</span></tt>). The <tt class="docutils literal"><span class="pre">edit()</span></tt> action will need to load the data for the page from the model and then populate the form with the page information. Here’s what it looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s">&#39;heading&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">heading</span><span class="p">,</span>
        <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">content</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/edit.html&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-1080">Notice how this example uses FormEncode’s <tt class="docutils literal"><span class="pre">htmlfill</span></tt> module to populate the form fields with the values obtained from the <tt class="docutils literal"><span class="pre">page</span></tt> object. The call to <tt class="docutils literal"><span class="pre">render('/derived/page/edit.html')</span></tt> generates the HTML, and the call to <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> populates the values.</p>
<p>The <tt class="docutils literal"><span class="pre">/derived/page/edit.html</span></tt> template can also use the same fields you used in the <tt class="docutils literal"><span class="pre">new.html</span></tt> template. It looks very similar:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;
&lt;%namespace file="fields.html" name="fields" import="*"/&gt;

&lt;%def name="heading()"&gt;
    &lt;h1 class="main"&gt;Editing ${c.title}&lt;/h1&gt;
&lt;/%def&gt;

&lt;p&gt;Editing the source code for the ${c.title} page:&lt;/p&gt;

${h.form_start(h.url_for(controller='page', action='save',
     id=request.urlvars['id']), method="post")}
    ${fields.body()}
    ${h.field(field=h.submit(value="Save Changes", name='submit'))}
${h.form_end()}</pre>
</div>
<p id="index-1081">The only difference is that the form action points to <tt class="docutils literal"><span class="pre">save</span></tt> instead of <tt class="docutils literal"><span class="pre">new</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">save()</span></tt> action is also slightly different from the <tt class="docutils literal"><span class="pre">create()</span></tt> action because it has to update attributes on an existing page object. Here’s how it looks:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c"># Issue an HTTP redirect</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_int</span> <span class="o">=</span> <span class="mf">302</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;Moved temporarily&quot;</span>
</pre></div>
</div>
<p>Notice how this time attributes of the page are set only if they have changed. Remember when using FormEncode in this way, when the form is valid, the converted results get saved as the <tt class="docutils literal"><span class="pre">self.form_result</span></tt> dictionary, so you should get the submitted content from there rather than from <tt class="docutils literal"><span class="pre">request.params</span></tt>. Also, in this instance, the FormEncode schema for creating a new page is the same as the one needed for editing a page, so you are using <tt class="docutils literal"><span class="pre">NewSchemaForm</span></tt> again in the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator. Often you will need to use a second schema, though.</p>
<p id="index-1082">Why not try editing a page? For example, to edit the home page, you could visit <a class="reference external" href="http://localhost:5000/page/edit/1">http://localhost:5000/page/edit/1</a>.</p>
</div>
<div class="section" id="list">
<h3>list()<a class="headerlink" href="#list" title="Permalink to this headline">¶</a></h3>
<p id="index-1083">Add the <tt class="docutils literal"><span class="pre">list()</span></tt> action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/list.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">list()</span></tt> action simply gets all the pages from the database and displays them. Notice the way you use the template context object <tt class="docutils literal"><span class="pre">c</span></tt> to pass the page data to the template. Create a new file named <tt class="docutils literal"><span class="pre">templates/derived/page/list.html</span></tt> to display the list of pages:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="heading()"&gt;
    &lt;h1 class="main"&gt;Page List&lt;/h1&gt;
&lt;/%def&gt;

&lt;ul id="titles"&gt;
% for page in c.pages:
&lt;li&gt;
    ${page.title} [${h.link_to('visit', h.url_for(controller='page', action='view',
        id=page.id))}]
&lt;/li&gt;
% endfor
&lt;/ul&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">h.link_to()</span></tt> helper is a tool for generating a hyperlink, of course you can also write the <tt class="docutils literal"><span class="pre">&lt;a&gt;</span></tt> tag out yourself if you prefer. To use it add the following import to the end of <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="n">link_to</span>
</pre></div>
</div>
<p id="index-1084">If you visit <a class="reference external" href="http://127.0.0.1:5000/page/list">http://127.0.0.1:5000/page/list</a>, you should see the full titles list, and you should be able to visit each page.</p>
</div>
<div class="section" id="delete">
<h3>delete()<a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h3>
<p id="index-1085">Users of the application might want to be able to delete a page, so let’s add a <tt class="docutils literal"><span class="pre">delete()</span></tt> action.</p>
<p>Add the following action to the <tt class="docutils literal"><span class="pre">page</span></tt> controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">page_q</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">page_q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mf">404</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/deleted.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This page searches for the page to be deleted and aborts with a 404 Not Found HTTP status if the page doesn’t exist. Otherwise, the page is deleted using the <tt class="docutils literal"><span class="pre">Session</span></tt> object, and the changes are committed.</p>
<p>Add the <tt class="docutils literal"><span class="pre">templates/derived/page/deleted.html</span></tt> template with the following content to display a message that the page has been deleted:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="heading()"&gt;
    &lt;h1 class="main"&gt;Page Deleted&lt;/h1&gt;
&lt;/%def&gt;

&lt;p&gt;This page has been deleted.&lt;/p&gt;</pre>
</div>
<p>Later in the chapter you’ll see how you can use a session and a <em>flash message</em> to display a simple message like this on a different page rather than needing to create a template for it.</p>
<p id="index-1086">At this point, you have a very simple (yet perfectly functional) web site for creating pages and editing their content. There is clearly more that could be done, though, so now it’s time to turn your attention to other aspects of the SimpleSite application you are creating.</p>
</div>
</div>
<div class="section" id="updating-the-footer">
<h2>Updating the Footer<a class="headerlink" href="#updating-the-footer" title="Permalink to this headline">¶</a></h2>
<p id="index-1087">Now that the basic structure of the controller is in place, the users of SimpleSite will need a quick and easy way of adding, editing, and deleting the pages without having to enter the appropriate URLs in the browser address bar.</p>
<p id="index-1088">Modify the <tt class="docutils literal"><span class="pre">derived/page/view.html</span></tt> template so that it includes some links in the page footer:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;${c.page.title}&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;${c.page.heading or c.page.title}&lt;/h1&gt;&lt;/%def&gt;

${c.page.content}

&lt;%def name="footer()"&gt;
## Then add our page links
&lt;p&gt;
  &lt;a href="${h.url_for(controller='page', action='list', id=None)}"&gt;All Pages&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='new', id=None)}"&gt;New Page&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='edit',
        id=c.page.id)}"&gt;Edit Page&lt;/a&gt;
| &lt;a href="${h.url_for(controller='page', action='delete',
        id=c.page.id)}"&gt;Delete Page&lt;/a&gt;
&lt;/p&gt;
## Include the parent footer too
${parent.footer()}
&lt;/%def&gt;</pre>
</div>
<p>Notice that the <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> call for both a new page and to list all pages has <tt class="docutils literal"><span class="pre">id=None</span></tt> specified. You’ll learn about Routes in Chapter 9, but for now you simply need to know that by default Routes automatically fills in values for routing variables based on the ones that were used to route the request to the current controller and action. This is not a recommended behavior, and you’ll learn how to change it in Chapter 9. The <tt class="docutils literal"><span class="pre">new()</span></tt> and <tt class="docutils literal"><span class="pre">list()</span></tt> actions don’t take an <tt class="docutils literal"><span class="pre">id</span></tt>, but unless you specify <tt class="docutils literal"><span class="pre">id=None</span></tt>, Routes fills in the <tt class="docutils literal"><span class="pre">id</span></tt> of the current page.</p>
<p id="index-1089">If you view a page, you will now see the links you need are present.</p>
</div>
<div class="section" id="using-pagination">
<h2>Using Pagination<a class="headerlink" href="#using-pagination" title="Permalink to this headline">¶</a></h2>
<p id="index-1090">If you want to display large numbers of items, it isn’t always appropriate to display them all at once. Instead, you should split the data into smaller chunks known as <em>pages</em> (not to be confused with the web site pages I’ve been talking about) and show each page of data one at a time. This is called <em>pagination</em>, and providing an interface for the user to page through the results is the job of a <em>paginator</em>.</p>
<p>As an example, imagine what would happen if lots of people started adding pages to the site. You could quickly get, say, 27 pages, which might be too many to display comfortably in a single list. Instead, you could use a paginator to display the web site pages ten at a time in each page in the paginator. The first page of results would show web site pages 1–10, the second would show 11–20, and the last would display 21–27.</p>
<p id="index-1091">The user also needs some way of navigating through the different pages of results. The Pylons WebHelpers come with a <tt class="docutils literal"><span class="pre">webhelpers.paginate</span></tt> module to make pagination easier, and it provides two solutions to allow the user to navigate the pages of data. The first is called a <em>pager</em>, and it produces an interface like the one shown here. The single arrows take you backward or forward one page of results at a time, and the double arrows take you straight to the first or last page.</p>
<div class="highlight-python"><pre>&lt;&lt; &lt; 11-20 of 27 &gt; &gt;&gt;</pre>
</div>
<p id="index-1092">The second navigation tool is called the <em>navigator</em> and produces an interface that looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="p">[</span><span class="mf">3</span><span class="p">]</span>
</pre></div>
</div>
<p>This allows you to click directly on the page of results you want to view.</p>
<p>Let’s update the <tt class="docutils literal"><span class="pre">list()</span></tt> action to use the paginator. First import the paginator module into the page controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">webhelpers.paginate</span> <span class="kn">as</span> <span class="nn">paginate</span>
</pre></div>
</div>
<p>Then update the <tt class="docutils literal"><span class="pre">list()</span></tt> action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">paginator</span> <span class="o">=</span> <span class="n">paginate</span><span class="o">.</span><span class="n">Page</span><span class="p">(</span>
        <span class="n">records</span><span class="p">,</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)),</span>
        <span class="n">items_per_page</span> <span class="o">=</span> <span class="mf">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/page/list.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is also a subtlety in this example which you could easily miss. The <tt class="docutils literal"><span class="pre">paginate.Page</span></tt> class has built-in support for SQLAlchemy so in this case, rather than simply providing the paginator with a standard list of Python objects, we are passing in an SQLAlchemy query object. This allows the paginator to only select the records it needs from the database for the page of results it is displaying.</p>
<p id="index-1093">It is unfortunate that the records you are paginating here are pages when the word <em>page</em> is also used to describe a set of records displayed by the paginator. In this case, the <tt class="docutils literal"><span class="pre">page</span></tt> variable retrieved using <tt class="docutils literal"><span class="pre">request.params</span></tt> is referring to the paginator page, not the <tt class="docutils literal"><span class="pre">id</span></tt> of a page record.</p>
<p id="index-1094">The <tt class="docutils literal"><span class="pre">list.html</span></tt> template also needs updating to use the paginator. Here’s what it looks like:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="heading()"&gt;&lt;h1&gt;Page List&lt;/h1&gt;&lt;/%def&gt;

&lt;%def name="buildrow(page, odd=True)"&gt;
    %if odd:
        &lt;tr class="odd"&gt;
    %else:
        &lt;tr class="even"&gt;
    % endif
        &lt;td valign="top"&gt;
            ${h.link_to(
                page.id,
                h.url_for(
                    controller=u'page',
                    action='view',
                    id=unicode(page.id)
                )
            )}
        &lt;/td&gt;
        &lt;td valign="top"&gt;
            ${page.title}
        &lt;/td&gt;
        &lt;td valign="top"&gt;${page.posted.strftime('%c')}&lt;/td&gt;
        &lt;/tr&gt;
&lt;/%def&gt;

% if len(c.paginator):
&lt;p&gt;${ c.paginator.pager('$link_first $link_previous $first_item to $last_item of
$item_count $link_next $link_last') }&lt;/p&gt;
&lt;table class="paginator"&gt;&lt;tr&gt;&lt;th&gt;Page ID&lt;/th&gt;&lt;th&gt;Page Title&lt;/th&gt;&lt;th&gt;Posted&lt;/th&gt;&lt;/tr&gt;
&lt;% counter=0 %&gt;
% for item in c.paginator:
    ${buildrow(item, counter%2)}
    &lt;% counter += 1 %&gt;
% endfor
&lt;/table&gt;
&lt;p&gt;${ c.paginator.pager('~2~') }&lt;/p&gt;
% else:
&lt;p&gt;
    No pages have yet been created.
    &lt;a href="${h.url_for(controller='page', action='new')}"&gt;Add one&lt;/a&gt;.
&lt;/p&gt;
% endif</pre>
</div>
<p id="index-1095">As you can see, the paginator is set up at the bottom of the template, but for each record the <tt class="docutils literal"><span class="pre">buildrow()</span></tt> def is called to generate a representation of the page.</p>
<p>When you click any of the navigation components in the paginator, a new request is made to the <tt class="docutils literal"><span class="pre">list()</span></tt> action with the ID of the paginator page. This is sent via the query string and passed as the <tt class="docutils literal"><span class="pre">page</span></tt> argument to <tt class="docutils literal"><span class="pre">paginate.Page</span></tt> to generate the next set of results.</p>
<p>The nice thing about the Pylons paginator implementation is that it can be used to page any type of information, whether comments in a blog, rows in a table, or entries in an address book. This is because the rendering of each item in the page can be handled in your template so that you have complete control over the visual appearance of your data.</p>
<p>To test the paginator, you might need to create a few extra pages and try setting the <tt class="docutils literal"><span class="pre">items_per_page</span></tt> option to <tt class="docutils literal"><span class="pre">paginate.Page()</span></tt> to a low number such as 2 so that you don’t have to create too many extra pages.</p>
<p id="index-1096">Here are the variables you can use as arguments to <tt class="docutils literal"><span class="pre">.pager()</span></tt> in the template:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">$first_page</span></tt></dt>
<dd>Number of first reachable page</dd>
<dt><tt class="docutils literal"><span class="pre">$last_page</span></tt></dt>
<dd>Number of last reachable page</dd>
<dt><tt class="docutils literal"><span class="pre">$current_page</span></tt></dt>
<dd>Number of currently selected page</dd>
<dt><tt class="docutils literal"><span class="pre">$page_count</span></tt></dt>
<dd>Number of reachable pages</dd>
<dt><tt class="docutils literal"><span class="pre">$items_per_page</span></tt></dt>
<dd>Maximum number of items per page</dd>
<dt><tt class="docutils literal"><span class="pre">$first_item</span></tt></dt>
<dd>Index of first item on the current page</dd>
<dt><tt class="docutils literal"><span class="pre">$last_item</span></tt></dt>
<dd>Index of last item on the current page</dd>
<dt><tt class="docutils literal"><span class="pre">$item_count</span></tt></dt>
<dd>Total number of items</dd>
<dt><tt class="docutils literal"><span class="pre">$link_first</span></tt></dt>
<dd>Link to first page (unless this is the first page)</dd>
<dt><tt class="docutils literal"><span class="pre">$link_last</span></tt></dt>
<dd>Link to last page (unless this is the last page)</dd>
<dt><tt class="docutils literal"><span class="pre">$link_previous</span></tt></dt>
<dd>Link to previous page (unless this is the first page)</dd>
<dt><tt class="docutils literal"><span class="pre">$link_next</span></tt></dt>
<dd>Link to next page (unless this is the last page)</dd>
</dl>
<p id="index-1097">Because these variables look a bit like Mako variables, you might be tempted to think you can put other template markup in the format string to <tt class="docutils literal"><span class="pre">.pager()</span></tt>, but in fact you can use only these variables.</p>
<p>Figure 8-5 shows a page generated with the paginator-enhanced code.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0805.png"><img alt="Figure 8-5. The paginator in action" src="_images/9349f0805.png" /></a>
<p class="caption">Figure 8-5. The paginator in action</p>
</div>
</div>
<div class="section" id="formatting-dates-and-times">
<h2>Formatting Dates and Times<a class="headerlink" href="#formatting-dates-and-times" title="Permalink to this headline">¶</a></h2>
<p id="index-1098">To get the date to display in the way it does in the paginator column, you made use of the fact that Python <tt class="docutils literal"><span class="pre">datetime.datetime</span></tt> objects have a <tt class="docutils literal"><span class="pre">strftime()</span></tt> method that turns a date to a string based on the arguments specified. You used <tt class="docutils literal"><span class="pre">%c</span></tt>, which tells the <tt class="docutils literal"><span class="pre">strftime()</span></tt> method to use the locale’s appropriate date and time representation. The display format is highly customizable, though, and takes the options documented in Table 8-1.</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="64%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Directive</th>
<th class="head">Meaning</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">%a</span></tt></td>
<td>Locale&#8217;s abbreviated weekday
name.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%A</span></tt></td>
<td>Locale&#8217;s full weekday name.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%b</span></tt></td>
<td>Locale&#8217;s abbreviated month
name.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%B</span></tt></td>
<td>Locale&#8217;s full month name.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%c</span></tt></td>
<td>Locale&#8217;s appropriate date and
time representation.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%d</span></tt></td>
<td>Day of the month as a decimal
number [01,31].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%H</span></tt></td>
<td>Hour (24-hour clock) as a
decimal number [00,23].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%I</span></tt></td>
<td>Hour (12-hour clock) as a
decimal number [01,12].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%j</span></tt></td>
<td>Day of the year as a decimal
number [001,366].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%m</span></tt></td>
<td>Month as a decimal number
[01,12].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%M</span></tt></td>
<td>Minute as a decimal number
[00,59].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%p</span></tt></td>
<td>Locale&#8217;s equivalent of either
AM or PM.</td>
<td>(1)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%S</span></tt></td>
<td>Second as a decimal number
[00,61].</td>
<td>(2)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%U</span></tt></td>
<td>Week number of the year
(Sunday as the first day of
the week) as a decimal number
[00,53].  All days in a new
year preceding the first
Sunday are considered to be in
week 0.</td>
<td>(3)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%w</span></tt></td>
<td>Weekday as a decimal number
[0(Sunday),6].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%W</span></tt></td>
<td>Week number of the year
(Monday as the first day of
the week) as a decimal number
[00,53].  All days in a new
year preceding the first
Monday are considered to be in
week 0.</td>
<td>(3)</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%x</span></tt></td>
<td>Locale&#8217;s appropriate date
representation.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%X</span></tt></td>
<td>Locale&#8217;s appropriate time
representation.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%y</span></tt></td>
<td>Year without century as a
decimal number [00,99].</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%Y</span></tt></td>
<td>Year with century as a decimal
number.</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%Z</span></tt></td>
<td>Time zone name (no characters
if no time zone exists).</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">%%</span></tt></td>
<td>A literal <tt class="docutils literal"><span class="pre">'%'</span></tt> character.</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ol class="arabic simple">
<li>When used with the <tt class="xref docutils literal"><span class="pre">strptime()</span></tt> function, the <tt class="docutils literal"><span class="pre">%p</span></tt> directive only affects
the output hour field if the <tt class="docutils literal"><span class="pre">%I</span></tt> directive is used to parse the hour.</li>
<li>The range really is <tt class="docutils literal"><span class="pre">0</span></tt> to <tt class="docutils literal"><span class="pre">61</span></tt>; this accounts for leap seconds and the
(very rare) double leap seconds.</li>
<li>When used with the <tt class="xref docutils literal"><span class="pre">strptime()</span></tt> function, <tt class="docutils literal"><span class="pre">%U</span></tt> and <tt class="docutils literal"><span class="pre">%W</span></tt> are only used in
calculations when the day of the week and the year are specified.</li>
</ol>
<p>Table 8-1. Python Date and Time Formatting Directives</p>
</div>
<div class="section" id="using-sessions-and-a-flash-message">
<h2>Using Sessions and a Flash Message<a class="headerlink" href="#using-sessions-and-a-flash-message" title="Permalink to this headline">¶</a></h2>
<p id="index-1099">One of the problems with the setup you have so far is that no notification is displayed to confirm that changes have been successfully saved after you’ve edited a page. As was hinted at earlier in the chapter, you can solve this problem by using Pylons’ session-handling facilities to display a <em>flash message</em>.</p>
<p id="index-1100">Session handling is actually provided in Pylons by the Beaker package set up as middleware, and it can be configured in your <tt class="docutils literal"><span class="pre">development.ini</span></tt> file. By default, session information is stored in a <tt class="docutils literal"><span class="pre">sessions</span></tt> directory within the directory specified by the <tt class="docutils literal"><span class="pre">cache_dir</span></tt> option. This means that by default sessions are stored in your project’s <tt class="docutils literal"><span class="pre">data/sessions</span></tt> directory.</p>
<p>Start by importing the <tt class="docutils literal"><span class="pre">session</span></tt> object into the page controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">session</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">session</span></tt> object exposes a dictionary-like interface that allows you to attach any Python object that can be pickled (see <a class="reference external" href="http://docs.python.org/lib/module-pickle.html">http://docs.python.org/lib/module-pickle.html</a>) as a value against a named key. After a call to <tt class="docutils literal"><span class="pre">session.save()</span></tt>, the session information is saved, and a cookie is automatically set. On subsequent requests, the Beaker middleware can read the session cookie, and you can then access the value against the named key.</p>
<p>In the <tt class="docutils literal"><span class="pre">save()</span></tt> action, you simply need to add the following lines before the redirect at the end of the action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">session</span><span class="p">[</span><span class="s">&#39;flash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Page successfully updated.&#39;</span>
<span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-1101">Now the message will be saved to the <tt class="docutils literal"><span class="pre">flash</span></tt> key. Then in the base template, you’ll need some code to look up the <tt class="docutils literal"><span class="pre">flash</span></tt> key and display the message if one exists. Add the following to the end of <tt class="docutils literal"><span class="pre">templates/base/index.html</span></tt>:</p>
<div class="highlight-python"><pre>&lt;%def name="flash()"&gt;
    % if session.has_key('flash'):
    &lt;div id="flash"&gt;&lt;p&gt;${session.get('flash')}&lt;/p&gt;&lt;/div&gt;
    &lt;%
        del session['flash']
        session.save()
    %&gt;
    % endif
&lt;/%def&gt;</pre>
</div>
<p>Now add this in the same template before the call to <tt class="docutils literal"><span class="pre">${next.body()}</span></tt>:</p>
<div class="highlight-python"><pre>${self.flash()}</pre>
</div>
<p>Let’s also add some style so the message is properly highlighted. Add this to the <tt class="docutils literal"><span class="pre">public/css/main.css</span></tt> file:</p>
<div class="highlight-python"><pre>#flash {
    background: #ffc;
    padding: 5px;
    border: 1px dotted #000;
    margin-bottom: 20px;
}
#flash p { margin: 0px; padding: 0px; }</pre>
</div>
<p id="index-1102">Now when the <tt class="docutils literal"><span class="pre">save()</span></tt> action is called, the message is saved in the session so that when the browser is redirected to the <tt class="docutils literal"><span class="pre">view()</span></tt> page, the message can be read back and displayed on the screen.</p>
<p>Give it a go by editing and saving a page (see Figure 8-6).</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0806.png"><img alt="Figure 8-6. The flash message in action" src="_images/9349f0806.png" /></a>
<p class="caption">Figure 8-6. The flash message in action</p>
</div>
<p id="index-1103">You can find more information about Pylons sessions at <a class="reference external" href="http://docs.pylonshq.com/sessions.html">http://docs.pylonshq.com/sessions.html</a>.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p id="index-1104">That’s it! You have created a very simple working web page editor. Now, although the site so far does everything you set out for it to do and forms a very good basis for any application you might create yourself, you’ll probably agree it isn’t overly exciting. In the rest of the book, you’ll change that by adding a comment system, a tagging facility, a navigation hierarchy, a hint of Ajax, and a set of navigation widgets. By the end of the book, you’ll have a template project that will serve very well as a basis for many of your own projects, and you will understand many of the key principles you will need to write your own Pylons applications.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 8: Starting the SimpleSite Tutorial</a><ul>
<li><a class="reference external" href="#getting-started-with-simplesite">Getting Started with SimpleSite</a></li>
<li><a class="reference external" href="#exploring-the-template-structure">Exploring the Template Structure</a></li>
<li><a class="reference external" href="#using-sqlalchemy-in-pylons">Using SQLAlchemy in Pylons</a><ul>
<li><a class="reference external" href="#configuring-the-engine">Configuring the Engine</a></li>
<li><a class="reference external" href="#creating-the-model">Creating the Model</a></li>
<li><a class="reference external" href="#creating-the-database-tables">Creating the Database Tables</a></li>
<li><a class="reference external" href="#querying-data">Querying Data</a></li>
<li><a class="reference external" href="#understanding-the-role-of-the-base-controller">Understanding the Role of the Base Controller</a></li>
<li><a class="reference external" href="#using-a-sqlalchemy-session-in-pylons">Using a SQLAlchemy Session in Pylons</a></li>
</ul>
</li>
<li><a class="reference external" href="#updating-the-controller-to-support-editing-pages">Updating the Controller to Support Editing Pages</a><ul>
<li><a class="reference external" href="#view">view()</a></li>
<li><a class="reference external" href="#new">new()</a></li>
<li><a class="reference external" href="#create">create()</a></li>
<li><a class="reference external" href="#edit-and-save">edit() and save()</a></li>
<li><a class="reference external" href="#list">list()</a></li>
<li><a class="reference external" href="#delete">delete()</a></li>
</ul>
</li>
<li><a class="reference external" href="#updating-the-footer">Updating the Footer</a></li>
<li><a class="reference external" href="#using-pagination">Using Pagination</a></li>
<li><a class="reference external" href="#formatting-dates-and-times">Formatting Dates and Times</a></li>
<li><a class="reference external" href="#using-sessions-and-a-flash-message">Using Sessions and a Flash Message</a></li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="introducing-the-model-and-sqlalchemy.html"
                                  title="previous chapter">Chapter 7: Introducing the Model and SQLAlchemy</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="urls-routing-and-dispatch.html"
                                  title="next chapter">Chapter 9: URLs, Routing and Dispatch</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/starting-the-simplesite-tutorial.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="urls-routing-and-dispatch.html" title="Chapter 9: URLs, Routing and Dispatch"
             >next</a> |</li>
        <li class="right" >
          <a href="introducing-the-model-and-sqlalchemy.html" title="Chapter 7: Introducing the Model and SQLAlchemy"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/starting-the-simplesite-tutorial.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:42:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>