<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from pylonsbook.com/en/1.0/simplesite-tutorial-part-3.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:43:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 19: SimpleSite Tutorial Part 3 &mdash; Pylons Book v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.0 documentation" href="index.html" />
    <link rel="next" title="Chapter 20: Logging" href="logging.html" />
    <link rel="prev" title="Chapter 18: Authentication and Authorization" href="authentication-and-authorization.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="logging.html" title="Chapter 20: Logging"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="authentication-and-authorization.html" title="Chapter 18: Authentication and Authorization"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-19-simplesite-tutorial-part-3">
<h1>Chapter 19: SimpleSite Tutorial Part 3<a class="headerlink" href="#chapter-19-simplesite-tutorial-part-3" title="Permalink to this headline">¶</a></h1>
<p id="index-932">In this final part of the SimpleSite tutorial, you’ll add authentication and authorization facilities to SimpleSite so that only registered users can edit pages and so that only administrators can move pages or sections around or delete them.</p>
<p>After the authentication and authorization facilities are in place, you’ll learn how to customize Pylons’ error pages so that they use the same templates as the rest of SimpleSite. At that point, you’ll learn how to package up an application and publish it on the Python Package Index. Finally, you’ll turn the whole SimpleSite project into a project template (similar to the Pylons template you are used to using to with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span> <span class="pre">--template</span></tt> command) so that other people can use it as a basis for their own projects.</p>
<p>There’s a lot to do, so let’s get started!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is some code in Chapters 15 and 16 related to SimpleSite that handles animating the flash message, includes some extra CSS, and handles populating the <tt class="docutils literal"><span class="pre">before</span></tt> field drop-down list with Ajax. You should add this to your project before continuing with the tutorial or download the source code for the beginning of this chapter from the Apress website.</p>
</div>
<div class="section" id="authentication-and-authorization">
<h2>Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permalink to this headline">¶</a></h2>
<p id="index-933">In the first part of this chapter, you’ll use AuthKit to add authentication and authorization facilities to the SimpleSite project. If you haven’t already installed AuthKit, you should do so now with this command:</p>
<div class="highlight-python"><pre>$ easy_install "AuthKit&gt;=0.4.3,&lt;=0.4.99"</pre>
</div>
<div class="section" id="setting-up-the-middleware">
<h3>Setting Up the Middleware<a class="headerlink" href="#setting-up-the-middleware" title="Permalink to this headline">¶</a></h3>
<p id="index-934">You’ll remember from Chapter 18 that the first thing you need to do to use AuthKit in a Pylons application is to set up the AuthKit authentication middleware. Edit <tt class="docutils literal"><span class="pre">config/middleware.py</span></tt>, and add the following import at the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">authkit.authenticate</span>
</pre></div>
</div>
<p>Then add the AuthKit middleware immediately before the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware (shown here in line 9):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></td><td class="code"><div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">RoutesMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;routes.map&#39;</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">SessionMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">CacheMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">full_stack</span><span class="p">):</span>
    <span class="c"># Handle Python exceptions</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;pylons.errorware&#39;</span><span class="p">])</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">authkit</span><span class="o">.</span><span class="n">authenticate</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">app_conf</span><span class="p">)</span>

    <span class="c"># Display error documents for 401, 403, 404 status codes (and</span>
    <span class="c"># 500 when debug is disabled)</span>
    <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">StatusCodeRedirect</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="p">[</span><span class="mf">400</span><span class="p">,</span> <span class="mf">401</span><span class="p">,</span> <span class="mf">403</span><span class="p">,</span> <span class="mf">404</span><span class="p">,</span> <span class="mf">500</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you find you have a conflict with the version of Pylons you are using or if you are using a configuration with the <tt class="docutils literal"><span class="pre">full_stack</span></tt> option set to <tt class="docutils literal"><span class="pre">false</span></tt>, set the AuthKit middleware up after the <tt class="docutils literal"><span class="pre">Cascade</span></tt>, just before the <tt class="docutils literal"><span class="pre">make_app()</span></tt> function returns <tt class="docutils literal"><span class="pre">app</span></tt>.</p>
</div>
<p id="index-935">AuthKit comes with a SQLAlchemy driver that can be used to store AuthKit user information in a relational database. The driver requires slightly more configuration to integrate it into a Pylons project than the file-based <tt class="docutils literal"><span class="pre">UsersFromFile</span></tt> driver you saw in the previous chapter but is still fairly straightforward. First you’ll need to edit your <tt class="docutils literal"><span class="pre">development.ini</span></tt> file so that these lines appear at the end of the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section:</p>
<div class="highlight-python"><pre>authkit.setup.enable = true
authkit.setup.method = form, cookie
authkit.form.authenticate.user.type = authkit.users.sqlalchemy_driver:UsersFromDatabase
authkit.form.authenticate.user.data = simplesite.model
authkit.cookie.secret = secret string
authkit.cookie.signoutpath = /signout</pre>
</div>
<p>These options tell AuthKit that you are going to be using a SQLAlchemy database to manage the users and that the SQLAlchemy model used by the rest of your Pylons application is defined in the <tt class="docutils literal"><span class="pre">simplesite.model</span></tt> module.</p>
<p>AuthKit will expect the model to be set up in the standard way described in Chapter 7 with a <tt class="docutils literal"><span class="pre">Session</span></tt> object and the <tt class="docutils literal"><span class="pre">meta</span></tt> module present. It will add its own tables and classes to the model automatically during the first request, so you don’t need to manually change the model to use the new SQLAlchemy tables.</p>
<p id="index-936">To make it harder for someone to guess a user’s cookie, you should always set a new string for the <tt class="docutils literal"><span class="pre">authkit.cookie.secret</span></tt> option. Using the same string as the example (which is <tt class="docutils literal"><span class="pre">secret</span> <span class="pre">string</span></tt>) isn’t very secure.</p>
</div>
<div class="section" id="adjusting-websetup-py">
<h3>Adjusting websetup.py<a class="headerlink" href="#adjusting-websetup-py" title="Permalink to this headline">¶</a></h3>
<p id="index-937">At this point, the middleware is correctly configured, but the database tables AuthKit requires don’t exist yet. You’ll need to change SimpleSite’s <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file so that these tables are created at the same time as any other tables used by your model.</p>
<p>First add the following import to the top of the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">authkit.users.sqlalchemy_driver</span> <span class="kn">import</span> <span class="n">UsersFromDatabase</span>
</pre></div>
</div>
<p>Then after these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Load the models</span>
<span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>
<span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">engine</span>
</pre></div>
</div>
<p>add these lines to add the AuthKit classes and mappers to the model:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding the AuthKit model...&quot;</span><span class="p">)</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">UsersFromDatabase</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p>Next you’ll need to add some users and roles to the application. After these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create the tables if they aren&#39;t there already</span>
<span class="n">meta</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>add these:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding roles and uses...&quot;</span><span class="p">)</span>

<span class="n">users</span><span class="o">.</span><span class="n">role_create</span><span class="p">(</span><span class="s">&quot;delete&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="o">.</span><span class="n">user_create</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="o">.</span><span class="n">user_create</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;opensesame&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="o">.</span><span class="n">user_add_role</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s">&quot;delete&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>While you are updating the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file, it also makes sense to add a default set of tags so that users can begin tagging pages. Although it doesn’t have anything to do with AuthKit, add these Pylons-related tags by adding these lines after the ones earlier:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding tags...&quot;</span><span class="p">)</span>

<span class="n">tag1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">()</span>
<span class="n">tag1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Pylons&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag1</span><span class="p">)</span>

<span class="n">tag2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">()</span>
<span class="n">tag2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Paste&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag2</span><span class="p">)</span>

<span class="n">tag3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">()</span>
<span class="n">tag3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Tutorial&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag3</span><span class="p">)</span>

<span class="n">tag4</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">()</span>
<span class="n">tag4</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Database&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag4</span><span class="p">)</span>

<span class="n">tag5</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Tag</span><span class="p">()</span>
<span class="n">tag5</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">u&#39;Recipe&#39;</span>
<span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag5</span><span class="p">)</span>
</pre></div>
</div>
<p>With the changes in place, you will need to drop the database you’ve been using so far or change the config file to use a new database so that you can set up the new AuthKit tables. Re-create the database with this command:</p>
<div class="highlight-python"><pre>$ paster setup-app development.ini
Running setup_config() from simplesite.websetup
22:30:49,808 INFO  [simplesite.websetup] Adding the AuthKit model...
... omitted log output for brevity ...
22:30:50,076 INFO  [simplesite.websetup] Successfully set up.</pre>
</div>
<p>If you are using the <tt class="docutils literal"><span class="pre">filter-with</span></tt> option in <tt class="docutils literal"><span class="pre">[app:main]</span></tt> you&#8217;ll need to disable it to create the database. If all goes well and you see the <tt class="docutils literal"><span class="pre">Successfully</span> <span class="pre">set</span> <span class="pre">up</span></tt> message, you should find the new tables have been successfully created. If you use a command-line tool to inspect the database, you will notice that there are some new tables used by AuthKit, including <tt class="docutils literal"><span class="pre">users</span></tt>, <tt class="docutils literal"><span class="pre">roles</span></tt>, <tt class="docutils literal"><span class="pre">groups</span></tt>, and <tt class="docutils literal"><span class="pre">user_roles</span></tt>:</p>
<div class="highlight-python"><pre>$ sqlite3 development.db
SQLite version 3.4.2
Enter ".help" for instructions
sqlite&gt; .tables
comment      nav          pagetag      section      users
groups       page         roles        tag          users_roles</pre>
</div>
</div>
<div class="section" id="protecting-controller-actions">
<h3>Protecting Controller Actions<a class="headerlink" href="#protecting-controller-actions" title="Permalink to this headline">¶</a></h3>
<p id="index-938">Now that AuthKit is set up, let’s think about how it should be used in the SimpleSite application. Over the following sections, you’ll add functionality that allows anyone to create pages and sections but allows only signed-in users to edit or move them. Only users with the <tt class="docutils literal"><span class="pre">delete</span></tt> role should be able to delete pages or sections, edit comments, or rename tags.</p>
<p id="index-939">Let’s start by ensuring only people who are signed in can edit pages. To do this, you need to add a <tt class="docutils literal"><span class="pre">ValidAuthKitUser()</span></tt> permission to the <tt class="docutils literal"><span class="pre">page</span></tt> controller’s <tt class="docutils literal"><span class="pre">edit</span></tt> action. Add the following imports at the top of the <tt class="docutils literal"><span class="pre">page.py</span></tt> controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">authkit.permissions</span> <span class="kn">import</span> <span class="n">ValidAuthKitUser</span>
<span class="kn">from</span> <span class="nn">authkit.authorize.pylons_adaptors</span> <span class="kn">import</span> <span class="n">authorize</span>
</pre></div>
</div>
<p>Then add an authorize decorator before the <tt class="docutils literal"><span class="pre">edit()</span></tt> action so that it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@authorize</span><span class="p">(</span><span class="n">ValidAuthKitUser</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Let’s start the server and see what happens:</p>
<div class="highlight-python"><pre>$ paster serve --reload development.ini</pre>
</div>
<p>If you are following along from the previous chapter, close your browser to clear any AuthKit session cookies you might still have from the previous application, and visit <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a>. You will be able to see the front page as usual (albeit with the extra tags), but if you click the Edit Page link at the bottom, you will be shown the AuthKit sign-in page you saw in Figure 18-1. Sign in with the username <tt class="docutils literal"><span class="pre">foo</span></tt> and the password <tt class="docutils literal"><span class="pre">bar</span></tt>, which were set up in the <tt class="docutils literal"><span class="pre">websetup.py</span></tt> file.</p>
<p>Once you are signed in, you can then see the edit page as usual, and because AuthKit auto-matically sets a cookie, on each subsequent request you will also be able to edit pages too because AuthKit can read the cookie to find out which user is signed in.</p>
<p id="index-940">So far, you have protected the <tt class="docutils literal"><span class="pre">edit()</span></tt> action only, but it is the <tt class="docutils literal"><span class="pre">save()</span></tt> action that actually modifies the database, so currently a malicious user could still make changes to pages if they knew that there was a <tt class="docutils literal"><span class="pre">save()</span></tt> action. You’d better protect <tt class="docutils literal"><span class="pre">save()</span></tt> too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@authorize</span><span class="p">(</span><span class="n">ValidAuthKitUser</span><span class="p">())</span>
<span class="nd">@restrict</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">NewPageForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The decorators on both the <tt class="docutils literal"><span class="pre">edit()</span></tt> and <tt class="docutils literal"><span class="pre">save()</span></tt> actions use a different instance of the <tt class="docutils literal"><span class="pre">ValidAuthKitUser</span></tt> permission class, but AuthKit permission objects are designed to be used multiple times; therefore, a better way of organizing permissions is in their own module. Add a new file to the <tt class="docutils literal"><span class="pre">lib</span></tt> directory called <tt class="docutils literal"><span class="pre">auth.py</span></tt>, and add the following code to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">authkit.permissions</span> <span class="kn">import</span> <span class="n">ValidAuthKitUser</span>
<span class="n">is_valid_user</span> <span class="o">=</span> <span class="n">ValidAuthKitUser</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next section, you’ll need to access the <tt class="docutils literal"><span class="pre">is_valid_user</span></tt> permission in the templates as well as the controllers, so it makes sense to import the whole <tt class="docutils literal"><span class="pre">auth</span></tt> module into the <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> so that permissions can be easily accessed via <tt class="docutils literal"><span class="pre">h.auth</span></tt>, for example, as <tt class="docutils literal"><span class="pre">h.auth.is_valid_user</span></tt>. Add this to the end of the helper imports:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">simplesite.lib</span> <span class="kn">import</span> <span class="n">auth</span>
</pre></div>
</div>
<p>Now you can update the <tt class="docutils literal"><span class="pre">&#64;authorize</span></tt> decorators in the page controller to look like this:</p>
<div class="highlight-python"><pre>@authorize(h.auth.is_valid_user)</pre>
</div>
<p id="index-941">You can also remove the import of the <tt class="docutils literal"><span class="pre">ValidAuthKitUser</span></tt> from the page controller if you like because it isn’t needed now, thanks to the addition of the permissions to the helpers module.</p>
<p id="index-942">Although all signed-in users should be able to create new pages and edit existing ones, only users with the <tt class="docutils literal"><span class="pre">delete</span></tt> role should be able to delete pages. You’ll need to create a different permission object to handle this condition. Add the following line to <tt class="docutils literal"><span class="pre">lib/auth.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">has_delete_role</span> <span class="o">=</span> <span class="n">HasAuthKitRole</span><span class="p">([</span><span class="s">&#39;delete&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>You’ll also need to add this import at the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">authkit.permissions</span> <span class="kn">import</span> <span class="n">HasAuthKitRole</span>
</pre></div>
</div>
<p>Now edit the page controller’s <tt class="docutils literal"><span class="pre">delete()</span></tt> action so that it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@authorize</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">has_delete_role</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p id="index-943">If you try to delete a page while still being signed in as the user <tt class="docutils literal"><span class="pre">foo</span></tt>, you will be shown the Pylons 403 Forbidden page because although you are signed in, you don’t have permission to access the resource, so AuthKit triggers a 403 response that the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware will intercept to produce the error document (see Figure 19-1).</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1901.png"><img alt="Figure 19-1. The Pylons 403 Forbidden error document" src="_images/9349f1901.png" /></a>
<p class="caption">Figure 19-1. The Pylons 403 Forbidden error document</p>
</div>
<p id="index-944">Now that you’ve tested the permissions as user <tt class="docutils literal"><span class="pre">foo</span></tt>, close the browser, and open it again at <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a>. This will clear the AuthKit cookie and hence sign out the user <tt class="docutils literal"><span class="pre">foo</span></tt>. Now visit <a class="reference external" href="http://localhost:5000/page/edit/6">http://localhost:5000/page/edit/6</a> to edit the home page. Once again, you will be asked to sign in. This time sign in with the username <tt class="docutils literal"><span class="pre">admin</span></tt> and the password <tt class="docutils literal"><span class="pre">opensesame</span></tt> that you also set up in <tt class="docutils literal"><span class="pre">websetup.py</span></tt>. You’ll now find you have permission to delete pages because the <tt class="docutils literal"><span class="pre">admin</span></tt> user has the <tt class="docutils literal"><span class="pre">delete</span></tt> role.</p>
</div>
<div class="section" id="changing-templates-based-on-permissions">
<h3>Changing Templates Based on Permissions<a class="headerlink" href="#changing-templates-based-on-permissions" title="Permalink to this headline">¶</a></h3>
<p id="index-945">Now that users who aren’t signed in can’t edit pages, it isn’t sensible to show them the Edit Page link. Once again, you can use AuthKit, but this time, you’ll use the <tt class="docutils literal"><span class="pre">authorized()</span></tt> function, which returns <tt class="xref docutils literal"><span class="pre">True</span></tt> if the user has the permission specified and <tt class="xref docutils literal"><span class="pre">False</span></tt> otherwise.</p>
<p>Let’s add this function to the <tt class="docutils literal"><span class="pre">lib/auth.py</span></tt> file so that it can easily be accessed as <tt class="docutils literal"><span class="pre">h.auth.authorized()</span></tt> from the project’s templates:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">authkit.authorize.pylons_adaptors</span> <span class="kn">import</span> <span class="n">authorized</span>
</pre></div>
</div>
<p>Now you can update the <tt class="docutils literal"><span class="pre">derived/page/view.html</span></tt> template so that the Edit Page link looks like this:</p>
<div class="highlight-python"><pre>% if h.auth.authorized(h.auth.is_valid_user):
| &lt;a href="${h.url_for(controller='page', action='edit', id=c.page.id)}"&gt;Edit
Page&lt;/a&gt;
% endif</pre>
</div>
<p id="index-946">When a user is signed in, they will now see the Edit Page link, and when they are not, they won’t. This isn’t too easy to test yet, so let’s add some facilities for signing in and out more easily first.</p>
</div>
<div class="section" id="signing-in-and-signing-out">
<h3>Signing In and Signing Out<a class="headerlink" href="#signing-in-and-signing-out" title="Permalink to this headline">¶</a></h3>
<p id="index-947">When you added the AuthKit configuration to the config file, you specified the option <tt class="docutils literal"><span class="pre">authkit.cookie.signoutpath</span> <span class="pre">=</span> <span class="pre">/signout</span></tt>. This means that when a user visits the path <tt class="docutils literal"><span class="pre">/signout</span></tt>, the AuthKit cookie will be removed, and they will be signed out. Try visiting <a class="reference external" href="http://localhost:5000/signout">http://localhost:5000/signout</a> now. You’ll be shown the standard Create Page screen, but when you try to browse the site again, you’ll see that you’ve been signed out by the AuthKit middleware because the URL you visited matched the value of the <tt class="docutils literal"><span class="pre">authkit.cookie.signoutpath</span></tt> option in the config file.</p>
<p>Let’s add a new controller to the application to specifically handle signing in and signing out. Call this controller <tt class="docutils literal"><span class="pre">account</span></tt> because it could eventually be extended to handle other account functionality. Add it like this:</p>
<div class="highlight-python"><pre>$ paster controller account</pre>
</div>
<p id="index-948">Edit the skeleton account controller in <tt class="docutils literal"><span class="pre">controllers/account.py</span></tt> so that it has the following two actions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AccountController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">signin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_USER&#39;</span><span class="p">):</span>
            <span class="c"># This triggers the AuthKit middleware into displaying the sign-in form</span>
            <span class="n">abort</span><span class="p">(</span><span class="mf">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/account/signedin.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">signout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The actual removal of the AuthKit cookie occurs when the response passes</span>
        <span class="c"># through the AuthKit middleware, we simply need to display a page</span>
        <span class="c"># confirming the user is signed out</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/account/signedout.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>When a user is signed in, AuthKit sets the environment variable <tt class="docutils literal"><span class="pre">REMOTE_USER</span></tt> to contain the user’s username. The <tt class="docutils literal"><span class="pre">signin()</span></tt> action checks this to see whether it is present. If it isn’t, it aborts with a 401 response to trigger AuthKit to prompt the user to sign in.</p>
<p id="index-949">Once a user is signed in, the <tt class="docutils literal"><span class="pre">signedin.html</span></tt> template is rendered. Create the <tt class="docutils literal"><span class="pre">templates/derived/account</span></tt> directory, and add the <tt class="docutils literal"><span class="pre">signedin.html</span></tt> template to it with the following content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Signed In&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Signed In&lt;/h1&gt;&lt;/%def&gt;

&lt;p&gt;You are signed in as ${request.environ['REMOTE_USER']}.
&lt;a href="${h.url_for(controller='account', action='signout')}"&gt;Sign out&lt;/a&gt;&lt;/p&gt;</pre>
</div>
<p id="index-950">Next you’ll need to add the <tt class="docutils literal"><span class="pre">signedout.html</span></tt> template to the <tt class="docutils literal"><span class="pre">account</span></tt> directory too with the following content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Signed Out&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Signed Out&lt;/h1&gt;&lt;/%def&gt;

&lt;p&gt;You have been signed out.&lt;/p&gt;</pre>
</div>
<p>Now you need to modify the routes so that the path <tt class="docutils literal"><span class="pre">/signin</span></tt> points to the <tt class="docutils literal"><span class="pre">signin()</span></tt> action and the path <tt class="docutils literal"><span class="pre">signout()</span></tt> points to the <tt class="docutils literal"><span class="pre">signout()</span></tt> action. Add the following named routes immediately after the <tt class="docutils literal"><span class="pre">#</span> <span class="pre">CUSTOM</span> <span class="pre">ROUTES</span> <span class="pre">HERE</span></tt> line in <tt class="docutils literal"><span class="pre">config/routing.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;signout&#39;</span><span class="p">,</span> <span class="s">&#39;/signout&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;signout&#39;</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;signin&#39;</span><span class="p">,</span> <span class="s">&#39;/signin&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;signin&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s add an extra line to the header so it contains a link to the <tt class="docutils literal"><span class="pre">signin()</span></tt> action when you are not signed in and contains your username and a link to the <tt class="docutils literal"><span class="pre">signout()</span></tt> action when you are signed in. Modify the <tt class="docutils literal"><span class="pre">base/index.html</span></tt> template so that the header has the extra links. Lines 6-14 are the ones you need to change:</p>
<div class="highlight-mako"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><div class="highlight"><pre><span class="x">&lt;div id=&quot;hd&quot;&gt;</span>
<span class="x">    &lt;div class=&quot;yui-gc&quot;&gt;</span>
<span class="x">        &lt;div class=&quot;yui-u first&quot;&gt;</span>
<span class="x">            </span><span class="cp">${</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">        &lt;div class=&quot;yui-u&quot;&gt;</span>
            <span class="cp">%</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authorized</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">is_valid_user</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="x"></span>
<span class="x">               request.urlvars[&#39;controller&#39;] == &#39;account&#39; and request.urlvars[&#39;action&#39;] == &#39;signout&#39;):</span>
<span class="x">                &lt;p&gt;Signed in as </span><span class="cp">${</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;REMOTE_USER&#39;</span><span class="p">]</span><span class="cp">}</span><span class="x">,</span>
<span class="x">                    &lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;signout&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Sign out&lt;/a&gt;&lt;/p&gt;</span>
            <span class="cp">%</span> <span class="k">else</span><span class="p">:</span><span class="x"></span>
<span class="x">                &lt;p&gt;&lt;a href=&quot;</span><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;signin&#39;</span><span class="p">)</span><span class="cp">}</span><span class="x">&quot;&gt;Sign in&lt;/a&gt;&lt;/p&gt;</span>
            <span class="cp">%</span><span class="k"> endif</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    </span><span class="cp">${</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="x">    </span><span class="cp">${</span><span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="p">()</span><span class="cp">}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div>
<p id="index-951">Because you don’t want the “Signed in as...” message on the signed-out page, you have to test the routing variables to ensure that the user isn’t on the signed-out page. The routing variables are always available as the <tt class="docutils literal"><span class="pre">request.urlvars</span></tt> dictionary, which can be useful if you haven’t explicitly added them to the template context global <tt class="docutils literal"><span class="pre">c</span></tt>.</p>
<p>Notice also that because you set up named routes for signing in and signing out in the <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> file, you just need to specify the name of the route when using <tt class="docutils literal"><span class="pre">h.url_for()</span></tt>, and not the routing variables as well. This is particularly handy for routes that get used a lot or for ones that don’t have any variable parts.</p>
<p>You can also add a style so that the text appears on the right. Add this to <tt class="docutils literal"><span class="pre">public/css/main.css</span></tt>:</p>
<div class="highlight-python"><pre>#hd p {
    text-align: right;
    padding-right: 20px;
    padding-top: 5px;
}</pre>
</div>
<p id="index-952">With these changes in place, you can test the sign-in and sign-out functionality. Figure 19-2 shows what the home page looks like when you are signed out. Notice the Sign In link in the top right and the fact the Edit Page link isn’t visible, because you are not signed in.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1902.png"><img alt="Figure 19-2. The updated home page" src="_images/9349f1902.png" /></a>
<p class="caption">Figure 19-2. The updated home page</p>
</div>
</div>
<div class="section" id="styling-the-sign-in-screen">
<h3>Styling the Sign-in Screen<a class="headerlink" href="#styling-the-sign-in-screen" title="Permalink to this headline">¶</a></h3>
<p id="index-953">You’ve now seen AuthKit and its user management API in action, but for a production system, you need to style the sign-in screen so that it looks like the rest of the site. AuthKit allows you to do this in two ways. The first is to provide all the HTML for the sign-in screen as a config option. In reality, though, it would be more useful if you could use the template structure you’ve set up for the rest of the pages so that if the styles in the base template were to change at some point in the future, you wouldn’t have to generate a new static version for AuthKit. Luckily, AuthKit also allows you to specify a custom function, which, when called, will generate a template dynamically. Let’s create such a function.</p>
<p>First, create a new template in <tt class="docutils literal"><span class="pre">derived/account/signin.html</span></tt> with this content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Sign In&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Sign In&lt;/h1&gt;&lt;/%def&gt;

${h.form_start('%s', method="post")}
    ${h.field(
        "Username",
        h.text(name='username'),
    )}
    ${h.field(
        "Password",
        h.password(name='password'),
    )}
    ${h.field(field=h.submit(value="Sign in", name='submit'))}
${h.form_end()}</pre>
</div>
<p>AuthKit expects the username and password to be submitted as the <tt class="docutils literal"><span class="pre">username</span></tt> and <tt class="docutils literal"><span class="pre">password</span></tt> fields, respectively, and is designed to handle a POST method. AuthKit will use Python string interpolation to replace the <tt class="docutils literal"><span class="pre">%s</span></tt> string with the URL the form needs to submit to. For this to work you&#8217;ll need to import <tt class="docutils literal"><span class="pre">password</span></tt> from the <tt class="docutils literal"><span class="pre">webhelpers.html.tags</span></tt> module into <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt>.</p>
<p>Now let’s create a new function in <tt class="docutils literal"><span class="pre">lib/auth.py</span></tt> to render it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">render_signin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/account/signin.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You’ll need to add this import to the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons.templating</span> <span class="kn">import</span> <span class="n">render_mako</span> <span class="k">as</span> <span class="n">render</span>
</pre></div>
</div>
<p id="index-954">You can then specify in the <tt class="docutils literal"><span class="pre">development.ini</span></tt> config file that, instead of using the default template, AuthKit should call the <tt class="docutils literal"><span class="pre">render_signin()</span></tt> function you created in <tt class="docutils literal"><span class="pre">simplesite.lib.auth</span></tt> to render the <tt class="docutils literal"><span class="pre">signin.html</span></tt> page. Add this to the config options:</p>
<div class="highlight-python"><pre>authkit.form.template.obj = simplesite.lib.auth:render_signin</pre>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>One potential problem with this approach is that if the HTML returned from the template contains other <tt class="docutils literal"><span class="pre">%</span></tt> characters, then the string interpolation will fail in AuthKit. In these situations, you can put a string such as <tt class="docutils literal"><span class="pre">FORM_ACTION</span></tt> in the <tt class="docutils literal"><span class="pre">signin.html</span></tt> template and then modify the <tt class="docutils literal"><span class="pre">render_signin()</span></tt> function to escape the <tt class="docutils literal"><span class="pre">%</span></tt> characters like this:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">render_signin</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/account/signin.html&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%%</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;FORM_ACTION&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
<p>Once the server has restarted, you will be able to test the new sign-in screen (see Figure 19-3), and you should find it now shares the same theme as the rest of the site.</p>
<p>Now that you can sign in and out easily, have a go at signing in as the <tt class="docutils literal"><span class="pre">admin</span></tt> user. You’ll find you can delete pages as the <tt class="docutils literal"><span class="pre">admin</span></tt> user but not as the <tt class="docutils literal"><span class="pre">foo</span></tt> user.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last" id="index-955">Previous versions of Pylons required a more complex version of the <tt class="docutils literal"><span class="pre">render_signin()</span></tt> function, so this works only with Pylons 0.9.7 or newer. This is because previous Pylons required the initialization of a component called Buffet before templates could be rendered, and this was not set up by the point in the middleware stack where AuthKit needed to access it to render the sign-in screen. Pylons 0.9.7 and newer replace Buffet with the simple render functions you learned about in Chapter 5 and that have been using throughout the book.</p>
</div>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1903.png"><img alt="Figure 19-3. The updated sign-in page" src="_images/9349f1903.png" /></a>
<p class="caption">Figure 19-3. The updated sign-in page</p>
</div>
</div>
<div class="section" id="protecting-the-rest-of-the-actions">
<h3>Protecting the Rest of the Actions<a class="headerlink" href="#protecting-the-rest-of-the-actions" title="Permalink to this headline">¶</a></h3>
<p id="index-956">Now that the edit and delete functionality for the page controller is properly protected, you need to protect the actions in the other controllers. Table 19-1 lists the permission objects you need to add to each controller action with an <tt class="docutils literal"><span class="pre">&#64;h.auth.authorize</span></tt> decorator. For this to work you&#8217;ll need to import the`` &#64;authorize`` decorator at the top of the <tt class="docutils literal"><span class="pre">lib/auth.py</span> <span class="pre">file</span></tt>. Once these permissions are added, you can continue with the tutorial.</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="31%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Controller</th>
<th class="head">Permission</th>
<th class="head">Actions</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Page</td>
<td><tt class="docutils literal"><span class="pre">h.auth.is_valid_user</span></tt></td>
<td><tt class="docutils literal"><span class="pre">edit()</span></tt>, <tt class="docutils literal"><span class="pre">save()</span></tt></td>
</tr>
<tr><td>Page</td>
<td><tt class="docutils literal"><span class="pre">h.auth.has_delete_role</span></tt></td>
<td><tt class="docutils literal"><span class="pre">delete()</span></tt>, <tt class="docutils literal"><span class="pre">list()</span></tt></td>
</tr>
<tr><td>Section</td>
<td><tt class="docutils literal"><span class="pre">h.auth.is_valid_user</span></tt></td>
<td><tt class="docutils literal"><span class="pre">edit()</span></tt>, <tt class="docutils literal"><span class="pre">save()</span></tt></td>
</tr>
<tr><td>Section</td>
<td><tt class="docutils literal"><span class="pre">h.auth.has_delete_role</span></tt></td>
<td><tt class="docutils literal"><span class="pre">delete()</span></tt></td>
</tr>
<tr><td>Tab</td>
<td><tt class="docutils literal"><span class="pre">h.auth.has_delete_role</span></tt></td>
<td><tt class="docutils literal"><span class="pre">delete()</span></tt>, <tt class="docutils literal"><span class="pre">list()</span></tt>, <tt class="docutils literal"><span class="pre">edit()</span></tt>, <tt class="docutils literal"><span class="pre">save()</span></tt></td>
</tr>
<tr><td>Comment</td>
<td><tt class="docutils literal"><span class="pre">h.auth.has_delete_role</span></tt></td>
<td><tt class="docutils literal"><span class="pre">delete()</span></tt>, <tt class="docutils literal"><span class="pre">edit()</span></tt>, <tt class="docutils literal"><span class="pre">save()</span></tt></td>
</tr>
</tbody>
</table>
<p>Table 19-1. The Controller Actions and Their Associated Permissions</p>
<p>With this setup and in line with the original requirements, anyone can now create pages and sections, but only signed-in users can edit or move them. Only users with the <tt class="docutils literal"><span class="pre">delete</span></tt> role can delete pages or sections, edit comments, or rename tags.</p>
<p id="index-957">With this in mind, let’s update the <tt class="docutils literal"><span class="pre">page/view.html</span></tt> footer so that people are shown the links only for functionality they are entitled to use. The finished footer looks like this:</p>
<div class="highlight-python"><pre>&lt;%def name="footer()"&gt;
## Then add our page links
&lt;p&gt;
% if h.auth.authorized(h.auth.has_delete_role):
  &lt;a href="${h.url_for(controller='page', action='list')}"&gt;All Pages&lt;/a&gt; |
% endif
&lt;a href="${h.url_for(controller='page', action='new', section=c.page.section,
before=c.page.before)}"&gt;New Page&lt;/a&gt;
% if h.auth.authorized(h.auth.is_valid_user):
| &lt;a href="${h.url_for(controller='page', action='edit', id=c.page.id)}"&gt;Edit
Page&lt;/a&gt;
% endif
% if h.auth.authorized(h.auth.has_delete_role):
| &lt;a href="${h.url_for(controller='page', action='delete', id=c.page.id)}"&gt;Delete
Page&lt;/a&gt;
% endif
&lt;/p&gt;
## Comment links
&lt;p&gt;
  &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='list')}"
&gt;Comments (${str(c.comment_count)})&lt;/a&gt;
| &lt;a href="${h.url_for(pageid=c.page.id, controller='comment', action='new')}"
&gt;Add Comment&lt;/a&gt;
&lt;/p&gt;
## Section links
&lt;p&gt;
  &lt;a href="${h.url_for(controller='section', action='new', section=c.page.section,
before=c.page.before)}"&gt;New Section&lt;/a&gt;
% if h.auth.authorized(h.auth.is_valid_user):
| &lt;a href="${h.url_for(controller='section', action='edit', id=c.page.section)}"
&gt;Edit Section&lt;/a&gt;
% endif
% if h.auth.authorized(h.auth.has_delete_role):
| &lt;a href="${h.url_for(controller='section', action='delete', id=c.page.section)}"
&gt;Delete Section and Index Page&lt;/a&gt;
% endif
&lt;/p&gt;
## Tag links
&lt;p&gt;
% if h.auth.authorized(h.auth.has_delete_role):
&lt;a href="${h.url_for(controller='tag', action='list')}"&gt;All Tags&lt;/a&gt;
|
% endif
&lt;a href="${h.url_for(controller='tag', action='new')}"&gt;Add Tag&lt;/a&gt;&lt;/p&gt;
## Include the parent footer too
${parent.footer()}
&lt;/%def&gt;</pre>
</div>
<p id="index-958">Finally, let’s update the <tt class="docutils literal"><span class="pre">base/index.html</span></tt> template’s footer so that there is always a link back to the home page available:</p>
<div class="highlight-python"><pre>&lt;%def name="footer()"&gt;
    &lt;p&gt;
        &lt;a href="${h.url_for('/')}"&gt;[Home]&lt;/a&gt; |
        &lt;a href="#top"&gt;Top ^&lt;/a&gt;
    &lt;/p&gt;
&lt;/%def&gt;</pre>
</div>
<p id="index-959">Notice the use of the explicit URL in the <tt class="docutils literal"><span class="pre">href</span></tt> attribute because you always want the link to point to the root of the site, no matter which page or section that serves. This still takes advantage of Routes’ ability to adjust URLs for you if the application is mounted at a nonroot URL.</p>
</div>
<div class="section" id="using-the-authkit-user-management-api">
<h3>Using the AuthKit User Management API<a class="headerlink" href="#using-the-authkit-user-management-api" title="Permalink to this headline">¶</a></h3>
<p id="index-960">At this point, all the permissions are set up, but in real life you might want to add a new user to the system or perhaps change a user’s roles. You could do that by altering <tt class="docutils literal"><span class="pre">websetup.py</span></tt> and re-creating the database, but that would result in all your data being lost. Another solution would be to manually alter the data in the AuthKit tables using SQL, or you could even create your own interface for managing users. For the moment, though, let’s use the Pylons interactive shell.</p>
<p>Start the interactive shell like this:</p>
<div class="highlight-python"><pre>$ paster shell development.ini</pre>
</div>
<p>AuthKit automatically adds a <tt class="docutils literal"><span class="pre">UsersFromDatabase</span></tt> instance (like the one you used in <tt class="docutils literal"><span class="pre">websetup.py</span></tt> as the <tt class="docutils literal"><span class="pre">users</span></tt> object) to the <tt class="docutils literal"><span class="pre">authkit.users</span></tt> key in the WSGI <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary so you can easily access it from your application, your tests, or the interactive shell. The commands below show you how to give the user <tt class="docutils literal"><span class="pre">foo</span></tt> the <tt class="docutils literal"><span class="pre">delete</span></tt> role. Don&#8217;t run them just yet though.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;authkit.users&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">users</span><span class="o">.</span><span class="n">user_add_role</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s">&quot;delete&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">simplesite.model</span> <span class="kn">import</span> <span class="n">meta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-961">The AuthKit <tt class="docutils literal"><span class="pre">users</span></tt> object has a series of different methods for managing users, described in detail at <a class="reference external" href="http://authkit.org/docs/0.4/class-authkit.users.Users.html">http://authkit.org/docs/0.4/class-authkit.users.Users.html</a>. Using this API and the Pylons interactive shell, you can manipulate the AuthKit settings directly without needing to re-create any database tables.</p>
</div>
</div>
<div class="section" id="error-documents">
<h2>Error Documents<a class="headerlink" href="#error-documents" title="Permalink to this headline">¶</a></h2>
<p id="index-962">Now that the authentication and authorization facilities are in place, let’s pause for a moment to look at how and why Pylons generates error documents such as the 403 error document shown in Figure 19-1.</p>
<p>In certain circumstances, your Pylons application will return a status code that isn’t 200. This might be because the URL requested doesn’t exist, because the user is not authorized to view a particular URL, or occasionally because there is a bug in your code that caused an exception. Most browsers will understand the status code and display some sort of error message so that the user knows what went wrong, but rather than relying on the browser to inform the user of the problem, it is often preferable for your application to display an error document so that the page contains the same branding as the rest of your site.</p>
<p id="index-963">As you saw in Chapter 17, whenever a response with a 401, 403, 404, or 500 response is returned down the middleware chain as far as the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware, it is intercepted, and a request is forwarded to your project’s error controller. The exact HTTP response status codes to be intercepted can be customized by changing the arguments to the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware. The error controller itself is a special controller set up by Pylons specifically for generating error documents.</p>
<p id="index-964">Your project’s <tt class="docutils literal"><span class="pre">controllers/error.py</span></tt> will look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">from</span> <span class="nn">paste.urlparser</span> <span class="kn">import</span> <span class="n">StaticURLParser</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">forward</span>
<span class="kn">from</span> <span class="nn">pylons.middleware</span> <span class="kn">import</span> <span class="n">error_document_template</span><span class="p">,</span> <span class="n">media_path</span>
<span class="kn">from</span> <span class="nn">webhelpers.html.builder</span> <span class="kn">import</span> <span class="n">literal</span>

<span class="kn">from</span> <span class="nn">simplesite.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span>

<span class="k">class</span> <span class="nc">ErrorController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render the error document&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pylons.original_response&#39;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;message&#39;</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">error_document_template</span> <span class="o">%</span> \
            <span class="nb">dict</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                 <span class="n">code</span><span class="o">=</span><span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_int</span><span class="p">))),</span>
                 <span class="n">message</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">page</span>

    <span class="k">def</span> <span class="nf">img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serve Pylons&#39; stock images&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serve_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">media_path</span><span class="p">,</span> <span class="s">&#39;img&#39;</span><span class="p">),</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serve Pylons&#39; stock stylesheets&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serve_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">media_path</span><span class="p">,</span> <span class="s">&#39;style&#39;</span><span class="p">),</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_serve_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call Paste&#39;s FileApp (a WSGI application) to serve the file</span>
<span class="sd">        at the specified path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">static</span> <span class="o">=</span> <span class="n">StaticURLParser</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">static</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-965">When the <tt class="docutils literal"><span class="pre">StatusCodeRedirect</span></tt> middleware forwards a request, it does so by passing the status code and status message to the <tt class="docutils literal"><span class="pre">document()</span></tt> action of the error controller by modifying the request so that it looks as if it came from a URL such as this: <tt class="docutils literal"><span class="pre">/error/document?code=404&amp;message=Not%20Found</span></tt>. It is the responsibility of the <tt class="docutils literal"><span class="pre">document()</span></tt> action to then return the HTML of the error document with the code and message provided.</p>
<p id="index-966">For the default implementation, the error document is generated from the Python string <tt class="docutils literal"><span class="pre">error_document_template</span></tt> in the <tt class="docutils literal"><span class="pre">pylons.middleware</span></tt> module, which is used to generate a response after the code, and messages have been substituted in the appropriate places. What is craftier is that to avoid having to add error document static files into your project template, the Pylons developers have added two further actions, <tt class="docutils literal"><span class="pre">img()</span></tt> and <tt class="docutils literal"><span class="pre">style()</span></tt>, that both create a static file server application and serve the static files from the Pylons module directory. (They use the same <tt class="docutils literal"><span class="pre">StaticURLParser</span></tt> WSGI application that is used to serve files from your project directory.) The template then references these actions so that all the images and CSS styles that the default template use are actually served from the Pylons module directory and don’t clutter up your application.</p>
<div class="section" id="customizing-the-error-documents-for-simplesite">
<h3>Customizing the Error Documents for SimpleSite<a class="headerlink" href="#customizing-the-error-documents-for-simplesite" title="Permalink to this headline">¶</a></h3>
<p id="index-967">Now that you’ve seen how error documents are generated by default, let’s look at how you can customize them to change the theme for the SimpleSite application. The easiest way to do this is to simply replace <tt class="docutils literal"><span class="pre">error_document_template</span></tt> with a different string containing the HTML you want returned. The string can contain the variables <tt class="docutils literal"><span class="pre">%(prefix)s</span></tt>, <tt class="docutils literal"><span class="pre">%(code)s</span></tt>, and <tt class="docutils literal"><span class="pre">%(message)s</span></tt>, which get substituted for the URL path where the application is mounted, the HTTP status code that was intercepted, and the default Pylons description of the HTTP status, respectively.</p>
<p>Although this approach works perfectly well, for the SimpleSite application you’ll go one step further and use a custom template to generate the error documents. To do this, you need to modify the <tt class="docutils literal"><span class="pre">document()</span></tt> action. Update it to look like this (lines 7 and 11-13 have changed):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Render the error document&quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pylons.original_response&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span> <span class="ow">or</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_int</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No status code was found&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">c</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">content</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/error/document.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The start of the action remains the same, but the lines in bold pass the code and message to a template rather than generating a response based on a string. Notice that you’ve also changed <tt class="docutils literal"><span class="pre">resp.body</span></tt> to <tt class="docutils literal"><span class="pre">resp.status</span></tt> because <tt class="docutils literal"><span class="pre">resp.body</span></tt> contains some HTML markup you don’t need.</p>
<p>For the previous code to work, you need to add imports for the <tt class="docutils literal"><span class="pre">c</span></tt> global and Mako <tt class="docutils literal"><span class="pre">render()</span></tt> function at the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">simplesite.lib.base</span> <span class="kn">import</span> <span class="n">render</span>
</pre></div>
</div>
<p>Create the new <tt class="docutils literal"><span class="pre">derived/error/document.html</span></tt> template with the following content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Server Error ${c.code}&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Error ${c.code}&lt;/h1&gt;&lt;/%def&gt;

&lt;p&gt;${c.message}&lt;/p&gt;</pre>
</div>
<p id="index-968">With the changes in place, you can test the template by visiting a page that doesn’t exist such as <a class="reference external" href="http://localhost:5000/no/such/page">http://localhost:5000/no/such/page</a>. The result is shown in Figure 19-4.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1904.png"><img alt="Figure 19-4. The updated error document support showing a 404 Not Found page" src="_images/9349f1904.png" /></a>
<p class="caption">Figure 19-4. The updated error document support showing a 404 Not Found page</p>
</div>
<p id="index-969">When a user tries to access functionality they don’t have access to, they are now shown the styled 403 error document. Although this is a significant improvement over the Pylons default version, it would be even better if the user was given a customized error message explaining that they don’t have the appropriate permissions to perform the action they are trying to perform. It would also be a good idea to provide a link so they can sign in as a different user who does have the required permissions.</p>
<p>Let’s start by customizing the template to display a custom message for the 403 status code and the link to allow the user to sign in again. Update the template so it looks like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html"/&gt;

&lt;%def name="title()"&gt;Server Error ${c.code}&lt;/%def&gt;
&lt;%def name="heading()"&gt;&lt;h1&gt;Error ${c.code}&lt;/h1&gt;&lt;/%def&gt;

% if c.code == '403':
&lt;p&gt;You do not have sufficient permissions to access this page. Please
&lt;a href="${h.url_for('signinagain')}"&gt;sign in&lt;/a&gt; as a different user.&lt;/p&gt;
% else:
&lt;p&gt;${c.message}&lt;/p&gt;
% endif</pre>
</div>
<p>When a user clicks the link, the action that gets called would need to sign them out before displaying the sign-in screen; otherwise, when they try to sign in, they will find they are still signed in as the original user.</p>
<p>Up until now, the only method you’ve seen for signing out a user is for them to visit the URL specified in the <tt class="docutils literal"><span class="pre">authkit.cookie.signoutpath</span></tt> option in the config file; this isn’t the only method you can use, though. The AuthKit cookie plug-in you are using is an extended version of the Paste <tt class="docutils literal"><span class="pre">paste.auth.auth_tkt</span></tt> functionality and as such uses the same API for signing out users. This means the AuthKit middleware adds a sign-out function to the <tt class="docutils literal"><span class="pre">environ</span></tt> dictionary under the key <tt class="docutils literal"><span class="pre">'paste.auth_tkt.logout_user'</span></tt>. If you call this function, the middleware will remove the cookie from the headers after the response is returned. Now that you know this, you can write a new action that signs the user out and displays the sign-in form:</p>
<p id="index-970">Add this action to the account controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">signinagain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;paste.auth_tkt.logout_user&#39;</span><span class="p">]()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/account/signin.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;signin&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Remember that the <tt class="docutils literal"><span class="pre">/derived/account/signin.html</span></tt> page isn’t a normal template. It has to be set up so that it returns a string that AuthKit can use Python string interpolation on to replace the <tt class="docutils literal"><span class="pre">%s</span></tt> character with the action. Since you are not using the template with AuthKit this time, you have to add the form action yourself. (If you are using <tt class="docutils literal"><span class="pre">FORM_ACTION</span></tt> instead of <tt class="docutils literal"><span class="pre">%s</span></tt>, you’ll have to adjust the last line accordingly.)</p>
<p>You’ll also need another route for the <tt class="docutils literal"><span class="pre">signinagain()</span></tt> action in the <tt class="docutils literal"><span class="pre">config/routing.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;signinagain&#39;</span><span class="p">,</span> <span class="s">&#39;/signinagain&#39;</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;signinagain&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, add the import for <tt class="docutils literal"><span class="pre">h</span></tt> into the <tt class="docutils literal"><span class="pre">account</span></tt> controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">simplesite.lib.helpers</span> <span class="kn">as</span> <span class="nn">h</span>
</pre></div>
</div>
<p>This new action is now accessible from <tt class="docutils literal"><span class="pre">/signinagain</span></tt> and presents the sign-in form with the action adjusted to point to the sign-in screen.</p>
<p>There’s one final change to make. You’ll need to update the <tt class="docutils literal"><span class="pre">base/index.html</span></tt> template so the “Signed in as...” link isn’t shown on the sign-in again page. Make the relevant line look like this:</p>
<div class="highlight-python"><pre>            % if h.auth.authorized(h.auth.is_valid_user) and not (
request.urlvars['controller'] == 'account' and request.urlvars['action']
in ['signout', 'signinagain']):</pre>
</div>
<p id="index-971">If you sign in as user <tt class="docutils literal"><span class="pre">foo</span></tt> and try to access a URL such as <a class="reference external" href="http://localhost:5000/page/list">http://localhost:5000/page/list</a>, you will now be shown the page in Figure 19-5. Clicking the sign-in link will then take you to the sign-in again page, where you can sign in as a different user. With these changes in place, the customization of the error documents support is complete.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1905.png"><img alt="Figure 19-5. The customized 403 error document" src="_images/9349f1905.png" /></a>
<p class="caption">Figure 19-5. The customized 403 error document</p>
</div>
</div>
</div>
<div class="section" id="adding-a-wysiwyg-interface">
<h2>Adding a WYSIWYG Interface<a class="headerlink" href="#adding-a-wysiwyg-interface" title="Permalink to this headline">¶</a></h2>
<p id="index-972">Even with all the changes you’ve made so far, SimpleSite is still rather simple. After all, it can be used to edit only plain text, which isn’t too helpful for a website. In this section, you’ll update the edit page functionality to use the YUI Rich Text Editor, and you’ll change the page view template to allow HTML to be rendered.</p>
<p id="index-973">Let’s start by thinking about the JavaScript required to change the content text area on the edit page to use a visual editor. The editor you’ll use is the YUI Rich Text Editor and is documented at <a class="reference external" href="http://developer.yahoo.com/yui/editor/">http://developer.yahoo.com/yui/editor/</a>. To set it up, you need to modify the <tt class="docutils literal"><span class="pre">derived/page/edit.html</span></tt> template so that the <tt class="docutils literal"><span class="pre">js()</span></tt> def looks like this:</p>
<div class="highlight-python"><pre>&lt;%def name="js()"&gt;
    ${parent.js()}
    ${navfields.js()}

    &lt;script type="text/javascript"
        src="/yui/2.6.0/element/element-beta-min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript"
        src="/yui/2.6.0/container/container_core-min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript"
        src="/yui/2.6.0/editor/simpleeditor-min.js"&gt;&lt;/script&gt;

    &lt;script type="text/javascript"&gt;
    (function() {
        // Set up some private variables
        var Dom = YAHOO.util.Dom;
        var Event = YAHOO.util.Event;

        // The SimpleEditor config
        var myConfig = {
            height: '200px',
            width: '630px',
            dompath: true,
            focusAtStart: true,
            handleSubmit: true
        };

        // Now let's load the SimpleEditor..
        var myEditor = new YAHOO.widget.SimpleEditor('editor', myConfig);
        myEditor._defaultToolbar.buttonType = 'advanced';
        document.e = myEditor;
        myEditor._defaultToolbar.titlebar = 'Rich Text Editor';
        myEditor.render();
    })();
    &lt;/script&gt;
&lt;/%def&gt;</pre>
</div>
<p id="index-974">Ordinarily, you would also need the <tt class="docutils literal"><span class="pre">yahoo-dom-event</span></tt> and <tt class="docutils literal"><span class="pre">connection</span></tt> libraries, but you are already using these to support the <tt class="docutils literal"><span class="pre">callAJAX()</span></tt> function used to update the <tt class="docutils literal"><span class="pre">before</span></tt> field, so you don’t need to include them again.</p>
<p>For the previous JavaScript to work, you need some more changes. First, you need to add <tt class="docutils literal"><span class="pre">id=&quot;editor&quot;</span></tt> to the text area used to edit the content so that the JavaScript you’ve added is applied to the correct element. Change <tt class="docutils literal"><span class="pre">derived/page/fields.html</span></tt> so the <tt class="docutils literal"><span class="pre">content</span></tt> field definition looks like this with a text area with a <tt class="docutils literal"><span class="pre">id=editor</span></tt> attribute:</p>
<div class="highlight-python"><pre>${h.field(
    "Content",
    h.textarea(name='content', rows=7, cols=40, id='editor'),
    required=True,
    field_desc = 'The text which will make up the body of the page'
)}</pre>
</div>
<p id="index-975">If you were to try to edit the page now, you’d see that although you could correctly edit the text, the Rich Text Editor wouldn’t be displayed correctly. This is because you haven’t yet chosen a theme for YUI.</p>
<p>YUI’s theming system relies on the name of the theme to be used being specified as the class of the <tt class="docutils literal"><span class="pre">&lt;body&gt;</span></tt> tag. The default theme is called <em>sam skin</em>, so you’ll use this one. Update the <tt class="docutils literal"><span class="pre">&lt;body&gt;</span></tt> tag in <tt class="docutils literal"><span class="pre">base/index.html</span></tt> so that it looks like this:</p>
<div class="highlight-python"><pre>&lt;body class="yui-skin-sam"&gt;</pre>
</div>
<p>Finally, add this def to the end of <tt class="docutils literal"><span class="pre">derived/page/edit.html</span></tt>.</p>
<div class="highlight-python"><pre>&lt;%def name="head()"&gt;
    ${parent.head()}
    ${h.stylesheet_link(h.url_for('/yui/2.6.0/assets/skins/sam/skin.css'))}
&lt;/%def&gt;</pre>
</div>
<p>With these changes in place, try editing a page, and you should see an editor that allows you to add content such as that shown in Figure 19-6.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1906.png"><img alt="Figure 19-6. Adding some HTML and an Image with the YUI Rich Text Editor" src="_images/9349f1906.png" /></a>
<p class="caption">Figure 19-6. Adding some HTML and an Image with the YUI Rich Text Editor</p>
</div>
<p id="index-976">If you try to use the editor to create a complex page, you’ll notice that, because you were conscientious when designing the application, your HTML content is automatically escaped when viewing pages. To prevent the HTML page’s content from being escaped, you can edit <tt class="docutils literal"><span class="pre">derived/page/view.html</span></tt> and replace this line:</p>
<div class="highlight-python"><pre>${(c.page.content)}</pre>
</div>
<p>with these lines so that content is treated as an HTML literal:</p>
<div class="highlight-python"><pre>&lt;%!
    from webhelpers.html import literal
%&gt;
&lt;div id="page-content"&gt;
${literal(c.page.content)}
&lt;/div&gt;</pre>
</div>
<p id="index-977">The final problem is that since you are using the YUI <tt class="docutils literal"><span class="pre">reset.css</span></tt> styles in the SimpleSite pages, some of the styles that looked correct in the editor get reset when you view the HTML. To fix this, add the following styles to the end of the <tt class="docutils literal"><span class="pre">public/css/main.css</span></tt> file:</p>
<div class="highlight-python"><pre>#page-content strong {
    font-weight: bold;
}
#page-content em {
    font-style: italic;
}
#page-content p {
    margin-bottom: 20px;
}
#page-content ol, #page-content ul {
    margin: 20px 20px 20px 1em;
    padding-left: 20px;
}
#page-content ol li {
    list-style: decimal;
}
#page-content ul li {
    list-style: disc;
}</pre>
</div>
<p id="index-978">The pages will now display correctly.</p>
</div>
<div class="section" id="configuring-the-setup-py-file">
<h2>Configuring the setup.py File<a class="headerlink" href="#configuring-the-setup-py-file" title="Permalink to this headline">¶</a></h2>
<p id="index-979">At this point, the SimpleSite application is pretty much finished, so it is nearly time to package it up to be distributed. Pylons comes equipped with quite a few tools to help you easily publish your application and to allow other people to easily install it and its dependencies. We’ll look at these tools in this section.</p>
<p>Before you can publish the egg, there are a number of changes you need to make including the following:</p>
<blockquote>
<ul class="simple">
<li>Choosing a version number</li>
<li>Configuring dependencies</li>
<li>Specifying metadata</li>
<li>Customizing the production config file template</li>
</ul>
</blockquote>
<div class="section" id="choosing-a-version-number">
<h3>Choosing a Version Number<a class="headerlink" href="#choosing-a-version-number" title="Permalink to this headline">¶</a></h3>
<p id="index-980">The first step in distributing an application is to choose a version number for the project. Ordinarily, the 1.0.0 release is considered to be the first main release of a project. You’ve made three core sets of revisions to SimpleSite in each of the three chapters, but there are still some changes you might like to make before this is an official product you’d be proud to distribute more widely (notably the lack of documentation), so it probably isn’t ready for a 1.0.0 release just yet. Let’s set the version number to 0.3.0 to reflect the fact that this is the third minor revision.</p>
<p>The version number is set in <tt class="docutils literal"><span class="pre">setup.py</span></tt> and is used by Easy Install when determining which version to install. Update the version number for the SimpleSite project like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">version</span> <span class="o">=</span> <span class="s">&#39;0.3.0&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>This example uses a simple version number, but Pylons also supports development releases and alpha, beta, and prerelease versions.</p>
<p id="index-981">Let’s start with alpha, beta, and prerelease releases. These are treated by <tt class="docutils literal"><span class="pre">setuptools</span></tt> as being before the final version for the purposes of their use in Easy Install conditions. For example, 0.5.0a1 would be considered the first alpha release of the 0.5 version of a particular application. Similarly, 0.5.0pre2 would be the second prerelease, and 0.5.0rc3 would be the third release candidate. This means that if certain software required version 0.5 or greater, none of the releases specified so far would be suitable.</p>
<p>For example, during the process of writing the book, I released the first version of the SimpleSite code as version 0.3.0pre1. As the book went into production, I released the 0.3.0 release, but if there are changes to Pylons before the book is released and these need corresponding changes in SimpleSite, I’d release a 0.3.1 release.</p>
<p>Development versions are slightly more complicated but are an equally useful feature. In development mode, <tt class="docutils literal"><span class="pre">setuptools</span></tt> automatically calculates the version revision number from the revision of the Subversion repository you are currently developing the Pylons application in (if indeed you are using Subversion). By default, Pylons applications are set up to be treated as a development version, which means the <tt class="docutils literal"><span class="pre">.egg</span></tt> file produced from it will have <tt class="docutils literal"><span class="pre">dev</span></tt> as part of the version. For example, if the repository is at revision 68, then the egg produced would be labeled <tt class="docutils literal"><span class="pre">SimpleSite-0.3.0dev-r68_py2.5.egg</span></tt>. If you want your release to be treated as a production release, you need to edit <tt class="docutils literal"><span class="pre">setup.cfg</span></tt> and comment out these two lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">egg_info</span><span class="p">]</span>
<span class="c">#tag_build = dev</span>
<span class="c">#tag_svn_revision = true</span>
</pre></div>
</div>
<p>You should make this change to the SimpleSite project.</p>
<p id="index-982">At this point, the project is set up to build the egg for the 0.3.0 production release so the egg produced will be named <tt class="docutils literal"><span class="pre">SimpleSite-0.3.0_py2.5.egg</span></tt>, but there are still some changes you need to make.</p>
</div>
<div class="section" id="configuring-dependencies">
<h3>Configuring Dependencies<a class="headerlink" href="#configuring-dependencies" title="Permalink to this headline">¶</a></h3>
<p id="index-983">Now that the version number has been specified, let’s update the list of libraries and other Python software the application depends on. This is done by adding the dependencies to the <tt class="docutils literal"><span class="pre">install_requires</span></tt> argument of the <tt class="docutils literal"><span class="pre">setup()</span></tt> function in your project’s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file. When you install software with Easy Install, the <tt class="docutils literal"><span class="pre">easy_install</span></tt> script automatically installs all the software specified in the <tt class="docutils literal"><span class="pre">install_requires</span></tt> line. The SimpleSite <tt class="docutils literal"><span class="pre">setup.py</span></tt> file currently has an <tt class="docutils literal"><span class="pre">install_requires</span></tt>, which looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
    <span class="s">&quot;Pylons&gt;=0.9.7&quot;</span><span class="p">,</span>
    <span class="s">&quot;SQLAlchemy&gt;=0.4&quot;</span><span class="p">,</span>
    <span class="s">&quot;Mako&quot;</span><span class="p">,</span>
    <span class="s">&quot;FormBuild&gt;=2.0&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p>Update this information to use SQLAlchemy 0.5 and to include AuthKit 0.4.3.</p>
<p>Here’s what the lines should look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
    <span class="s">&quot;Pylons&gt;=0.9.7,&lt;=0.9.7.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;SQLAlchemy&gt;=0.5,&lt;=0.5.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;Mako&gt;=0.2.2,&lt;=0.2.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;FormBuild&gt;=2.0.1,&lt;=2.0.99&quot;</span><span class="p">,</span>
    <span class="s">&quot;AuthKit&gt;=0.4.3,&lt;=0.4.99&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p>Notice that you’ve specified all the dependencies with version numbers in a particular range. Package developers should be using the convention that any software release where only the revision has changed (the revision being the very last number making up the version) will be compatible with all previous versions with the same major and minor numbers (the first and second parts of the version, respectively). This means you can be fairly confident that your application should work with more recent versions of the dependencies as long as the major and minor components of the version number haven’t changed. By specifying a range of suitable alternatives in your application, if any bug fix releases of the dependencies are made, SimpleSite can use them. It also means that if a user has a slightly different yet still compatible version of a dependency already installed, then Easy Install can use that rather than downloading a new version.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You might expect that you would be able to specify dependencies like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&quot;AuthKit&gt;=0.4,&lt;=0.5&quot;</span>
</pre></div>
</div>
<p class="last" id="index-984">This isn’t quite what you want, though, because as has already been discussed, Easy Install would also treat other AuthKit versions including 0.5.0dev, 0.5.0a1, and 0.5.0pre2 as being lower than 0.5, and since these have a different minor version, the APIs might not be backward compatible with the 0.4 release. Instead, the convention is to use &lt;0.4.99 on the basis that it is unlikely that there would be 99 revisions of a minor version of a piece of software.</p>
</div>
</div>
<div class="section" id="extra-dependencies">
<h3>Extra Dependencies<a class="headerlink" href="#extra-dependencies" title="Permalink to this headline">¶</a></h3>
<p id="index-985">Sometimes you might want a particular dependency installed only if a user is installing a particular feature. As an example, SimpleSite is designed to work with multiple database engines, each of which require a particular driver. Let’s focus on just MySQL and PostgreSQL, though. You wouldn’t want to list both the mysql-python and psycopg2 packages in the <tt class="docutils literal"><span class="pre">install_requires</span></tt> line as dependencies because your users would only ever need one of the drivers. On the other hand, if you left out the drivers completely, they would not be automatically installed when SimpleSite was installed.</p>
<p>To cater for this situation, Pylons applications can use the <tt class="docutils literal"><span class="pre">setuptools</span></tt> optional extra dependency feature. Add the following to the end of the <tt class="docutils literal"><span class="pre">setup()</span></tt> function in <tt class="docutils literal"><span class="pre">setup.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">extras_require</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;MySQL&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s">&quot;mysql-python&gt;=1.2&quot;</span><span class="p">],</span>
    <span class="s">&#39;PostgreSQL&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;psycopg2&quot;</span><span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
<p>Each of the extras is specified as a key and a list of all the dependencies. In this case, both the extras require only one dependency to be installed.</p>
<p>When it comes to installing SimpleSite, the extras required can be specified like this:</p>
<div class="highlight-python"><pre>$ easy_install SimpleSite[MySQL]</pre>
</div>
<p id="index-986">This will now automatically install the mysql-python package version 1.2 or greater, which provides the <tt class="docutils literal"><span class="pre">MySQLdb</span></tt> module that SQLAlchemy uses for its MySQL support.</p>
</div>
<div class="section" id="extra-dependency-links">
<h3>Extra Dependency Links<a class="headerlink" href="#extra-dependency-links" title="Permalink to this headline">¶</a></h3>
<p id="index-987">By default, Easy Install installs software only from the Python Package Index unless you use the <tt class="docutils literal"><span class="pre">-f</span></tt> flag to specify extra URLs.</p>
<p>If your application relies on packages hosted at different URLs, you can add them to the <tt class="docutils literal"><span class="pre">setup()</span></tt> function like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">dependency_links</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;http://pylonshq.com/download/&quot;</span>
<span class="p">],</span>
</pre></div>
</div>
<p>Easy Install will automatically search these links when trying to resolve the dependencies.</p>
</div>
<div class="section" id="specifying-metadata">
<h3>Specifying Metadata<a class="headerlink" href="#specifying-metadata" title="Permalink to this headline">¶</a></h3>
<p id="index-988">As well as allowing you to specify dependencies, the <tt class="docutils literal"><span class="pre">setup()</span></tt> function takes arguments for specifying metadata about your project. This metadata is used as the basis for the information on the Python Package Index. Update the <tt class="docutils literal"><span class="pre">setup.py</span></tt> with the following metadata:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;SimpleSite&#39;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s">&#39;0.3.0&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">&#39;&#39;&#39;A simple website application written as a demonstration of Pylons</span>
<span class="s">for the Definitive Guide to Pylons&#39;&#39;&#39;</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s">&#39;James Gardner&#39;</span><span class="p">,</span>
<span class="n">author_email</span><span class="o">=</span><span class="s">&#39;feedback@pylonsbook.com&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s">&#39;http://pylonsbook.com&#39;</span><span class="p">,</span>
    <span class="n">long_description</span><span class="o">=</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">A simple CMS application allowing WYSIWYG page editing, sections and subsections</span>
<span class="s">and full navigation widgets</span>
<span class="s">    &#39;&#39;&#39;</span><span class="p">,</span>
    <span class="o">...</span> <span class="n">other</span> <span class="n">options</span> <span class="n">here</span> <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p id="index-989">The <tt class="docutils literal"><span class="pre">short_description</span></tt> argument is used in the list on the home page of the Python Package Index, and the <tt class="docutils literal"><span class="pre">long_description</span></tt> argument is used in the main page for the project on the Python Package Index. In addition to the <tt class="docutils literal"><span class="pre">author</span></tt>, <tt class="docutils literal"><span class="pre">author_email</span></tt>, and home page <tt class="docutils literal"><span class="pre">url</span></tt>, you can also specify which categories the application should be placed in. The categories are known as <em>trove classifiers</em>, and you can find a full list at <a class="reference external" href="http://pypi.python.org/pypi?%3Aaction=list_classifiers">http://pypi.python.org/pypi?%3Aaction=list_classifiers</a>. Here are the classifiers for Pylons itself:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">classifiers</span><span class="o">=</span><span class="p">[</span>
    <span class="s">&quot;Development Status :: 5 - Production/Stable&quot;</span><span class="p">,</span>
    <span class="s">&quot;Intended Audience :: Developers&quot;</span><span class="p">,</span>
    <span class="s">&quot;License :: OSI Approved :: BSD License&quot;</span><span class="p">,</span>
    <span class="s">&quot;Framework :: Pylons&quot;</span><span class="p">,</span>
    <span class="s">&quot;Programming Language :: Python&quot;</span><span class="p">,</span>
    <span class="s">&quot;Topic :: Internet :: WWW/HTTP&quot;</span><span class="p">,</span>
    <span class="s">&quot;Topic :: Internet :: WWW/HTTP :: Dynamic Content&quot;</span><span class="p">,</span>
    <span class="s">&quot;Topic :: Internet :: WWW/HTTP :: WSGI&quot;</span><span class="p">,</span>
    <span class="s">&quot;Topic :: Software Development :: Libraries :: Python Modules&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p id="index-990">In addition, it can also be useful to specify keywords related to the application and the license:</p>
<div class="highlight-python"><pre>keywords='pylons simple site book example',
license='BSD, see the simplesite/public/yui/2.6.0/LICENSE.txt file for details.</pre>
</div>
</div>
<div class="section" id="customizing-the-long-description">
<h3>Customizing the Long Description<a class="headerlink" href="#customizing-the-long-description" title="Permalink to this headline">¶</a></h3>
<p id="index-991">The <tt class="docutils literal"><span class="pre">long_description</span></tt> argument is used on the main page for the package and also accepts reStructuredText, which you learned about in Chapter 13. This means you can add some quite complex formatting to the long description. You can use something like this, for example:</p>
<div class="highlight-python"><pre>++++++++++
SimpleSite
++++++++++

A simple website application allowing WYSIWYG editing, sections and
subsections and full navigation widgets. The idea is that the application can
form a starting point for your own website projects.


Installation
============

First install Easy Install if you don't have it already by downloading
``ez_setup.py`` from http://peak.telecommunity.com/dist/ez_setup.py and
installing it like this::

    python ez_setup.py

Install SimpleSite like this specifying either MySQL, SQLite or PostgreSQL
as the word within the square brackets depending on the database you intend to
use::

    easy_install SimpleSite["MySQL"]
    paster make-config simplesite.ini

Configure the application by editing ``simplesite.ini`` to specify a database
to use using the format described at
http://www.sqlalchemy.org/docs/05/dbengine.html#dbengine_supported ::

    paster setup-app simplesite.ini
    paster serve simplesite.ini

The running application will now be available at http://localhost/

Files
=====</pre>
</div>
<p id="index-992">The reason for the <tt class="docutils literal"><span class="pre">Files</span></tt> subheading at the end is that the Python Package Index specifies the files after the long description, so this formatting will result in a nicely structured page on the Python Package Index.</p>
<p id="index-993">With these changes in place, the Python Package Index page for the project will look eventually look like Figure 19-7 once the package is published.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1907.png"><img alt="Figure 19-7. The SimpleSite project on the Python Package Index" src="_images/9349f1907.png" /></a>
<p class="caption">Figure 19-7. The SimpleSite project on the Python Package Index</p>
</div>
</div>
<div class="section" id="customizing-the-production-config-file-template">
<h3>Customizing the Production Config File Template<a class="headerlink" href="#customizing-the-production-config-file-template" title="Permalink to this headline">¶</a></h3>
<p id="index-994">There is one more customization you need to make before you are ready to publish the egg itself. As you’ll see in Chapter 21 about deployment, when a user has installed your <tt class="docutils literal"><span class="pre">.egg</span></tt>, they will run the application directly from a config file. To create the config file, they’ll use this command:</p>
<div class="highlight-python"><pre>$ paster make-config SimpleSite myconfig.ini</pre>
</div>
<p id="index-995">The SimpleSite application requires the AuthKit configuration options to be present in the config file that the earlier command generates. To achieve this, you need to customize how Pylons generates the config file. Pylon provides a <tt class="docutils literal"><span class="pre">deployment.ini_tmpl</span></tt> file in your project’s <tt class="docutils literal"><span class="pre">config</span></tt> directory, which will be used as a basis for generating this config file, so you should update it to contain the AuthKit configuration (lines 25-31 here):</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></td><td class="code"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># SimpleSite - Pylons configuration</span>
<span class="c">#</span>
<span class="c"># The %(here)s variable will be replaced with the parent directory of this file</span>
<span class="c">#</span>
<span class="k">[DEFAULT]</span>
<span class="na">debug</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">email_to</span> <span class="o">=</span> <span class="s">you@yourdomain.com</span>
<span class="na">smtp_server</span> <span class="o">=</span> <span class="s">localhost</span>
<span class="na">error_email_from</span> <span class="o">=</span> <span class="s">paste@localhost</span>

<span class="k">[server:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:Paste#http</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">0.0.0.0</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">5000</span>

<span class="k">[app:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:SimpleSite</span>
<span class="na">full_stack</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">cache_dir</span> <span class="o">=</span> <span class="s">%(here)s/data</span>
<span class="na">beaker.session.key</span> <span class="o">=</span> <span class="s">simplesite</span>
<span class="na">beaker.session.secret</span> <span class="o">=</span> <span class="s">${app_instance_secret}</span>
<span class="na">app_instance_uuid</span> <span class="o">=</span> <span class="s">${app_instance_uuid}</span>

<span class="na">authkit.setup.enable</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">authkit.setup.method</span> <span class="o">=</span> <span class="s">form, cookie</span>
<span class="na">authkit.form.authenticate.user.type</span> <span class="o">=</span> <span class="s">authkit.users.sqlalchemy_driver:UsersFromDatabase</span>
<span class="na">authkit.form.authenticate.user.data</span> <span class="o">=</span> <span class="s">simplesite.model</span>
<span class="na">authkit.cookie.secret</span> <span class="o">=</span> <span class="s">secret string</span>
<span class="na">authkit.cookie.signoutpath</span> <span class="o">=</span> <span class="s">/signout</span>
<span class="na">authkit.form.template.obj</span> <span class="o">=</span> <span class="s">simplesite.lib.auth:render_signin</span>

<span class="c"># If you&#39;d like to fine-tune the individual locations of the cache data dirs</span>
<span class="c"># for the Cache data, or the Session saves, un-comment the desired settings</span>
<span class="c"># here:</span>
<span class="c">#beaker.cache.data_dir = %(here)s/data/cache</span>
<span class="c">#beaker.session.data_dir = %(here)s/data/sessions</span>
<span class="c"># SQLAlchemy database URL</span>
<span class="na">sqlalchemy.url</span> <span class="o">=</span> <span class="s">sqlite:///production.db</span>
<span class="na">sqlalchemy.echo</span> <span class="o">=</span> <span class="s">False</span>

<span class="c"># WARNING: *THE LINE BELOW MUST BE UNCOMMENTED ON A PRODUCTION ENVIRONMENT*</span>
<span class="c"># Debug mode will enable the interactive debugging tool, allowing ANYONE to</span>
<span class="c"># execute malicious code after an exception is raised.</span>
<span class="na">set debug</span> <span class="o">=</span> <span class="s">false</span>

<span class="c"># Logging configuration</span>
<span class="k">[loggers]</span>
<span class="na">keys</span> <span class="o">=</span> <span class="s">root</span>

<span class="k">[handlers]</span>
<span class="na">keys</span> <span class="o">=</span> <span class="s">console</span>

<span class="k">[formatters]</span>
<span class="na">keys</span> <span class="o">=</span> <span class="s">generic</span>

<span class="k">[logger_root]</span>
<span class="na">level</span> <span class="o">=</span> <span class="s">INFO</span>
<span class="na">handlers</span> <span class="o">=</span> <span class="s">console</span>

<span class="k">[handler_console]</span>
<span class="na">class</span> <span class="o">=</span> <span class="s">StreamHandler</span>
<span class="na">args</span> <span class="o">=</span> <span class="s">(sys.stderr,)</span>
<span class="na">level</span> <span class="o">=</span> <span class="s">NOTSET</span>
<span class="na">formatter</span> <span class="o">=</span> <span class="s">generic</span>

<span class="k">[formatter_generic]</span>
<span class="na">format</span> <span class="o">=</span> <span class="s">%(asctime)s %(levelname)-5.5s [%(name)s] %(message)s</span>
</pre></div>
</td></tr></table></div>
<p id="index-996">You’ll notice that this file is slightly different from the default <tt class="docutils literal"><span class="pre">development.ini</span></tt> file. In particular, it has these two extra lines:</p>
<div class="highlight-python"><pre>beaker.session.secret = ${app_instance_secret}
app_instance_uuid = ${app_instance_uuid}</pre>
</div>
<p>The variables <tt class="docutils literal"><span class="pre">${app_instance_secret}</span></tt> and <tt class="docutils literal"><span class="pre">${app_instance_uuid}</span></tt> are replaced with appropriate values when the user of the application runs the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">make-config</span></tt> command.</p>
<p>You’ll also notice that debugging is automatically set to <tt class="docutils literal"><span class="pre">false</span></tt> to ensure that production deployments don’t accidentally have the Pylons interactive debugger enabled.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last" id="index-997">Pylons 0.9.6 users will be used to using a <tt class="docutils literal"><span class="pre">paste_deploy_config.ini_tmpl</span></tt> in their project’s <tt class="docutils literal"><span class="pre">ProjectName.egg-info</span></tt> directory. The <tt class="docutils literal"><span class="pre">config/deployment.ini_tmpl</span></tt> file behaves in the same way but is in a location that is less likely to be deleted accidentally.</p>
</div>
</div>
</div>
<div class="section" id="packaging-a-pylons-project-for-distribution">
<h2>Packaging a Pylons Project for Distribution<a class="headerlink" href="#packaging-a-pylons-project-for-distribution" title="Permalink to this headline">¶</a></h2>
<p id="index-998">Now that you know how to customize <tt class="docutils literal"><span class="pre">setup.py</span></tt>, let’s look at how to package the SimpleSite application.</p>
<p>Pylons applications are designed to be distributed as <tt class="docutils literal"><span class="pre">.egg</span></tt> files. This is the same format that Pylons itself and all its dependencies are distributed in. You’ll remember from Chapter 2 that applications distributed as eggs can be installed with Easy Install. This means that if your Pylons application is published on the Python Package Index, other users will be able to install it with Easy Install too. Let’s start by looking at how to build an egg.</p>
<div class="section" id="building-an-egg-file">
<h3>Building an Egg File<a class="headerlink" href="#building-an-egg-file" title="Permalink to this headline">¶</a></h3>
<p id="index-999">The first step of building an egg is to remove any unnecessary files that you don’t want packaged. In this case, this includes any of the YUI library files the application is not using. By looking at Firebug’s Net tab when using the application, you can see that only the following files are being used:</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">/css/main.css</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/animation/animation-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/assets/skins/sam/blankimage.png</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/assets/skins/sam/editor-sprite.gif</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/assets/skins/sam/editor-sprite-active.gif</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/assets/skins/sam/skin.css</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/assets/skins/sam/sprite.png</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/connection/connection-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/container/container_core-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/editor/simpleeditor-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/element/element-beta-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/json/json-min.js</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/reset-fonts-grids/reset-fonts-grids.css</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/yui/2.6.0/yahoo-dom-event/yahoo-dom-event.js</span></tt></li>
</ul>
</blockquote>
<p>You should remove all the other files from your project’s <tt class="docutils literal"><span class="pre">public</span></tt> directory. Also, because YUI is licensed under a separate license, you should also add the text of the license to <tt class="docutils literal"><span class="pre">/yui/2.6.0/LICENSE.txt</span></tt>. Then you are ready to build the egg. You can do so with this command:</p>
<div class="highlight-python"><pre>$ python setup.py bdist_egg</pre>
</div>
<p>If everything goes smoothly, an <tt class="docutils literal"><span class="pre">.egg</span></tt> file with the correct name and version number appears in a newly created <tt class="docutils literal"><span class="pre">dist</span></tt> directory. The <tt class="docutils literal"><span class="pre">.egg</span></tt> file contains everything anyone needs to run your program. You should probably make eggs for each version of Python your users might require by running the previous command with Python 2.4, 2.5, and 2.6 to create each version of the egg.</p>
<p>At this point, your work as a developer is done. The finished and packaged egg file is now produced and ready to be distributed or deployed. If you emailed the egg to a colleague, they could now install it into their own virtual Python environment just like this:</p>
<div class="highlight-python"><pre>$ easy_install SimpleSite-0.3.0-py2.5.egg</pre>
</div>
<p id="index-1000">You’ll learn about how you can deploy eggs like this one in production environments in Chapter 21, but for now let’s look at how you can publish eggs on the Python Package Index to make it even easier to share them with the wider Python community.</p>
</div>
<div class="section" id="publishing-an-egg-on-the-python-package-index">
<h3>Publishing an Egg on the Python Package Index<a class="headerlink" href="#publishing-an-egg-on-the-python-package-index" title="Permalink to this headline">¶</a></h3>
<p id="index-1001">Now that you have successfully created eggs for your application, you can register them on the Python Package Index at <a class="reference external" href="http://www.python.org/pypi">http://www.python.org/pypi</a>. Do this by running the following command. <em>Please do this only with your own projects, though, because SimpleSite has already been registered!</em></p>
<p id="index-1002">When you run the command, some processing is done on the project, and then you are given some choices of how to proceed. Here I’m using my existing login details, but you can choose option <tt class="docutils literal"><span class="pre">2.</span></tt> to register a new account with the system:</p>
<div class="highlight-python"><pre>$ python setup.py register
running register
... some lines omitted ...
We need to know who you are, so please choose either:
 1. use your existing login,
 2. register as a new user,
 3. have the server generate a new password for you (and email it to you), or
 4. quit
Your selection [default 1]:  1
Username: thejimmyg
Password:
Server response (200): OK
I can store your PyPI login so future submissions will be faster.
(the login will be stored in /home/james/.pypirc)
Save your login (y/N)?y</pre>
</div>
<p>The program then asks you whether you want it to save your login details. When I ran the previous example to register SimpleSite, I chose to save them because I knew I’d want to upload the egg files automatically too. This option saved me from having to enter my details again.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The Python Package Index authentication is very weak, and passwords are transmitted in plain text. Don’t use any sign-in details that you use for important applications because they could be easily intercepted.</p>
</div>
<p id="index-1003">If you visit <a class="reference external" href="http://pypi.python.org/pypi/SimpleSite/0.3.0">http://pypi.python.org/pypi/SimpleSite/0.3.0</a>, you’ll see the page that was created by the previous command. It was also shown a few pages ago in Figure 19-7. You’ll also notice that new projects appear at the top of the list of recent projects on the Python Package Index home page, as shown in Figure 19-8.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f1908.png"><img alt="Figure 19-8. The SimpleSite project on the Python Package Index" src="_images/9349f1908.png" /></a>
<p class="caption">Figure 19-8. The SimpleSite project on the Python Package Index</p>
</div>
<p id="index-1004">You can now sign in to the Python Package Index with the account details you used when you registered your application and upload the eggs you’ve created, or if you prefer, you can even have Python do it for you; just enter this command for each version of Python supported to upload the eggs for you:</p>
<div class="highlight-python"><pre>$ python2.4 setup.py bdist_egg register upload
$ python2.5 setup.py bdist_egg register upload</pre>
</div>
<p>If you didn’t allow the <tt class="docutils literal"><span class="pre">register</span></tt> command to create a <tt class="docutils literal"><span class="pre">.pypirc</span></tt> file in your home directory for you, you’ll need to create one yourself. It should contain your username and password so that the <tt class="docutils literal"><span class="pre">upload</span></tt> command knows who to sign in as, and it should look similar to this:</p>
<div class="highlight-python"><pre>[server-login]
username: james
password: password</pre>
</div>
<p>This works on Windows too, but you will need to set your <tt class="docutils literal"><span class="pre">HOME</span></tt> environment variable first. If your home directory is <tt class="docutils literal"><span class="pre">C:\Documents</span> <span class="pre">and</span> <span class="pre">Settings\James</span></tt>, you would put your <tt class="docutils literal"><span class="pre">.pypirc</span></tt> file in that directory and set your <tt class="docutils literal"><span class="pre">HOME</span></tt> environment variable with this command:</p>
<div class="highlight-python"><pre>&gt; SET HOME=C:\Documents and Settings\James</pre>
</div>
<p>You can now use <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">bdist_egg</span> <span class="pre">upload</span></tt> as normal.</p>
<p>At this point, your project has been successfully published. Other Python users can now install it just by entering this command:</p>
<div class="highlight-python"><pre>$ easy_install SimpleSite</pre>
</div>
<p id="index-1005">With the application successfully published, you might think your work is done, but actually, if you have a project you think would make a good starting point for other people’s projects, you can package it up as a project template. Let’s look at this next.</p>
</div>
</div>
<div class="section" id="making-simplesite-into-a-paste-project-template">
<h2>Making SimpleSite into a Paste Project Template<a class="headerlink" href="#making-simplesite-into-a-paste-project-template" title="Permalink to this headline">¶</a></h2>
<p id="index-1006">If you have a Pylons project you think would be useful to other people, it is possible to turn your Pylons <em>project</em> into a Paster <em>project template</em>, which can then be used to automatically generate a skeleton project based on SimpleSite by running this command:</p>
<div class="highlight-python"><pre>$ paster create --template=SimpleSite MyProject</pre>
</div>
<p id="index-1007">To set this up for SimpleSite, you’ll need to create a new project called <tt class="docutils literal"><span class="pre">SimpleSiteTemplate</span></tt>, which is just an empty <tt class="docutils literal"><span class="pre">setuptools</span></tt>-enabled package (not a Pylons project this time). Run the following command, and enter the appropriate information when prompted:</p>
<div class="highlight-python"><pre>$ paster create SimpleSiteTemplate

Selected and implied templates:
  PasteScript#basic_package  A basic setuptools-enabled package

Variables:
  egg:      SimpleSiteTemplate
  package:  simplesitetemplate
  project:  SimpleSiteTemplate
Enter version (Version (like 0.1)) ['']: 0.1
Enter description (One-line description of the package) ['']: A Paste Templatewhich allows you to create a new Pylons project based on the SimpleSite tutorial described in the Pylons Book
Enter long_description (Multi-line description (in reST)) ['']:
Enter keywords (Space-separated keywords/tags) ['']: Pylons Paste Template SimpleSite Simple Site Website
Enter author (Author name) ['']: James Gardner
Enter author_email (Author email) ['']: feedback@pylonsbook.com
Enter url (URL of homepage) ['']: http://pylonsbook.com
Enter license_name (License name) ['']: BSD
Enter zip_safe (True/False: if the package can be distributed as a .zip file) [False]:
Creating template basic_package
Creating directory ./SimpleSiteTemplate
  Recursing into +package+
    Creating ./SimpleSiteTemplate/simplesitetemplate/
    Copying __init__.py to ./SimpleSiteTemplate/simplesitetemplate/__init__.py
  Copying setup.cfg to ./SimpleSiteTemplate/setup.cfg
  Copying setup.py_tmpl to ./SimpleSiteTemplate/setup.py
Running /Users/james/devenv/bin/python setup.py egg_info</pre>
</div>
<p id="index-1008">This creates a skeleton package with a simple <tt class="docutils literal"><span class="pre">setup.py</span></tt> file built with the settings you entered at the command prompt.</p>
<p>You need a submodule to store the template files that will be used to as a basis for building the Pylons projects. Create a <tt class="docutils literal"><span class="pre">template</span></tt> directory within the <tt class="docutils literal"><span class="pre">SimpleSiteTemplate/simplesitetemplate</span></tt> directory. Next, copy every file and folder underneath the top-level SimpleSite directory into the <tt class="docutils literal"><span class="pre">SimpleSiteTemplate/simplesitetemplate/template</span></tt> directory.</p>
<div class="highlight-python"><pre>$ cd SimpleSiteProject/simplesiteproject/template
$ cp -pr /path/to/SimpleSite/* ./</pre>
</div>
<p>You don’t need the <tt class="docutils literal"><span class="pre">data</span></tt> directory, though, because Pylons re-creates this as it is needed based on the settings in the config file of the Pylons package the user eventually creates. You don’t need the <tt class="docutils literal"><span class="pre">dist</span></tt> or <tt class="docutils literal"><span class="pre">build</span></tt> directories either because they will get created automatically too if they are needed, and you don’t need any of the <tt class="docutils literal"><span class="pre">.pyc</span></tt> files or any of the files in <tt class="docutils literal"><span class="pre">SimpleSite.egg-info</span></tt> because they are all re-created by Paste when a user creates a project from the template. You should also remove any development database files you might have used such as the <tt class="docutils literal"><span class="pre">development.db</span></tt> file because users of your template will create their own database and are unlikely to want your existing content.</p>
<p>One command you can use to delete all <tt class="docutils literal"><span class="pre">.pyc</span></tt> files (tested on Mac OS X Leopard) is as follows:</p>
<div class="highlight-python"><pre>$ find . | grep .pyc | xargs rm</pre>
</div>
<p>Once you have finished, the <tt class="docutils literal"><span class="pre">SimpleSiteTemplate/simplesitetemplate</span></tt> directory should look like this:</p>
<div class="highlight-python"><pre>$ ls
MANIFEST.in             docs                    simplesite
README.txt              ez_setup.py             test.ini
SimpleSite.egg-info     setup.cfg
development.ini         setup.py</pre>
</div>
<p>Next, you’ll need to customize the SimpleSiteProject <tt class="docutils literal"><span class="pre">setup.py</span></tt> file so that Paste is automatically installed if a user tries to use the project template (this is not the <tt class="docutils literal"><span class="pre">setup.py</span></tt> file you copied into the <tt class="docutils literal"><span class="pre">template</span></tt> directory):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">install_requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Paste&gt;=1.7&quot;</span><span class="p">,</span>
<span class="p">],</span>
</pre></div>
</div>
<p>At this point, you are ready to start implementing the template part. First, you need to implement the plug-in class, which Paste will use to determine how to create the template. It is very simple. Add this to the <tt class="docutils literal"><span class="pre">SimpleSiteTemplate/simplesitetemplate/__init__.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.script.templates</span> <span class="kn">import</span> <span class="n">BasicPackage</span>

<span class="k">class</span> <span class="nc">SimpleSitePackage</span><span class="p">(</span><span class="n">BasicPackage</span><span class="p">):</span>
    <span class="n">_template_dir</span> <span class="o">=</span> <span class="s">&#39;template&#39;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="s">&quot;A Pylons template to create a simple, user-editable website&quot;</span>
    <span class="n">egg_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;PasteScript&#39;</span><span class="p">,</span> <span class="s">&#39;Pylons&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">_template_dir</span></tt> variable specifies the directory that contains the template files, relative to the Python module the <tt class="docutils literal"><span class="pre">BasicPackage</span></tt> class is defined in (in this case the <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file). The <tt class="docutils literal"><span class="pre">summary</span></tt> variable contains the text that is displayed when a user runs the command <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span> <span class="pre">--list-templates</span></tt>.</p>
<p>Next you need to use egg entry points so that the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">template</span></tt> program can find your new template. Edit the SimpleSiteProject <tt class="docutils literal"><span class="pre">setup.py</span></tt> file again to update the <tt class="docutils literal"><span class="pre">entry_points</span></tt> argument to the <tt class="docutils literal"><span class="pre">setup()</span></tt> function, to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry_points</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    # -*- Entry points: -*-</span>
<span class="s">    [paste.paster_create_template]</span>
<span class="s">    simplesite=simplesitetemplate:SimpleSitePackage</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>The entry point name will be used as the name of the plug-in, which in this case is <tt class="docutils literal"><span class="pre">simplesite</span></tt>. The second part points to the class that Paste will use to create the file structure for the new project. In this case, it is the <tt class="docutils literal"><span class="pre">SimpleSitePackage</span></tt> class you’ve just created in <tt class="docutils literal"><span class="pre">simplesitetemplate/__init__.py</span></tt>.</p>
<p>At this point, everything is set up and ready to test. Install the package in development mode with the following:</p>
<div class="highlight-python"><pre>$ python setup.py develop</pre>
</div>
<p id="index-1009">You can try to create a sample project somewhere, but there will be some problems:</p>
<div class="highlight-python"><pre>$ cd /path/to/create/new/project
$ paster create --template simplesite MyProject
simplesite MyProject
Selected and implied templates:
  SimpleSiteTemplate#simplesite  A Pylons template to create a simple, user-editable website

Variables:
  egg:      MyProject
  package:  myproject
  project:  MyProject
Enter version (Version (like 0.1)) ['']:
Enter description (One-line description of the package) ['']:
Enter long_description (Multi-line description (in reST)) ['']:
Enter keywords (Space-separated keywords/tags) ['']:
Enter author (Author name) ['']:
Enter author_email (Author email) ['']:
Enter url (URL of homepage) ['']:
Enter license_name (License name) ['']:
Enter zip_safe (True/False: if the package can be distributed as a .zip file) [False]:
Creating template simplesite
Creating directory ./MyProject
  Copying MANIFEST.in to ./MyProject/MANIFEST.in
  Copying README.txt to ./MyProject/README.txt
  Recursing into SimpleSite.egg-info
...
Copying test_models.py to ./MyProject/simplesite/tests/test_models.py
    Copying websetup.py to ./MyProject/simplesite/websetup.py
  Copying test.ini to ./MyProject/test.ini
Running /Users/james/devenv/bin/python setup.py egg_info
Traceback (most recent call last):
...
IOError: No egg-info directory found
...</pre>
</div>
<p id="index-1010">The command created a <tt class="docutils literal"><span class="pre">SimpleSite.egg-info</span></tt> directory, not a <tt class="docutils literal"><span class="pre">MyProject.egg-info</span></tt> directory, so when the command to set up the <tt class="docutils literal"><span class="pre">egg-info</span></tt> directory was run, it failed. You’ll need to fix that and also change the files and directories in the <tt class="docutils literal"><span class="pre">template</span></tt> directory so that they use variable names that Paste can replace when it creates the template.</p>
<p id="index-1011">It would also be nice if the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> script prompted you for a SQLAlchemy URL so that no manual editing of the <tt class="docutils literal"><span class="pre">development.ini</span></tt> file was necessary. You’ll learn how do each of these things in the next sections.</p>
<div class="section" id="introducing-project-template-variables">
<h3>Introducing Project Template Variables<a class="headerlink" href="#introducing-project-template-variables" title="Permalink to this headline">¶</a></h3>
<p id="index-1012">Classes derived from <tt class="docutils literal"><span class="pre">BasicPackage</span></tt> like the <tt class="docutils literal"><span class="pre">SimpleSitePackage</span></tt> class you just created can take a <tt class="docutils literal"><span class="pre">vars</span></tt> member variable. This allows you to ask extra questions just before the project is generated. The answers to those questions can then be assigned to variable names you specify, and those variable names can be used in the filenames, directory names, and file content, and they will be substituted for the options chosen on the command line when someone creates a project using the project template.</p>
<p>As you saw in the previous section, the <tt class="docutils literal"><span class="pre">BasicPackage</span></tt> class already asks the person creating a project a number of questions, and it assigns the answers of these questions to the following variables:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">version</span>
<span class="n">description</span>
<span class="n">long_description</span>
<span class="n">keywords</span>
<span class="n">author</span>
<span class="n">author_email</span>
<span class="n">url</span>
<span class="n">license_name</span>
<span class="n">zip_safe</span>
</pre></div>
</div>
<p>If you look at the output when you run the command, you’ll see these variable names in part of the question. For example <tt class="docutils literal"><span class="pre">author_email</span></tt> in the line below:</p>
<div class="highlight-python"><pre>Enter author_email (Author email) ['']:</pre>
</div>
<p>Let’s modify <tt class="docutils literal"><span class="pre">SimpleSitePackage</span></tt> to also ask for a value for <tt class="docutils literal"><span class="pre">sqlalchemy_url</span></tt>. Update the <tt class="docutils literal"><span class="pre">simplesitetemplate/__init__.py</span></tt> file to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">paste.script.templates</span> <span class="kn">import</span> <span class="n">BasicPackage</span><span class="p">,</span> <span class="n">var</span>

<span class="k">class</span> <span class="nc">SimpleSitePackage</span><span class="p">(</span><span class="n">BasicPackage</span><span class="p">):</span>
    <span class="n">_template_dir</span> <span class="o">=</span> <span class="s">&#39;template&#39;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="s">&quot;A Pylons template to create a simple, user-editable website&quot;</span>
    <span class="n">egg_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;PasteScript&#39;</span><span class="p">,</span> <span class="s">&#39;Pylons&#39;</span><span class="p">]</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">var</span><span class="p">(</span><span class="s">&#39;sqlalchemy_url&#39;</span><span class="p">,</span> <span class="s">&#39;The SQLAlchemy URL to the database to use&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s">&#39;sqlite:///</span><span class="si">%(here)s</span><span class="s">/develpment.db&#39;</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>If you run the command again, you’ll now be prompted for a SQLAlchemy URL, and if you don’t provide one, a default of <tt class="docutils literal"><span class="pre">sqlite:///%(here)s/develpment.db</span></tt> will be used.</p>
<div class="highlight-python"><pre>Enter sqlalchemy_url (The SQLAlchemy URL to the database to use) ['sqlite://%(here)s/develpment.db']:</pre>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">There are some other options too, but you won’t use them in this example. If you want to set up a more complex <tt class="docutils literal"><span class="pre">BasicPackage</span></tt> plug-in, you should have a look at the source code at the following location to understand how everything works: <a class="reference external" href="http://pythonpaste.org/script/paste/script/templates.py.html">http://pythonpaste.org/script/paste/script/templates.py.html</a>.</p>
</div>
</div>
<div class="section" id="using-project-template-variables">
<h3>Using Project Template Variables<a class="headerlink" href="#using-project-template-variables" title="Permalink to this headline">¶</a></h3>
<p>Now that the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> script is correctly prompting the user for all the information you need, it is time to update the files and directories in <tt class="docutils literal"><span class="pre">simplesitetemplate/template</span></tt> to use these variables.</p>
<p>In addition to the variables described so far, Paste sets up three more variables for you. If you look at the output from running the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span> <span class="pre">--template=simplesite</span> <span class="pre">MyProject</span></tt> command from the previous section, you’ll see them listed near the top:</p>
<div class="highlight-python"><pre>Variables:
  egg:      MyProject
  package:  myproject
  project:  MyProject</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">egg</span></tt>, <tt class="docutils literal"><span class="pre">package</span></tt>, and <tt class="docutils literal"><span class="pre">project</span></tt> variables represent the name used in the egg file, the Python name of the package, and the project name (which is the name that would be used if you published the package on the Python Package Index), respectively. Now that the variables have values assigned to them, you can begin using them in the files and directories in the <tt class="docutils literal"><span class="pre">template</span></tt> directory. Variables can be used in filenames, in directory names, and in the source code itself, but there are a few rules to follow:</p>
<blockquote>
<ul>
<li><p class="first">When a variable is used in a directory name or filename, it must have <tt class="docutils literal"><span class="pre">+</span></tt> characters on either side. For example:</p>
<div class="highlight-python"><pre>+egg+.egg_info

+project+.py</pre>
</div>
</li>
<li><p class="first">Variables within files should be wrapped in <tt class="docutils literal"><span class="pre">{{</span></tt> and <tt class="docutils literal"><span class="pre">}}</span></tt> characters. For example:</p>
<div class="highlight-python"><pre>import {{package}}.lib.base</pre>
</div>
</li>
<li><p class="first">Any file that contains variables should be renamed so that its file extension ends in <tt class="docutils literal"><span class="pre">_tmpl</span></tt>. So, <tt class="docutils literal"><span class="pre">foo.ini</span></tt> would become <tt class="docutils literal"><span class="pre">foo.ini_tmpl</span></tt>, and <tt class="docutils literal"><span class="pre">foo</span></tt> would become <tt class="docutils literal"><span class="pre">foo_tmpl</span></tt>.</p>
</li>
</ul>
</blockquote>
<p>In fact, you can perform more complex operations too. The <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span> <span class="pre">template</span></tt> script understands a very simple template language called Tempita documented at <a class="reference external" href="http://pythonpaste.org/tempita/">http://pythonpaste.org/tempita/</a>, so you can use any constructs supported by Tempita. Now that you know the rules, let’s go through and update the files, directories, and code in <tt class="docutils literal"><span class="pre">simplesitetemplate/template</span></tt> to use the variables you now have access too, starting by renaming the <tt class="docutils literal"><span class="pre">SimpleSite.egg-info</span></tt> and <tt class="docutils literal"><span class="pre">simplesite</span></tt> directories:</p>
<div class="highlight-python"><pre>$ cd SimpleSiteTemplate/simplesitetemplate/template
$ rm -r SimpleSite.egg-info
$ mkdir +egg+.egginfo
$ mv simplesite +package+</pre>
</div>
<p>You can delete the <tt class="docutils literal"><span class="pre">+package+/controllers/template.py.txt</span></tt> file you used as a template for other controllers in Chapter 14.</p>
<p>Now let’s get a list of all the files that contain the word <tt class="docutils literal"><span class="pre">SimpleSite</span></tt> or <tt class="docutils literal"><span class="pre">simplesite</span></tt>, because you’ll need to update them:</p>
<div class="highlight-python"><pre>$ egrep -rl '(simplesite|SimpleSite)' . | grep -v ".pyc"
./+package+/config/deployment.ini_tmpl
./+package+/config/environment.py
./+package+/config/middleware.py
./+package+/config/routing.py
./+package+/controllers/account.py
./+package+/controllers/comment.py
./+package+/controllers/error.py
./+package+/controllers/nav.py
./+package+/controllers/page.py
./+package+/controllers/section.py
./+package+/controllers/tag.py
./+package+/lib/base.py
./+package+/lib/helpers.py
./+package+/model/__init__.py
./+package+/public/yui/2.6.0/LICENSE.txt
./+package+/templates/base/index.html
./+package+/templates/component/navigation.html
./+package+/tests/functional/test_account.py
./+package+/tests/functional/test_nav.py
./+package+/tests/functional/test_page.py
./+package+/websetup.py
./MANIFEST.in
./README.txt
./development.ini
./docs/index.txt
./setup.cfg
./setup.py
./test.ini</pre>
</div>
<p>Rename each of these files so that they all have <tt class="docutils literal"><span class="pre">_tmpl</span></tt> added to the end of the filename. The <tt class="docutils literal"><span class="pre">config/deployment.ini_tmpl</span></tt> will need the extension too so will end up as <tt class="docutils literal"><span class="pre">config/deployment.ini_tmpl_tmpl</span></tt>.</p>
<p>If you don’t want to do this manually and are comfortable with a single command that will do this for you in a Bash shell, you could try the following one. The command should be entered on one line, and you are advised to back up your files first in case it behaves slightly differently or your platform:</p>
<div class="highlight-python"><pre>$ for f in `egrep -rl '(simplesite|SimpleSite)' . | grep -v .pyc `; do mv "$f" "`echo $f`_tmpl"; done</pre>
</div>
<p>Once the files are renamed, you’ll need to update the contents of the files. The majority of the work is changing the text <tt class="docutils literal"><span class="pre">SimpleSite</span></tt> and <tt class="docutils literal"><span class="pre">simplesite</span></tt>, so let’s do that first:</p>
<div class="highlight-python"><pre>$ grep -rl simplesite . | xargs perl -pi -w -e 's/simplesite/{{package}}/g;'
$ grep -rl SimpleSite . | xargs perl -pi -w -e 's/SimpleSite/{{project}}/g;'</pre>
</div>
<p>You also need to use the <tt class="docutils literal"><span class="pre">sqlalchemy_url</span></tt> variable the user has specified to fill in the value of the <tt class="docutils literal"><span class="pre">sqlalchemy.url</span></tt> option in <tt class="docutils literal"><span class="pre">development.ini</span></tt>.</p>
<p>Update <tt class="docutils literal"><span class="pre">development.ini_tmpl</span></tt> so that the <tt class="docutils literal"><span class="pre">sqlalchemy.url</span></tt> option looks like this:</p>
<div class="highlight-python"><pre>sqlalchemy.url = {{sqlalchemy_url}}</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You might be tempted to think that it would be a good idea to use the <tt class="docutils literal"><span class="pre">sqlalchemy_url</span></tt> variable in the <tt class="docutils literal"><span class="pre">config/deployment.ini_tmpl_tmpl</span></tt> file too, but just because users of your application are using a particular SQLAlchemy URL for their development doesn’t mean they will use the same in production.</p>
</div>
<p>You should also ensure that none of the files you are about to package contain any usernames, passwords or any other information you don&#8217;t want distributed. In particular you should check the <tt class="docutils literal"><span class="pre">development.ini</span></tt> and <tt class="docutils literal"><span class="pre">test.ini</span></tt> files.</p>
<p>Now that everything is set up correctly, let’s give the new template a test run. First let’s check that the template has been found:</p>
<div class="highlight-python"><pre>$ paster create --list-templates
Available templates:
  authenticate_plugin:  An AuthKit authenticate middleware plugin
  basic_package:        A basic setuptools-enabled package
  paste_deploy:         A web application deployed through paste.deploy
  pylons:               Pylons application template
  pylons_minimal:       Pylons minimal application template
  simplesite:           A Pylons template to create a simple, user-editable website</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">simplesite</span></tt> project template is correctly listed, so let’s try to create the <tt class="docutils literal"><span class="pre">MyProject</span></tt> application again. Remove the old <tt class="docutils literal"><span class="pre">MyProject</span></tt> directory if you tried to create the project earlier in the chapter, and then run the following command:</p>
<div class="highlight-python"><pre>$ paster create --template=simplesite MyProject</pre>
</div>
<p>If everything worked correctly, you can now test the application:</p>
<div class="highlight-python"><pre>$ cd MyProject
$ python setup.py develop
$ paster setup-app development.ini
$ paster serve --reload development.ini</pre>
</div>
<p id="index-1013">If you visit <a class="reference external" href="http://localhost:5000/">http://localhost:5000</a>, you will see the new project correctly serving pages. You’ve successfully created a new project with the same functionality as SimpleSite with just a few commands. At this point, you are ready to start customizing the MyProject application for your own requirements and needs.</p>
</div>
<div class="section" id="completing-the-cycle">
<h3>Completing the Cycle<a class="headerlink" href="#completing-the-cycle" title="Permalink to this headline">¶</a></h3>
<p id="index-1014">If you’ve been following along with the tutorial chapters of the book, you’ll actually have achieved something quite remarkable by this point. You’ll have created a useful product and packaged it up in such a way that other developers can use it as a project template for their own projects without having to re-solve all the problems you’ve already solved.</p>
<p>To complete the cycle, I&#8217;d like to show you how I packaged up and released the SimpleSiteTemplate on the Python Package Index so that other developers can use it as a basis for their projects. First I edited <tt class="docutils literal"><span class="pre">setup.cfg</span></tt> to comment out the <tt class="docutils literal"><span class="pre">tag_build</span></tt> and <tt class="docutils literal"><span class="pre">tag_svn_revision</span></tt> options. Then I created a <tt class="docutils literal"><span class="pre">MANIFEST.in</span></tt> file. This tells Python which files need to be included in the package. It looks like this and includes all the files in the <tt class="docutils literal"><span class="pre">template</span></tt> directory:</p>
<div class="highlight-python"><pre>recursive-include simplesitetemplate/template *</pre>
</div>
<p>Finally, I ran this command to create and upload the package:</p>
<div class="highlight-python"><pre>$ python setup.py bdist_egg sdist register upload</pre>
</div>
<p>Now any user can create a Pylons project based on SimpleSite, just by entering the following commands:</p>
<div class="highlight-python"><pre>$ easy_install SimpleSiteTemplate
$ paster create --template=simplesite MyProject</pre>
</div>
<p id="index-1015">I hope you consider packaging any projects you frequently use as a basis for your own projects into Paste Templates in a similar way so that other people can use them as starting points. In this way, members of the Pylons community can quickly and easily build on the success of other Pylons users’ projects.</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>You learned a lot in this chapter, from adding authentication and authorization facilities to SimpleSite to customizing Pylons’ error pages. You also saw how to add metadata to projects and how the egg format and Pylons metadata integrate with the Python Package Index so that you can easily publish projects online and automatically create a page containing basic information. You also saw what a project template really is, and you turned the SimpleSite application into a reusable project template so that other people can use it as a basis for their own projects.</p>
<p>That’s the end of the SimpleSite tutorial, but I hope many of the techniques and tools you’ve used to create the SimpleSite application will be useful in your own applications. If you are building a wiki, you might even be able to use the project template as a starting point for your code.</p>
<p id="index-1016">In the next chapter, you’ll look at Pylons’ logging support before moving on to see how to deploy Pylons applications in production environments.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Chapter 19: SimpleSite Tutorial Part 3</a><ul>
<li><a class="reference external" href="#authentication-and-authorization">Authentication and Authorization</a><ul>
<li><a class="reference external" href="#setting-up-the-middleware">Setting Up the Middleware</a></li>
<li><a class="reference external" href="#adjusting-websetup-py">Adjusting websetup.py</a></li>
<li><a class="reference external" href="#protecting-controller-actions">Protecting Controller Actions</a></li>
<li><a class="reference external" href="#changing-templates-based-on-permissions">Changing Templates Based on Permissions</a></li>
<li><a class="reference external" href="#signing-in-and-signing-out">Signing In and Signing Out</a></li>
<li><a class="reference external" href="#styling-the-sign-in-screen">Styling the Sign-in Screen</a></li>
<li><a class="reference external" href="#protecting-the-rest-of-the-actions">Protecting the Rest of the Actions</a></li>
<li><a class="reference external" href="#using-the-authkit-user-management-api">Using the AuthKit User Management API</a></li>
</ul>
</li>
<li><a class="reference external" href="#error-documents">Error Documents</a><ul>
<li><a class="reference external" href="#customizing-the-error-documents-for-simplesite">Customizing the Error Documents for SimpleSite</a></li>
</ul>
</li>
<li><a class="reference external" href="#adding-a-wysiwyg-interface">Adding a WYSIWYG Interface</a></li>
<li><a class="reference external" href="#configuring-the-setup-py-file">Configuring the setup.py File</a><ul>
<li><a class="reference external" href="#choosing-a-version-number">Choosing a Version Number</a></li>
<li><a class="reference external" href="#configuring-dependencies">Configuring Dependencies</a></li>
<li><a class="reference external" href="#extra-dependencies">Extra Dependencies</a></li>
<li><a class="reference external" href="#extra-dependency-links">Extra Dependency Links</a></li>
<li><a class="reference external" href="#specifying-metadata">Specifying Metadata</a></li>
<li><a class="reference external" href="#customizing-the-long-description">Customizing the Long Description</a></li>
<li><a class="reference external" href="#customizing-the-production-config-file-template">Customizing the Production Config File Template</a></li>
</ul>
</li>
<li><a class="reference external" href="#packaging-a-pylons-project-for-distribution">Packaging a Pylons Project for Distribution</a><ul>
<li><a class="reference external" href="#building-an-egg-file">Building an Egg File</a></li>
<li><a class="reference external" href="#publishing-an-egg-on-the-python-package-index">Publishing an Egg on the Python Package Index</a></li>
</ul>
</li>
<li><a class="reference external" href="#making-simplesite-into-a-paste-project-template">Making SimpleSite into a Paste Project Template</a><ul>
<li><a class="reference external" href="#introducing-project-template-variables">Introducing Project Template Variables</a></li>
<li><a class="reference external" href="#using-project-template-variables">Using Project Template Variables</a></li>
<li><a class="reference external" href="#completing-the-cycle">Completing the Cycle</a></li>
</ul>
</li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="authentication-and-authorization.html"
                                  title="previous chapter">Chapter 18: Authentication and Authorization</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="logging.html"
                                  title="next chapter">Chapter 20: Logging</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/simplesite-tutorial-part-3.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.0/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="logging.html" title="Chapter 20: Logging"
             >next</a> |</li>
        <li class="right" >
          <a href="authentication-and-authorization.html" title="Chapter 18: Authentication and Authorization"
             >previous</a> |</li>
        <li><a href="index.html">Pylons Book v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.1.
    </div>
  </body>

<!-- Mirrored from pylonsbook.com/en/1.0/simplesite-tutorial-part-3.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 11 Jun 2009 15:44:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>